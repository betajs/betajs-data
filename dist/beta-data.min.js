/*!
betajs-data - v1.0.0 - 2014-10-27
Copyright (c) Oliver Friedmann
MIT Software License.
*/
BetaJS.Queries={subsumizes:function(a,b){if(!BetaJS.Types.is_object(a)||!BetaJS.Types.is_object)return a==b;for(var c in a)if(!(c in b&&this.subsumizes(a[c],b[c])))return!1;return!0},normalize:function(a){return BetaJS.Sort.deep_sort(a)},serialize:function(a){return JSON.stringify(this.normalize(a))},unserialize:function(a){return JSON.parse(a)},__increase_dependency:function(a,b){return a in b?b[a]++:b[a]=1,b},__dependencies_queries:function(a,b){return BetaJS.Objs.iter(a,function(a){b=this.__dependencies_query(a,b)},this),b},__dependencies_query:function(a,b){for(key in a)b=this.__dependencies_pair(key,a[key],b);return b},__dependencies_pair:function(a,b,c){return"$or"==a||"$and"==a?this.__dependencies_queries(b,c):this.__increase_dependency(a,c)},dependencies:function(a){return this.__dependencies_query(a,{})},__evaluate_query:function(a,b){for(var c in a)if(!this.__evaluate_pair(c,a[c],b))return!1;return!0},__evaluate_pair:function(a,b,c){return"$or"==a?this.__evaluate_or(b,c):"$and"==a?this.__evaluate_and(b,c):this.__evaluate_value(b,c[a])},__evaluate_value:function(a,b){if(BetaJS.Types.is_object(a)){var c=!0;return BetaJS.Objs.iter(a,function(a,d){"$in"==d&&(c=c&&BetaJS.Objs.contains_value(a,b)),"$gt"==d&&(c=c&&b>=a),"$gtic"==d&&(c=c&&b.toLowerCase()>=a.toLowerCase()),"$lt"==d&&(c=c&&a>=b),"$ltic"==d&&(c=c&&b.toLowerCase()<=a.toLowerCase()),"$sw"==d&&(c=c&&0===b.indexOf(a)),"$swic"==d&&(c=c&&0===b.toLowerCase().indexOf(a.toLowerCase()))},this),c}return a==b},__evaluate_or:function(a,b){return BetaJS.Objs.iter(a,function(a){return this.__evaluate_query(a,b)?!0:void 0},this),!1},__evaluate_and:function(a,b){return BetaJS.Objs.iter(a,function(a){return this.__evaluate_query(a,b)?void 0:!1},this),!0},format:function(a){return BetaJS.Class.is_class_instance(a)?a.format():JSON.stringify(a)},overloaded_evaluate:function(a,b){return BetaJS.Class.is_class_instance(a)?a.evaluate(b):BetaJS.Types.is_function(a)?a(b):this.evaluate(a,b)},evaluate:function(a,b){return this.__evaluate_query(a,b)},emulate:function(a,b,c){var d=b.apply(c||this,{}),e=d;return d?BetaJS.Types.is_array(d)&&(e=BetaJS.Iterators.ArrayIterator(d)):e=BetaJS.Iterators.ArrayIterator([]),new BetaJS.Iterators.FilteredIterator(e,function(b){return BetaJS.Queries.evaluate(a,b)})}},BetaJS.Queries.Constrained={make:function(a,b){return{query:a,options:b||{}}},is_constrained:function(a){return a&&(a.query||a.options)},format:function(a){var b=a.query;a.query=BetaJS.Queries.format(b);var c=JSON.stringify(a);return a.query=b,c},normalize:function(a){return{query:"query"in a?BetaJS.Queries.normalize(a.query):{},options:{skip:"options"in a&&"skip"in a.options?a.options.skip:null,limit:"limit"in a&&"limit"in a.options?a.options.limit:null,sort:"sort"in a&&"sort"in a.options?a.options.sort:{}}}},emulate:function(a,b,c,d,e){var f=a.query||{},g=a.options||{},h={},i={};"sort"in g&&"sort"in b&&(i.sort=g.sort),h=f,("query"in b||BetaJS.Types.is_empty(f))&&(h=f,(!g.sort||"sort"in b)&&("skip"in g&&"skip"in b&&(i.skip=g.skip),"limit"in g&&"limit"in b&&(i.limit=g.limit,"skip"in g&&!("skip"in b)&&(i.limit+=g.skip))));var j=[h,i];e&&j.push(e);var k=function(a){var c=a;return null===a?c=new BetaJS.Iterators.ArrayIterator([]):BetaJS.Types.is_array(a)&&(c=new BetaJS.Iterators.ArrayIterator(a)),"query"in b||BetaJS.Types.is_empty(f)||(c=new BetaJS.Iterators.FilteredIterator(c,function(a){return BetaJS.Queries.evaluate(f,a)})),"sort"in g&&!("sort"in i)&&(c=new BetaJS.Iterators.SortedIterator(c,BetaJS.Comparators.byObject(g.sort))),"skip"in g&&!("skip"in i)&&(c=new BetaJS.Iterators.SkipIterator(c,g.skip)),"limit"in g&&!("limit"in i)&&(c=new BetaJS.Iterators.LimitIterator(c,g.limit)),e&&e.success&&BetaJS.SyncAsync.callback(e,"success",c),c},l=function(a){if(!e||!e.exception)throw a;BetaJS.SyncAsync.callback(e,"exception",a)};if(e)c.apply(d||this,[h,i,{success:k,exception:l,sync:e.sync,context:e.context||this}]);else try{var m=c.apply(d||this,[h,i]);return k(m)}catch(n){l(n)}return!0},subsumizes:function(a,b){if(qopt=a.options||{},qopt2=b.options||{},qskip=qopt.skip||0,qskip2=qopt2.skip||0,qlimit=qopt.limit||null,qlimit2=qopt2.limit||null,qsort=qopt.sort,qsort2=qopt2.sort,qskip>qskip2)return!1;if(qlimit){if(!qlimit2)return!1;if(qlimit2+qskip2>qlimit+qskip)return!1}return(qskip||qlimit)&&(qsort||qsort2)&&JSON.stringify(qsort)!=JSON.stringify(qsort2)?!1:BetaJS.Queries.subsumizes(a.query,b.query)},serialize:function(a){return JSON.stringify(this.normalize(a))},unserialize:function(a){return JSON.parse(a)},mergeable:function(a,b){if(BetaJS.Queries.serialize(a.query)!=BetaJS.Queries.serialize(b.query))return!1;var c=(a.options||{},b.options||{});return JSON.stringify(qopts.sort||{})!=JSON.stringify(c.sort||{})?!1:"skip"in qopts?"skip"in c?qopts.skip<=c.skip?!qopts.limit||qopts.skip+qopts.limit>=c.skip:!c.limit||c.skip+c.limit>=qopts.skip:!c.limit||c.limit>=qopts.skip:!("skip"in c)||!qopts.limit||qopts.limit>=c.skip},merge:function(a,b){var c=(a.options||{},b.options||{});return{query:a.query,options:{skip:"skip"in qopts&&"skip"in c?Math.min(qopts.skip,c.skip):null,limit:"limit"in qopts&&"limit"in c?Math.max(qopts.limit,c.limit):null,sort:a.sort}}}},BetaJS.Class.extend("BetaJS.Queries.AbstractQueryModel",{register:function(){},executable:function(){}}),BetaJS.Queries.AbstractQueryModel.extend("BetaJS.Queries.DefaultQueryModel",{constructor:function(){this._inherited(BetaJS.Queries.DefaultQueryModel,"constructor"),this.__queries={}},_insert:function(a){this.__queries[BetaJS.Queries.Constrained.serialize(a)]=a},_remove:function(a){delete this.__queries[BetaJS.Queries.Constrained.serialize(a)]},exists:function(a){return BetaJS.Queries.Constrained.serialize(a)in this.__queries},subsumizer_of:function(a){if(this.exists(a))return a;var b=null;return BetaJS.Objs.iter(this.__queries,function(c){return BetaJS.Queries.Constrained.subsumizes(c,a)&&(b=c),!b},this),b},executable:function(a){return!!this.subsumizer_of(a)},register:function(a){for(var b=!0;b;)b=!1,BetaJS.Objs.iter(this.__queries,function(c){BetaJS.Queries.Constrained.subsumizes(a,c)&&(this._remove(c),b=!0)},this);this._insert(a)},invalidate:function(a){var b=this.subsumizer_of(a);b&&this._remove(b)}}),BetaJS.Queries.DefaultQueryModel.extend("BetaJS.Queries.StoreQueryModel",{constructor:function(a){this.__store=a,this._inherited(BetaJS.Queries.StoreQueryModel,"constructor")},initialize:function(a){this.__store.query({},{},{context:this,success:function(b){for(;b.hasNext();){var c=b.next();delete c.id,this._insert(c)}BetaJS.SyncAsync.callback(a,"success")},exception:function(b){BetaJS.SyncAsync.callback(a,"exception",b)}})},_insert:function(a){this._inherited(BetaJS.Queries.StoreQueryModel,"_insert",a),this.__store.insert(a,{})},_remove:function(a){delete this.__queries[BetaJS.Queries.Constrained.serialize(a)],this.__store.query({query:a},{},{context:this,success:function(a){for(;a.hasNext();)this.__store.remove(a.next().id,{})}})}}),BetaJS.Collections.Collection.extend("BetaJS.Collections.QueryCollection",{constructor:function(a,b,c,d){this._source=a,this._inherited(BetaJS.Collections.QueryCollection,"constructor",c),this._options=BetaJS.Objs.extend({forward_steps:null,backward_steps:null,range:null},c),null!==b&&this.set_query(b,d)},query:function(){return this._query},set_query:function(a,b){b&&(b.context=b.context||this),this._query=BetaJS.Objs.extend({query:{},options:{}},a),this._query.options.skip=this._query.options.skip||0,this._query.options.limit=this._query.options.limit||null,this._query.options.sort=this._query.options.sort||{},this._count=0,this.__execute_query(this._query.options.skip,this._query.options.limit,!0,b)},__sub_query:function(a,b){this._source.query(this._query.query,a,b)},__execute_query:function(a,b,c,d){a=Math.max(a,0);var e={};this._query.options.sort&&!BetaJS.Types.is_empty(this._query.options.sort)&&(e.sort=this._query.options.sort),c?(a>0&&(e.skip=a),null!==b&&(e.limit=b),this.__sub_query(e,{context:this,success:function(c){var e=c.asArray();this._query.options.skip=a,this._query.options.limit=b,this._count=!b||e.length<b?a+e.length:null,this.clear(),this.add_objects(e),BetaJS.SyncAsync.callback(d,"success")}})):a<this._query.options.skip?(b=this._query.options.skip-a,a>0&&(e.skip=a),e.limit=b,this.__sub_query(e,{context:this,success:function(b){var c=b.asArray();this._query.options.skip=a;var e=this.add_objects(c);this._query.options.limit=null===this._query.options.limit?null:this._query.options.limit+e,BetaJS.SyncAsync.callback(d,"success")}})):a>=this._query.options.skip&&null!==this._query.options.limit&&(!b||a+b>this._query.options.skip+this._query.options.limit)&&(b=a+b-(this._query.options.skip+this._query.options.limit),a=this._query.options.skip+this._query.options.limit,a>0&&(e.skip=a),b&&(e.limit=b),this.__sub_query(e,{context:this,success:function(c){var e=c.asArray(),f=this.add_objects(e);this._query.options.limit=this._query.options.limit+f,b>e.length&&(this._count=a+f),BetaJS.SyncAsync.callback(d,"success")}}))},increase_forwards:function(a,b){a=a?a:this._options.forward_steps,a&&null!==this._query.options.limit&&this.__execute_query(this._query.options.skip+this._query.options.limit,a,!1,b)},increase_backwards:function(a){a=a?a:this._options.backward_steps,a&&this._query.options.skip>0&&(a=Math.min(a,this._query.options.skip),this.__execute_query(this._query.options.skip-a,a,!1))},paginate:function(a){this.__execute_query(this._options.range*a,this._options.range,!0)},paginate_index:function(){return this._options.range?Math.floor(this._query.options.skip/this._options.range):null},paginate_count:function(){return this._count&&this._options.range?Math.ceil(this._count/this._options.range):null},next:function(){var a=this.paginate_index();if(a){var b=this.paginate_count();(!b||a<this.paginate_count()-1)&&this.paginate(a+1)}},prev:function(){var a=this.paginate_index();a&&a>0&&this.paginate(a-1)},isComplete:function(){return null!==this._count}}),BetaJS.Collections.QueryCollection.extend("BetaJS.Collections.ActiveQueryCollection",{constructor:function(a,b,c,d){this._inherited(BetaJS.Collections.ActiveQueryCollection,"constructor",a,b,c,d),a.on("create",this.__active_create,this),a.on("remove",this.__active_remove,this),a.on("update",this.__active_update,this)},destroy:function(){this._source.off(null,null,this),this._inherited(BetaJS.Collections.ActiveQueryCollection,"destroy")},is_valid:function(a){return BetaJS.Queries.evaluate(this.query().query,a.getAll())},__active_create:function(a){this.is_valid(a)&&!this.exists(a)&&(this.add(a),this._count=this._count+1,null!==this._query.options.limit&&(this._query.options.limit=this._query.options.limit+1))},__active_remove:function(a){this.exists(a)&&(this.remove(a),this._count=this._count-1,null!==this._query.options.limit&&(this._query.options.limit=this._query.options.limit-1))},__active_update:function(a){this.is_valid(a)?this.__active_create(a):this.__active_remove(a)}}),BetaJS.Exceptions.Exception.extend("BetaJS.Stores.StoreException"),BetaJS.Class.extend("BetaJS.Stores.ListenerStore",[BetaJS.Events.EventsMixin,{constructor:function(a){this._inherited(BetaJS.Stores.ListenerStore,"constructor"),a=a||{},this._id_key=a.id_key||"id"},id_key:function(){return this._id_key},_inserted:function(a,b){this.trigger("insert",a,b)},_removed:function(a,b){this.trigger("remove",a,b)},_updated:function(a,b,c){this.trigger("update",a,b,c)}}]),BetaJS.Stores.BaseStore=BetaJS.Stores.ListenerStore.extend("BetaJS.Stores.BaseStore",[BetaJS.SyncAsync.SyncAsyncMixin,{constructor:function(a){this._inherited(BetaJS.Stores.BaseStore,"constructor",a),a=a||{},this._id_key=a.id_key||"id",this._create_ids=a.create_ids||!1,this._create_ids&&(this._id_generator=a.id_generator||this._auto_destroy(new BetaJS.Classes.TimedIdGenerator)),this._supportsSync=!0,this._supportsAsync=!0,this._query_model="query_model"in a?a.query_model:null},query_model:function(){return arguments.length>0&&(this._query_model=arguments[0]),this._query_model},_insert:function(){throw new BetaJS.Stores.StoreException("unsupported: insert")},_remove:function(){throw new BetaJS.Stores.StoreException("unsupported: remove")},_get:function(){throw new BetaJS.Stores.StoreException("unsupported: get")},_update:function(){throw new BetaJS.Stores.StoreException("unsupported: update")},_query_capabilities:function(){return{}},_query:function(){throw new BetaJS.Stores.StoreException("unsupported: query")},insert:function(a,b){var c=null;return BetaJS.Types.is_array(a)&&(c=a[1],a=a[0]),!this._create_ids||this._id_key in a&&a[this._id_key]||(a[this._id_key]=this._id_generator.generate()),this.then(this._insert,[a],b,function(a,b){this._inserted(a,c),BetaJS.SyncAsync.callback(b,"success",a)})},insert_all:function(a,b,c){var d=null;if(arguments.length>3&&(d=arguments[3]),c&&this._query_model&&(this.trigger("query_register",c),this._query_model.register(c)),b){var e=this,f=function(c){return c>=a.length?void BetaJS.SyncAsync.callback(b,"success"):void this.insert(d?[a[c],d]:a[c],BetaJS.SyncAsync.mapSuccess(b,function(){f.call(e,c+1)}))};f.call(this,0)}else for(var g=0;g<a.length;++g)this.insert(d?[a[g],d]:a[g])},remove:function(a,b){var c=null;return BetaJS.Types.is_array(a)&&(c=a[1],a=a[0]),this.then(this._remove,[a],b,function(b,d){this._removed(a,c),BetaJS.SyncAsync.callback(d,"success",a)})},get:function(a,b){return this.delegate(this._get,[a],b)},update:function(a,b,c){var d=null;return BetaJS.Types.is_array(b)&&(d=b[1],b=b[0]),this.then(this._update,[a,b],c,function(a,c){this._updated(a,b,d),BetaJS.SyncAsync.callback(c,"success",a,b)})},query:function(a,b,c){if(b&&(b.limit&&(b.limit=parseInt(b.limit,10)),b.skip&&(b.skip=parseInt(b.skip,10))),this._query_model){var d=this._query_model.subsumizer_of({query:a,options:b});if(!d){this.trigger("query_miss",{query:a,options:b});var e=new BetaJS.Stores.StoreException("Cannot execute query");if(!c)throw e;return BetaJS.SyncAsync.callback(c,"exception",e),null}this.trigger("query_hit",{query:a,options:b},d)}var f=function(c){return BetaJS.Queries.Constrained.emulate(BetaJS.Queries.Constrained.make(a,b||{}),this._query_capabilities(),this._query,this,c)};return this.either(c,f,f)},_query_applies_to_id:function(a,b){var c=this.get(b);return c&&BetaJS.Queries.overloaded_evaluate(a,c)},clear:function(a){return this.then(this.query,[{},{}],a,function(a,b){for(var c=[];a.hasNext();)c.push(this.remove,[a.next().id]);return this.join(c,b)})},_ensure_index:function(){},ensure_index:function(a){this._ensure_index(a)},perform:function(a,b){var c=BetaJS.Objs.keyByIndex(a),d=BetaJS.Objs.valueByIndex(a);if("insert"==c)this.insert(d,b);else if("remove"==c)this.remove(d,b);else{if("update"!=c)throw new BetaJS.Stores.StoreException("unsupported: perform "+c);this.update(BetaJS.Objs.keyByIndex(d),BetaJS.Objs.valueByIndex(d),b)}},bulk:function(a,b,c){var d=[];if(c){var e=function(){d.length<a.length?this.perform(a[d.length],{context:this,success:function(){d.push(!0),e.apply(this)},exception:function(a){d.push(!1),b?e.apply(this):c.exception.apply(c.context||this,a)}}):c.success.call(c.context||this,d)};e.apply(this)}else for(var f=0;f<a.length;++f)try{this.perform(a[f]),d.push(!0)}catch(g){if(d.push(!1),!b)throw g}return d}}]),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.AssocStore",{_read_key:function(){},_write_key:function(){},_remove_key:function(){},_iterate:function(){},constructor:function(a){a=a||{},a.create_ids=!0,this._inherited(BetaJS.Stores.AssocStore,"constructor",a),this._supportsAsync=!1},_insert:function(a){return this._write_key(a[this._id_key],a),a},_remove:function(a){var b=this._read_key(a);return b&&!this._remove_key(a)?null:b},_get:function(a){return this._read_key(a)},_update:function(a,b){var c=this._get(a);return c&&(this._id_key in b&&(this._remove_key(a),a=b[this._id_key],delete b[this._id_key]),BetaJS.Objs.extend(c,b),this._write_key(a,c)),c},_query:function(){return this._iterate()}}),BetaJS.Stores.AssocStore.extend("BetaJS.Stores.MemoryStore",{constructor:function(a){this._inherited(BetaJS.Stores.MemoryStore,"constructor",a),this.__data={}},_read_key:function(a){return this.__data[a]},_write_key:function(a,b){this.__data[a]=b},_remove_key:function(a){delete this.__data[a]},_iterate:function(){return new BetaJS.Iterators.ObjectValuesIterator(this.__data)}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.DumbStore",{_read_last_id:function(){},_write_last_id:function(){},_remove_last_id:function(){},_read_first_id:function(){},_write_first_id:function(){},_remove_first_id:function(){},_read_item:function(){},_write_item:function(){},_remove_item:function(){},_read_next_id:function(){},_write_next_id:function(){},_remove_next_id:function(){},_read_prev_id:function(){},_write_prev_id:function(){},_remove_prev_id:function(){},constructor:function(a){a=a||{},a.create_ids=!0,this._inherited(BetaJS.Stores.DumbStore,"constructor",a),this._supportsAsync=!1},_insert:function(a){var b=this._read_last_id(),c=a[this._id_key];return null!==b?(this._write_next_id(b,c),this._write_prev_id(c,b)):this._write_first_id(c),this._write_last_id(c),this._write_item(c,a),a},_remove:function(a){var b=this._read_item(a);if(b){this._remove_item(a);var c=this._read_next_id(a),d=this._read_prev_id(a);null!==c?(this._remove_next_id(a),null!==d?(this._remove_prev_id(a),this._write_next_id(d,c),this._write_prev_id(c,d)):(this._remove_prev_id(c),this._write_first_id(c))):null!==d?(this._remove_next_id(d),this._write_last_id(d)):(this._remove_first_id(),this._remove_last_id())}return b},_get:function(a){return this._read_item(a)},_update:function(a,b){var c=this._get(a);return c&&(delete b[this._id_key],BetaJS.Objs.extend(c,b),this._write_item(a,c)),c},_query_capabilities:function(){return{query:!0}},_query:function(a){var b=new BetaJS.Iterators.Iterator,c=this,d=this._read_first_id();return BetaJS.Objs.extend(b,{__id:null===d?1:d,__store:c,__query:a,hasNext:function(){var b=this.__store._read_last_id();if(null===b)return!1;for(;this.__id<b&&!this.__store._read_item(this.__id);)this.__id++;for(;this.__id<=b;){if(this.__store._query_applies_to_id(a,this.__id))return!0;this.__id<b?this.__id=this.__store._read_next_id(this.__id):this.__id++}return!1},next:function(){if(this.hasNext()){var a=this.__store.get(this.__id);return this.__id==this.__store._read_last_id()?this.__id++:this.__id=this.__store._read_next_id(this.__id),a}return null}}),b}}),BetaJS.Stores.DumbStore.extend("BetaJS.Stores.AssocDumbStore",{_read_key:function(){},_write_key:function(){},_remove_key:function(){},__read_id:function(a){var b=this._read_key(a);return b?parseInt(b,10):null},_read_last_id:function(){return this.__read_id("last_id")},_write_last_id:function(a){this._write_key("last_id",a)},_remove_last_id:function(){this._remove_key("last_id")},_read_first_id:function(){return this.__read_id("first_id")},_write_first_id:function(a){this._write_key("first_id",a)},_remove_first_id:function(){this._remove_key("first_id")},_read_item:function(a){return this._read_key("item_"+a)},_write_item:function(a,b){this._write_key("item_"+a,b)},_remove_item:function(a){this._remove_key("item_"+a)},_read_next_id:function(a){return this.__read_id("next_"+a)},_write_next_id:function(a,b){this._write_key("next_"+a,b)},_remove_next_id:function(a){this._remove_key("next_"+a)},_read_prev_id:function(a){return this.__read_id("prev_"+a)},_write_prev_id:function(a,b){this._write_key("prev_"+a,b)},_remove_prev_id:function(a){this._remove_key("prev_"+a)}}),BetaJS.Stores.AssocDumbStore.extend("BetaJS.Stores.LocalStore",{constructor:function(a){this._inherited(BetaJS.Stores.LocalStore,"constructor",a),this.__prefix=a.prefix},__key:function(a){return this.__prefix+a},_read_key:function(a){var b=this.__key(a);return b in localStorage?JSON.parse(localStorage[b]):null},_write_key:function(a,b){localStorage[this.__key(a)]=JSON.stringify(b)},_remove_key:function(a){delete localStorage[this.__key(a)]}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.DualStore",{constructor:function(a,b,c){c=BetaJS.Objs.extend({create_options:{},update_options:{},delete_options:{},get_options:{},query_options:{}},c||{}),c.id_key=a._id_key,this.__first=a,this.__second=b,this._inherited(BetaJS.Stores.DualStore,"constructor",c),this._supportsSync=a.supportsSync()&&b.supportsSync(),this._supportsAsync=a.supportsAsync()||b.supportsAsync(),this.__create_options=BetaJS.Objs.extend({start:"first",strategy:"then",auto_replicate:"first"},c.create_options),this.__update_options=BetaJS.Objs.extend({start:"first",strategy:"then",auto_replicate:"first"},c.update_options),this.__remove_options=BetaJS.Objs.extend({start:"first",strategy:"then",auto_replicate:"first"},c.delete_options),this.__get_options=BetaJS.Objs.extend({start:"first",strategy:"or",clone:!0,clone_second:!1,or_on_null:!0},c.get_options),this.__query_options=BetaJS.Objs.extend({start:"first",strategy:"or",clone:!0,clone_second:!1,or_on_null:!0},c.query_options),this.__first.on("insert",this.__inserted_first,this),this.__second.on("insert",this.__inserted_second,this),this.__first.on("update",this.__updated_first,this),this.__second.on("update",this.__updated_second,this),this.__first.on("remove",this.__removed_first,this),this.__second.on("remove",this.__removed_second,this)},__inserted_first:function(a,b){b&&b.dual_insert||(("first"==this.__create_options.auto_replicate||"both"==this.__create_options.auto_replicate)&&this.__second.insert([a,{dual_insert:!0}],{}),this._inserted(a))},__inserted_second:function(a,b){b&&b.dual_insert||(("second"==this.__create_options.auto_replicate||"both"==this.__create_options.auto_replicate)&&this.__first.insert([a,{dual_insert:!0}],{}),this._inserted(a))},__updated_first:function(a,b,c){c&&c.dual_update||(("first"==this.__update_options.auto_replicate||"both"==this.__update_options.auto_replicate)&&this.__second.update(a[this.id_key()],[b,{dual_update:!0}],{}),this._updated(a,b))},__updated_second:function(a,b,c){c&&c.dual_update||(("second"==this.__update_options.auto_replicate||"both"==this.__update_options.auto_replicate)&&this.__first.update(a[this.id_key()],[b,{dual_update:!0}],{}),this._updated(a,b))},__removed_first:function(a,b){b&&b.dual_remove||(("first"==this.__remove_options.auto_replicate||"both"==this.__remove_options.auto_replicate)&&this.__second.remove([a,{dual_remove:!0}],{}),this._removed(a))},__removed_second:function(a,b){b&&b.dual_remove||(("second"==this.__remove_options.auto_replicate||"both"==this.__remove_options.auto_replicate)&&this.__first.remove([a,{dual_remove:!0}],{}),this._removed(a))},first:function(){return this.__first},second:function(){return this.__second},_insert:function(a,b){var c=this.__first,d=this.__second;"first"!=this.__create_options.start&&(c=this.__second,d=this.__first);var e=this.__create_options.strategy;if(b)if("then"==e)c.insert([a,{dual_insert:!0}],{success:function(a){d.insert([a,{dual_insert:!0}],b)},exception:b.exception});else{if("or"==e)return c.insert([a,{dual_insert:!0}],{success:b.success,exception:function(){d.insert([a,{dual_insert:!0}],b)}});c.insert([a,{dual_insert:!0}],b)}else{if("then"==e)return d.insert([c.insert([a,{dual_insert:!0}]),{dual_insert:!0}]);if("or"!=e)return c.insert([a,{dual_insert:!0}]);try{return c.insert([a,{dual_insert:!0}])}catch(f){return d.insert([a,{dual_insert:!0}])}}return!0},_update:function(a,b,c){var d=this.__first,e=this.__second;"first"!=this.__update_options.start&&(d=this.__second,e=this.__first);var f=this.__update_options.strategy;if(c)if("then"==f)d.update(a,[b,{dual_update:!0}],{success:function(b){e.update(a,[b,{dual_update:!0}],c)},exception:c.exception});else{if("or"==f)return d.update(a,[b,{dual_update:!0}],{success:c.success,exception:function(){e.update(a,[b,{dual_update:!0}],c)}});d.update(a,[b,{dual_update:!0}],c)}else{if("then"==f)return e.update(a,[d.update(a,[b,{dual_update:!0}]),{dual_update:!0}]);if("or"!=f)return d.update(a,[b,{dual_update:!0}]);try{return d.update(a,[b,{dual_update:!0}])}catch(g){return e.update(a,[b,{dual_update:!0}])}}return!0},_remove:function(a,b){var c=this.__first,d=this.__second;"first"!=this.__remove_options.start&&(c=this.__second,d=this.__first);var e=this.__remove_options.strategy;if(b)"then"==e?c.remove([a,{dual_remove:!0}],{success:function(){d.remove([a,{dual_remove:!0}],b)},exception:b.exception}):"or"==e?c.remove([a,{dual_remove:!0}],{success:b.success,exception:function(){d.remove([a,{dual_remove:!0}],b)}}):c.remove(a,b);else if("then"==e)c.remove([a,{dual_remove:!0}]),d.remove([a,{dual_remove:!0}]);else if("or"==e)try{c.remove([a,{dual_remove:!0}])}catch(f){d.remove([a,{dual_remove:!0}])}else c.remove([a,{dual_remove:!0}])},_query_capabilities:function(){return{query:!0,sort:!0,limit:!0,skip:!0}},_get:function(a,b){var c=this.__first,d=this.__second;"first"!=this.__get_options.start&&(c=this.__second,d=this.__first);var e=this.__get_options.strategy,f=this.__get_options.clone,g=this.__get_options.clone_second,h=this.__get_options.or_on_null;if("or"==e){var i=function(b){d.get(a,BetaJS.SyncAsync.mapSuccess(b,function(a){a&&f?c.delegate(c.insert,[a],b):this.callback(b,"success",a)}))};return c.then(c.get,[a],b,function(b,c){return!b&&h?void i(c):void(g?d.get(a,{success:function(a){a?this.callback(c,"success",b):d.insert(b,c)},exception:function(){d.insert(b,c)}}):this.callback(c,"success",b))},function(a,b){i(b)})}return c.get(a,b)},_query:function(a,b,c){var d=this.__first,e=this.__second;"first"!=this.__query_options.start&&(d=this.__second,e=this.__first);var f=this.__query_options.strategy,g=this.__query_options.clone,h=this.__get_options.clone_second,i=this.__query_options.or_on_null,j=null;if("or"==f){var k=function(c){return this.trigger("query_second",a,b),e.query(a,b,BetaJS.SyncAsync.mapSuccess(c,function(e){if(e&&g){arr=e.asArray(),e=new BetaJS.Iterators.ArrayIterator(arr);var f=BetaJS.SyncAsync.mapSuccess(c,function(){BetaJS.SyncAsync.callback(c,"success",e)});d.insert_all(arr,f,{query:a,options:b},{dual_insert:!0})}else BetaJS.SyncAsync.callback(c,"success",e)})),j},l=function(c,d){arr=c.asArray(),c=new BetaJS.Iterators.ArrayIterator(arr);var f=BetaJS.SyncAsync.mapSuccess(d,function(){BetaJS.SyncAsync.callback(d,"success",c)});e.insert_all(arr,f,{query:a,options:b},{dual_insert:!0})};return this.trigger("query_first",a,b),this.then(d,d.query,[a,b],c,function(c,d){return!c&&i?void k.call(this,d):void(h?(this.trigger("query_second",a,b),e.query(a,b,{success:function(a){a?this.callback(d,"success",c):l(c,d)},exception:function(){l(c,d)}})):this.callback(d,"success",c))},function(a,b){k.call(this,b)})}return this.trigger("query_first",a,b),d.query(a,b,c)}}),BetaJS.Stores.DualStore.extend("BetaJS.Stores.CachedStore",{constructor:function(a,b){b=b||{};var c=b.cache_store;"cache_store"in b||(c=this._auto_destroy(new BetaJS.Stores.MemoryStore({id_key:a.id_key()}))),c.query_model()||c.query_model(b.cache_query_model?b.cache_query_model:this._auto_destroy(new BetaJS.Queries.DefaultQueryModel)),this.__invalidation_options=b.invalidation||{},this._inherited(BetaJS.Stores.CachedStore,"constructor",a,c,BetaJS.Objs.extend({get_options:{start:"second",strategy:"or"},query_options:{start:"second",strategy:"or",clone:!0,or_on_null:!1}},b)),this.__invalidation_options.reload_after_first_hit&&(this.__queries={},this.cache().on("query_hit",function(a,b){var c=BetaJS.Queries.Constrained.serialize(b);this.__queries[c]||(this.__queries[c]=!0,BetaJS.SyncAsync.eventually(function(){this.invalidate_query(b,!0)},[],this))},this),this.cache().on("query_miss",function(a){var b=BetaJS.Queries.Constrained.serialize(a);this.__queries[b]=!0},this))},destroy:function(){this.cache().off(null,null,this),this._inherited(BetaJS.Stores.CachedStore,"destroy")},invalidate_query:function(a,b){this.cache().query_model().invalidate(a),b&&(this.supportsAsync()?this.query(a.query,a.options,{}):this.query(a.query,a.options)),this.trigger("invalidate_query",a,b)},cache:function(){return this.second()},store:function(){return this.first()}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.ConversionStore",{constructor:function(a,b){b=b||{},b.id_key=a._id_key,this._inherited(BetaJS.Stores.ConversionStore,"constructor",b),this.__store=a,this.__key_encoding=b.key_encoding||{},this.__key_decoding=b.key_decoding||{},this.__value_encoding=b.value_encoding||{},this.__value_decoding=b.value_decoding||{}},encode_object:function(a){var b={};for(var c in a){var d=this.encode_key(c);d&&(b[d]=this.encode_value(c,a[c]))}return b},decode_object:function(a){var b={};for(var c in a){var d=this.decode_key(c);d&&(b[d]=this.decode_value(c,a[c]))}return b},encode_key:function(a){return a in this.__key_encoding?this.__key_encoding[a]:a},decode_key:function(a){return a in this.__key_decoding?this.__key_decoding[a]:a},encode_value:function(a,b){return a in this.__value_encoding?this.__value_encoding[a](b):b},decode_value:function(a,b){return a in this.__value_decoding?this.__value_decoding[a](b):b},_query_capabilities:function(){return this.__store._query_capabilities()},_ensure_index:function(a){return this.__store.ensure_index(a)},_insert:function(a,b){return this.then(this.__store,this.__store.insert,[this.encode_object(a)],b,function(a,b){b.success(this.decode_object(a))})},_remove:function(a,b){return this.delegate(this.__store,this.__store.remove,[this.encode_value(this._id_key,a)],b)},_get:function(a,b){return this.then(this.__store,this.__store.get,[this.encode_value(this._id_key,a)],b,function(a,b){b.success(this.decode_object(a))})},_update:function(a,b,c){return this.then(this.__store,this.__store.update,[this.encode_value(this._id_key,a),this.encode_object(b)],c,function(a,b){b.success(this.decode_object(a))})},_query:function(a,b,c){return this.then(this.__store,this.__store.query,[this.encode_object(a),b],c,function(a,b){var c=new BetaJS.Iterators.MappedIterator(a,function(a){return this.decode_object(a)},this);b.success(c)})}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.PassthroughStore",{constructor:function(a,b){this.__store=a,b=b||{},b.id_key=a.id_key(),this._projection=b.projection||{},this._inherited(BetaJS.Stores.PassthroughStore,"constructor",b),this._supportsAsync=a.supportsAsync(),this._supportsSync=a.supportsSync(),b.destroy_store&&this._auto_destroy(a)},_query_capabilities:function(){return this.__store._query_capabilities()},_insert:function(a,b){return this.__store.insert(BetaJS.Objs.extend(a,this._projection),b)},_remove:function(a,b){return this.__store.remove(a,b)},_get:function(a,b){return this.__store.get(a,b)},_update:function(a,b,c){return this.__store.update(a,b,c)},_query:function(a,b,c){return this.__store.query(BetaJS.Objs.extend(a,this._projection),b,c)},_ensure_index:function(a){return this.__store.ensure_index(a)},_store:function(){return this.__store}}),BetaJS.Stores.PassthroughStore.extend("BetaJS.Stores.ActiveStore",{constructor:function(a,b,c){this._inherited(BetaJS.Stores.ActiveStore,"constructor",a,c),this.__listener=b,this.delegateEvents(null,b)}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.SocketStore",{constructor:function(a,b,c){this._inherited(BetaJS.Stores.SocketStore,"constructor",a),this.__socket=b,this.__prefix=c,this._supportsAsync=!1},__send:function(a,b){this.__socket.emit(this.__prefix+":"+a,b)},_insert:function(a){this.__send("insert",a)},_remove:function(a){this.__send("remove",a)},_update:function(a,b){this.__send("update",BetaJS.Objs.objectBy(a,b))},bulk:function(a){this.__send("bulk",a)}}),BetaJS.Stores.ListenerStore.extend("BetaJS.Stores.SocketListenerStore",{constructor:function(a,b,c){this._inherited(BetaJS.Stores.SocketListenerStore,"constructor",a);var d=this;this.__prefix=c,b.on(this.__prefix+":insert",function(a){d._perform("insert",a)}),b.on(this.__prefix+":remove",function(a){d._perform("remove",a)}),b.on(this.__prefix+":update",function(a){d._perform("update",a)}),b.on(this.__prefix+":bulk",function(a){for(var b=0;b<a.length;++b)d._perform(BetaJS.Objs.keyByIndex(a[b]),BetaJS.Objs.valueByIndex(a[b]))
})},_perform:function(a,b){if("insert"==a)this._inserted(b);else if("remove"==a)this._removed(b);else{if("update"!=a)throw new BetaJS.Stores.StoreException("unsupported: perform "+a);this._updated(BetaJS.Objs.objectBy(this.id_key(),BetaJS.Objs.keyByIndex(b)),BetaJS.Objs.valueByIndex(b))}}}),BetaJS.Stores.StoreException.extend("BetaJS.Stores.RemoteStoreException",{constructor:function(a){a=BetaJS.Net.AjaxException.ensure(a),this._inherited(BetaJS.Stores.RemoteStoreException,"constructor",a.toString()),this.__source=a},source:function(){return this.__source}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.RemoteStore",{constructor:function(a,b,c){this._inherited(BetaJS.Stores.RemoteStore,"constructor",c),this._uri=a,this.__ajax=b,this.__options=BetaJS.Objs.extend({update_method:"PUT",uri_mappings:{},bulk_method:"POST",supports_bulk:!1},c||{})},getUri:function(){return this._uri},prepare_uri:function(a,b){return this.__options.uri_mappings[a]?this.__options.uri_mappings[a](b):"remove"==a||"get"==a||"update"==a?this.getUri()+"/"+b[this._id_key]:this.getUri()},_encode_query:function(){return{uri:this.prepare_uri("query")}},__invoke:function(a,b,c){if(b)return this.__ajax.asyncCall(a,{success:function(a){if(c&&BetaJS.Types.is_string(a))try{a=JSON.parse(a)}catch(d){}BetaJS.SyncAsync.callback(b,"success",a)},exception:function(a){BetaJS.SyncAsync.callback(b,"exception",new BetaJS.Stores.RemoteStoreException(a))}});try{var d=this.__ajax.syncCall(a);if(c&&BetaJS.Types.is_string(d))try{return JSON.parse(d)}catch(e){}return d}catch(e){throw new BetaJS.Stores.RemoteStoreException(e)}return!1},_insert:function(a,b){return this.__invoke({method:"POST",uri:this.prepare_uri("insert",a),data:a},b,!0)},_get:function(a,b){var c={};return c[this._id_key]=a,this.__invoke({uri:this.prepare_uri("get",c)},b)},_update:function(a,b,c){var d=BetaJS.Objs.clone(b,1);return d[this._id_key]=a,this.__invoke({method:this.__options.update_method,uri:this.prepare_uri("update",d),data:b},c)},_remove:function(a,b){var c={};return c[this._id_key]=a,this.__invoke({method:"DELETE",uri:this.prepare_uri("remove",c)},b)},_query:function(a,b,c){return this.__invoke(this._encode_query(a,b),c,!0)},bulk:function(a,b){return this.__options.supports_bulk?this.__invoke({method:this.__options.bulk_method,uri:this.prepare_uri("bulk"),data:a}):this._inherited(BetaJS.Stores.RemoteStore,"bulk",a,b)}}),BetaJS.Stores.RemoteStore.extend("BetaJS.Stores.QueryGetParamsRemoteStore",{constructor:function(a,b,c,d){this._inherited(BetaJS.Stores.QueryGetParamsRemoteStore,"constructor",a,b,d),this.__capability_params=c},_query_capabilities:function(){var a={};return"skip"in this.__capability_params&&(a.skip=!0),"limit"in this.__capability_params&&(a.limit=!0),"query"in this.__capability_params&&(a.query=!0),"sort"in this.__capability_params&&(a.sort=!0),a},_encode_query:function(a,b){b=b||{};var c=this.getUri()+"?";return b.skip&&"skip"in this.__capability_params&&(c+=this.__capability_params.skip+"="+b.skip+"&"),b.limit&&"limit"in this.__capability_params&&(c+=this.__capability_params.limit+"="+b.limit+"&"),b.sort&&"sort"in this.__capability_params&&(c+=this.__capability_params.sort+"="+JSON.stringify(b.sort)+"&"),"query"in this.__capability_params&&(c+=this.__capability_params.query+"="+JSON.stringify(a)+"&"),{uri:c}}}),BetaJS.Class.extend("BetaJS.Stores.StoresMonitor",[BetaJS.Events.EventsMixin,{attach:function(a,b){b.on("insert",function(c){this.trigger("insert",a,b,c),this.trigger("write","insert",a,b,c)},this),b.on("remove",function(c){this.trigger("remove",a,b,c),this.trigger("write","remove",a,b,c)},this),b.on("update",function(c,d){this.trigger("update",a,b,c,d),this.trigger("write","update",a,b,c,d)},this)}}]),BetaJS.Class.extend("BetaJS.Stores.StoreHistory",[BetaJS.Events.EventsMixin,{constructor:function(a,b){this._inherited(BetaJS.Stores.StoreHistory,"constructor"),b=b||{},this._combine_update_update=b.combine_update_update||!1,this._combine_insert_update=b.combine_insert_update||!1,this._combine_insert_remove=b.combine_insert_remove||!1,this._combine_update_remove=b.combine_update_remove||!1,this._commits={},this._revision_id=null,this._store=a,this._item_commits={},this._store.on("insert",function(a){this.__add_commit({action:"insert",id:a[this._store.id_key()],data:a})},this),this._store.on("remove",function(a){this.__add_commit({action:"remove",id:a})},this),this._store.on("update",function(a,b){this.__add_commit({action:"update",id:a,data:b})},this)},__remove_commit:function(a){this.trigger("remove",this._commits[a]);var b=this._commits[a].id;delete this._commits[a],delete this._item_commits[b],BetaJS.Objs.is_empty(this._item_commits[b])&&delete this._item_commits[b]},__add_commit:function(a){a.revision_id=this._new_revision_id();var b=!1,c=!1,d=null;for(var e in this._item_commits[a.id]){var f=this._commits[e];b=b||"insert"==f.action,c=c||"update"==f.action,d=e}if(this._revision_id=a.revision_id,this._commits[this._revision_id]=a,this._item_commits[a.id]=this._item_commits[a.id]||{},this._item_commits[a.id][a.revision_id]=!0,this.trigger("commit",a),"update"==a.action)(this._combine_insert_update&&!c&&b||this._combine_update_update&&c)&&(this.__remove_commit(a.revision_id),this._commits[d].data=BetaJS.Objs.extend(this._commits[d].data,a.data));else if("remove"==a.action)for(e in this._item_commits[a.id])f=this._commits[e],(b&&this._combine_insert_remove||"update"==f.action&&this._combine_update_remove)&&this.__remove_commit(e)},flush:function(a){a=a||this._revision_id;for(var b in this._commits){if(b>a)break;this.__remove_commit(b)}},serialize:function(a){var b=this._commits[a];return"insert"==commin.action?{insert:b.data}:"remove"==b.action?{remove:b.id}:"update"==b?{update:BetaJS.Objs.objectBy(b.id,b.data)}:null},serialize_bulk:function(a){a=a||this._revision_id;var b=[];for(var c in this._commits){if(c>a)break;b.push(this.serialize(c))}return b},revision_id:function(){return this._revision_id},_new_revision_id:function(){return this.cls.__revision_id+1}}],{__revision_id:0}),BetaJS.Exceptions.Exception.extend("BetaJS.Modelling.ModelException",{constructor:function(a,b){this._inherited(BetaJS.Modelling.ModelException,"constructor",b),this.__model=a},model:function(){return this.__model}}),BetaJS.Modelling.ModelException.extend("BetaJS.Modelling.ModelMissingIdException",{constructor:function(a){this._inherited(BetaJS.Modelling.ModelMissingIdException,"constructor",a,"No id given.")}}),BetaJS.Modelling.ModelException.extend("BetaJS.Modelling.ModelInvalidException",{constructor:function(a){var b=BetaJS.Objs.values(a.errors()).join("\n");this._inherited(BetaJS.Modelling.ModelInvalidException,"constructor",a,b)}}),BetaJS.Properties.Properties.extend("BetaJS.Modelling.SchemedProperties",{constructor:function(a,b){this._inherited(BetaJS.Modelling.SchemedProperties,"constructor");var c=this.cls.scheme();this._properties_changed={},this.__errors={},this.__unvalidated={};for(var d in c)"def"in c[d]?this.set(d,c[d].def):c[d].auto_create?this.set(d,c[d].auto_create(this)):this.set(d,null);b=b||{},this._properties_changed={},this.__errors={};for(d in a)this.set(d,a[d])},_unsetChanged:function(a){delete this._properties_changed[a]},_beforeSet:function(a,b){var c=this.cls.scheme();if(!(a in c))return b;var d=c[a];return"boolean"==d.type?BetaJS.Types.parseBool(b):(d.transform&&(b=d.transform.apply(this,[b])),b)},_afterSet:function(a,b){var c=this.cls.scheme();if(a in c&&(this._properties_changed[a]=b,this.__unvalidated[a]=!0,delete this.__errors[a],c[a].after_set)){var d=BetaJS.Types.is_string(c[a].after_set)?this[c[a].after_set]:c[a].after_set;d.apply(this,[b])}},properties_changed:function(a){return BetaJS.Types.is_boolean(a)?BetaJS.Objs.filter(this._properties_changed,function(b,c){return this.validateAttr(c)==a},this):this._properties_changed},get_all_properties:function(){var a={},b=this.cls.scheme();for(var c in b)a[c]=this.get(c);return a},properties_by:function(a){return BetaJS.Types.is_boolean(a)?BetaJS.Objs.filter(this.get_all_properties(),function(b,c){return this.validateAttr(c)==a},this):this.get_all_properties()},validate:function(){this.trigger("validate");for(var a in this.__unvalidated)this.validateAttr(a);return this._customValidate(),BetaJS.Types.is_empty(this.__errors)},_customValidate:function(){},validateAttr:function(a){if(a in this.__unvalidated){delete this.__unvalidated[a],delete this.__errors[a];var b=this.cls.scheme(),c=b[a];if("validate"in c){var d=c.validate;BetaJS.Types.is_array(d)||(d=[d]);var e=this.get(a);BetaJS.Objs.iter(d,function(b){var c=b.validate(e,this);return c&&(this.__errors[a]=c),null===c},this)}this.trigger("validate:"+a,!(a in this.__errors),this.__errors[a])}return!(a in this.__errors)},setError:function(a,b){delete this.__unvalidated[a],this.__errors[a]=b,this.trigger("validate:"+a,!(a in this.__errors),this.__errors[a])},revalidate:function(){return this.__errors={},this.__unvalidated=this.keys(!0),this.validate()},errors:function(){return this.__errors},getError:function(a){return this.__errors[a]},asRecord:function(a){var b={},c=this.cls.scheme(),d=this.get_all_properties();a=a||{};for(var e in d)if(e in c){var f=c[e].tags||[],g={};BetaJS.Objs.iter(f,function(a){g[a]=!0});var h=!0;BetaJS.Objs.iter(a,function(a){h=h&&a in g},this),h&&(b[e]=d[e])}return b},setByTags:function(a,b){var c=this.cls.scheme();b=b||{};for(var d in a)if(d in c){var e=c[d].tags||[],f={};BetaJS.Objs.iter(e,function(a){f[a]=!0});var g=!0;BetaJS.Objs.iter(b,function(a){g=g&&a in f},this),g&&this.set(d,a[d])}},validation_exception_conversion:function(a){var b=a;if(a.instance_of(BetaJS.Stores.RemoteStoreException))b=a.source();else if(!("status_code"in b&&"data"in b))return a;return b.status_code()==BetaJS.Net.HttpHeader.HTTP_STATUS_PRECONDITION_FAILED&&b.data()&&(BetaJS.Objs.iter(b.data(),function(a,b){this.setError(b,a)},this),a=new BetaJS.Modelling.ModelInvalidException(model)),a}},{_initializeScheme:function(){return{}},asRecords:function(a,b){return a.map(function(a){return a.asRecord(b)})},filterPersistent:function(a){var b={},c=this.scheme();for(var d in a)(!BetaJS.Types.is_defined(c[d].persistent)||c[d].persistent)&&(b[d]=a[d]);return b}},{scheme:function(){return this.__scheme=this.__scheme||this._initializeScheme(),this.__scheme}}),BetaJS.Modelling.SchemedProperties.extend("BetaJS.Modelling.AssociatedProperties",{constructor:function(a,b){this._inherited(BetaJS.Modelling.AssociatedProperties,"constructor",a,b),this.assocs=this._initializeAssociations();for(var c in this.assocs)this.__addAssoc(c,this.assocs[c])},__addAssoc:function(a,b){this[a]=function(){return b.yield()}},_initializeAssociations:function(){return{}},destroy:function(){for(var a in this.assocs)this.assocs[a].destroy();this._inherited(BetaJS.Modelling.AssociatedProperties,"destroy")},id:function(){return this.get(this.cls.primary_key())},hasId:function(){return this.has(this.cls.primary_key())}},{primary_key:function(){return"id"},_initializeScheme:function(){var a=this._inherited(BetaJS.Modelling.AssociatedProperties,"_initializeScheme");return a[this.primary_key()]={type:"id"},a}}),BetaJS.Modelling.AssociatedProperties.extend("BetaJS.Modelling.Model",[BetaJS.SyncAsync.SyncAsyncMixin,{constructor:function(a,b){b=b||{},this._inherited(BetaJS.Modelling.Model,"constructor",a,b),this.__saved="saved"in b?b.saved:!1,this.__new="new"in b?b["new"]:!0,this.__removed=!1,this.__saved&&(this._properties_changed={}),this.__table=b.table||this.cls.defaultTable(),this.__table._model_register(this),this.__destroying=!1,this._supportsAsync=this.__table.supportsAsync(),this._supportsSync=this.__table.supportsSync()},destroy:function(){!this.__destroying&&this.__table&&(this.__destroying=!0,this.__table._model_unregister(this),this.trigger("destroy"),this._inherited(BetaJS.Modelling.Model,"destroy"))},isSaved:function(){return this.__saved},isNew:function(){return this.__new},isRemoved:function(){return this.__removed},update:function(a,b,c){this.setAll(a,{silent:!0}),this.save(c)},_afterSet:function(a,b,c,d){this._inherited(BetaJS.Modelling.Model,"_afterSet",a,b,c,d);var e=this.cls.scheme();a in e&&(d&&d.no_change?this._unsetChanged(a):this.__saved=!1,d&&d.silent||this.__table&&this.__table._model_set_value(this,a,b,d))},_after_create:function(){},_before_create:function(){},save:function(a){return this.__new&&this._before_create(),this.then(this.__table,this.__table._model_save,[this],a,function(a,b){this.trigger("save"),this.__saved=!0;var c=this.__new;this.__new=!1,c&&this._after_create(),this.callback(b,"success",a)})},remove:function(a){return this.then(this.__table,this.__table._model_remove,[this],a,function(a,b){this.trigger("remove"),this.__removed=!0,this.callback(b,"success",a)})},table:function(){return this.__table}}],{defaultTable:function(){return this.table||(this.table=new BetaJS.Modelling.Table(new BetaJS.Stores.MemoryStore,this)),this.table}}),BetaJS.Class.extend("BetaJS.Modelling.Table",[BetaJS.Events.EventsMixin,BetaJS.SyncAsync.SyncAsyncMixin,{constructor:function(a,b,c){this._inherited(BetaJS.Modelling.Table,"constructor"),this.__store=a,this.__model_type=b,this.__models_by_id={},this.__models_changed={},this.__options=BetaJS.Objs.extend({model_cache_size:null,type_column:null,auto_create:!1,store_validation_conversion:!0,auto_update:!0,auto_materialize:!1},c||{}),this.__models_by_cid=new BetaJS.Classes.ObjectCache({size:this.__options.model_cache_size}),this._auto_destroy(this.__models_by_cid),this.__models_by_cid.on("release",function(a){a.hasId()&&delete this.__models_by_id[a.id()]},this),this.__options.auto_materialize&&this.__store.on("insert",function(a,b){if(!(this.__models_by_id[a[this.primary_key()]]||b&&b.model_create)){var c=this.__materialize(a);this.trigger("create",c)}},this),this.__store.on("update",function(a,b,c){if(!(!this.__models_by_id[a[this.primary_key()]]||c&&c.model_update)){var d=this.__models_by_id[a[this.primary_key()]];d.setAll(b,{silent:!0}),this.trigger("update",d)}},this),this.__store.on("remove",function(a,b){if(!(!this.__models_by_id[a]||b&&b.model_remove)){var c=this.__models_by_id[a];this.trigger("remove",c),c.destroy()}},this),this._supportsAsync=!0,this._supportsSync=a.supportsSync()},_model_register:function(a){this.hasModel(a)||(this.trigger("register",a),this.__models_by_cid.add(a),a.hasId()&&(this.__models_by_id[a.id()]=a),a.isNew()&&this.__options.auto_create&&this._model_create(a))},_model_unregister:function(a){this.hasModel(a)&&(a.save(),this.__models_by_cid.remove(a),a.hasId()&&delete this.__models_by_id[a.id()],this.trigger("unregister",a))},hasModel:function(a){return null!==this.__models_by_cid.get(a)},_model_remove:function(a,b){return this.hasModel(a)?this.then(this.__store,this.__store.remove,[[a.id(),{model_remove:!0}]],b,function(b,c){this.trigger("remove",a),a.destroy(),this.callback(c,"success",!0)},function(a,b){this.callback(b,"exception",a)}):!1},_model_save:function(a,b){return a.isNew()?this._model_create(a,b):this._model_update(a,b)},__exception_conversion:function(a,b){return this.__options.store_validation_conversion?a.validation_exception_conversion(b):b},_model_create:function(a,b){if(!this.hasModel(a)||!a.isNew())return!1;if(!a.validate()){var c=new BetaJS.Modelling.ModelInvalidException(a);if(!b)throw c;this.callback(b,"exception",c)}var d=BetaJS.Scopes.resolve(this.__model_type).filterPersistent(a.get_all_properties());return this.__options.type_column&&(d[this.__options.type_column]=a.cls.classname),this.then(this.__store,this.__store.insert,[[d,{model_create:!0}]],b,function(b,c){return a.cls.primary_key()in b?(this.__models_by_id[b[a.cls.primary_key()]]=a,a.setAll(b,{no_change:!0,silent:!0}),delete this.__models_changed[a.cid()],this.trigger("create",a),this.trigger("save",a),this.callback(c,"success",a),!0):this.callback(c,"exception",new BetaJS.Modelling.ModelMissingIdException(a))},function(b,c){b=BetaJS.Exceptions.ensure(b),b=this.__exception_conversion(a,b),this.callback(c,"exception",b)})},_model_update:function(a,b){if(!this.hasModel(a)||a.isNew())return!1;if(!a.validate()){var c=new BetaJS.Modelling.ModelInvalidException(a);if(!b)throw c;this.callback(b,"exception",c)}var d=BetaJS.Scopes.resolve(this.__model_type).filterPersistent(a.properties_changed());return BetaJS.Types.is_empty(d)?(b&&this.callback(b,"success",d),d):this.then(this.__store,this.__store.update,[a.id(),[d,{model_update:!0}]],b,function(b,c){return a.setAll(b,{no_change:!0,silent:!0}),delete this.__models_changed[a.cid()],this.trigger("update",a),this.trigger("save",a),this.callback(c,"success",b),b},function(b,c){return b=BetaJS.Exceptions.ensure(b),b=this.__exception_conversion(a,b),this.callback(c,"exception",b),!1})},_model_set_value:function(a,b,c,d){return this.__models_changed[a.cid()]=a,this.trigger("change",a,b,c),this.trigger("change:"+b,a,c),this.__options.auto_update?a.save(d):void 0},save:function(a){if(a){var b=[];return BetaJS.Objs.iter(this.__models_changed,function(a){b.push(a.promise(a.save))},this),this.join(b,a)}var c=!0;return BetaJS.Objs.iter(this.__models_changed,function(a){c=a.save()&&c}),c},primary_key:function(){return BetaJS.Scopes.resolve(this.__model_type).primary_key()},__materialize:function(a){if(!a)return null;var b=this.__model_type;this.__options.type_column&&a[this.__options.type_column]&&(b=a[this.__options.type_column]);var c=BetaJS.Scopes.resolve(b);if(this.__models_by_id[a[this.primary_key()]])return this.__models_by_id[a[this.primary_key()]];var d=new c(a,{table:this,saved:!0,"new":!1});return d},findById:function(a,b){return this.__models_by_id[a]?(b&&this.callback(b,"success",this.__models_by_id[a]),this.__models_by_id[a]):this.then(this.__store,this.__store.get,[a],b,function(b,c){this.callback(c,"success",this.__materialize(this.__store.get(a)))})},findBy:function(a,b){return this.then(this,this.allBy,[a,{limit:1}],b,function(a,b){this.callback(b,"success",a.next())})},all:function(a,b){return this.allBy({},a,b)},allBy:function(a,b,c){var d=this;return this.__store.then(this.__store.query,[a,b],c,function(a,b){var c=new BetaJS.Iterators.MappedIterator(a,function(a){return this.__materialize(a)},d);d.callback(b,"success",c)})},query:function(){return this.allBy.apply(this,arguments)},scheme:function(){return this.__model_type.scheme()},ensure_indices:function(){if(!("ensure_index"in this.__store))return!1;var a=this.scheme();for(var b in a)a[b].index&&this.__store.ensure_index(b);return!0}}]),BetaJS.Class.extend("BetaJS.Modelling.Associations.Association",[BetaJS.SyncAsync.SyncAsyncMixin,{constructor:function(a,b){this._inherited(BetaJS.Modelling.Associations.Association,"constructor"),this._model=a,this._options=b||{},this.__cache=null,b.delete_cascade&&a.on("remove",function(){this.__delete_cascade()},this)},__delete_cascade:function(){this.yield({success:function(a){a=BetaJS.Iterators.ensure(a).toArray();for(var b=[];a.hasNext();){var c=a.next();b.push(c.promise(c.remove))}this.join(b,{success:function(){}})}})},"yield":function(a){return this._options.cached?this.eitherFactory("__cache",a,this._yield,this._yield):this._yield(a)},invalidate:function(){delete this.__cache}}]),BetaJS.Modelling.Associations.Association.extend("BetaJS.Modelling.Associations.TableAssociation",{constructor:function(a,b,c,d){this._inherited(BetaJS.Modelling.Associations.TableAssociation,"constructor",a,d),this._foreign_table=b,this._foreign_key=c,d.primary_key&&(this._primary_key=d.primary_key),this._options.cached&&this._foreign_table.on("create update remove",function(){this.invalidate()},this)},destroy:function(){this._foreign_table.off(null,null,this),this._inherited(BetaJS.Modelling.Associations.TableAssociation,"destroy")}}),BetaJS.Modelling.Associations.TableAssociation.extend("BetaJS.Modelling.Associations.HasManyAssociation",{_id:function(){return this._primary_key?this._model.get(this._primary_key):this._model.id()},_yield:function(a){return this.allBy({},a)},"yield":function(a){if(!this._options.cached)return this._yield(a);if(this.__cache){var b=new BetaJS.Iterators.ArrayIterator(this.__cache);return a&&this.callback(a,"success",b),b}return this.then(this._yield,a,function(a,b){this.__cache=a.asArray(),BetaJS.Objs.iter(this.__cache,function(a){a.on("destroy",function(){this.invalidate()},this)},this),this.callback(b,"success",new BetaJS.Iterators.ArrayIterator(this.__cache))})},invalidate:function(){BetaJS.Objs.iter(this.__cache,function(a){a.off(null,null,this)},this),this._inherited(BetaJS.Modelling.Associations.HasManyAssociation,"invalidate")},findBy:function(a,b){return a[this._foreign_key]=this._id(),this._foreign_table.findBy(a,b)},allBy:function(a,b,c){return a[this._foreign_key]=c?c:this._id(),this._foreign_table.allBy(a,{},b)}}),BetaJS.Modelling.Associations.HasManyAssociation.extend("BetaJS.Modelling.Associations.HasManyThroughArrayAssociation",{_yield:function(a){if(a){var b=[];return BetaJS.Objs.iter(this._model.get(this._foreign_key),function(a){b.push(this._foreign_table.promise(this._foreign_table.findById,[a]))},this),this.join(b,BetaJS.SyncAsync.mapSuccess(a,function(b){this.callback(a,"success",BetaJS.Objs.filter(b,function(a){return!!a}))}))}var c=[];return BetaJS.Objs.iter(this._model.get(this._foreign_key),function(a){var b=this._foreign_table.findById(a);b&&c.push(b)},this),c},"yield":function(a){if(!this._options.cached)return new BetaJS.Iterators.ArrayIterator(this._yield(a));if(this.__cache){var b=new BetaJS.Iterators.ArrayIterator(this.__cache);return a&&this.callback(a,"success",b),b}return this.then(this._yield,a,function(a,b){this.__cache=a,BetaJS.Objs.iter(this.__cache,function(a){a.on("destroy",function(){this.invalidate()},this)},this),this.callback(b,"success",new BetaJS.Iterators.ArrayIterator(this.__cache))})}}),BetaJS.Modelling.Associations.TableAssociation.extend("BetaJS.Modelling.Associations.HasOneAssociation",{_yield:function(a,b){var c={};return c[this._foreign_key]=b?b:this._primary_key?this._model.get(this._primary_key):this._model.id(),this.then(this._foreign_table,this._foreign_table.findBy,[c],a,function(a,b){a&&a.on("destroy",function(){this.invalidate()},this),this.callback(b,"success",a)})}}),BetaJS.Modelling.Associations.TableAssociation.extend("BetaJS.Modelling.Associations.BelongsToAssociation",{_yield:function(a){var b=function(a,b){a&&a.on("destroy",function(){this.invalidate()},this),this.callback(b,"success",a)};if(!this._primary_key)return this.then(this._foreign_table,this._foreign_table.findById,[this._model.get(this._foreign_key)],a,b);var c={};return c[this._primary_key]=this._model.get(this._foreign_key),this.then(this._foreign_table,this._foreign_table.findBy,[c],a,b)}}),BetaJS.Modelling.Associations.Association.extend("BetaJS.Modelling.Associations.ConditionalAssociation",{constructor:function(a,b){this._inherited(BetaJS.Modelling.Associations.ConditionalAssociation,"constructor"),this._model=a,this._options=b||{},this.__cache=null,b.delete_cascade&&a.on("remove",function(){this.__delete_cascade()},this)},_yield:function(a){return this._model.assocs[this._options.conditional(this._model)].yield(a)}}),BetaJS.Modelling.Associations.Association.extend("BetaJS.Modelling.Associations.PolymorphicHasOneAssociation",{constructor:function(a,b,c,d){this._inherited(BetaJS.Modelling.Associations.PolymorphicHasOneAssociation,"constructor",a,d),this._foreign_table_key=b,this._foreign_key=c,d.primary_key&&(this._primary_key=d.primary_key)},_yield:function(a,b){var c={};c[this._foreign_key]=b?b:this._primary_key?this._model.get(this._primary_key):this._model.id();var d=BetaJS.Scopes.resolve(this._model.get(this._foreign_table_key));return this.then(d,d.findBy,[c],a,function(a,b){a&&a.on("destroy",function(){this.invalidate()},this),this.callback(b,"success",a)})}}),BetaJS.Class.extend("BetaJS.Modelling.Validators.Validator",{validate:function(){return null}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.PresentValidator",{constructor:function(a){this._inherited(BetaJS.Modelling.Validators.PresentValidator,"constructor"),this.__error_string=a?a:"Field is required"},validate:function(a){return BetaJS.Types.is_null(a)||""===a?this.__error_string:null}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.EmailValidator",{constructor:function(a){this._inherited(BetaJS.Modelling.Validators.EmailValidator,"constructor"),this.__error_string=a?a:"Not a valid email address"},validate:function(a){return BetaJS.Strings.is_email_address(a)?null:this.__error_string}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.LengthValidator",{constructor:function(a){this._inherited(BetaJS.Modelling.Validators.LengthValidator,"constructor"),this.__min_length=BetaJS.Types.is_defined(a.min_length)?a.min_length:null,this.__max_length=BetaJS.Types.is_defined(a.max_length)?a.max_length:null,this.__error_string=BetaJS.Types.is_defined(a.error_string)?a.error_string:null,this.__error_string||(null!==this.__min_length?this.__error_string=null!==this.__max_length?"Between "+this.__min_length+" and "+this.__max_length+" characters":"At least "+this.__min_length+" characters":null!==this.__max_length&&(this.__error_string="At most "+this.__max_length+" characters"))},validate:function(a){return null!==this.__min_length&&(!a||a.length<this.__min_length)?this.__error_string:null!==this.__max_length&&a.length>this.__max_length?this.__error_string:null}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.UniqueValidator",{constructor:function(a,b){this._inherited(BetaJS.Modelling.Validators.UniqueValidator,"constructor"),this.__key=a,this.__error_string=b?b:"Key already present"},validate:function(a,b){var c={};c[this.__key]=a;var d=b.table().findBy(c);return!d||!b.isNew()&&b.id()==d.id()?null:this.__error_string}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.ConditionalValidator",{constructor:function(a,b){this._inherited(BetaJS.Modelling.Validators.ConditionalValidator,"constructor"),this.__condition=a,this.__validator=BetaJS.Types.is_array(b)?b:[b]},validate:function(a,b){if(!this.__condition(a,b))return null;for(var c=0;c<this.__validator.length;++c){var d=this.__validator[c].validate(a,b);if(null!==d)return d}return null}});