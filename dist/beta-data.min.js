/*!
betajs-data - v1.0.0 - 2014-10-02
Copyright (c) Oliver Friedmann
MIT Software License.
*/
BetaJS.Queries={subsumizes:function(t,e){if(!BetaJS.Types.is_object(t)||!BetaJS.Types.is_object)return t==e;for(var i in t)if(!(i in e&&this.subsumizes(t[i],e[i])))return!1;return!0},normalize:function(t){return BetaJS.Sort.deep_sort(t)},serialize:function(t){return JSON.stringify(this.normalize(t))},unserialize:function(t){return JSON.parse(t)},__increase_dependency:function(t,e){return t in e?e[t]++:e[t]=1,e},__dependencies_queries:function(t,e){return BetaJS.Objs.iter(t,function(t){e=this.__dependencies_query(t,e)},this),e},__dependencies_query:function(t,e){for(key in t)e=this.__dependencies_pair(key,t[key],e);return e},__dependencies_pair:function(t,e,i){return"$or"==t||"$and"==t?this.__dependencies_queries(e,i):this.__increase_dependency(t,i)},dependencies:function(t){return this.__dependencies_query(t,{})},__evaluate_query:function(t,e){for(var i in t)if(!this.__evaluate_pair(i,t[i],e))return!1;return!0},__evaluate_pair:function(t,e,i){return"$or"==t?this.__evaluate_or(e,i):"$and"==t?this.__evaluate_and(e,i):this.__evaluate_value(e,i[t])},__evaluate_value:function(t,e){if(BetaJS.Types.is_object(t)){var i=!0;return BetaJS.Objs.iter(t,function(t,s){"$in"==s&&(i=i&&BetaJS.Objs.contains_value(t,e)),"$gt"==s&&(i=i&&e>=t),"$gtic"==s&&(i=i&&e.toLowerCase()>=t.toLowerCase()),"$lt"==s&&(i=i&&t>=e),"$ltic"==s&&(i=i&&e.toLowerCase()<=t.toLowerCase()),"$sw"==s&&(i=i&&0===e.indexOf(t)),"$swic"==s&&(i=i&&0===e.toLowerCase().indexOf(t.toLowerCase()))},this),i}return t==e},__evaluate_or:function(t,e){return BetaJS.Objs.iter(t,function(t){return this.__evaluate_query(t,e)?!0:void 0},this),!1},__evaluate_and:function(t,e){return BetaJS.Objs.iter(t,function(t){return this.__evaluate_query(t,e)?void 0:!1},this),!0},format:function(t){return BetaJS.Class.is_class_instance(t)?t.format():JSON.stringify(t)},overloaded_evaluate:function(t,e){return BetaJS.Class.is_class_instance(t)?t.evaluate(e):BetaJS.Types.is_function(t)?t(e):this.evaluate(t,e)},evaluate:function(t,e){return this.__evaluate_query(t,e)},emulate:function(t,e,i){var s=e.apply(i||this,{}),n=s;return s?BetaJS.Types.is_array(s)&&(n=BetaJS.Iterators.ArrayIterator(s)):n=BetaJS.Iterators.ArrayIterator([]),new BetaJS.Iterators.FilteredIterator(n,function(e){return BetaJS.Queries.evaluate(t,e)})}},BetaJS.Queries.Constrained={make:function(t,e){return{query:t,options:e||{}}},is_constrained:function(t){return t&&(t.query||t.options)},format:function(t){var e=t.query;t.query=BetaJS.Queries.format(e);var i=JSON.stringify(t);return t.query=e,i},normalize:function(t){return{query:"query"in t?BetaJS.Queries.normalize(t.query):{},options:{skip:"options"in t&&"skip"in t.options?t.options.skip:null,limit:"limit"in t&&"limit"in t.options?t.options.limit:null,sort:"sort"in t&&"sort"in t.options?t.options.sort:{}}}},emulate:function(t,e,i,s,n){var r=t.query||{},o=t.options||{},_={},a={};"sort"in o&&"sort"in e&&(a.sort=o.sort),_=r,("query"in e||BetaJS.Types.is_empty(r))&&(_=r,(!o.sort||"sort"in e)&&("skip"in o&&"skip"in e&&(a.skip=o.skip),"limit"in o&&"limit"in e&&(a.limit=o.limit,"skip"in o&&!("skip"in e)&&(a.limit+=o.skip))));var c=[_,a];n&&c.push(n);var u=function(t){var i=t;return null===t?i=new BetaJS.Iterators.ArrayIterator([]):BetaJS.Types.is_array(t)&&(i=new BetaJS.Iterators.ArrayIterator(t)),"query"in e||BetaJS.Types.is_empty(r)||(i=new BetaJS.Iterators.FilteredIterator(i,function(t){return BetaJS.Queries.evaluate(r,t)})),"sort"in o&&!("sort"in a)&&(i=new BetaJS.Iterators.SortedIterator(i,BetaJS.Comparators.byObject(o.sort))),"skip"in o&&!("skip"in a)&&(i=new BetaJS.Iterators.SkipIterator(i,o.skip)),"limit"in o&&!("limit"in a)&&(i=new BetaJS.Iterators.LimitIterator(i,o.limit)),n&&n.success&&BetaJS.SyncAsync.callback(n,"success",i),i},h=function(t){if(!n||!n.exception)throw t;BetaJS.SyncAsync.callback(n,"exception",t)};if(n)i.apply(s||this,[_,a,{success:u,exception:h,sync:n.sync,context:n.context||this}]);else try{var d=i.apply(s||this,[_,a]);return u(d)}catch(l){h(l)}return!0},subsumizes:function(t,e){if(qopt=t.options||{},qopt2=e.options||{},qskip=qopt.skip||0,qskip2=qopt2.skip||0,qlimit=qopt.limit||null,qlimit2=qopt2.limit||null,qsort=qopt.sort,qsort2=qopt2.sort,qskip>qskip2)return!1;if(qlimit){if(!qlimit2)return!1;if(qlimit2+qskip2>qlimit+qskip)return!1}return(qskip||qlimit)&&(qsort||qsort2)&&JSON.stringify(qsort)!=JSON.stringify(qsort2)?!1:BetaJS.Queries.subsumizes(t.query,e.query)},serialize:function(t){return JSON.stringify(this.normalize(t))},unserialize:function(t){return JSON.parse(t)},mergeable:function(t,e){if(BetaJS.Queries.serialize(t.query)!=BetaJS.Queries.serialize(e.query))return!1;t.options||{};var i=e.options||{};return JSON.stringify(qopts.sort||{})!=JSON.stringify(i.sort||{})?!1:"skip"in qopts?"skip"in i?qopts.skip<=i.skip?!qopts.limit||qopts.skip+qopts.limit>=i.skip:!i.limit||i.skip+i.limit>=qopts.skip:!i.limit||i.limit>=qopts.skip:!("skip"in i)||!qopts.limit||qopts.limit>=i.skip},merge:function(t,e){t.options||{};var i=e.options||{};return{query:t.query,options:{skip:"skip"in qopts?"skip"in i?Math.min(qopts.skip,i.skip):null:null,limit:"limit"in qopts?"limit"in i?Math.max(qopts.limit,i.limit):null:null,sort:t.sort}}}},BetaJS.Class.extend("BetaJS.Queries.AbstractQueryModel",{register:function(){},executable:function(){}}),BetaJS.Queries.AbstractQueryModel.extend("BetaJS.Queries.DefaultQueryModel",{constructor:function(){this._inherited(BetaJS.Queries.DefaultQueryModel,"constructor"),this.__queries={}},_insert:function(t){this.__queries[BetaJS.Queries.Constrained.serialize(t)]=t},_remove:function(t){delete this.__queries[BetaJS.Queries.Constrained.serialize(t)]},exists:function(t){return BetaJS.Queries.Constrained.serialize(t)in this.__queries},subsumizer_of:function(t){if(this.exists(t))return t;var e=null;return BetaJS.Objs.iter(this.__queries,function(i){return BetaJS.Queries.Constrained.subsumizes(i,t)&&(e=i),!e},this),e},executable:function(t){return!!this.subsumizer_of(t)},register:function(t){for(var e=!0;e;)e=!1,BetaJS.Objs.iter(this.__queries,function(i){BetaJS.Queries.Constrained.subsumizes(t,i)&&(this._remove(i),e=!0)},this);this._insert(t)},invalidate:function(t){var e=this.subsumizer_of(t);e&&this._remove(e)}}),BetaJS.Queries.DefaultQueryModel.extend("BetaJS.Queries.StoreQueryModel",{constructor:function(t){this.__store=t,this._inherited(BetaJS.Queries.StoreQueryModel,"constructor")},initialize:function(t){this.__store.query({},{},{context:this,success:function(e){for(;e.hasNext();){var i=e.next();delete i.id,this._insert(i)}BetaJS.SyncAsync.callback(t,"success")},exception:function(e){BetaJS.SyncAsync.callback(t,"exception",e)}})},_insert:function(t){this._inherited(BetaJS.Queries.StoreQueryModel,"_insert",t),this.__store.insert(t,{})},_remove:function(t){delete this.__queries[BetaJS.Queries.Constrained.serialize(t)],this.__store.query({query:t},{},{context:this,success:function(t){for(;t.hasNext();)this.__store.remove(t.next().id,{})}})}}),BetaJS.Collections.Collection.extend("BetaJS.Collections.QueryCollection",{constructor:function(t,e,i,s){this._source=t,this._inherited(BetaJS.Collections.QueryCollection,"constructor",i),this._options=BetaJS.Objs.extend({forward_steps:null,backward_steps:null,range:null},i),null!==e&&this.set_query(e,s)},query:function(){return this._query},set_query:function(t,e){e&&(e.context=e.context||this),this._query=BetaJS.Objs.extend({query:{},options:{}},t),this._query.options.skip=this._query.options.skip||0,this._query.options.limit=this._query.options.limit||null,this._query.options.sort=this._query.options.sort||{},this._count=0,this.__execute_query(this._query.options.skip,this._query.options.limit,!0,e)},__sub_query:function(t,e){this._source.query(this._query.query,t,e)},__execute_query:function(t,e,i,s){t=Math.max(t,0);var n={};this._query.options.sort&&!BetaJS.Types.is_empty(this._query.options.sort)&&(n.sort=this._query.options.sort),i?(t>0&&(n.skip=t),null!==e&&(n.limit=e),this.__sub_query(n,{context:this,success:function(i){var n=i.asArray();this._query.options.skip=t,this._query.options.limit=e,this._count=!e||e>n.length?t+n.length:null,this.clear(),this.add_objects(n),BetaJS.SyncAsync.callback(s,"success")}})):this._query.options.skip>t?(e=this._query.options.skip-t,t>0&&(n.skip=t),n.limit=e,this.__sub_query(n,{context:this,success:function(e){var i=e.asArray();this._query.options.skip=t;var n=this.add_objects(i);this._query.options.limit=null===this._query.options.limit?null:this._query.options.limit+n,BetaJS.SyncAsync.callback(s,"success")}})):t>=this._query.options.skip&&null!==this._query.options.limit&&(!e||t+e>this._query.options.skip+this._query.options.limit)&&(e=t+e-(this._query.options.skip+this._query.options.limit),t=this._query.options.skip+this._query.options.limit,t>0&&(n.skip=t),e&&(n.limit=e),this.__sub_query(n,{context:this,success:function(i){var n=i.asArray(),r=this.add_objects(n);this._query.options.limit=this._query.options.limit+r,e>n.length&&(this._count=t+r),BetaJS.SyncAsync.callback(s,"success")}}))},increase_forwards:function(t,e){t=t?t:this._options.forward_steps,t&&null!==this._query.options.limit&&this.__execute_query(this._query.options.skip+this._query.options.limit,t,!1,e)},increase_backwards:function(t){t=t?t:this._options.backward_steps,t&&this._query.options.skip>0&&(t=Math.min(t,this._query.options.skip),this.__execute_query(this._query.options.skip-t,t,!1))},paginate:function(t){this.__execute_query(this._options.range*t,this._options.range,!0)},paginate_index:function(){return this._options.range?Math.floor(this._query.options.skip/this._options.range):null},paginate_count:function(){return this._count&&this._options.range?Math.ceil(this._count/this._options.range):null},next:function(){var t=this.paginate_index();if(t){var e=this.paginate_count();(!e||this.paginate_count()-1>t)&&this.paginate(t+1)}},prev:function(){var t=this.paginate_index();t&&t>0&&this.paginate(t-1)},isComplete:function(){return null!==this._count}}),BetaJS.Collections.QueryCollection.extend("BetaJS.Collections.ActiveQueryCollection",{constructor:function(t,e,i,s){this._inherited(BetaJS.Collections.ActiveQueryCollection,"constructor",t,e,i,s),t.on("create",this.__active_create,this),t.on("remove",this.__active_remove,this),t.on("update",this.__active_update,this)},destroy:function(){this._source.off(null,null,this),this._inherited(BetaJS.Collections.ActiveQueryCollection,"destroy")},is_valid:function(t){return BetaJS.Queries.evaluate(this.query().query,t.getAll())},__active_create:function(t){this.is_valid(t)&&!this.exists(t)&&(this.add(t),this._count=this._count+1,null!==this._query.options.limit&&(this._query.options.limit=this._query.options.limit+1))},__active_remove:function(t){this.exists(t)&&(this.remove(t),this._count=this._count-1,null!==this._query.options.limit&&(this._query.options.limit=this._query.options.limit-1))},__active_update:function(t){this.is_valid(t)?this.__active_create(t):this.__active_remove(t)}}),BetaJS.Exceptions.Exception.extend("BetaJS.Stores.StoreException"),BetaJS.Class.extend("BetaJS.Stores.ListenerStore",[BetaJS.Events.EventsMixin,{constructor:function(t){this._inherited(BetaJS.Stores.ListenerStore,"constructor"),t=t||{},this._id_key=t.id_key||"id"},id_key:function(){return this._id_key},_inserted:function(t,e){this.trigger("insert",t,e)},_removed:function(t,e){this.trigger("remove",t,e)},_updated:function(t,e,i){this.trigger("update",t,e,i)}}]),BetaJS.Stores.BaseStore=BetaJS.Stores.ListenerStore.extend("BetaJS.Stores.BaseStore",[BetaJS.SyncAsync.SyncAsyncMixin,{constructor:function(t){this._inherited(BetaJS.Stores.BaseStore,"constructor",t),t=t||{},this._id_key=t.id_key||"id",this._create_ids=t.create_ids||!1,this._last_id=1,this._supportsSync=!0,this._supportsAsync=!0,this._query_model="query_model"in t?t.query_model:null},query_model:function(){return arguments.length>0&&(this._query_model=arguments[0]),this._query_model},_insert:function(){throw new BetaJS.Stores.StoreException("unsupported: insert")},_remove:function(){throw new BetaJS.Stores.StoreException("unsupported: remove")},_get:function(){throw new BetaJS.Stores.StoreException("unsupported: get")},_update:function(){throw new BetaJS.Stores.StoreException("unsupported: update")},_query_capabilities:function(){return{}},_query:function(){throw new BetaJS.Stores.StoreException("unsupported: query")},insert:function(t,e){var i=null;if(BetaJS.Types.is_array(t)&&(i=t[1],t=t[0]),this._create_ids&&!(this._id_key in t&&t[this._id_key])){for(;this.get(this._last_id);)this._last_id++;t[this._id_key]=this._last_id}return this.then(this._insert,[t],e,function(t,e){this._inserted(t,i),BetaJS.SyncAsync.callback(e,"success",t)})},insert_all:function(t,e,i){var s=null;if(arguments.length>3&&(s=arguments[3]),i&&this._query_model&&(this.trigger("query_register",i),this._query_model.register(i)),e){var n=this,r=function(i){return i>=t.length?(BetaJS.SyncAsync.callback(e,"success"),void 0):(this.insert(s?[t[i],s]:t[i],BetaJS.SyncAsync.mapSuccess(e,function(){r.call(n,i+1)})),void 0)};r.call(this,0)}else for(var o=0;t.length>o;++o)this.insert(s?[t[o],s]:t[o])},remove:function(t,e){var i=null;return BetaJS.Types.is_array(t)&&(i=t[1],t=t[0]),this.then(this._remove,[t],e,function(e,s){this._removed(t,i),BetaJS.SyncAsync.callback(s,"success",t)})},get:function(t,e){return this.delegate(this._get,[t],e)},update:function(t,e,i){var s=null;return BetaJS.Types.is_array(e)&&(s=e[1],e=e[0]),this.then(this._update,[t,e],i,function(t,i){this._updated(t,e,s),BetaJS.SyncAsync.callback(i,"success",t,e)})},query:function(t,e,i){if(e&&(e.limit&&(e.limit=parseInt(e.limit,10)),e.skip&&(e.skip=parseInt(e.skip,10))),this._query_model){var s=this._query_model.subsumizer_of({query:t,options:e});if(!s){this.trigger("query_miss",{query:t,options:e});var n=new BetaJS.Stores.StoreException("Cannot execute query");if(!i)throw n;return BetaJS.SyncAsync.callback(i,"exception",n),null}this.trigger("query_hit",{query:t,options:e},s)}var r=function(i){return BetaJS.Queries.Constrained.emulate(BetaJS.Queries.Constrained.make(t,e||{}),this._query_capabilities(),this._query,this,i)};return this.either(i,r,r)},_query_applies_to_id:function(t,e){var i=this.get(e);return i&&BetaJS.Queries.overloaded_evaluate(t,i)},clear:function(t){return this.then(this.query,[{},{}],t,function(t,e){for(var i=[];t.hasNext();)i.push(this.remove,[t.next().id]);return this.join(i,e)})},_ensure_index:function(){},ensure_index:function(t){this._ensure_index(t)},perform:function(t,e){var i=BetaJS.Objs.keyByIndex(t),s=BetaJS.Objs.valueByIndex(t);if("insert"==i)this.insert(s,e);else if("remove"==i)this.remove(s,e);else{if("update"!=i)throw new BetaJS.Stores.StoreException("unsupported: perform "+i);this.update(BetaJS.Objs.keyByIndex(s),BetaJS.Objs.valueByIndex(s),e)}},bulk:function(t,e,i){var s=[];if(i){var n=function(){s.length<t.length?this.perform(t[s.length],{context:this,success:function(){s.push(!0),n.apply(this)},exception:function(t){s.push(!1),e?n.apply(this):i.exception.apply(i.context||this,t)}}):i.success.call(i.context||this,s)};n.apply(this)}else for(var r=0;t.length>r;++r)try{this.perform(t[r]),s.push(!0)}catch(o){if(s.push(!1),!e)throw o}return s}}]),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.AssocStore",{_read_key:function(){},_write_key:function(){},_remove_key:function(){},_iterate:function(){},constructor:function(t){t=t||{},t.create_ids=!0,this._inherited(BetaJS.Stores.AssocStore,"constructor",t),this._supportsAsync=!1},_insert:function(t){return this._write_key(t[this._id_key],t),t},_remove:function(t){var e=this._read_key(t);return e&&!this._remove_key(t)?null:e},_get:function(t){return this._read_key(t)},_update:function(t,e){var i=this._get(t);return i&&(this._id_key in e&&(this._remove_key(t),t=e[this._id_key],delete e[this._id_key]),BetaJS.Objs.extend(i,e),this._write_key(t,i)),i},_query:function(){return this._iterate()}}),BetaJS.Stores.AssocStore.extend("BetaJS.Stores.MemoryStore",{constructor:function(t){this._inherited(BetaJS.Stores.MemoryStore,"constructor",t),this.__data={}},_read_key:function(t){return this.__data[t]},_write_key:function(t,e){this.__data[t]=e},_remove_key:function(t){delete this.__data[t]},_iterate:function(){return new BetaJS.Iterators.ObjectValuesIterator(this.__data)}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.DumbStore",{_read_last_id:function(){},_write_last_id:function(){},_remove_last_id:function(){},_read_first_id:function(){},_write_first_id:function(){},_remove_first_id:function(){},_read_item:function(){},_write_item:function(){},_remove_item:function(){},_read_next_id:function(){},_write_next_id:function(){},_remove_next_id:function(){},_read_prev_id:function(){},_write_prev_id:function(){},_remove_prev_id:function(){},constructor:function(t){t=t||{},t.create_ids=!0,this._inherited(BetaJS.Stores.DumbStore,"constructor",t),this._supportsAsync=!1},_insert:function(t){var e=this._read_last_id(),i=t[this._id_key];return null!==e?(this._write_next_id(e,i),this._write_prev_id(i,e)):this._write_first_id(i),this._write_last_id(i),this._write_item(i,t),t},_remove:function(t){var e=this._read_item(t);if(e){this._remove_item(t);var i=this._read_next_id(t),s=this._read_prev_id(t);null!==i?(this._remove_next_id(t),null!==s?(this._remove_prev_id(t),this._write_next_id(s,i),this._write_prev_id(i,s)):(this._remove_prev_id(i),this._write_first_id(i))):null!==s?(this._remove_next_id(s),this._write_last_id(s)):(this._remove_first_id(),this._remove_last_id())}return e},_get:function(t){return this._read_item(t)},_update:function(t,e){var i=this._get(t);return i&&(delete e[this._id_key],BetaJS.Objs.extend(i,e),this._write_item(t,i)),i},_query_capabilities:function(){return{query:!0}},_query:function(t){var e=new BetaJS.Iterators.Iterator,i=this,s=this._read_first_id();return BetaJS.Objs.extend(e,{__id:null===s?1:s,__store:i,__query:t,hasNext:function(){var e=this.__store._read_last_id();if(null===e)return!1;for(;e>this.__id&&!this.__store._read_item(this.__id);)this.__id++;for(;e>=this.__id;){if(this.__store._query_applies_to_id(t,this.__id))return!0;e>this.__id?this.__id=this.__store._read_next_id(this.__id):this.__id++}return!1},next:function(){if(this.hasNext()){var t=this.__store.get(this.__id);return this.__id==this.__store._read_last_id()?this.__id++:this.__id=this.__store._read_next_id(this.__id),t}return null}}),e}}),BetaJS.Stores.DumbStore.extend("BetaJS.Stores.AssocDumbStore",{_read_key:function(){},_write_key:function(){},_remove_key:function(){},__read_id:function(t){var e=this._read_key(t);return e?parseInt(e,10):null},_read_last_id:function(){return this.__read_id("last_id")},_write_last_id:function(t){this._write_key("last_id",t)},_remove_last_id:function(){this._remove_key("last_id")},_read_first_id:function(){return this.__read_id("first_id")},_write_first_id:function(t){this._write_key("first_id",t)},_remove_first_id:function(){this._remove_key("first_id")},_read_item:function(t){return this._read_key("item_"+t)},_write_item:function(t,e){this._write_key("item_"+t,e)},_remove_item:function(t){this._remove_key("item_"+t)},_read_next_id:function(t){return this.__read_id("next_"+t)},_write_next_id:function(t,e){this._write_key("next_"+t,e)},_remove_next_id:function(t){this._remove_key("next_"+t)},_read_prev_id:function(t){return this.__read_id("prev_"+t)},_write_prev_id:function(t,e){this._write_key("prev_"+t,e)},_remove_prev_id:function(t){this._remove_key("prev_"+t)}}),BetaJS.Stores.AssocDumbStore.extend("BetaJS.Stores.LocalStore",{constructor:function(t){this._inherited(BetaJS.Stores.LocalStore,"constructor",t),this.__prefix=t.prefix},__key:function(t){return this.__prefix+t},_read_key:function(t){var e=this.__key(t);return e in localStorage?JSON.parse(localStorage[e]):null},_write_key:function(t,e){localStorage[this.__key(t)]=JSON.stringify(e)},_remove_key:function(t){delete localStorage[this.__key(t)]}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.DualStore",{constructor:function(t,e,i){i=BetaJS.Objs.extend({create_options:{},update_options:{},delete_options:{},get_options:{},query_options:{}},i||{}),i.id_key=t._id_key,this.__first=t,this.__second=e,this._inherited(BetaJS.Stores.DualStore,"constructor",i),this._supportsSync=t.supportsSync()&&e.supportsSync(),this._supportsAsync=t.supportsAsync()||e.supportsAsync(),this.__create_options=BetaJS.Objs.extend({start:"first",strategy:"then",auto_replicate:"first"},i.create_options),this.__update_options=BetaJS.Objs.extend({start:"first",strategy:"then",auto_replicate:"first"},i.update_options),this.__remove_options=BetaJS.Objs.extend({start:"first",strategy:"then",auto_replicate:"first"},i.delete_options),this.__get_options=BetaJS.Objs.extend({start:"first",strategy:"or",clone:!0,clone_second:!1,or_on_null:!0},i.get_options),this.__query_options=BetaJS.Objs.extend({start:"first",strategy:"or",clone:!0,clone_second:!1,or_on_null:!0},i.query_options),this.__first.on("insert",this.__inserted_first,this),this.__second.on("insert",this.__inserted_second,this),this.__first.on("update",this.__updated_first,this),this.__second.on("update",this.__updated_second,this),this.__first.on("remove",this.__removed_first,this),this.__second.on("remove",this.__removed_second,this)},__inserted_first:function(t,e){e&&e.dual_insert||(("first"==this.__create_options.auto_replicate||"both"==this.__create_options.auto_replicate)&&this.__second.insert([t,{dual_insert:!0}],{}),this._inserted(t))},__inserted_second:function(t,e){e&&e.dual_insert||(("second"==this.__create_options.auto_replicate||"both"==this.__create_options.auto_replicate)&&this.__first.insert([t,{dual_insert:!0}],{}),this._inserted(t))},__updated_first:function(t,e,i){i&&i.dual_update||(("first"==this.__update_options.auto_replicate||"both"==this.__update_options.auto_replicate)&&this.__second.update(t[this.id_key()],[e,{dual_update:!0}],{}),this._updated(t,e))},__updated_second:function(t,e,i){i&&i.dual_update||(("second"==this.__update_options.auto_replicate||"both"==this.__update_options.auto_replicate)&&this.__first.update(t[this.id_key()],[e,{dual_update:!0}],{}),this._updated(t,e))},__removed_first:function(t,e){e&&e.dual_remove||(("first"==this.__remove_options.auto_replicate||"both"==this.__remove_options.auto_replicate)&&this.__second.remove([t,{dual_remove:!0}],{}),this._removed(t))},__removed_second:function(t,e){e&&e.dual_remove||(("second"==this.__remove_options.auto_replicate||"both"==this.__remove_options.auto_replicate)&&this.__first.remove([t,{dual_remove:!0}],{}),this._removed(t))},first:function(){return this.__first},second:function(){return this.__second},_insert:function(t,e){var i=this.__first,s=this.__second;"first"!=this.__create_options.start&&(i=this.__second,s=this.__first);var n=this.__create_options.strategy;if(e)if("then"==n)i.insert([t,{dual_insert:!0}],{success:function(t){s.insert([t,{dual_insert:!0}],e)},exception:e.exception});else{if("or"==n)return i.insert([t,{dual_insert:!0}],{success:e.success,exception:function(){s.insert([t,{dual_insert:!0}],e)}});i.insert([t,{dual_insert:!0}],e)}else{if("then"==n)return s.insert([i.insert([t,{dual_insert:!0}]),{dual_insert:!0}]);if("or"!=n)return i.insert([t,{dual_insert:!0}]);try{return i.insert([t,{dual_insert:!0}])}catch(r){return s.insert([t,{dual_insert:!0}])}}return!0},_update:function(t,e,i){var s=this.__first,n=this.__second;"first"!=this.__update_options.start&&(s=this.__second,n=this.__first);var r=this.__update_options.strategy;if(i)if("then"==r)s.update(t,[e,{dual_update:!0}],{success:function(e){n.update(t,[e,{dual_update:!0}],i)},exception:i.exception});else{if("or"==r)return s.update(t,[e,{dual_update:!0}],{success:i.success,exception:function(){n.update(t,[e,{dual_update:!0}],i)}});s.update(t,[e,{dual_update:!0}],i)}else{if("then"==r)return n.update(t,[s.update(t,[e,{dual_update:!0}]),{dual_update:!0}]);if("or"!=r)return s.update(t,[e,{dual_update:!0}]);try{return s.update(t,[e,{dual_update:!0}])}catch(o){return n.update(t,[e,{dual_update:!0}])}}return!0},_remove:function(t,e){var i=this.__first,s=this.__second;"first"!=this.__remove_options.start&&(i=this.__second,s=this.__first);var n=this.__remove_options.strategy;if(e)"then"==n?i.remove([t,{dual_remove:!0}],{success:function(){s.remove([t,{dual_remove:!0}],e)},exception:e.exception}):"or"==n?i.remove([t,{dual_remove:!0}],{success:e.success,exception:function(){s.remove([t,{dual_remove:!0}],e)}}):i.remove(t,e);else if("then"==n)i.remove([t,{dual_remove:!0}]),s.remove([t,{dual_remove:!0}]);else if("or"==n)try{i.remove([t,{dual_remove:!0}])}catch(r){s.remove([t,{dual_remove:!0}])}else i.remove([t,{dual_remove:!0}])},_query_capabilities:function(){return{query:!0,sort:!0,limit:!0,skip:!0}},_get:function(t,e){var i=this.__first,s=this.__second;"first"!=this.__get_options.start&&(i=this.__second,s=this.__first);var n=this.__get_options.strategy,r=this.__get_options.clone,o=this.__get_options.clone_second,_=this.__get_options.or_on_null;if("or"==n){var a=function(e){s.get(t,BetaJS.SyncAsync.mapSuccess(e,function(t){t&&r?i.delegate(i.insert,[t],e):this.callback(e,"success",t)}))};return i.then(i.get,[t],e,function(e,i){return!e&&_?(a(i),void 0):(o?s.get(t,{success:function(t){t?this.callback(i,"success",e):s.insert(e,i)},exception:function(){s.insert(e,i)}}):this.callback(i,"success",e),void 0)},function(t,e){a(e)})}return i.get(t,e)},_query:function(t,e,i){var s=this.__first,n=this.__second;"first"!=this.__query_options.start&&(s=this.__second,n=this.__first);var r=this.__query_options.strategy,o=this.__query_options.clone,_=this.__get_options.clone_second,a=this.__query_options.or_on_null,c=null;if("or"==r){var u=function(i){return this.trigger("query_second",t,e),n.query(t,e,BetaJS.SyncAsync.mapSuccess(i,function(n){if(n&&o){arr=n.asArray(),n=new BetaJS.Iterators.ArrayIterator(arr);var r=BetaJS.SyncAsync.mapSuccess(i,function(){BetaJS.SyncAsync.callback(i,"success",n)});s.insert_all(arr,r,{query:t,options:e},{dual_insert:!0})}else BetaJS.SyncAsync.callback(i,"success",n)})),c},h=function(i,s){arr=i.asArray(),i=new BetaJS.Iterators.ArrayIterator(arr);var r=BetaJS.SyncAsync.mapSuccess(s,function(){BetaJS.SyncAsync.callback(s,"success",i)});n.insert_all(arr,r,{query:t,options:e},{dual_insert:!0})};return this.trigger("query_first",t,e),this.then(s,s.query,[t,e],i,function(i,s){return!i&&a?(u.call(this,s),void 0):(_?(this.trigger("query_second",t,e),n.query(t,e,{success:function(t){t?this.callback(s,"success",i):h(i,s)},exception:function(){h(i,s)}})):this.callback(s,"success",i),void 0)},function(t,e){u.call(this,e)})}return this.trigger("query_first",t,e),s.query(t,e,i)}}),BetaJS.Stores.DualStore.extend("BetaJS.Stores.CachedStore",{constructor:function(t,e){e=e||{};var i=e.cache_store;"cache_store"in e||(i=this._auto_destroy(new BetaJS.Stores.MemoryStore({id_key:t.id_key()}))),i.query_model()||i.query_model(e.cache_query_model?e.cache_query_model:this._auto_destroy(new BetaJS.Queries.DefaultQueryModel)),this.__invalidation_options=e.invalidation||{},this._inherited(BetaJS.Stores.CachedStore,"constructor",t,i,BetaJS.Objs.extend({get_options:{start:"second",strategy:"or"},query_options:{start:"second",strategy:"or",clone:!0,or_on_null:!1}},e)),this.__invalidation_options.reload_after_first_hit&&(this.__queries={},this.cache().on("query_hit",function(t,e){var i=BetaJS.Queries.Constrained.serialize(e);this.__queries[i]||(this.__queries[i]=!0,BetaJS.SyncAsync.eventually(function(){this.invalidate_query(e,!0)},[],this))},this),this.cache().on("query_miss",function(t){var e=BetaJS.Queries.Constrained.serialize(t);this.__queries[e]=!0},this))},destroy:function(){this.cache().off(null,null,this),this._inherited(BetaJS.Stores.CachedStore,"destroy")},invalidate_query:function(t,e){this.cache().query_model().invalidate(t),e&&(this.supportsAsync()?this.query(t.query,t.options,{}):this.query(t.query,t.options)),this.trigger("invalidate_query",t,e)},cache:function(){return this.second()},store:function(){return this.first()}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.ConversionStore",{constructor:function(t,e){e=e||{},e.id_key=t._id_key,this._inherited(BetaJS.Stores.ConversionStore,"constructor",e),this.__store=t,this.__key_encoding=e.key_encoding||{},this.__key_decoding=e.key_decoding||{},this.__value_encoding=e.value_encoding||{},this.__value_decoding=e.value_decoding||{}},encode_object:function(t){var e={};for(var i in t){var s=this.encode_key(i);s&&(e[s]=this.encode_value(i,t[i]))}return e},decode_object:function(t){var e={};for(var i in t){var s=this.decode_key(i);s&&(e[s]=this.decode_value(i,t[i]))}return e},encode_key:function(t){return t in this.__key_encoding?this.__key_encoding[t]:t},decode_key:function(t){return t in this.__key_decoding?this.__key_decoding[t]:t},encode_value:function(t,e){return t in this.__value_encoding?this.__value_encoding[t](e):e},decode_value:function(t,e){return t in this.__value_decoding?this.__value_decoding[t](e):e},_query_capabilities:function(){return this.__store._query_capabilities()},_ensure_index:function(t){return this.__store.ensure_index(t)},_insert:function(t,e){return this.then(this.__store,this.__store.insert,[this.encode_object(t)],e,function(t,e){e.success(this.decode_object(t))})},_remove:function(t,e){return this.delegate(this.__store,this.__store.remove,[this.encode_value(this._id_key,t)],e)},_get:function(t,e){return this.then(this.__store,this.__store.get,[this.encode_value(this._id_key,t)],e,function(t,e){e.success(this.decode_object(t))})},_update:function(t,e,i){return this.then(this.__store,this.__store.update,[this.encode_value(this._id_key,t),this.encode_object(e)],i,function(t,e){e.success(this.decode_object(t))})},_query:function(t,e,i){return this.then(this.__store,this.__store.query,[this.encode_object(t),e],i,function(t,e){var i=new BetaJS.Iterators.MappedIterator(t,function(t){return this.decode_object(t)},this);e.success(i)})}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.PassthroughStore",{constructor:function(t,e){this.__store=t,e=e||{},e.id_key=t.id_key(),this._projection=e.projection||{},this._inherited(BetaJS.Stores.PassthroughStore,"constructor",e),this._supportsAsync=t.supportsAsync(),this._supportsSync=t.supportsSync(),e.destroy_store&&this._auto_destroy(t)},_query_capabilities:function(){return this.__store._query_capabilities()},_insert:function(t,e){return this.__store.insert(BetaJS.Objs.extend(t,this._projection),e)},_remove:function(t,e){return this.__store.remove(t,e)},_get:function(t,e){return this.__store.get(t,e)},_update:function(t,e,i){return this.__store.update(t,e,i)},_query:function(t,e,i){return this.__store.query(BetaJS.Objs.extend(t,this._projection),e,i)},_ensure_index:function(t){return this.__store.ensure_index(t)},_store:function(){return this.__store}}),BetaJS.Stores.PassthroughStore.extend("BetaJS.Stores.ActiveStore",{constructor:function(t,e,i){this._inherited(BetaJS.Stores.ActiveStore,"constructor",t,i),this.__listener=e,this.delegateEvents(null,e)}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.SocketStore",{constructor:function(t,e,i){this._inherited(BetaJS.Stores.SocketStore,"constructor",t),this.__socket=e,this.__prefix=i,this._supportsAsync=!1},__send:function(t,e){this.__socket.emit(this.__prefix+":"+t,e)},_insert:function(t){this.__send("insert",t)},_remove:function(t){this.__send("remove",t)},_update:function(t,e){this.__send("update",BetaJS.Objs.objectBy(t,e))},bulk:function(t){this.__send("bulk",t)}}),BetaJS.Stores.ListenerStore.extend("BetaJS.Stores.SocketListenerStore",{constructor:function(t,e,i){this._inherited(BetaJS.Stores.SocketListenerStore,"constructor",t);var s=this;this.__prefix=i,e.on(this.__prefix+":insert",function(t){s._perform("insert",t)}),e.on(this.__prefix+":remove",function(t){s._perform("remove",t)}),e.on(this.__prefix+":update",function(t){s._perform("update",t)}),e.on(this.__prefix+":bulk",function(t){for(var e=0;t.length>e;++e)s._perform(BetaJS.Objs.keyByIndex(t[e]),BetaJS.Objs.valueByIndex(t[e]))})},_perform:function(t,e){if("insert"==t)this._inserted(e);
else if("remove"==t)this._removed(e);else{if("update"!=t)throw new BetaJS.Stores.StoreException("unsupported: perform "+t);this._updated(BetaJS.Objs.objectBy(this.id_key(),BetaJS.Objs.keyByIndex(e)),BetaJS.Objs.valueByIndex(e))}}}),BetaJS.Stores.StoreException.extend("BetaJS.Stores.RemoteStoreException",{constructor:function(t){t=BetaJS.Net.AjaxException.ensure(t),this._inherited(BetaJS.Stores.RemoteStoreException,"constructor",""+t),this.__source=t},source:function(){return this.__source}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.RemoteStore",{constructor:function(t,e,i){this._inherited(BetaJS.Stores.RemoteStore,"constructor",i),this._uri=t,this.__ajax=e,this.__options=BetaJS.Objs.extend({update_method:"PUT",uri_mappings:{},bulk_method:"POST",supports_bulk:!1},i||{})},getUri:function(){return this._uri},prepare_uri:function(t,e){return this.__options.uri_mappings[t]?this.__options.uri_mappings[t](e):"remove"==t||"get"==t||"update"==t?this.getUri()+"/"+e[this._id_key]:this.getUri()},_encode_query:function(){return{uri:this.prepare_uri("query")}},__invoke:function(t,e,i){if(e)return this.__ajax.asyncCall(t,{success:function(t){if(i&&BetaJS.Types.is_string(t))try{t=JSON.parse(t)}catch(s){}BetaJS.SyncAsync.callback(e,"success",t)},exception:function(t){BetaJS.SyncAsync.callback(e,"exception",new BetaJS.Stores.RemoteStoreException(t))}});try{var s=this.__ajax.syncCall(t);if(i&&BetaJS.Types.is_string(s))try{return JSON.parse(s)}catch(n){}return s}catch(n){throw new BetaJS.Stores.RemoteStoreException(n)}return!1},_insert:function(t,e){return this.__invoke({method:"POST",uri:this.prepare_uri("insert",t),data:t},e,!0)},_get:function(t,e){var i={};return i[this._id_key]=t,this.__invoke({uri:this.prepare_uri("get",i)},e)},_update:function(t,e,i){var s=BetaJS.Objs.clone(e,1);return s[this._id_key]=t,this.__invoke({method:this.__options.update_method,uri:this.prepare_uri("update",s),data:e},i)},_remove:function(t,e){var i={};return i[this._id_key]=t,this.__invoke({method:"DELETE",uri:this.prepare_uri("remove",i)},e)},_query:function(t,e,i){return this.__invoke(this._encode_query(t,e),i,!0)},bulk:function(t,e){return this.__options.supports_bulk?this.__invoke({method:this.__options.bulk_method,uri:this.prepare_uri("bulk"),data:t}):this._inherited(BetaJS.Stores.RemoteStore,"bulk",t,e)}}),BetaJS.Stores.RemoteStore.extend("BetaJS.Stores.QueryGetParamsRemoteStore",{constructor:function(t,e,i,s){this._inherited(BetaJS.Stores.QueryGetParamsRemoteStore,"constructor",t,e,s),this.__capability_params=i},_query_capabilities:function(){var t={};return"skip"in this.__capability_params&&(t.skip=!0),"limit"in this.__capability_params&&(t.limit=!0),"query"in this.__capability_params&&(t.query=!0),"sort"in this.__capability_params&&(t.sort=!0),t},_encode_query:function(t,e){e=e||{};var i=this.getUri()+"?";return e.skip&&"skip"in this.__capability_params&&(i+=this.__capability_params.skip+"="+e.skip+"&"),e.limit&&"limit"in this.__capability_params&&(i+=this.__capability_params.limit+"="+e.limit+"&"),e.sort&&"sort"in this.__capability_params&&(i+=this.__capability_params.sort+"="+JSON.stringify(e.sort)+"&"),"query"in this.__capability_params&&(i+=this.__capability_params.query+"="+JSON.stringify(t)+"&"),{uri:i}}}),BetaJS.Class.extend("BetaJS.Stores.StoresMonitor",[BetaJS.Events.EventsMixin,{attach:function(t,e){e.on("insert",function(i){this.trigger("insert",t,e,i),this.trigger("write","insert",t,e,i)},this),e.on("remove",function(i){this.trigger("remove",t,e,i),this.trigger("write","remove",t,e,i)},this),e.on("update",function(i,s){this.trigger("update",t,e,i,s),this.trigger("write","update",t,e,i,s)},this)}}]),BetaJS.Class.extend("BetaJS.Stores.StoreHistory",[BetaJS.Events.EventsMixin,{constructor:function(t,e){this._inherited(BetaJS.Stores.StoreHistory,"constructor"),e=e||{},this._combine_update_update=e.combine_update_update||!1,this._combine_insert_update=e.combine_insert_update||!1,this._combine_insert_remove=e.combine_insert_remove||!1,this._combine_update_remove=e.combine_update_remove||!1,this._commits={},this._revision_id=null,this._store=t,this._item_commits={},this._store.on("insert",function(t){this.__add_commit({action:"insert",id:t[this._store.id_key()],data:t})},this),this._store.on("remove",function(t){this.__add_commit({action:"remove",id:t})},this),this._store.on("update",function(t,e){this.__add_commit({action:"update",id:t,data:e})},this)},__remove_commit:function(t){this.trigger("remove",this._commits[t]);var e=this._commits[t].id;delete this._commits[t],delete this._item_commits[e],BetaJS.Objs.is_empty(this._item_commits[e])&&delete this._item_commits[e]},__add_commit:function(t){t.revision_id=this._new_revision_id();var e=!1,i=!1,s=null;for(var n in this._item_commits[t.id]){var r=this._commits[n];e=e||"insert"==r.action,i=i||"update"==r.action,s=n}if(this._revision_id=t.revision_id,this._commits[this._revision_id]=t,this._item_commits[t.id]=this._item_commits[t.id]||{},this._item_commits[t.id][t.revision_id]=!0,this.trigger("commit",t),"update"==t.action)(this._combine_insert_update&&!i&&e||this._combine_update_update&&i)&&(this.__remove_commit(t.revision_id),this._commits[s].data=BetaJS.Objs.extend(this._commits[s].data,t.data));else if("remove"==t.action)for(n in this._item_commits[t.id])r=this._commits[n],(e&&this._combine_insert_remove||"update"==r.action&&this._combine_update_remove)&&this.__remove_commit(n)},flush:function(t){t=t||this._revision_id;for(var e in this._commits){if(e>t)break;this.__remove_commit(e)}},serialize:function(t){var e=this._commits[t];return"insert"==commin.action?{insert:e.data}:"remove"==e.action?{remove:e.id}:"update"==e?{update:BetaJS.Objs.objectBy(e.id,e.data)}:null},serialize_bulk:function(t){t=t||this._revision_id;var e=[];for(var i in this._commits){if(i>t)break;e.push(this.serialize(i))}return e},revision_id:function(){return this._revision_id},_new_revision_id:function(){return this.cls.__revision_id+1}}],{__revision_id:0}),BetaJS.Exceptions.Exception.extend("BetaJS.Modelling.ModelException",{constructor:function(t,e){this._inherited(BetaJS.Modelling.ModelException,"constructor",e),this.__model=t},model:function(){return this.__model}}),BetaJS.Modelling.ModelException.extend("BetaJS.Modelling.ModelMissingIdException",{constructor:function(t){this._inherited(BetaJS.Modelling.ModelMissingIdException,"constructor",t,"No id given.")}}),BetaJS.Modelling.ModelException.extend("BetaJS.Modelling.ModelInvalidException",{constructor:function(t){var e=BetaJS.Objs.values(t.errors()).join("\n");this._inherited(BetaJS.Modelling.ModelInvalidException,"constructor",t,e)}}),BetaJS.Properties.Properties.extend("BetaJS.Modelling.SchemedProperties",{constructor:function(t,e){this._inherited(BetaJS.Modelling.SchemedProperties,"constructor");var i=this.cls.scheme();this._properties_changed={},this.__errors={},this.__unvalidated={};for(var s in i)"def"in i[s]?this.set(s,i[s].def):i[s].auto_create?this.set(s,i[s].auto_create(this)):this.set(s,null);e=e||{},this._properties_changed={},this.__errors={};for(s in t)this.set(s,t[s])},_unsetChanged:function(t){delete this._properties_changed[t]},_beforeSet:function(t,e){var i=this.cls.scheme();if(!(t in i))return e;var s=i[t];return"boolean"==s.type?BetaJS.Types.parseBool(e):(s.transform&&(e=s.transform.apply(this,[e])),e)},_afterSet:function(t,e){var i=this.cls.scheme();if(t in i&&(this._properties_changed[t]=e,this.__unvalidated[t]=!0,delete this.__errors[t],i[t].after_set)){var s=BetaJS.Types.is_string(i[t].after_set)?this[i[t].after_set]:i[t].after_set;s.apply(this,[e])}},properties_changed:function(t){return BetaJS.Types.is_boolean(t)?BetaJS.Objs.filter(this._properties_changed,function(e,i){return this.validateAttr(i)==t},this):this._properties_changed},get_all_properties:function(){var t={},e=this.cls.scheme();for(var i in e)t[i]=this.get(i);return t},properties_by:function(t){return BetaJS.Types.is_boolean(t)?BetaJS.Objs.filter(this.get_all_properties(),function(e,i){return this.validateAttr(i)==t},this):this.get_all_properties()},validate:function(){this.trigger("validate");for(var t in this.__unvalidated)this.validateAttr(t);return this._customValidate(),BetaJS.Types.is_empty(this.__errors)},_customValidate:function(){},validateAttr:function(t){if(t in this.__unvalidated){delete this.__unvalidated[t],delete this.__errors[t];var e=this.cls.scheme(),i=e[t];if("validate"in i){var s=i.validate;BetaJS.Types.is_array(s)||(s=[s]);var n=this.get(t);BetaJS.Objs.iter(s,function(e){var i=e.validate(n,this);return i&&(this.__errors[t]=i),null===i},this)}this.trigger("validate:"+t,!(t in this.__errors),this.__errors[t])}return!(t in this.__errors)},setError:function(t,e){delete this.__unvalidated[t],this.__errors[t]=e,this.trigger("validate:"+t,!(t in this.__errors),this.__errors[t])},revalidate:function(){return this.__errors={},this.__unvalidated=this.keys(!0),this.validate()},errors:function(){return this.__errors},getError:function(t){return this.__errors[t]},asRecord:function(t){var e={},i=this.cls.scheme(),s=this.get_all_properties();t=t||{};for(var n in s)if(n in i){var r=i[n].tags||[],o={};BetaJS.Objs.iter(r,function(t){o[t]=!0});var _=!0;BetaJS.Objs.iter(t,function(t){_=_&&t in o},this),_&&(e[n]=s[n])}return e},setByTags:function(t,e){var i=this.cls.scheme();e=e||{};for(var s in t)if(s in i){var n=i[s].tags||[],r={};BetaJS.Objs.iter(n,function(t){r[t]=!0});var o=!0;BetaJS.Objs.iter(e,function(t){o=o&&t in r},this),o&&this.set(s,t[s])}},validation_exception_conversion:function(t){var e=t;if(t.instance_of(BetaJS.Stores.RemoteStoreException))e=t.source();else if(!("status_code"in e&&"data"in e))return t;return e.status_code()==BetaJS.Net.HttpHeader.HTTP_STATUS_PRECONDITION_FAILED&&e.data()&&(BetaJS.Objs.iter(e.data(),function(t,e){this.setError(e,t)},this),t=new BetaJS.Modelling.ModelInvalidException(model)),t}},{_initializeScheme:function(){return{}},asRecords:function(t,e){return t.map(function(t){return t.asRecord(e)})},filterPersistent:function(t){var e={},i=this.scheme();for(var s in t)(!BetaJS.Types.is_defined(i[s].persistent)||i[s].persistent)&&(e[s]=t[s]);return e}},{scheme:function(){return this.__scheme=this.__scheme||this._initializeScheme(),this.__scheme}}),BetaJS.Modelling.SchemedProperties.extend("BetaJS.Modelling.AssociatedProperties",{constructor:function(t,e){this._inherited(BetaJS.Modelling.AssociatedProperties,"constructor",t,e),this.assocs=this._initializeAssociations();for(var i in this.assocs)this.__addAssoc(i,this.assocs[i]);this.on("change:"+this.cls.primary_key(),function(t,e){this._change_id(t,e),this.trigger("change_id",t,e)},this)},_change_id:function(){},__addAssoc:function(t,e){this[t]=function(){return e.yield()}},_initializeAssociations:function(){return{}},destroy:function(){for(var t in this.assocs)this.assocs[t].destroy();this._inherited(BetaJS.Modelling.AssociatedProperties,"destroy")},id:function(){return this.get(this.cls.primary_key())},hasId:function(){return this.has(this.cls.primary_key())}},{primary_key:function(){return"id"},_initializeScheme:function(){var t=this._inherited(BetaJS.Modelling.AssociatedProperties,"_initializeScheme");return t[this.primary_key()]={type:"id"},t}}),BetaJS.Modelling.AssociatedProperties.extend("BetaJS.Modelling.Model",[BetaJS.SyncAsync.SyncAsyncMixin,{constructor:function(t,e){e=e||{},this._inherited(BetaJS.Modelling.Model,"constructor",t,e),this.__saved="saved"in e?e.saved:!1,this.__new="new"in e?e["new"]:!0,this.__removed=!1,this.__saved&&(this._properties_changed={}),this.__table=e.table||this.cls.defaultTable(),this.__table._model_register(this),this.__destroying=!1,this._supportsAsync=this.__table.supportsAsync(),this._supportsSync=this.__table.supportsSync()},destroy:function(){!this.__destroying&&this.__table&&(this.__destroying=!0,this.__table._model_unregister(this),this.trigger("destroy"),this._inherited(BetaJS.Modelling.Model,"destroy"))},isSaved:function(){return this.__saved},isNew:function(){return this.__new},isRemoved:function(){return this.__removed},update:function(t,e,i){this.setAll(t,{silent:!0}),this.save(i)},_afterSet:function(t,e,i,s){this._inherited(BetaJS.Modelling.Model,"_afterSet",t,e,i,s);var n=this.cls.scheme();t in n&&(s&&s.no_change?this._unsetChanged(t):this.__saved=!1,s&&s.silent||this.__table&&this.__table._model_set_value(this,t,e,s))},_after_create:function(){},_before_create:function(){},save:function(t){return this.__new&&this._before_create(),this.then(this.__table,this.__table._model_save,[this],t,function(t,e){this.trigger("save"),this.__saved=!0;var i=this.__new;this.__new=!1,i&&this._after_create(),this.callback(e,"success",t)})},remove:function(t){return this.then(this.__table,this.__table._model_remove,[this],t,function(t,e){this.trigger("remove"),this.__removed=!0,this.callback(e,"success",t)})},table:function(){return this.__table}}],{defaultTable:function(){return this.table||(this.table=new BetaJS.Modelling.Table(new BetaJS.Stores.MemoryStore,this)),this.table}}),BetaJS.Class.extend("BetaJS.Modelling.Table",[BetaJS.Events.EventsMixin,BetaJS.SyncAsync.SyncAsyncMixin,{constructor:function(t,e,i){this._inherited(BetaJS.Modelling.Table,"constructor"),this.__store=t,this.__model_type=e,this.__models_by_id={},this.__models_changed={},this.__options=BetaJS.Objs.extend({model_cache_size:null,type_column:null,auto_create:!1,store_validation_conversion:!0,auto_update:!0,auto_materialize:!1},i||{}),this.__models_by_cid=new BetaJS.Classes.ObjectCache({size:this.__options.model_cache_size}),this._auto_destroy(this.__models_by_cid),this.__models_by_cid.on("release",function(t){t.hasId()&&delete this.__models_by_id[t.id()]},this),this.__options.auto_materialize&&this.__store.on("insert",function(t,e){if(!(this.__models_by_id[t[this.primary_key()]]||e&&e.model_create)){var i=this.__materialize(t);this.trigger("create",i)}},this),this.__store.on("update",function(t,e,i){if(!(!this.__models_by_id[t[this.primary_key()]]||i&&i.model_update)){var s=this.__models_by_id[t[this.primary_key()]];s.setAll(e,{silent:!0}),this.trigger("update",s)}},this),this.__store.on("remove",function(t,e){if(!(!this.__models_by_id[t]||e&&e.model_remove)){var i=this.__models_by_id[t];this.trigger("remove",i),i.destroy()}},this),this._supportsAsync=!0,this._supportsSync=t.supportsSync()},_model_register:function(t){this.hasModel(t)||(this.trigger("register",t),this.__models_by_cid.add(t),t.hasId()&&(this.__models_by_id[t.id()]=t),t.isNew()&&this.__options.auto_create&&this._model_create(t))},_model_unregister:function(t){this.hasModel(t)&&(t.save(),this.__models_by_cid.remove(t),t.hasId()&&delete this.__models_by_id[t.id()],this.trigger("unregister",t))},hasModel:function(t){return null!==this.__models_by_cid.get(t)},_model_remove:function(t,e){return this.hasModel(t)?this.then(this.__store,this.__store.remove,[[t.id(),{model_remove:!0}]],e,function(e,i){this.trigger("remove",t),t.destroy(),this.callback(i,"success",!0)},function(t,e){this.callback(e,"exception",t)}):!1},_model_save:function(t,e){return t.isNew()?this._model_create(t,e):this._model_update(t,e)},__exception_conversion:function(t,e){return this.__options.store_validation_conversion?t.validation_exception_conversion(e):e},_model_create:function(t,e){if(!this.hasModel(t)||!t.isNew())return!1;if(!t.validate()){var i=new BetaJS.Modelling.ModelInvalidException(t);if(!e)throw i;this.callback(e,"exception",i)}var s=BetaJS.Scopes.resolve(this.__model_type).filterPersistent(t.get_all_properties());return this.__options.type_column&&(s[this.__options.type_column]=t.cls.classname),this.then(this.__store,this.__store.insert,[[s,{model_create:!0}]],e,function(e,i){return t.cls.primary_key()in e?(this.__models_by_id[e[t.cls.primary_key()]]=t,t.setAll(e,{no_change:!0,silent:!0}),delete this.__models_changed[t.cid()],this.trigger("create",t),this.trigger("save",t),this.callback(i,"success",t),!0):this.callback(i,"exception",new BetaJS.Modelling.ModelMissingIdException(t))},function(e,i){e=BetaJS.Exceptions.ensure(e),e=this.__exception_conversion(t,e),this.callback(i,"exception",e)})},_model_update:function(t,e){if(!this.hasModel(t)||t.isNew())return!1;if(!t.validate()){var i=new BetaJS.Modelling.ModelInvalidException(t);if(!e)throw i;this.callback(e,"exception",i)}var s=BetaJS.Scopes.resolve(this.__model_type).filterPersistent(t.properties_changed());return BetaJS.Types.is_empty(s)?(e&&this.callback(e,"success",s),s):this.then(this.__store,this.__store.update,[t.id(),[s,{model_update:!0}]],e,function(e,i){return t.setAll(e,{no_change:!0,silent:!0}),delete this.__models_changed[t.cid()],this.trigger("update",t),this.trigger("save",t),this.callback(i,"success",e),e},function(e,i){return e=BetaJS.Exceptions.ensure(e),e=this.__exception_conversion(t,e),this.callback(i,"exception",e),!1})},_model_set_value:function(t,e,i,s){return this.__models_changed[t.cid()]=t,this.trigger("change",t,e,i),this.trigger("change:"+e,t,i),this.__options.auto_update?t.save(s):void 0},save:function(t){if(t){var e=[];return BetaJS.Objs.iter(this.__models_changed,function(t){e.push(t.promise(t.save))},this),this.join(e,t)}var i=!0;return BetaJS.Objs.iter(this.__models_changed,function(t){i=t.save()&&i}),i},primary_key:function(){return BetaJS.Scopes.resolve(this.__model_type).primary_key()},__materialize:function(t){if(!t)return null;var e=this.__model_type;this.__options.type_column&&t[this.__options.type_column]&&(e=t[this.__options.type_column]);var i=BetaJS.Scopes.resolve(e);if(this.__models_by_id[t[this.primary_key()]])return this.__models_by_id[t[this.primary_key()]];var s=new i(t,{table:this,saved:!0,"new":!1});return s},findById:function(t,e){return this.__models_by_id[t]?(e&&this.callback(e,"success",this.__models_by_id[t]),this.__models_by_id[t]):this.then(this.__store,this.__store.get,[t],e,function(e,i){this.callback(i,"success",this.__materialize(this.__store.get(t)))})},findBy:function(t,e){return this.then(this,this.allBy,[t,{limit:1}],e,function(t,e){this.callback(e,"success",t.next())})},all:function(t,e){return this.allBy({},t,e)},allBy:function(t,e,i){var s=this;return this.__store.then(this.__store.query,[t,e],i,function(t,e){var i=new BetaJS.Iterators.MappedIterator(t,function(t){return this.__materialize(t)},s);s.callback(e,"success",i)})},query:function(){return this.allBy.apply(this,arguments)},scheme:function(){return this.__model_type.scheme()},ensure_indices:function(){if(!("ensure_index"in this.__store))return!1;var t=this.scheme();for(var e in t)t[e].index&&this.__store.ensure_index(e);return!0}}]),BetaJS.Class.extend("BetaJS.Modelling.Associations.Association",[BetaJS.SyncAsync.SyncAsyncMixin,{constructor:function(t,e){this._inherited(BetaJS.Modelling.Associations.Association,"constructor"),this._model=t,this._options=e||{},this.__cache=null,e.delete_cascade&&t.on("remove",function(){this.__delete_cascade()},this),e.ignore_change_id||t.on("change_id",function(t,e){this._change_id(t,e)},this)},_change_id:function(){},__delete_cascade:function(){this.yield({success:function(t){t=BetaJS.Iterators.ensure(t).toArray();for(var e=[];t.hasNext();){var i=t.next();e.push(i.promise(i.remove))}this.join(e,{success:function(){}})}})},yield:function(t){return this._options.cached?this.eitherFactory("__cache",t,this._yield,this._yield):this._yield(t)},invalidate:function(){delete this.__cache}}]),BetaJS.Modelling.Associations.Association.extend("BetaJS.Modelling.Associations.TableAssociation",{constructor:function(t,e,i,s){this._inherited(BetaJS.Modelling.Associations.TableAssociation,"constructor",t,s),this._foreign_table=e,this._foreign_key=i,s.primary_key&&(this._primary_key=s.primary_key),this._options.cached&&this._foreign_table.on("create update remove",function(){this.invalidate()},this)},destroy:function(){this._foreign_table.off(null,null,this),this._inherited(BetaJS.Modelling.Associations.TableAssociation,"destroy")}}),BetaJS.Modelling.Associations.TableAssociation.extend("BetaJS.Modelling.Associations.HasManyAssociation",{_id:function(){return this._primary_key?this._model.get(this._primary_key):this._model.id()},_yield:function(t){return this.allBy({},t)},yield:function(t){if(!this._options.cached)return this._yield(t);if(this.__cache){var e=new BetaJS.Iterators.ArrayIterator(this.__cache);return t&&this.callback(t,"success",e),e}return this.then(this._yield,t,function(t,e){this.__cache=t.asArray(),BetaJS.Objs.iter(this.__cache,function(t){t.on("destroy",function(){this.invalidate()},this)},this),this.callback(e,"success",new BetaJS.Iterators.ArrayIterator(this.__cache))})},invalidate:function(){BetaJS.Objs.iter(this.__cache,function(t){t.off(null,null,this)},this),this._inherited(BetaJS.Modelling.Associations.HasManyAssociation,"invalidate")},findBy:function(t,e){return t[this._foreign_key]=this._id(),this._foreign_table.findBy(t,e)},allBy:function(t,e,i){return t[this._foreign_key]=i?i:this._id(),this._foreign_table.allBy(t,{},e)},_change_id:function(t,e){this.allBy({},{content:this,success:function(e){for(;e.hasNext();){var i=e.next();i.set(this._foreign_key,t),i.save()}}},e)}}),BetaJS.Modelling.Associations.HasManyAssociation.extend("BetaJS.Modelling.Associations.HasManyThroughArrayAssociation",{_yield:function(t){if(t){var e=[];return BetaJS.Objs.iter(this._model.get(this._foreign_key),function(t){e.push(this._foreign_table.promise(this._foreign_table.findById,[t]))},this),this.join(e,BetaJS.SyncAsync.mapSuccess(t,function(e){this.callback(t,"success",BetaJS.Objs.filter(e,function(t){return!!t}))}))}var i=[];return BetaJS.Objs.iter(this._model.get(this._foreign_key),function(t){var e=this._foreign_table.findById(t);e&&i.push(e)},this),i},yield:function(t){if(!this._options.cached)return new BetaJS.Iterators.ArrayIterator(this._yield(t));if(this.__cache){var e=new BetaJS.Iterators.ArrayIterator(this.__cache);return t&&this.callback(t,"success",e),e}return this.then(this._yield,t,function(t,e){this.__cache=t,BetaJS.Objs.iter(this.__cache,function(t){t.on("destroy",function(){this.invalidate()},this)},this),this.callback(e,"success",new BetaJS.Iterators.ArrayIterator(this.__cache))})}}),BetaJS.Modelling.Associations.TableAssociation.extend("BetaJS.Modelling.Associations.HasOneAssociation",{_yield:function(t,e){var i={};return i[this._foreign_key]=e?e:this._primary_key?this._model.get(this._primary_key):this._model.id(),this.then(this._foreign_table,this._foreign_table.findBy,[i],t,function(t,e){t&&t.on("destroy",function(){this.invalidate()},this),this.callback(e,"success",t)})},_change_id:function(t,e){this._yield({context:this,success:function(e){e&&(e.set(this._foreign_key,t),e.save())}},e)}}),BetaJS.Modelling.Associations.TableAssociation.extend("BetaJS.Modelling.Associations.BelongsToAssociation",{_yield:function(t){var e=function(t,e){t&&t.on("destroy",function(){this.invalidate()},this),this.callback(e,"success",t)};if(!this._primary_key)return this.then(this._foreign_table,this._foreign_table.findById,[this._model.get(this._foreign_key)],t,e);var i={};return i[this._primary_key]=this._model.get(this._foreign_key),this.then(this._foreign_table,this._foreign_table.findBy,[i],t,e)}}),BetaJS.Modelling.Associations.Association.extend("BetaJS.Modelling.Associations.ConditionalAssociation",{constructor:function(t,e){this._inherited(BetaJS.Modelling.Associations.ConditionalAssociation,"constructor"),this._model=t,this._options=e||{},this.__cache=null,e.delete_cascade&&t.on("remove",function(){this.__delete_cascade()},this),e.ignore_change_id||t.on("change_id",function(t,e){this._change_id(t,e)},this)},_yield:function(t){return this._model.assocs[this._options.conditional(this._model)].yield(t)}}),BetaJS.Modelling.Associations.Association.extend("BetaJS.Modelling.Associations.PolymorphicHasOneAssociation",{constructor:function(t,e,i,s){this._inherited(BetaJS.Modelling.Associations.PolymorphicHasOneAssociation,"constructor",t,s),this._foreign_table_key=e,this._foreign_key=i,s.primary_key&&(this._primary_key=s.primary_key)},_yield:function(t,e){var i={};i[this._foreign_key]=e?e:this._primary_key?this._model.get(this._primary_key):this._model.id();var s=BetaJS.Scopes.resolve(this._model.get(this._foreign_table_key));return this.then(s,s.findBy,[i],t,function(t,e){t&&t.on("destroy",function(){this.invalidate()},this),this.callback(e,"success",t)})},_change_id:function(t,e){this._yield({success:function(e){e&&(e.set(this._foreign_key,t),e.save())}},e)}}),BetaJS.Class.extend("BetaJS.Modelling.Validators.Validator",{validate:function(){return null}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.PresentValidator",{constructor:function(t){this._inherited(BetaJS.Modelling.Validators.PresentValidator,"constructor"),this.__error_string=t?t:"Field is required"},validate:function(t){return BetaJS.Types.is_null(t)||""===t?this.__error_string:null}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.EmailValidator",{constructor:function(t){this._inherited(BetaJS.Modelling.Validators.EmailValidator,"constructor"),this.__error_string=t?t:"Not a valid email address"},validate:function(t){return BetaJS.Strings.is_email_address(t)?null:this.__error_string}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.LengthValidator",{constructor:function(t){this._inherited(BetaJS.Modelling.Validators.LengthValidator,"constructor"),this.__min_length=BetaJS.Types.is_defined(t.min_length)?t.min_length:null,this.__max_length=BetaJS.Types.is_defined(t.max_length)?t.max_length:null,this.__error_string=BetaJS.Types.is_defined(t.error_string)?t.error_string:null,this.__error_string||(null!==this.__min_length?this.__error_string=null!==this.__max_length?"Between "+this.__min_length+" and "+this.__max_length+" characters":"At least "+this.__min_length+" characters":null!==this.__max_length&&(this.__error_string="At most "+this.__max_length+" characters"))},validate:function(t){return null!==this.__min_length&&(!t||t.length<this.__min_length)?this.__error_string:null!==this.__max_length&&t.length>this.__max_length?this.__error_string:null}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.UniqueValidator",{constructor:function(t,e){this._inherited(BetaJS.Modelling.Validators.UniqueValidator,"constructor"),this.__key=t,this.__error_string=e?e:"Key already present"},validate:function(t,e){var i={};i[this.__key]=t;var s=e.table().findBy(i);return!s||!e.isNew()&&e.id()==s.id()?null:this.__error_string}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.ConditionalValidator",{constructor:function(t,e){this._inherited(BetaJS.Modelling.Validators.ConditionalValidator,"constructor"),this.__condition=t,this.__validator=BetaJS.Types.is_array(e)?e:[e]},validate:function(t,e){if(!this.__condition(t,e))return null;for(var i=0;this.__validator.length>i;++i){var s=this.__validator[i].validate(t,e);if(null!==s)return s}return null}});