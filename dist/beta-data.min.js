/*!
betajs-data - v1.0.0 - 2015-01-14
Copyright (c) Oliver Friedmann
MIT Software License.
*/
BetaJS.Queries={subsumizes:function(a,b){if(!BetaJS.Types.is_object(a)||!BetaJS.Types.is_object)return a==b;for(var c in a)if(!(c in b&&this.subsumizes(a[c],b[c])))return!1;return!0},normalize:function(a){return BetaJS.Sort.deep_sort(a)},serialize:function(a){return JSON.stringify(this.normalize(a))},unserialize:function(a){return JSON.parse(a)},__increase_dependency:function(a,b){return a in b?b[a]++:b[a]=1,b},__dependencies_queries:function(a,b){return BetaJS.Objs.iter(a,function(a){b=this.__dependencies_query(a,b)},this),b},__dependencies_query:function(a,b){for(key in a)b=this.__dependencies_pair(key,a[key],b);return b},__dependencies_pair:function(a,b,c){return"$or"==a||"$and"==a?this.__dependencies_queries(b,c):this.__increase_dependency(a,c)},dependencies:function(a){return this.__dependencies_query(a,{})},__evaluate_query:function(a,b){for(var c in a)if(!this.__evaluate_pair(c,a[c],b))return!1;return!0},__evaluate_pair:function(a,b,c){return"$or"==a?this.__evaluate_or(b,c):"$and"==a?this.__evaluate_and(b,c):this.__evaluate_value(b,c[a])},__evaluate_value:function(a,b){if(BetaJS.Types.is_object(a)){var c=!0;return BetaJS.Objs.iter(a,function(a,d){"$in"==d&&(c=c&&BetaJS.Objs.contains_value(a,b)),"$gt"==d&&(c=c&&b>a),"$gtic"==d&&(c=c&&b.toLowerCase()>a.toLowerCase()),"$lt"==d&&(c=c&&a>b),"$ltic"==d&&(c=c&&b.toLowerCase()<a.toLowerCase()),"$gte"==d&&(c=c&&b>=a),"$geic"==d&&(c=c&&b.toLowerCase()>=a.toLowerCase()),"$le"==d&&(c=c&&a>=b),"$leic"==d&&(c=c&&b.toLowerCase()<=a.toLowerCase()),"$sw"==d&&(c=c&&0===b.indexOf(a)),"$swic"==d&&(c=c&&0===b.toLowerCase().indexOf(a.toLowerCase())),"$ct"==d&&(c=c&&b.indexOf(a)>=0),"$ctic"==d&&(c=c&&b.toLowerCase().indexOf(a.toLowerCase())>=0)},this),c}return a==b},__evaluate_or:function(a,b){var c=!1;return BetaJS.Objs.iter(a,function(a){return this.__evaluate_query(a,b)?(c=!0,!1):void 0},this),c},__evaluate_and:function(a,b){var c=!0;return BetaJS.Objs.iter(a,function(a){return this.__evaluate_query(a,b)?void 0:(c=!1,!1)},this),c},format:function(a){return BetaJS.Class.is_class_instance(a)?a.format():JSON.stringify(a)},overloaded_evaluate:function(a,b){return BetaJS.Class.is_class_instance(a)?a.evaluate(b):BetaJS.Types.is_function(a)?a(b):this.evaluate(a,b)},evaluate:function(a,b){return this.__evaluate_query(a,b)},emulate:function(a,b,c){var d=b.apply(c||this,{}),e=d;return d?BetaJS.Types.is_array(d)&&(e=BetaJS.Iterators.ArrayIterator(d)):e=BetaJS.Iterators.ArrayIterator([]),new BetaJS.Iterators.FilteredIterator(e,function(b){return BetaJS.Queries.evaluate(a,b)})}},BetaJS.Queries.Constrained={make:function(a,b){return{query:a,options:b||{}}},is_constrained:function(a){return a&&(a.query||a.options)},format:function(a){var b=a.query;a.query=BetaJS.Queries.format(b);var c=JSON.stringify(a);return a.query=b,c},normalize:function(a){return{query:"query"in a?BetaJS.Queries.normalize(a.query):{},options:{skip:"options"in a&&"skip"in a.options?a.options.skip:null,limit:"limit"in a&&"limit"in a.options?a.options.limit:null,sort:"sort"in a&&"sort"in a.options?a.options.sort:{}}}},emulate:function(a,b,c,d){var e=a.query||{},f=a.options||{},g={},h={};return"sort"in f&&"sort"in b&&(h.sort=f.sort),g=e,("query"in b||BetaJS.Types.is_empty(e))&&(g=e,(!f.sort||"sort"in b)&&("skip"in f&&"skip"in b&&(h.skip=f.skip),"limit"in f&&"limit"in b&&(h.limit=f.limit,"skip"in f&&!("skip"in b)&&(h.limit+=f.skip)))),c.call(d||this,g,h).mapSuccess(function(a){var c=a;return null===a?c=new BetaJS.Iterators.ArrayIterator([]):BetaJS.Types.is_array(a)&&(c=new BetaJS.Iterators.ArrayIterator(a)),"query"in b||BetaJS.Types.is_empty(e)||(c=new BetaJS.Iterators.FilteredIterator(c,function(a){return BetaJS.Queries.evaluate(e,a)})),"sort"in f&&!("sort"in h)&&(c=new BetaJS.Iterators.SortedIterator(c,BetaJS.Comparators.byObject(f.sort))),"skip"in f&&!("skip"in h)&&(c=new BetaJS.Iterators.SkipIterator(c,f.skip)),"limit"in f&&!("limit"in h)&&(c=new BetaJS.Iterators.LimitIterator(c,f.limit)),c})},subsumizes:function(a,b){if(qopt=a.options||{},qopt2=b.options||{},qskip=qopt.skip||0,qskip2=qopt2.skip||0,qlimit=qopt.limit||null,qlimit2=qopt2.limit||null,qsort=qopt.sort,qsort2=qopt2.sort,qskip>qskip2)return!1;if(qlimit){if(!qlimit2)return!1;if(qlimit2+qskip2>qlimit+qskip)return!1}return(qskip||qlimit)&&(qsort||qsort2)&&JSON.stringify(qsort)!=JSON.stringify(qsort2)?!1:BetaJS.Queries.subsumizes(a.query,b.query)},serialize:function(a){return JSON.stringify(this.normalize(a))},unserialize:function(a){return JSON.parse(a)},mergeable:function(a,b){if(BetaJS.Queries.serialize(a.query)!=BetaJS.Queries.serialize(b.query))return!1;var c=(a.options||{},b.options||{});return JSON.stringify(qopts.sort||{})!=JSON.stringify(c.sort||{})?!1:"skip"in qopts?"skip"in c?qopts.skip<=c.skip?!qopts.limit||qopts.skip+qopts.limit>=c.skip:!c.limit||c.skip+c.limit>=qopts.skip:!c.limit||c.limit>=qopts.skip:!("skip"in c)||!qopts.limit||qopts.limit>=c.skip},merge:function(a,b){var c=(a.options||{},b.options||{});return{query:a.query,options:{skip:"skip"in qopts&&"skip"in c?Math.min(qopts.skip,c.skip):null,limit:"limit"in qopts&&"limit"in c?Math.max(qopts.limit,c.limit):null,sort:a.sort}}}},BetaJS.Class.extend("BetaJS.Queries.AbstractQueryModel",{register:function(){},executable:function(){}}),BetaJS.Queries.AbstractQueryModel.extend("BetaJS.Queries.DefaultQueryModel",{constructor:function(){this._inherited(BetaJS.Queries.DefaultQueryModel,"constructor"),this.__queries={}},_insert:function(a){this.__queries[BetaJS.Queries.Constrained.serialize(a)]=a},_remove:function(a){delete this.__queries[BetaJS.Queries.Constrained.serialize(a)]},exists:function(a){return BetaJS.Queries.Constrained.serialize(a)in this.__queries},subsumizer_of:function(a){if(this.exists(a))return a;var b=null;return BetaJS.Objs.iter(this.__queries,function(c){return BetaJS.Queries.Constrained.subsumizes(c,a)&&(b=c),!b},this),b},executable:function(a){return!!this.subsumizer_of(a)},register:function(a){for(var b=!0;b;)b=!1,BetaJS.Objs.iter(this.__queries,function(c){BetaJS.Queries.Constrained.subsumizes(a,c)&&(this._remove(c),b=!0)},this);this._insert(a)},invalidate:function(a){var b=this.subsumizer_of(a);b&&this._remove(b)}}),BetaJS.Queries.DefaultQueryModel.extend("BetaJS.Queries.StoreQueryModel",{constructor:function(a){this.__store=a,this._inherited(BetaJS.Queries.StoreQueryModel,"constructor")},initialize:function(){return this.__store.mapSuccess(function(a){for(;a.hasNext();){var b=a.next();delete b.id,this._insert(b)}},this)},_insert:function(a){this._inherited(BetaJS.Queries.StoreQueryModel,"_insert",a),this.__store.insert(a)},_remove:function(a){delete this.__queries[BetaJS.Queries.Constrained.serialize(a)],this.__store.query({query:a}).success(function(a){for(;a.hasNext();)this.__store.remove(a.next().id)},this)}}),BetaJS.Collections.Collection.extend("BetaJS.Collections.QueryCollection",{constructor:function(a,b,c){this._source=a,this._inherited(BetaJS.Collections.QueryCollection,"constructor",c),this._options=BetaJS.Objs.extend({forward_steps:null,backward_steps:null,range:null},c),null!==b&&this.set_query(b)},query:function(){return this._query},set_query:function(a){return this._query=BetaJS.Objs.extend({query:{},options:{}},a),this._query.options.skip=this._query.options.skip||0,this._query.options.limit=this._query.options.limit||null,this._query.options.sort=this._query.options.sort||{},this._count=0,this.__execute_query(this._query.options.skip,this._query.options.limit,!0)},__sub_query:function(a){return this._source.query(this._query.query,a)},__execute_query:function(a,b,c){a=Math.max(a,0);var d={};return this._query.options.sort&&!BetaJS.Types.is_empty(this._query.options.sort)&&(d.sort=this._query.options.sort),c?(a>0&&(d.skip=a),null!==b&&(d.limit=b),this.__sub_query(d).mapSuccess(function(c){var d=c.asArray();return this._query.options.skip=a,this._query.options.limit=b,this._count=!b||d.length<b?a+d.length:null,this.clear(),this.add_objects(d),!0},this)):a<this._query.options.skip?(b=this._query.options.skip-a,a>0&&(d.skip=a),d.limit=b,this.__sub_query(d).mapSuccess(function(b){var c=b.asArray();this._query.options.skip=a;var d=this.add_objects(c);return this._query.options.limit=null===this._query.options.limit?null:this._query.options.limit+d,!0},this)):a>=this._query.options.skip?null!==this._query.options.limit&&(!b||a+b>this._query.options.skip+this._query.options.limit)?(b=a+b-(this._query.options.skip+this._query.options.limit),a=this._query.options.skip+this._query.options.limit,a>0&&(d.skip=a),b&&(d.limit=b),this.__sub_query(d).mapSuccess(function(c){var d=c.asArray(),e=this.add_objects(d);return this._query.options.limit=this._query.options.limit+e,b>d.length&&(this._count=a+e),!0},this)):BetaJS.Promise.create(!0):void 0},increase_forwards:function(a){return a=a?a:this._options.forward_steps,a&&null!==this._query.options.limit?this.__execute_query(this._query.options.skip+this._query.options.limit,a,!1):BetaJS.Promise.create(!0)},increase_backwards:function(a){return a=a?a:this._options.backward_steps,a&&this._query.options.skip>0?(a=Math.min(a,this._query.options.skip),this.__execute_query(this._query.options.skip-a,a,!1)):BetaJS.Promise.create(!0)},paginate:function(a){return this.__execute_query(this._options.range*a,this._options.range,!0)},paginate_index:function(){return this._options.range?Math.floor(this._query.options.skip/this._options.range):null},paginate_count:function(){return this._count&&this._options.range?Math.ceil(this._count/this._options.range):null},next:function(){var a=this.paginate_index();if(!a)return BetaJS.Promise.create(!0);var b=this.paginate_count();return!b||a<this.paginate_count()-1?this.paginate(a+1):BetaJS.Promise.create(!0)},prev:function(){var a=this.paginate_index();return a?(a>0&&this.paginate(a-1),BetaJS.Promise.create(!0)):BetaJS.Promise.create(!0)},isComplete:function(){return null!==this._count}}),BetaJS.Collections.QueryCollection.extend("BetaJS.Collections.ActiveQueryCollection",{constructor:function(a,b,c){this._inherited(BetaJS.Collections.ActiveQueryCollection,"constructor",a,b,c),a.on("create",this.__active_create,this),a.on("remove",this.__active_remove,this),a.on("update",this.__active_update,this)},destroy:function(){this._source.off(null,null,this),this._inherited(BetaJS.Collections.ActiveQueryCollection,"destroy")},get_ident:function(a){return a.id()},is_valid:function(a){return BetaJS.Queries.evaluate(this.query().query,a)},__active_create:function(a,b){if(this.is_valid(a)){var c=b();this.add(c),this._count=this._count+1,null!==this._query.options.limit&&(this._query.options.limit=this._query.options.limit+1)}},__active_remove:function(a){var b=this.getById(a);b&&(this.remove(b),this._count=this._count-1,null!==this._query.options.limit&&(this._query.options.limit=this._query.options.limit-1))},__active_update:function(a,b,c){var d=this.getById(a),e=BetaJS.Objs.extend(c,b);d?this.is_valid(e)||this.__active_remove(a):this.__active_create(e,this._source.materializer(e))}}),BetaJS.Exceptions.Exception.extend("BetaJS.Stores.StoreException"),BetaJS.Class.extend("BetaJS.Stores.ListenerStore",[BetaJS.Events.EventsMixin,{constructor:function(a){this._inherited(BetaJS.Stores.ListenerStore,"constructor"),a=a||{},this._id_key=a.id_key||"id"},id_key:function(){return this._id_key},_inserted:function(a,b){this.trigger("insert",a,b)},_removed:function(a,b){this.trigger("remove",a,b)},_updated:function(a,b,c){this.trigger("update",a,b,c)}}]),BetaJS.Stores.BaseStore=BetaJS.Stores.ListenerStore.extend("BetaJS.Stores.BaseStore",{constructor:function(a){this._inherited(BetaJS.Stores.BaseStore,"constructor",a),a=a||{},this._id_key=a.id_key||"id",this._create_ids=a.create_ids||!1,this._create_ids&&(this._id_generator=a.id_generator||this._auto_destroy(new BetaJS.Classes.TimedIdGenerator)),this._query_model="query_model"in a?a.query_model:null},query_model:function(){return arguments.length>0&&(this._query_model=arguments[0]),this._query_model},_insert:function(){return BetaJS.Promise.create(null,new BetaJS.Stores.StoreException("unsupported: insert"))},_remove:function(){return BetaJS.Promise.create(null,new BetaJS.Stores.StoreException("unsupported: remove"))},_get:function(){return BetaJS.Promise.create(null,new BetaJS.Stores.StoreException("unsupported: get"))},_update:function(){return BetaJS.Promise.create(null,new BetaJS.Stores.StoreException("unsupported: update"))},_query_capabilities:function(){return{}},_query:function(){return BetaJS.Promise.create(null,new BetaJS.Stores.StoreException("unsupported: query"))},insert:function(a){var b=null;return BetaJS.Types.is_array(a)&&(b=a[1],a=a[0]),!this._create_ids||this._id_key in a&&a[this._id_key]||(a[this._id_key]=this._id_generator.generate()),this._insert(a).success(function(a){this._inserted(a,b)},this)},insert_all:function(a,b){var c=null;arguments.length>2&&(c=arguments[2]),b&&this._query_model&&(this.trigger("query_register",b),this._query_model.register(b));for(var d=BetaJS.Promise.and(),e=0;e<a.length;++e)d=d.and(this.insert(c?[a[e],c]:a[e]));return d.end()},remove:function(a){var b=null;return BetaJS.Types.is_array(a)&&(b=a[1],a=a[0]),this._remove(a).success(function(){this._removed(a,b)},this)},get:function(a){return this._get(a)},update:function(a,b){var c=null;return BetaJS.Types.is_array(b)&&(c=b[1],b=b[0]),this._update(a,b).success(function(a){this._updated(a,b,c)},this)},query:function(a,b){if(a=BetaJS.Objs.clone(a,-1),b&&(b.limit&&(b.limit=parseInt(b.limit,10)),b.skip&&(b.skip=parseInt(b.skip,10))),this._query_model){var c=this._query_model.subsumizer_of({query:a,options:b});if(!c)return this.trigger("query_miss",{query:a,options:b}),BetaJS.Promise.error(new BetaJS.Stores.StoreException("Cannot execute query"));this.trigger("query_hit",{query:a,options:b},c)}return BetaJS.Queries.Constrained.emulate(BetaJS.Queries.Constrained.make(a,b||{}),this._query_capabilities(),this._query,this)},_query_applies_to_id:function(a,b){var c=this.get(b);return c&&BetaJS.Queries.overloaded_evaluate(a,c)},_ensure_index:function(){},ensure_index:function(a){return this._ensure_index(a)},clear:function(){return this.query().mapSuccess(function(a){for(var b=BetaJS.Promise.and();a.hasNext();){var c=a.next();b=b.and(this.remove(c[this._id_key]))}return b},this)},perform:function(a){var b=BetaJS.Objs.keyByIndex(a),c=BetaJS.Objs.valueByIndex(a);return"insert"==b?this.insert(c):"remove"==b?this.remove(c):"update"==b?this.update(BetaJS.Objs.keyByIndex(c),BetaJS.Objs.valueByIndex(c)):BetaJS.Promise.error(new BetaJS.Stores.StoreException("unsupported: perform "+b))}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.AssocStore",{_read_key:function(){},_write_key:function(){},_remove_key:function(){},_iterate:function(){},constructor:function(a){a=a||{},a.create_ids=!0,this._inherited(BetaJS.Stores.AssocStore,"constructor",a)},_insert:function(a){return BetaJS.Promise.tryCatch(function(){return this._write_key(a[this._id_key],a),a},this)},_remove:function(a){return BetaJS.Promise.tryCatch(function(){var b=this._read_key(a);return b&&!this._remove_key(a)?null:b},this)},_get:function(a){return BetaJS.Promise.tryCatch(function(){return this._read_key(a)},this)},_update:function(a,b){return BetaJS.Promise.tryCatch(function(){var c=this._read_key(a);return c&&(this._id_key in b&&(this._remove_key(a),a=b[this._id_key],delete b[this._id_key]),BetaJS.Objs.extend(c,b),this._write_key(a,c)),c},this)},_query:function(){return BetaJS.Promise.tryCatch(function(){return this._iterate()},this)}}),BetaJS.Stores.AssocStore.extend("BetaJS.Stores.MemoryStore",{constructor:function(a){this._inherited(BetaJS.Stores.MemoryStore,"constructor",a),this.__data={}},_read_key:function(a){return this.__data[a]},_write_key:function(a,b){this.__data[a]=b},_remove_key:function(a){delete this.__data[a]},_iterate:function(){return new BetaJS.Iterators.ObjectValuesIterator(this.__data)}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.DumbStore",{_read_last_id:function(){},_write_last_id:function(){},_remove_last_id:function(){},_read_first_id:function(){},_write_first_id:function(){},_remove_first_id:function(){},_read_item:function(){},_write_item:function(){},_remove_item:function(){},_read_next_id:function(){},_write_next_id:function(){},_remove_next_id:function(){},_read_prev_id:function(){},_write_prev_id:function(){},_remove_prev_id:function(){},constructor:function(a){a=a||{},a.create_ids=!0,this._inherited(BetaJS.Stores.DumbStore,"constructor",a)},_insert:function(a){return BetaJS.Promise.tryCatch(function(){var b=this._read_last_id(),c=a[this._id_key];return null!==b?(this._write_next_id(b,c),this._write_prev_id(c,b)):this._write_first_id(c),this._write_last_id(c),this._write_item(c,a),a},this)},_remove:function(a){return BetaJS.Promise.tryCatch(function(){var b=this._read_item(a);if(b){this._remove_item(a);var c=this._read_next_id(a),d=this._read_prev_id(a);null!==c?(this._remove_next_id(a),null!==d?(this._remove_prev_id(a),this._write_next_id(d,c),this._write_prev_id(c,d)):(this._remove_prev_id(c),this._write_first_id(c))):null!==d?(this._remove_next_id(d),this._write_last_id(d)):(this._remove_first_id(),this._remove_last_id())}return b},this)},_get:function(a){return BetaJS.Promise.tryCatch(function(){return this._read_item(a)},this)},_update:function(a,b){return BetaJS.Promise.tryCatch(function(){var c=this._get(a);return c&&(delete b[this._id_key],BetaJS.Objs.extend(c,b),this._write_item(a,c)),c},this)},_query_capabilities:function(){return{query:!0}},_query:function(a){return BetaJS.Promise.tryCatch(function(){var b=new BetaJS.Iterators.Iterator,c=this,d=this._read_first_id();return BetaJS.Objs.extend(b,{__id:null===d?1:d,__store:c,__query:a,hasNext:function(){var b=this.__store._read_last_id();if(null===b)return!1;for(;this.__id<b&&!this.__store._read_item(this.__id);)this.__id++;for(;this.__id<=b;){if(this.__store._query_applies_to_id(a,this.__id))return!0;this.__id<b?this.__id=this.__store._read_next_id(this.__id):this.__id++}return!1},next:function(){if(this.hasNext()){var a=this.__store.get(this.__id);return this.__id==this.__store._read_last_id()?this.__id++:this.__id=this.__store._read_next_id(this.__id),a}return null}}),b},this)}}),BetaJS.Stores.DumbStore.extend("BetaJS.Stores.AssocDumbStore",{_read_key:function(){},_write_key:function(){},_remove_key:function(){},__read_id:function(a){var b=this._read_key(a);return b?parseInt(b,10):null},_read_last_id:function(){return this.__read_id("last_id")},_write_last_id:function(a){this._write_key("last_id",a)},_remove_last_id:function(){this._remove_key("last_id")},_read_first_id:function(){return this.__read_id("first_id")},_write_first_id:function(a){this._write_key("first_id",a)},_remove_first_id:function(){this._remove_key("first_id")},_read_item:function(a){return this._read_key("item_"+a)},_write_item:function(a,b){this._write_key("item_"+a,b)},_remove_item:function(a){this._remove_key("item_"+a)},_read_next_id:function(a){return this.__read_id("next_"+a)},_write_next_id:function(a,b){this._write_key("next_"+a,b)},_remove_next_id:function(a){this._remove_key("next_"+a)},_read_prev_id:function(a){return this.__read_id("prev_"+a)},_write_prev_id:function(a,b){this._write_key("prev_"+a,b)},_remove_prev_id:function(a){this._remove_key("prev_"+a)}}),BetaJS.Stores.AssocDumbStore.extend("BetaJS.Stores.LocalStore",{constructor:function(a){this._inherited(BetaJS.Stores.LocalStore,"constructor",a),this.__prefix=a.prefix},__key:function(a){return this.__prefix+a},_read_key:function(a){var b=this.__key(a);return b in localStorage?JSON.parse(localStorage[b]):null},_write_key:function(a,b){localStorage[this.__key(a)]=JSON.stringify(b)},_remove_key:function(a){delete localStorage[this.__key(a)]}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.DualStore",{constructor:function(a,b,c){c=BetaJS.Objs.extend({create_options:{},update_options:{},delete_options:{},get_options:{},query_options:{}},c||{}),c.id_key=a._id_key,this.__first=a,this.__second=b,this._inherited(BetaJS.Stores.DualStore,"constructor",c),this.__create_options=BetaJS.Objs.extend({start:"first",strategy:"then",auto_replicate:"first"},c.create_options),this.__update_options=BetaJS.Objs.extend({start:"first",strategy:"then",auto_replicate:"first"},c.update_options),this.__remove_options=BetaJS.Objs.extend({start:"first",strategy:"then",auto_replicate:"first"},c.delete_options),this.__get_options=BetaJS.Objs.extend({start:"first",strategy:"or",clone:!0,clone_second:!1,or_on_null:!0},c.get_options),this.__query_options=BetaJS.Objs.extend({start:"first",strategy:"or",clone:!0,clone_second:!1,or_on_null:!0},c.query_options),this.__first.on("insert",this.__inserted_first,this),this.__second.on("insert",this.__inserted_second,this),this.__first.on("update",this.__updated_first,this),this.__second.on("update",this.__updated_second,this),this.__first.on("remove",this.__removed_first,this),this.__second.on("remove",this.__removed_second,this)},__inserted_first:function(a,b){b&&b.dual_insert||(("first"==this.__create_options.auto_replicate||"both"==this.__create_options.auto_replicate)&&this.__second.insert([a,{dual_insert:!0}]),this._inserted(a))},__inserted_second:function(a,b){b&&b.dual_insert||(("second"==this.__create_options.auto_replicate||"both"==this.__create_options.auto_replicate)&&this.__first.insert([a,{dual_insert:!0}]),this._inserted(a))},__updated_first:function(a,b,c){c&&c.dual_update||(("first"==this.__update_options.auto_replicate||"both"==this.__update_options.auto_replicate)&&this.__second.update(a[this.id_key()],[b,{dual_update:!0}]),this._updated(a,b))},__updated_second:function(a,b,c){c&&c.dual_update||(("second"==this.__update_options.auto_replicate||"both"==this.__update_options.auto_replicate)&&this.__first.update(a[this.id_key()],[b,{dual_update:!0}]),this._updated(a,b))},__removed_first:function(a,b){b&&b.dual_remove||(("first"==this.__remove_options.auto_replicate||"both"==this.__remove_options.auto_replicate)&&this.__second.remove([a,{dual_remove:!0}]),this._removed(a))},__removed_second:function(a,b){b&&b.dual_remove||(("second"==this.__remove_options.auto_replicate||"both"==this.__remove_options.auto_replicate)&&this.__first.remove([a,{dual_remove:!0}]),this._removed(a))},first:function(){return this.__first},second:function(){return this.__second},_insert:function(a){var b=this.__first,c=this.__second;"first"!=this.__create_options.start&&(b=this.__second,c=this.__first);var d=this.__create_options.strategy;return"then"==d?b.insert([a,{dual_insert:!0}]).mapSuccess(function(a){return c.insert([a,{dual_insert:!0}])},this):"or"==d?b.insert([a,{dual_insert:!0}]).mapError(function(){return c.insert([a,{dual_insert:!0}])},this):b.insert([a,{dual_insert:!0}])},_update:function(a,b){var c=this.__first,d=this.__second;"first"!=this.__update_options.start&&(c=this.__second,d=this.__first);var e=this.__update_options.strategy;return"then"==e?c.update(a,[b,{dual_update:!0}]).mapSuccess(function(b){return d.update(a,[b,{dual_update:!0}])},this):"or"==e?c.update(a,[b,{dual_update:!0}]).mapError(function(){return d.update(a,[b,{dual_update:!0}])},this):c.update(a,[b,{dual_update:!0}])},_remove:function(a){var b=this.__first,c=this.__second;"first"!=this.__remove_options.start&&(b=this.__second,c=this.__first);var d=this.__remove_options.strategy;return"then"==d?b.remove([a,{dual_remove:!0}]).mapSuccess(function(){return c.remove([a,{dual_remove:!0}])},this):"or"==d?b.remove([a,{dual_remove:!0}]).mapError(function(){return c.remove([a,{dual_remove:!0}])},this):b.remove(a)},_query_capabilities:function(){return{query:!0,sort:!0,limit:!0,skip:!0}},_get:function(a){var b=this.__first,c=this.__second;"first"!=this.__get_options.start&&(b=this.__second,c=this.__first);var d=this.__get_options.strategy,e=this.__get_options.clone,f=this.__get_options.clone_second,g=this.__get_options.or_on_null;return"or"==d?b.get(a).mapCallback(function(d,h){return d||!h&&g?c.get(a).mapSuccess(function(a){return a&&e?b.insert(a):a},this):f?c.get(a).mapCallback(function(a,b){return a||!b?c.insert(h):h},this):h},this):b.get(a)},_query:function(a,b){var c=this.__first,d=this.__second;"first"!=this.__query_options.start&&(c=this.__second,d=this.__first);var e=this.__query_options.strategy,f=this.__query_options.clone,g=this.__get_options.clone_second,h=this.__query_options.or_on_null;return"or"==e?(this.trigger("query_first",a,b),c.query(a,b).mapCallback(function(e,i){return e||!i&&h?(this.trigger("query_second",a,b),d.query(a,b).mapSuccess(function(d){if(d&&f){var e=d.asArray();return c.insert_all(e,{query:a,options:b},{dual_insert:!0}).mapSuccess(function(){return new BetaJS.Iterators.ArrayIterator(e)})}return d},this)):g?(this.trigger("query_second",a,b),d.query(a,b).mapCallback(function(c,e){if(c||!e){var f=i.asArray();return d.insert_all(f,{query:a,options:b},{dual_insert:!0}).mapSuccess(function(){return new BetaJS.Iterators.ArrayIterator(f)})}return i},this)):i},this)):(this.trigger("query_first",a,b),c.query(a,b))}}),BetaJS.Stores.DualStore.extend("BetaJS.Stores.CachedStore",{constructor:function(a,b){b=b||{};var c=b.cache_store;"cache_store"in b||(c=this._auto_destroy(new BetaJS.Stores.MemoryStore({id_key:a.id_key()}))),c.query_model()||c.query_model(b.cache_query_model?b.cache_query_model:this._auto_destroy(new BetaJS.Queries.DefaultQueryModel)),this.__invalidation_options=b.invalidation||{},this._inherited(BetaJS.Stores.CachedStore,"constructor",a,c,BetaJS.Objs.extend({get_options:{start:"second",strategy:"or"},query_options:{start:"second",strategy:"or",clone:!0,or_on_null:!1}},b)),this.__invalidation_options.reload_after_first_hit&&(this.__queries={},this.cache().on("query_hit",function(a,b){var c=BetaJS.Queries.Constrained.serialize(b);this.__queries[c]||(this.__queries[c]=!0,BetaJS.Async.eventually(function(){this.invalidate_query(b,!0)},[],this))},this),this.cache().on("query_miss",function(a){var b=BetaJS.Queries.Constrained.serialize(a);this.__queries[b]=!0},this))},destroy:function(){this.cache().off(null,null,this),this._inherited(BetaJS.Stores.CachedStore,"destroy")},invalidate_query:function(a,b){this.cache().query_model().invalidate(a),b&&this.query(a.query,a.options),this.trigger("invalidate_query",a,b)},cache:function(){return this.second()},store:function(){return this.first()}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.ConversionStore",{constructor:function(a,b){b=b||{},b.id_key=a._id_key,this._inherited(BetaJS.Stores.ConversionStore,"constructor",b),this.__store=a,this.__key_encoding=b.key_encoding||{},this.__key_decoding=b.key_decoding||{},this.__value_encoding=b.value_encoding||{},this.__value_decoding=b.value_decoding||{},this.__projection=b.projection||{}},store:function(){return this.__store},encode_object:function(a){if(!a)return null;var b={};for(var c in a){var d=this.encode_key(c);d&&(b[d]=this.encode_value(c,a[c]))}return BetaJS.Objs.extend(b,this.__projection)},decode_object:function(a){if(!a)return null;var b={};for(var c in a){var d=this.decode_key(c);d&&(b[d]=this.decode_value(c,a[c]))}for(c in this.__projection)delete b[c];return b},encode_key:function(a){return a in this.__key_encoding?this.__key_encoding[a]:a},decode_key:function(a){return a in this.__key_decoding?this.__key_decoding[a]:a},encode_value:function(a,b){return a in this.__value_encoding?this.__value_encoding[a](b):b},decode_value:function(a,b){return a in this.__value_decoding?this.__value_decoding[a](b):b},_query_capabilities:function(){return this.__store._query_capabilities()},_ensure_index:function(a){return this.__store.ensure_index(a)},_insert:function(a){return this.__store.insert(this.encode_object(a)).mapSuccess(this.decode_object,this)},_remove:function(a){return this.__store.remove(this.encode_value(this._id_key,a))},_get:function(a){return this.__store.get(this.encode_value(this._id_key,a)).mapSuccess(this.decode_object,this)},_update:function(a,b){return this.__store.update(this.encode_value(this._id_key,a),this.encode_object(b)).mapSuccess(this.decode_object,this)},_query:function(a,b){return this.__store.query(this.encode_object(a),b).mapSuccess(function(a){return new BetaJS.Iterators.MappedIterator(a,this.decode_object,this)},this)}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.PassthroughStore",{constructor:function(a,b){this.__store=a,b=b||{},b.id_key=a.id_key(),this._projection=b.projection||{},this._inherited(BetaJS.Stores.PassthroughStore,"constructor",b),b.destroy_store&&this._auto_destroy(a)},_query_capabilities:function(){return this.__store._query_capabilities()},_insert:function(a){return this.__store.insert(BetaJS.Objs.extend(a,this._projection))},_remove:function(a){return this.__store.remove(a)},_get:function(a){return this.__store.get(a)},_update:function(a,b){return this.__store.update(a,b)},_query:function(a,b){return this.__store.query(BetaJS.Objs.extend(a,this._projection),b)},_ensure_index:function(a){return this.__store.ensure_index(a)},_store:function(){return this.__store}}),BetaJS.Stores.PassthroughStore.extend("BetaJS.Stores.ActiveStore",{constructor:function(a,b,c){this._inherited(BetaJS.Stores.ActiveStore,"constructor",a,c),this.__listener=b,this.delegateEvents(null,b)}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.SocketStore",{constructor:function(a,b,c){this._inherited(BetaJS.Stores.SocketStore,"constructor",a),this.__socket=b,this.__prefix=c,this._supportsAsync=!1},__send:function(a,b){this.__socket.emit(this.__prefix+":"+a,b)},_insert:function(a){this.__send("insert",a)},_remove:function(a){this.__send("remove",a)},_update:function(a,b){this.__send("update",BetaJS.Objs.objectBy(a,b))}}),BetaJS.Stores.ListenerStore.extend("BetaJS.Stores.SocketListenerStore",{constructor:function(a,b,c){this._inherited(BetaJS.Stores.SocketListenerStore,"constructor",a);var d=this;this.__prefix=c,b.on(this.__prefix+":insert",function(a){d._perform("insert",a)}),b.on(this.__prefix+":remove",function(a){d._perform("remove",a)}),b.on(this.__prefix+":update",function(a){d._perform("update",a)}),b.on(this.__prefix+":bulk",function(a){for(var b=0;b<a.length;++b)d._perform(BetaJS.Objs.keyByIndex(a[b]),BetaJS.Objs.valueByIndex(a[b]))})},_perform:function(a,b){if("insert"==a)this._inserted(b);else if("remove"==a)this._removed(b);else{if("update"!=a)throw new BetaJS.Stores.StoreException("unsupported: perform "+a);this._updated(BetaJS.Objs.objectBy(this.id_key(),BetaJS.Objs.keyByIndex(b)),BetaJS.Objs.valueByIndex(b))}}}),BetaJS.Stores.StoreException.extend("BetaJS.Stores.RemoteStoreException",{constructor:function(a){a=BetaJS.Net.AjaxException.ensure(a),this._inherited(BetaJS.Stores.RemoteStoreException,"constructor",a.toString()),this.__source=a},source:function(){return this.__source}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.RemoteStore",{constructor:function(a,b,c){this._inherited(BetaJS.Stores.RemoteStore,"constructor",c),this._uri=a,this.__ajax=b,this.__options=BetaJS.Objs.extend({update_method:"PUT",uri_mappings:{}},c||{})},getUri:function(){return this._uri},prepare_uri:function(a,b){return this.__options.uri_mappings[a]?this.__options.uri_mappings[a](b):"remove"==a||"get"==a||"update"==a?this.getUri()+"/"+b[this._id_key]:this.getUri()},_encode_query:function(){return{uri:this.prepare_uri("query")}},__invoke:function(a,b){return this.__ajax.asyncCall(a).mapCallback(function(a,c){if(a)return new BetaJS.Stores.RemoteStoreException(a);if(b&&BetaJS.Types.is_string(c))try{c=JSON.parse(c)}catch(a){}return c})},_insert:function(a){return this.__invoke({method:"POST",uri:this.prepare_uri("insert",a),data:a},!0)},_get:function(a){var b={};return b[this._id_key]=a,this.__invoke({uri:this.prepare_uri("get",b)})},_update:function(a,b){var c=BetaJS.Objs.clone(b,1);return c[this._id_key]=a,this.__invoke({method:this.__options.update_method,uri:this.prepare_uri("update",c),data:b})},_remove:function(a){var b={};return b[this._id_key]=a,this.__invoke({method:"DELETE",uri:this.prepare_uri("remove",b)})},_query:function(a,b){return this.__invoke(this._encode_query(a,b),!0)
}}),BetaJS.Stores.RemoteStore.extend("BetaJS.Stores.QueryGetParamsRemoteStore",{constructor:function(a,b,c,d){this._inherited(BetaJS.Stores.QueryGetParamsRemoteStore,"constructor",a,b,d),this.__capability_params=c},_query_capabilities:function(){var a={};return"skip"in this.__capability_params&&(a.skip=!0),"limit"in this.__capability_params&&(a.limit=!0),"query"in this.__capability_params&&(a.query=!0),"sort"in this.__capability_params&&(a.sort=!0),a},_encode_query:function(a,b){b=b||{};var c=this.getUri()+"?";return b.skip&&"skip"in this.__capability_params&&(c+=this.__capability_params.skip+"="+b.skip+"&"),b.limit&&"limit"in this.__capability_params&&(c+=this.__capability_params.limit+"="+b.limit+"&"),b.sort&&"sort"in this.__capability_params&&(c+=this.__capability_params.sort+"="+JSON.stringify(b.sort)+"&"),"query"in this.__capability_params&&(c+=this.__capability_params.query+"="+JSON.stringify(a)+"&"),{uri:c}}}),BetaJS.Class.extend("BetaJS.Stores.StoresMonitor",[BetaJS.Events.EventsMixin,{attach:function(a,b){b.on("insert",function(c){this.trigger("insert",a,b,c),this.trigger("write","insert",a,b,c)},this),b.on("remove",function(c){this.trigger("remove",a,b,c),this.trigger("write","remove",a,b,c)},this),b.on("update",function(c,d){this.trigger("update",a,b,c,d),this.trigger("write","update",a,b,c,d)},this)}}]),BetaJS.Class.extend("BetaJS.Stores.StoreHistory",[BetaJS.Events.EventsMixin,{constructor:function(a,b){this._inherited(BetaJS.Stores.StoreHistory,"constructor"),b=b||{},this._combine_update_update=b.combine_update_update||!1,this._combine_insert_update=b.combine_insert_update||!1,this._combine_insert_remove=b.combine_insert_remove||!1,this._combine_update_remove=b.combine_update_remove||!1,this._commits={},this._revision_id=null,this._store=a,this._item_commits={},this._store.on("insert",function(a){this.__add_commit({action:"insert",id:a[this._store.id_key()],data:a})},this),this._store.on("remove",function(a){this.__add_commit({action:"remove",id:a})},this),this._store.on("update",function(a,b){this.__add_commit({action:"update",id:a,data:b})},this)},__remove_commit:function(a){this.trigger("remove",this._commits[a]);var b=this._commits[a].id;delete this._commits[a],delete this._item_commits[b],BetaJS.Objs.is_empty(this._item_commits[b])&&delete this._item_commits[b]},__add_commit:function(a){a.revision_id=this._new_revision_id();var b=!1,c=!1,d=null;for(var e in this._item_commits[a.id]){var f=this._commits[e];b=b||"insert"==f.action,c=c||"update"==f.action,d=e}if(this._revision_id=a.revision_id,this._commits[this._revision_id]=a,this._item_commits[a.id]=this._item_commits[a.id]||{},this._item_commits[a.id][a.revision_id]=!0,this.trigger("commit",a),"update"==a.action)(this._combine_insert_update&&!c&&b||this._combine_update_update&&c)&&(this.__remove_commit(a.revision_id),this._commits[d].data=BetaJS.Objs.extend(this._commits[d].data,a.data));else if("remove"==a.action)for(e in this._item_commits[a.id])f=this._commits[e],(b&&this._combine_insert_remove||"update"==f.action&&this._combine_update_remove)&&this.__remove_commit(e)},flush:function(a){a=a||this._revision_id;for(var b in this._commits){if(b>a)break;this.__remove_commit(b)}},serialize:function(a){var b=this._commits[a];return"insert"==commin.action?{insert:b.data}:"remove"==b.action?{remove:b.id}:"update"==b?{update:BetaJS.Objs.objectBy(b.id,b.data)}:null},serialize_bulk:function(a){a=a||this._revision_id;var b=[];for(var c in this._commits){if(c>a)break;b.push(this.serialize(c))}return b},revision_id:function(){return this._revision_id},_new_revision_id:function(){return this.cls.__revision_id+1}}],{__revision_id:0}),BetaJS.Exceptions.Exception.extend("BetaJS.Modelling.ModelException",{constructor:function(a,b){this._inherited(BetaJS.Modelling.ModelException,"constructor",b),this.__model=a},model:function(){return this.__model}}),BetaJS.Modelling.ModelException.extend("BetaJS.Modelling.ModelMissingIdException",{constructor:function(a){this._inherited(BetaJS.Modelling.ModelMissingIdException,"constructor",a,"No id given.")}}),BetaJS.Modelling.ModelException.extend("BetaJS.Modelling.ModelInvalidException",{constructor:function(a){var b=BetaJS.Objs.values(a.errors()).join("\n");this._inherited(BetaJS.Modelling.ModelInvalidException,"constructor",a,b)}}),BetaJS.Properties.Properties.extend("BetaJS.Modelling.SchemedProperties",{constructor:function(a){this._inherited(BetaJS.Modelling.SchemedProperties,"constructor");var b=this.cls.scheme();this._properties_changed={},this.__errors={};for(var c in b)"def"in b[c]?this.set(c,BetaJS.Types.is_function(b[c].def)?b[c].def():b[c].def):b[c].auto_create?this.set(c,b[c].auto_create(this)):this.set(c,null);this._properties_changed={},this.__errors={};for(c in a)this.set(c,a[c])},_unsetChanged:function(a){delete this._properties_changed[a]},_beforeSet:function(a,b){var c=this.cls.scheme();if(!(a in c))return b;var d=c[a];return d.type&&(b=BetaJS.Types.parseType(b,d.type)),d.transform&&(b=d.transform.apply(this,[b])),b},_afterSet:function(a,b){var c=this.cls.scheme();if(a in c&&(this._properties_changed[a]=b,delete this.__errors[a],c[a].after_set)){var d=BetaJS.Types.is_string(c[a].after_set)?this[c[a].after_set]:c[a].after_set;d.apply(this,[b])}},isChanged:function(){return!BetaJS.Types.is_empty(this._properties_changed)},properties_changed:function(){return this._properties_changed},get_all_properties:function(){var a={},b=this.cls.scheme();for(var c in b)a[c]=this.get(c);return a},validate:function(){this.trigger("validate");var a=[];for(var b in this.cls.scheme())a.push(this._validateAttr(b));return a.push(BetaJS.Promise.box(this._customValidate,this)),BetaJS.Promise.and(a).end().mapSuccess(function(a){var b=!0;return BetaJS.Objs.iter(a,function(a){b=b&&a}),b})},_customValidate:function(){return!0},_validateAttr:function(a){delete this.__errors[a];var b=this.cls.scheme(),c=b[a],d=c.validate;if(!d)return BetaJS.Promise.value(!0);BetaJS.Types.is_array(d)||(d=[d]);var e=this.get(a),f=[];return BetaJS.Objs.iter(d,function(a){f.push(BetaJS.Promise.box(a.validate,a,[e,this]))},this),BetaJS.Promise.and(f).end().mapSuccess(function(b){var c=!0;return BetaJS.Objs.iter(b,function(b){null!==b&&(c=!1,this.__errors[a]=b)},this),this.trigger("validate:"+a,c,this.__errors[a]),c},this)},setError:function(a,b){this.__errors[a]=b,this.trigger("validate:"+a,!(a in this.__errors),this.__errors[a])},errors:function(){return this.__errors},getError:function(a){return this.__errors[a]},asRecord:function(a){var b={},c=this.cls.scheme(),d=this.get_all_properties();a=a||{};for(var e in d)if(e in c){var f=c[e].tags||[],g={};BetaJS.Objs.iter(f,function(a){g[a]=!0});var h=!0;BetaJS.Objs.iter(a,function(a){h=h&&a in g},this),h&&(b[e]=d[e])}return b},setByTags:function(a,b){var c=this.cls.scheme();b=b||{};for(var d in a)if(d in c){var e=c[d].tags||[],f={};BetaJS.Objs.iter(e,function(a){f[a]=!0});var g=!0;BetaJS.Objs.iter(b,function(a){g=g&&a in f},this),g&&this.set(d,a[d])}},validation_exception_conversion:function(a){var b=a;if("instance_of"in a&&a.instance_of(BetaJS.Stores.RemoteStoreException))b=a.source();else if(!("status_code"in b&&"data"in b))return a;return b.status_code()==BetaJS.Net.HttpHeader.HTTP_STATUS_PRECONDITION_FAILED&&b.data()&&(BetaJS.Objs.iter(b.data(),function(a,b){this.setError(b,a)},this),a=new BetaJS.Modelling.ModelInvalidException(model)),a}},{_initializeScheme:function(){return{}},asRecords:function(a,b){return a.map(function(a){return a.asRecord(b)})},filterPersistent:function(a){var b={},c=this.scheme();for(var d in a)BetaJS.Types.is_defined(c[d].persistent)&&!c[d].persistent||!BetaJS.Types.is_defined(a[d])||(b[d]=a[d]);return b}},{scheme:function(){return this.__scheme=this.__scheme||this._initializeScheme(),this.__scheme}}),BetaJS.Modelling.SchemedProperties.extend("BetaJS.Modelling.AssociatedProperties",{constructor:function(a){this._inherited(BetaJS.Modelling.AssociatedProperties,"constructor",a),this.assocs=this._initializeAssociations();for(var b in this.assocs)this.__addAssoc(b,this.assocs[b])},__addAssoc:function(a,b){this[a]=function(){return b["yield"].apply(b,arguments)}},_initializeAssociations:function(){return{}},destroy:function(){for(var a in this.assocs)this.assocs[a].destroy();this._inherited(BetaJS.Modelling.AssociatedProperties,"destroy")},id:function(){return this.get(this.cls.primary_key())},hasId:function(){return this.has(this.cls.primary_key())}},{primary_key:function(){return"id"},_initializeScheme:function(){var a=this._inherited(BetaJS.Modelling.AssociatedProperties,"_initializeScheme");return a[this.primary_key()]={type:"id",tags:["read"]},a}}),BetaJS.Modelling.AssociatedProperties.extend("BetaJS.Modelling.Model",{constructor:function(a,b,c){this.__table=b,this.__options=BetaJS.Objs.extend({newModel:!0,removed:!1},c),this.__silent=1,this._inherited(BetaJS.Modelling.Model,"constructor",a),this.__silent=0,this.isNew()||(this._properties_changed={},this._registerEvents()),this.option("auto_create")&&this.isNew()&&this.save()},destroy:function(){this.__table.off(null,null,this),this.trigger("destroy"),this._inherited(BetaJS.Modelling.Model,"destroy")},option:function(a){var b=a in this.__options?this.__options:this.table().options();return b[a]},table:function(){return this.__table},isSaved:function(){return this.isRemoved()||!this.isNew()&&!this.isChanged()},isNew:function(){return this.option("newModel")},isRemoved:function(){return this.option("removed")},_registerEvents:function(){this.__table.on("update:"+this.id(),function(a){if(!this.isRemoved()){this.__silent++;for(var b in a)this._properties_changed[b]||this.set(b,a);this.__silent--}},this),this.__table.on("remove:"+this.id(),function(){this.isRemoved()||(this.trigger("remove"),this.__options.removed=!0)},this)},update:function(a){return this.__silent++,this.setAll(a),this.__silent--,this.isNew()?BetaJS.Promise.create(!0):this.save()},_afterSet:function(a,b,c,d){this._inherited(BetaJS.Modelling.Model,"_afterSet",a,b,c,d);var e=this.cls.scheme();a in e&&!(this.__silent>0)&&this.option("auto_update")&&!this.isNew()&&this.save()},save:function(){if(this.isRemoved())return BetaJS.Promise.create({});var a=this.option("save_invalid")?BetaJS.Promise.value(!0):this.validate();return a.mapSuccess(function(a){if(!a)return BetaJS.Promise.create(null,new BetaJS.Modelling.ModelInvalidException(this));var b;if(this.isNew())b=this.cls.filterPersistent(this.get_all_properties()),this.__options.type_column&&(b[this.__options.type_column]=model.cls.classname);else if(b=this.cls.filterPersistent(this.properties_changed()),BetaJS.Types.is_empty(b))return BetaJS.Promise.create(b);var c=this.isNew(),d=this.isNew()?this.__table.store().insert(b):this.__table.store().update(this.id(),b);return d.mapCallback(function(a,b){return a?BetaJS.Exceptions.ensure(this.validation_exception_conversion(a)):(this.__silent++,this.setAll(b),this.__silent--,this._properties_changed={},this.trigger("save"),c&&(this.__options.newModel=!1,this._registerEvents()),b)},this)},this)},remove:function(){return this.isNew()||this.isRemoved()?BetaJS.Promise.create(!0):this.__table.store().remove(this.id()).mapSuccess(function(a){return this.trigger("remove"),this.__options.removed=!0,a},this)}}),BetaJS.Class.extend("BetaJS.Modelling.Table",[BetaJS.Events.EventsMixin,{constructor:function(a,b,c){this._inherited(BetaJS.Modelling.Table,"constructor"),this.__store=a,this.__model_type=b,this.__options=BetaJS.Objs.extend({type_column:null,auto_create:!1,auto_update:!0,save_invalid:!1},c||{}),this.__store.on("insert",function(a){this.trigger("create",a,this.materializer(a))},this),this.__store.on("update",function(a,b){var c=a[this.primary_key()];this.trigger("update",c,b,a),this.trigger("update:"+c,b)},this),this.__store.on("remove",function(a){this.trigger("remove",a),this.trigger("remove:"+a)},this)},modelClass:function(a){return a?BetaJS.Types.is_string(a)?BetaJS.Scopes.resolve(a):a:BetaJS.Scopes.resolve(this.__model_type)},newModel:function(a,b){b=this.modelClass(b);var c=new b(a,this);return this.__options.auto_create&&c.save(),c},materialize:function(a){if(!a)return null;var b=this.modelClass(this.__options.type_column&&a[this.__options.type_column]?this.__options.type_column:null);return new b(a,this,{newModel:!1})},options:function(){return this.__options},store:function(){return this.__store},findById:function(a){return this.__store.get(a).mapSuccess(this.materialize,this)},findBy:function(a){return this.allBy(a,{limit:1}).mapSuccess(function(a){return a.next()})},allBy:function(a,b){return this.__store.query(a,b).mapSuccess(function(a){return new BetaJS.Iterators.MappedIterator(a,function(a){return this.materialize(a)},this)},this)},primary_key:function(){return BetaJS.Scopes.resolve(this.__model_type).primary_key()},all:function(a){return this.allBy({},a)},query:function(){return this.allBy.apply(this,arguments)},scheme:function(){return this.__model_type.scheme()},ensure_indices:function(){if(!("ensure_index"in this.__store))return!1;var a=this.scheme();for(var b in a)a[b].index&&this.__store.ensure_index(b);return!0},materializer:function(a){var b=this;return function(){return b.materialize(a)}}}]),BetaJS.Class.extend("BetaJS.Modelling.Associations.Association",{constructor:function(a,b){this._inherited(BetaJS.Modelling.Associations.Association,"constructor"),this._model=a,this._options=b||{},b.delete_cascade&&a.on("remove",function(){this.__delete_cascade()},this)},__delete_cascade:function(){this["yield"]().success(function(a){for(a=BetaJS.Iterators.ensure(a).toArray();a.hasNext();)a.next().remove({})},this)},"yield":function(){if("__cache"in this)return BetaJS.Promise.create(this.__cache);var a=this._yield();return this._options.cached&&a.callback(function(a,b){this.__cache=a?null:b},this),a},invalidate:function(){delete this.__cache}}),BetaJS.Modelling.Associations.Association.extend("BetaJS.Modelling.Associations.TableAssociation",{constructor:function(a,b,c,d){this._inherited(BetaJS.Modelling.Associations.TableAssociation,"constructor",a,d),this._foreign_table=b,this._foreign_key=c}}),BetaJS.Modelling.Associations.TableAssociation.extend("BetaJS.Modelling.Associations.HasManyAssociation",{_id:function(){return this._primary_key?this._model.get(this._primary_key):this._model.id()},_yield:function(){return this.allBy()},"yield":function(){return this._inherited(BetaJS.Modelling.Associations.HasManyAssociation,"yield").mapSuccess(function(a){return new BetaJS.Iterators.ArrayIterator(a)})},findBy:function(){return this._foreign_table.findBy(BetaJS.Objs.objectBy(this._foreign_key,this._id()))},allBy:function(a,b){return this._foreign_table.allBy(BetaJS.Objs.extend(BetaJS.Objs.objectBy(this._foreign_key,b?b:this._id(),a)))}}),BetaJS.Modelling.Associations.HasManyAssociation.extend("BetaJS.Modelling.Associations.HasManyThroughArrayAssociation",{_yield:function(){var a=BetaJS.Promise.create(),b=BetaJS.Promise.and();return BetaJS.Objs.iter(this._model.get(this._foreign_key),function(a){b=b.and(this._foreign_table.findById(a))},this),b.forwardError(a).success(function(b){a.asyncSuccess(BetaJS.Objs.filter(b,function(a){return!!a}))}),a}}),BetaJS.Modelling.Associations.TableAssociation.extend("BetaJS.Modelling.Associations.HasOneAssociation",{_yield:function(a){var b=a?a:this._primary_key?this._model.get(this._primary_key):this._model.id();return this._foreign_table.findBy(BetaJS.Objs.objectBy(this._foreign_key,b))}}),BetaJS.Modelling.Associations.TableAssociation.extend("BetaJS.Modelling.Associations.BelongsToAssociation",{_yield:function(){var a=this._model.get(this._foreign_key);return a?this._primary_key?this._foreign_table.findBy(BetaJS.Objs.objectBy(this._primary_key,a)):this._foreign_table.findById(a):BetaJS.Promise.value(null)}}),BetaJS.Modelling.Associations.Association.extend("BetaJS.Modelling.Associations.ConditionalAssociation",{_yield:function(){var a=this.assoc();return a["yield"].apply(a,arguments)},assoc:function(){return this._model.assocs[this._options.conditional(this._model)]}}),BetaJS.Modelling.Associations.Association.extend("BetaJS.Modelling.Associations.PolymorphicHasOneAssociation",{constructor:function(a,b,c,d){this._inherited(BetaJS.Modelling.Associations.PolymorphicHasOneAssociation,"constructor",a,d),this._foreign_table_key=b,this._foreign_key=c,d.primary_key&&(this._primary_key=d.primary_key)},_yield:function(a){var b=a?a:this._primary_key?this._model.get(this._primary_key):this._model.id(),c=BetaJS.Scopes.resolve(this._model.get(this._foreign_table_key));return c.findBy(BetaJS.Objs.objectBy(this._foreign_key,b))}}),BetaJS.Class.extend("BetaJS.Modelling.Validators.Validator",{validate:function(){return null}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.ConditionalValidator",{constructor:function(a,b){this._inherited(BetaJS.Modelling.Validators.ConditionalValidator,"constructor"),this.__condition=a,this.__validator=BetaJS.Types.is_array(b)?b:[b]},validate:function(a,b){if(!this.__condition(a,b))return null;for(var c=0;c<this.__validator.length;++c){var d=this.__validator[c].validate(a,b);if(null!==d)return d}return null}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.EmailValidator",{constructor:function(a){this._inherited(BetaJS.Modelling.Validators.EmailValidator,"constructor"),this.__error_string=a?a:"Not a valid email address"},validate:function(a){return BetaJS.Strings.is_email_address(a)?null:this.__error_string}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.LengthValidator",{constructor:function(a){this._inherited(BetaJS.Modelling.Validators.LengthValidator,"constructor"),this.__min_length=BetaJS.Types.is_defined(a.min_length)?a.min_length:null,this.__max_length=BetaJS.Types.is_defined(a.max_length)?a.max_length:null,this.__error_string=BetaJS.Types.is_defined(a.error_string)?a.error_string:null,this.__error_string||(null!==this.__min_length?this.__error_string=null!==this.__max_length?"Between "+this.__min_length+" and "+this.__max_length+" characters":"At least "+this.__min_length+" characters":null!==this.__max_length&&(this.__error_string="At most "+this.__max_length+" characters"))},validate:function(a){return null!==this.__min_length&&(!a||a.length<this.__min_length)?this.__error_string:null!==this.__max_length&&a.length>this.__max_length?this.__error_string:null}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.PresentValidator",{constructor:function(a){this._inherited(BetaJS.Modelling.Validators.PresentValidator,"constructor"),this.__error_string=a?a:"Field is required"},validate:function(a){return BetaJS.Types.is_null(a)||""===a?this.__error_string:null}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.UniqueValidator",{constructor:function(a,b){this._inherited(BetaJS.Modelling.Validators.UniqueValidator,"constructor"),this.__key=a,this.__error_string=b?b:"Key already present"},validate:function(a,b){var c={};return c[this.__key]=a,b.table().findBy(c).mapSuccess(function(a){return!a||!b.isNew()&&b.id()==a.id()?null:this.__error_string},this)}});