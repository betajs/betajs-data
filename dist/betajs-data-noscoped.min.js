/*!
betajs-data - v1.0.144 - 2019-04-07
Copyright (c) Oliver Friedmann,Pablo Iglesias
Apache-2.0 Software License.
*/

(function(){var a=this.subScope();a.binding("module","global:BetaJS.Data"),a.binding("base","global:BetaJS"),a.define("module:",function(){return{guid:"70ed7146-bb6d-4da4-97dc-5a8e2d23a23f",version:"1.0.144",datetime:1554679198542}}),a.assumeVersion("base:version","~1.0.141"),a.define("module:Collections.AbstractQueryCollection",["base:Collections.Collection","base:Objs","base:Types","base:Comparators","base:Promise","base:Class","module:Queries.Constrained","module:Queries","module:Queries.ConstrainedQueryBuilder"],function(t,a,e,i,c,r,_,s,o,n){return t.extend({scoped:n},function(n){return{constructor:function(t,e,i){i=i||{},n.constructor.call(this,{release_references:!0,uniqueness:i.uniqueness,indices:i.indices}),o.is_instance_of(e)&&(this._rangeQueryBuilder=i.range_query_builder,this.__queryBuilder=e,e=this.__queryBuilder.getQuery(),this._rangeQueryBuilder&&(e=a.extend(e,this._rangeQueryBuilder.getQuery())),i=a.extend(i,this.__queryBuilder.getOptions()),this.__queryBuilder.on("change",function(){var t=this.__queryBuilder.getConstrainedQuery();this._rangeQueryBuilder&&(t.query=a.extend(this._rangeQueryBuilder.getQuery(),t.query)),this.update(t)},this),this._rangeQueryBuilder&&this._rangeQueryBuilder.on("change",function(){var t=this.__queryBuilder.getConstrainedQuery();this.rangeSuperQueryIncrease(a.extend(this._rangeQueryBuilder.getQuery(),t.query))},this)),this._id_key=this._id_key||i.id_key||"id",this._secondary_ident=i.secondary_ident,this._source=t,this._complete=!1,this._active=i.active||!1,this._incremental=!("incremental"in i)||i.incremental,this._active_bounds=!("active_bounds"in i)||i.active_bounds,this._bounds_attribute=i.bounds_attribute,this._enabled=!1,this._range=i.range||null,this._forward_steps=i.forward_steps||null,this._backward_steps=i.backward_steps||null,this._async=i.async||!1,this._active_in_direction="active_in_direction"in i&&i.active_in_direction,this._active&&(this.on("add",function(t){this._watchItem(t.get(this._id_key))},this),this.on("remove",function(t){this._unwatchItem(t.get(this._id_key))},this)),this._query={query:{},options:{skip:0,limit:null,sort:null}},this.update(a.tree_extend({query:{},options:{skip:i.skip||0,limit:i.limit||i.range||null,sort:i.sort||null}},e?e.query||e.options?e:{query:e}:{})),i.auto&&this.enable()},destroy:function(){this.disable(),this._watcher()&&(this._watcher().unwatchInsert(null,this),this._watcher().unwatchItem(null,this)),this.__queryBuilder&&this.__queryBuilder.off(null,null,this),n.destroy.call(this)},source:function(){return this._source},paginate:function(t){return this.update({options:{skip:t*this._range,limit:this._range}})},paginate_index:function(){return Math.floor(this.getSkip()/this._range)},paginate_next:function(){return this.isComplete()?c.create(!0):this.paginate(this.paginate_index()+1)},paginate_prev:function(){return 0<this.paginate_index()?this.paginate(this.paginate_index()-1):c.create(!0)},increase_forwards:function(t){return t=t||this._forward_steps,this.isComplete()?c.create(!0):this.update({options:{limit:this.getLimit()+t}})},increase_backwards:function(t){return t=t||this._backward_steps,this.getSkip()?this.update({options:{skip:Math.max(this.getSkip()-t,0),limit:this.getLimit()?this.getLimit()+this.getSkip()-Math.max(this.getSkip()-t,0):null}}):c.create(!0)},bounds_forwards:function(t){var e=this._query.query[this._bounds_attribute].$lt;this._query.query[this._bounds_attribute].$lt=t;var i=a.clone(this._query.query,2);return i[this._bounds_attribute].$gte=e,this._execute({query:i},!0)},bounds_backwards:function(t){var e=this._query.query[this._bounds_attribute].$gte;this._query.query[this._bounds_attribute].$gte=t;var i=a.clone(this._query.query,2);return i[this._bounds_attribute].$lt=e,this._execute({query:i},!0)},get_ident:function(t){var e=r.is_class_instance(t)?t.get(this._id_key):t[this._id_key];return!e&&this._secondary_ident&&(e=this._secondary_ident(t)),e},getQuery:function(){return this._query},getSkip:function(){return this._query.options.skip||0},getLimit:function(){return this._query.options.limit||null},update:function(t){return this.trigger("collection-updating"),this.__update(t).callback(function(){this.trigger("collection-updated")},this)},__update:function(t){var e=!!t.query;t=_.rectify(t);var i=this._query.options.skip||0,n=this._query.options.limit||null;if(e&&(this._query.query=t.query),this._query.options=a.extend(this._query.options,t.options),!this._enabled)return c.create(!0);if(e||"sort"in t.options||!this._incremental)return this.refresh(!0);var r="skip"in t.options?t.options.skip||0:i,s="limit"in t.options?t.options.limit||null:n;if(r===i&&s===n)return c.create(!0);if(s&&r+s<=i||n&&i+n<=r)return this.refresh(!0);for(;i<r&&(null===n||0<n);)this.remove(this.getByIndex(0)),i++,n--;var o=c.create(!0);if(r<i){var u=i-r;null!==s&&(u=Math.min(u,s)),o=this._execute(a.tree_extend(a.clone(this._query,2),{options:{skip:r,limit:u}},2),!0),r+=u,null!==s&&(s-=u)}if(!n||s&&s<=n){if(s)for(;this.count()>s;)this.remove(this.getByIndex(this.count()-1));return o}return o.and(this._execute(a.tree_extend(a.clone(this._query,2),{options:{skip:i+n,limit:s?s-n:null}},2),!0))},enable:function(){this._enabled||(this._enabled=!0,this.refresh())},disable:function(){this._enabled&&(this._enabled=!1,this.clear(),this._unwatchInsert())},refresh:function(t){return t&&!this._incremental&&this.clear(),this._query.options.sort&&!e.is_empty(this._query.options.sort)?this.set_compare(i.byObject(this._query.options.sort)):this.set_compare(null),this._unwatchInsert(),this._active&&this._watchInsert(this._query),this._execute(this._query,!(t&&this._incremental))},rangeSuperQueryIncrease:function(t){var e=s.rangeSuperQueryDiffQuery(t,this._query.query);if(!e)throw"Range Super Query expected";return this._query.query=t,this._unwatchInsert(),this._active&&this._watchInsert(this._query),this._execute({query:e,options:this._query.options},!0)},isEnabled:function(){return this._enabled},_execute:function(t,e){return this.__executePromise?this.__executePromise.mapCallback(function(){return this._execute(t,e)},this):this._subExecute(t.query,t.options).mapSuccess(function(t){return e&&this._async?t.hasNext()?(this.__executePromise=t.asyncIterate(this.replace_object,this),this.__executePromise.callback(function(){this.__executePromise=null},this)):(this._complete=!0,t.destroy()):this.replace_objects(t.asArray(),e),!0},this)},_subExecute:function(t,e){return this._source.query(t,e)},isComplete:function(){return this._complete},isValid:function(t){return s.evaluate(this._query.query,t)},_materialize:function(t){return t},_activeCreate:function(t){if(this._active&&this._enabled&&this.isValid(t)){if(this._active_in_direction&&this._query.options.sort&&this._query.options.limit&&this.count()>=this._query.options.limit){var e=this.getByIndex(this.count()-1).getAll();if(i.byObject(this._query.options.sort)(e,t)<0)return}this.add(this._materialize(t)),this._query.options.limit&&this.count()>this._query.options.limit&&(this._active_bounds?this._query.options.limit++:this.remove(this.getByIndex(this.count()-1)))}},_activeRemove:function(t){if(this._active&&this._enabled){var e=this.getById(t);e&&(this.remove(e),null!==this._query.options.limit&&this._active_bounds&&this._query.options.limit--)}},_activeUpdate:function(t,e,i){if(this._active&&this._enabled){var n=this.getById(t),r=a.extend(i,e);n?this.isValid(a.extend(a.clone(n.getAll(),1),r))?n.setAllNoChange?n.setAllNoChange(e):n.setAll(e):this._activeRemove(t):this._activeCreate(r)}},_watcher:function(){return null},_watchInsert:function(t){this._watcher()&&this._watcher().watchInsert(t,this)},_unwatchInsert:function(){this._watcher()&&this._watcher().unwatchInsert(null,this)},_watchItem:function(t){this._watcher()&&this._watcher().watchItem(t,this)},_unwatchItem:function(t){this._watcher()&&this._watcher().unwatchItem(t,this)}}})}),a.define("module:Collections.StoreQueryCollection",["module:Collections.AbstractQueryCollection","base:Objs"],function(t,r,e){return t.extend({scoped:e},function(n){return{constructor:function(i,t,e){n.constructor.call(this,i,t,r.extend({id_key:i.id_key()},e)),(this._source=i).on("insert",this._activeCreate,this),i.on("remove",this._activeRemove,this),i.on("update",function(t,e){this._activeUpdate(i.id_of(t),e,t)},this)},destroy:function(){this._source.off(null,null,this),n.destroy.call(this)},get_ident:function(t){return t.get(this._source.id_key())},_watcher:function(){return this._source.watcher()}}})}),a.define("module:Collections.TableQueryCollection",["module:Collections.AbstractQueryCollection","base:Objs"],function(t,r,e){return t.extend({scoped:e},function(n){return{constructor:function(t,e,i){n.constructor.call(this,t,e,r.extend({id_key:t.primary_key()},i)),t.on("create",this._activeCreate,this),t.on("remove",this._activeRemove,this),t.on("update",this._activeUpdate,this)},destroy:function(){this._source.off(null,null,this),n.destroy.call(this)},_materialize:function(t){return this._source.materialize(t)},_watcher:function(){return this._source.store().watcher()}}})}),a.define("module:Stores.DatabaseStore",["module:Stores.BaseStore","base:Objs","module:Queries","module:Queries.Constrained","base:Iterators.MappedIterator"],function(t,n,e,i,r,s){return t.extend({scoped:s},function(s){return{constructor:function(t,e,i,n,r){this.__database=t,this.__table_name=e,this.__table=this.__database.getTable(this.__table_name,r),s.constructor.call(this,{id_key:i||this.__table.primary_key()}),this.__separate_ids=n,this.__map_ids=!this.__separate_ids&&this.id_key()!==this.__table.primary_key()},table:function(){return this.__table},_remove:function(t){return this.__separate_ids?this.table().removeRow(this.id_row(t)):this.table().removeById(t)},_get:function(t){var e=this.__separate_ids?this.table().findOne(this.id_row(t)):this.table().findById(t);return this.__map_ids?e.mapSuccess(function(t){return t&&(t[this.id_key()]=t[this.table().primary_key()],delete t[this.table().primary_key()]),t},this):e},_update:function(t,e){return this.__separate_ids?this.table().updateRow(this.id_row(t),e):this.table().updateById(t,e)},_query_capabilities:function(){return i.fullConstrainedQueryCapabilities(e.fullQueryCapabilities())},_insert:function(t){var e=this.table().insertRow(t);return this.__map_ids?e.mapSuccess(function(t){return t[this.id_key()]=t[this.table().primary_key()],delete t[this.table().primary_key()],t},this):e},_query:function(t,e){this.__map_ids&&t[this.id_key()]&&((t=n.clone(t,1))[this.table().primary_key()]=t[this.id_key()],delete t[this.id_key()]);var i=this.table().find(t,e);return this.__map_ids?i.mapSuccess(function(t){return new r(t,function(t){return t[this.id_key()]=t[this.table().primary_key()],delete t[this.table().primary_key()],t},this).auto_destroy(t,!0)},this):i},_ensure_index:function(t){this.table().ensureIndex(t)},clear:function(t){return t?s.clear.call(t):this.table().clear()}}})}),a.define("module:Databases.DatabaseTable",["base:Class","base:Objs","base:Iterators.MappedIterator"],function(t,r,i,e){return t.extend({scoped:e},function(n){return{constructor:function(t,e,i){n.constructor.call(this),this._database=t,this._table_name=e,this._table_options=i||{}},primary_key:function(){return"id"},findOne:function(t,e){return this._findOne(this._encode(t),e).mapSuccess(function(t){return t?this._decode(t):null},this)},_findOne:function(t,e){return(e=e||{}).limit=1,this._find(t,e).mapSuccess(function(t){var e=t.next();return t.destroy(),e})},_encode:function(t){return t},_decode:function(t){return t},_decodeMany:function(t){return t},_find:function(t,e){},find:function(t,e){return this._find(this._encode(t),e).mapSuccess(function(t){return new i(t,this._decode,this).auto_destroy(t,!0)},this)},findById:function(t){return this.findOne(r.objectBy(this.primary_key(),t))},count:function(t){return this._count(this._encode(t))},_insertRow:function(t){},_insertRows:function(t){},_removeRow:function(t){},_updateRow:function(t,e){},_count:function(t){return this.find(t).mapSuccess(function(t){for(var e=0;t.hasNext();)e++,t.next();return t.destroy(),e})},insertRow:function(t){return this._insertRow(this._encode(t)).mapSuccess(this._decode,this)},insertRows:function(t){var i=[];return r.iter(t,function(t,e){i.push(this._encode(t))},this),this._insertRows(i).mapSuccess(this._decodeMany,this)},removeRow:function(t){return this._removeRow(this._encode(t))},updateRow:function(t,e){return this._updateRow(this._encode(t),this._encode(e)).mapSuccess(this._decode,this)},removeById:function(t){return this.removeRow(r.objectBy(this.primary_key(),t))},updateById:function(t,e){return this.updateRow(r.objectBy(this.primary_key(),t),e)},ensureIndex:function(t){},_clear:function(){return this._removeRow({})},clear:function(){return this._clear()},renameTable:function(t){return this._renameTable(t).success(function(){this._database._renameTableCache(t,this._table_name),this._table_name=t},this)},_renameTable:function(t){throw"Unsupported"}}})}),a.define("module:Databases.Database",["base:Class"],function(t,e){return t.extend({scoped:e},function(t){return{constructor:function(){t.constructor.apply(this),this.__tableCache={}},_tableClass:function(){return null},getTable:function(t,e){if(!this.__tableCache[t]){var i=this._tableClass();this.__tableCache[t]=this.auto_destroy(new i(this,t,e))}return this.__tableCache[t]},_renameTableCache:function(t,e){this.__tableCache[e]=this.__tableCache[t],delete this.__tableCache[t]}}})}),a.define("module:Databases.Migrator",["base:Class","base:Types"],function(t,o,e){return t.extend({scoped:e},function(t){return{constructor:function(){t.constructor.call(this),this.__version=null,this.__migrations=[],this.__sorted=!0},version:function(t){return this.__version||(this.__version=this._getVersion()),this.__version},_getVersion:function(){},_setVersion:function(t){},_log:function(t){},migrations:function(){return this.__sorted||(this.__migrations.sort(function(t,e){return t.version-e.version}),this.__sorted=!0),this.__migrations},register:function(t){this.__migrations.push(t),this.__sorted=!1},_indexByVersion:function(t){for(var e=0;e<this.__migrations.length;++e){if(t==this.__migrations[e].version)return e;if(t<this.__migrations[e].version)return e-1}return this.__migrations.length},migrate:function(t){for(var e=this._indexByVersion(this.version()),i=o.is_defined(t)?this._indexByVersion(t):this.__migrations.length-1;e<i;){var n=this.__migrations[e+1];this._log("Migrate "+n.version+": "+n.title+" - "+n.description+"...\n");try{n.migrate(),this._setVersion(this.__migrations[e+1].version),e++,this._log("Successfully migrated "+n.version+".\n")}catch(r){this._log("Failure! Rolling back "+n.version+"...\n");try{if("partial_rollback"in n)n.partial_rollback();else{if(!("rollback"in n))throw"No rollback defined";n.rollback()}}catch(s){throw this._log("Failure! Couldn't roll back "+n.version+"!\n"),s}throw this._log("Rolled back "+n.version+"!\n"),r}}},rollback:function(t){for(var e=this._indexByVersion(this.version()),i=o.is_defined(t)?this._indexByVersion(t):e-1;i<e;){var n=this.__migrations[e];this._log("Rollback "+n.version+": "+n.title+" - "+n.description+"...\n");try{n.rollback(),this._setVersion(1<=e?this.__migrations[e-1].version:0),e--,this._log("Successfully rolled back "+n.version+".\n")}catch(r){throw this._log("Failure! Couldn't roll back "+n.version+"!\n"),r}}}}})}),a.define("module:Stores.AbstractIndex",["base:Class","base:Comparators","base:Objs","base:Functions"],function(t,o,u,e,i){return t.extend({scoped:i},function(s){return{constructor:function(t,i,e,n){s.constructor.call(this),this._options=u.extend({exact:!0,ignoreCase:!1},n),this._compare=e||o.byValue,this._store=t,this.__row_count=0,this._initialize();var r=t.id_key();t.query({}).value().iterate(function(t){this.__row_count++,this._insert(t[r],t[i])},this),t.on("insert",function(t){this.__row_count++,this._insert(t[r],t[i])},this),t.on("remove",function(t){this.__row_count--,this._remove(t)},this),t.on("update",function(t,e){i in e&&this._update(t,e[i])},this)},_initialize:function(){},destroy:function(){this._store.off(null,null,this),s.destroy.call(this)},compare:function(){return this._compare.apply(arguments)},comparator:function(){return e.as_method(this,this._compare)},info:function(){return{row_count:this.__row_count,key_count:this._key_count(),key_count_ic:this._key_count_ic()}},options:function(){return this._options},iterate:function(t,e,i,n){this._iterate(t,e,i,n)},itemIterate:function(t,e,i,n){this.iterate(t,e,function(t,e){return i.call(n,t,this._store.get(e).value())},this)},iterate_ic:function(t,e,i,n){this._iterate_ic(t,e,i,n)},itemIterateIc:function(t,e,i,n){this.iterate_ic(t,e,function(t,e){return i.call(n,t,this._store.get(e).value())},this)},_iterate:function(t,e,i,n){},_iterate_ic:function(t,e,i,n){},_insert:function(t,e){},_remove:function(t){},_update:function(t,e){},_key_count:function(){},_key_count_ic:function(){},key_count_left_ic:function(t){},key_count_right_ic:function(t){},key_count_distance_ic:function(t,e){},key_count_left:function(t){},key_count_right:function(t){},key_count_distance:function(t,e){}}})}),a.define("module:Stores.MemoryIndex",["module:Stores.AbstractIndex","base:Structures.TreeMap","base:Objs","base:Types"],function(t,s,r,o,e){return t.extend({scoped:e},function(t){return{_initialize:function(){this._options.exact&&(this._exactMap=s.empty(this._compare)),this._options.ignoreCase&&(this._ignoreCaseMap=s.empty(this._compare)),this._idToKey={}},__insert:function(t,e,i){var n=s.find(e,i);return n?n[t]=!0:i=s.add(e,r.objectBy(t,!0),i),i},_insert:function(t,e){this._idToKey[t]=e,this._options.exact&&(this._exactMap=this.__insert(t,e,this._exactMap)),this._options.ignoreCase&&(this._ignoreCaseMap=this.__insert(t,e,this._ignoreCaseMap))},__remove:function(t,e,i){var n=s.find(t,e);return delete n[i],o.is_empty(n)&&(e=s.remove(t,e)),e},_remove:function(t){var e=this._idToKey[t];delete this._idToKey[t],this._options.exact&&(this._exactMap=this.__remove(e,this._exactMap,t)),this._options.ignoreCase&&(this._ignoreCaseMap=this.__remove(e,this._ignoreCaseMap,t))},_update:function(t,e){this._idToKey[t]!=e&&(this._remove(t),this._insert(t,e))},_iterate:function(t,e,n,r){s.iterate_from(t,this._exactMap,function(t,e){for(var i in e)if(!1===n.call(r,t,i))return!1;return!0},this,!e)},_iterate_ic:function(t,e,n,r){s.iterate_from(t,this._ignoreCaseMap,function(t,e){for(var i in e)if(!1===n.call(r,t,i))return!1;return!0},this,!e)},_key_count:function(){return this._options.exact?s.length(this._exactMap):0},_key_count_ic:function(){return this._options.ignoreCase?s.length(this._ignoreCaseMap):0},key_count_left_ic:function(t){return s.treeSizeLeft(t,this._ignoreCaseMap)},key_count_right_ic:function(t){return s.treeSizeRight(t,this._ignoreCaseMap)},key_count_distance_ic:function(t,e){return s.distance(t,e,this._ignoreCaseMap)},key_count_left:function(t){return s.treeSizeLeft(t,this._exactMap)},key_count_right:function(t){return s.treeSizeRight(t,this._exactMap)},key_count_distance:function(t,e){return s.distance(t,e,this._exactMap)}}})}),a.define("module:Queries.Constrained",["module:Queries","base:Types","base:Objs","base:Tokens","base:Comparators"],function(a,e,n,i,t){return{rectify:function(t){var e="options"in t||"query"in t?t:{query:t};return n.extend({query:{},options:{}},e)},skipValidate:function(t,e){return!("skip"in t&&e)||e.skip},limitValidate:function(t,e){return!("limit"in t&&e)||e.limit},sortValidate:function(t,i){if("sort"in t){if(i&&!i.sort)return!1;if(i&&e.is_object(i.sort))if(!n.all(t.sort,function(t,e){return e in i.sort}))return!1}return!0},constraintsValidate:function(e,i){return n.all(["skip","limit","sort"],function(t){return this[t+"Validate"].call(this,e,i)},this)},validate:function(t,e){return t=this.rectify(t),this.constraintsValidate(t.options,e)&&a.validate(t.query,e.query||{})},fullConstrainedQueryCapabilities:function(t){return{query:t||a.fullQueryCapabilities(),skip:!0,limit:!0,sort:!0}},normalize:function(t){return t=this.rectify(t),{query:a.normalize(t.query),options:t.options}},serialize:function(t){return JSON.stringify(this.rectify(t))},unserialize:function(t){return JSON.parse(t)},hash:function(t){return i.simple_hash(this.serialize(t))},subsumizes:function(t,e){t=this.rectify(t),e=this.rectify(e);var i=t.options.skip||0,n=e.options.skip||0,r=t.options.limit||null,s=e.options.limit||null,o=t.options.sort,u=t.options.sort;if(n<i)return!1;if(r){if(!s)return!1;if(r+i<s+n)return!1}return(!i&&!r||!o&&!u||JSON.stringify(o)==JSON.stringify(u))&&a.subsumizes(t.query,e.query)},mergeable:function(t,e){if(t=this.rectify(t),e=this.rectify(e),a.serialize(t.query)!=a.serialize(e.query))return!1;var i=t.options,n=e.options;return JSON.stringify(i.sort||{})==JSON.stringify(n.sort||{})&&("skip"in i?"skip"in n?i.skip<=n.skip?!i.limit||i.skip+i.limit>=n.skip:!n.limit||n.skip+n.limit>=i.skip:!n.limit||n.limit>=i.skip:!("skip"in n)||!i.limit||i.limit>=n.skip)},merge:function(t,e){t=this.rectify(t),e=this.rectify(e);var i=t.options,n=e.options;return{query:t.query,options:{skip:"skip"in i&&"skip"in n?Math.min(i.skip,n.skip):null,limit:"limit"in i&&"limit"in n?Math.max(i.limit,n.limit):null,sort:t.sort}}}}}),a.define("module:Queries",["base:Types","base:Sort","base:Objs","base:Class","base:Tokens","base:Iterators.ArrayIterator","base:Iterators.FilteredIterator","base:Strings","base:Comparators"],function(o,e,l,t,i,n,r,s,d){return{SYNTAX_PAIR_KEYS:{$or:{evaluate_combine:l.exists},$and:{evaluate_combine:l.all}},SYNTAX_CONDITION_KEYS:{$in:{target:"atoms",evaluate_combine:l.exists,evaluate_single:function(t,e){return t===e}},$gt:{target:"atom",evaluate_single:function(t,e){return e<t}},$lt:{target:"atom",evaluate_single:function(t,e){return t<e}},$gte:{target:"atom",evaluate_single:function(t,e){return e<=t}},$lte:{target:"atom",evaluate_single:function(t,e){return t<=e}},$eq:{target:"atom",evaluate_single:function(t,e){return t===e}},$ne:{target:"atom",evaluate_single:function(t,e){return t!==e}},$regex:{target:"atom",evaluate_single:function(t,e,i){return s.cachedRegExp(e,i.$options).test(t)}},$options:{target:"atom",evaluate_single:function(t,e){return!0}},$elemMatch:{target:"query",no_index_support:!0,evaluate_combine:l.exists}},validate:function(t,e){return this.validate_query(t,e)},validate_atoms:function(t,e){return o.is_array(t)&&l.all(t,function(t){return this.validate_atom(t,e)},this)},validate_atom:function(t,e){return!e||!!e.atom},validate_queries:function(t,e){return o.is_array(t)&&l.all(t,function(t){return this.validate_query(t,e)},this)},validate_query:function(t,i){return o.is_object(t)&&l.all(t,function(t,e){return this.validate_pair(t,e,i)},this)},validate_pair:function(t,e,i){return e in this.SYNTAX_PAIR_KEYS?!(i&&!(i.bool&&e in i.bool))&&this.validate_queries(t,i):this.validate_value(t,i)},is_query_atom:function(t){return null===t||!o.is_object(t)||"[object Object]"!==t.toString()||l.all(t,function(t,e){return!(e in this.SYNTAX_CONDITION_KEYS)},this)},validate_value:function(t,e){return this.is_query_atom(t)?this.validate_atom(t,e):this.validate_conditions(t,e)},validate_conditions:function(t,i){return o.is_object(t)&&l.all(t,function(t,e){return this.validate_condition(t,e,i)},this)},validate_condition:function(t,e,i){if(i&&(!i.conditions||!(e in i.conditions)))return!1;var n=this.SYNTAX_CONDITION_KEYS[e];return!!n&&("atoms"===n.target?this.validate_atoms(t):"atom"===n.target?this.validate_atom(t):"query"===n.target&&this.validate_query(t,i))},normalize:function(t){return e.deep_sort(t)},serialize:function(t){return JSON.stringify(t)},unserialize:function(t){return JSON.parse(t)},hash:function(t){return i.simple_hash(this.serialize(t))},dependencies:function(t){return Object.keys(this.dependencies_query(t,{}))},dependencies_queries:function(t,e){return l.iter(t,function(t){e=this.dependencies_query(t,e)},this),e},dependencies_query:function(t,i){return l.iter(t,function(t,e){i=this.dependencies_pair(t,e,i)},this),i},dependencies_pair:function(t,e,i){return e in this.SYNTAX_PAIR_KEYS?this.dependencies_queries(t,i):this.dependencies_key(e,i)},dependencies_key:function(t,e){return e[t]=(e[t]||0)+1,e},evaluate:function(t,e){return this.evaluate_query(t,e)},evaluate_query:function(t,i){return l.all(t,function(t,e){return this.evaluate_pair(t,e,i)},this)},evaluate_pair:function(t,e,i){return e in this.SYNTAX_PAIR_KEYS?this.SYNTAX_PAIR_KEYS[e].evaluate_combine.call(l,t,function(t){return this.evaluate_query(t,i)},this):this.evaluate_value(t,i[e])},evaluate_value:function(t,e){return this.is_query_atom(t)?this.evaluate_atom(t,e):this.evaluate_conditions(t,e)},evaluate_atom:function(t,e){return t===e},evaluate_conditions:function(i,n){return l.all(i,function(t,e){return this.evaluate_condition(t,e,n,i)},this)},evaluate_condition:function(e,t,i,n){var r=this.SYNTAX_CONDITION_KEYS[t];return"atoms"===r.target?r.evaluate_combine.call(l,e,function(t){return r.evaluate_single.call(this,i,t,n)},this):"atom"===r.target?r.evaluate_single.call(this,i,e,n):"query"===r.target?r.evaluate_combine.call(l,i,function(t){return o.is_object(e)&&o.is_object(t)?this.evaluate_query(e,t):this.evaluate_query({value:e},{value:t})},this):void 0},rangeSuperQueryDiffQuery:function(t,a){if(!l.keyEquals(t,a))return!1;var c=l.objectify(["$gt","$lt","$gte","$lte"]),_=[],h={};return!!l.iter(t,function(i,t){i=l.clone(i,1);var n=l.clone(a[t],1);if(l.iter(c,function(t,e){i[e]&&n[e]&&i[e]===n[e]&&(delete i[e],delete n[e])}),d.deepEqual(i,n,-1))return h[t]=i,!0;var e=l.filter(i,function(t,e){return!c[e]}),r=l.filter(n,function(t,e){return!c[e]});if(!d.deepEqual(e,r,-1))return!1;var s=l.clone(i,1);if(n.$gt||n.$gte){if(n.$lt||n.$lte){if((i.$gt||i.$gte)&&(i.$gt||i.$gte)>(n.$gt||n.$gte))return!1;if((i.$lt||i.$lte)&&(i.$lt||i.$lte)<(n.$lt||n.$lte))return!1;var o=l.clone(s,1),u=l.clone(s,1);return delete o.$lt,delete o.$lte,o[n.$gt?"$lte":"$lt"]=n.$gt||n.$gte,delete u.$gt,delete u.$gte,u[n.$lt?"$gte":"$gt"]=n.$lt||n.$lte,_.push(l.objectBy(t,o)),_.push(l.objectBy(t,u)),!0}if(i.$lt||i.$lte)return!1;if((i.$gt||i.$gte)&&(i.$gt||i.$gte)>(n.$gt||n.$gte))return!1;s[n.$gt?"$lte":"$lt"]=n.$gt||n.$gte}else{if(!n.$lt&&!n.$lte)return!1;if(i.$gt||i.$gte)return!1;if((i.$lt||i.$lte)&&(i.$lt||i.$lte)<(n.$lt||n.$lte))return!1;s[n.$lt?"$gte":"$gt"]=n.$lt||n.$lte}h[t]=s})&&(0<_.length&&(h.$or=h.$or?h.$or.concat(_):_),h)},subsumizes:function(t,e){if(!o.is_object(t)||!o.is_object)return t==e;for(var i in t)if(!(i in e&&this.subsumizes(t[i],e[i])))return!1;return!0},fullQueryCapabilities:function(){var i={};l.iter(this.SYNTAX_PAIR_KEYS,function(t,e){i[e]=!0});var n={};return l.iter(this.SYNTAX_CONDITION_KEYS,function(t,e){n[e]=!0}),{atom:!0,bool:i,conditions:n}},mergeConditions:function(t,e){o.is_object(t)||(t={$eq:t}),o.is_object(e)||(e={$eq:e});var n=!1,r=l.clone(t,1);return l.iter(e,function(t,e){if(n)return!1;if(e in r){var i=r[e];s.starts_with(e,"$eq")&&(n=!0),s.starts_with(e,"$in")&&(i=l.objectify(i),r[e]=[],n=!0,l.iter(t,function(t){i[t]&&(r[e].push(t),n=!1)})),s.starts_with(e,"$gt")&&d.byValue(i,t)<0&&(r[e]=t),s.starts_with(e,"$lt")&&0<d.byValue(i,t)&&(r[e]=t)}else r[e]=t},this),n&&(r={$in:[]}),r},disjunctiveNormalForm:function(t,r){t=l.clone(t,1);var i=[];if(t.$or){var e=[];l.iter(t.$or,function(t){l.iter(this.disjunctiveNormalForm(t,r).$or,function(t){e.push(t)},this)},this),i.push(e),delete t.$or}t.$and&&(l.iter(t.$and,function(t){var e=[];l.iter(this.disjunctiveNormalForm(t,r).$or,function(t){e.push(t)},this),i.push(e)},this),delete t.$and);var s=[],o=function(e,n){n<i.length?l.iter(i[n],function(t){var i=l.clone(e,1);l.iter(t,function(t,e){e in i?r?i[e]=this.mergeConditions(i[e],t):(i.$and||(i.$and=[]),i.$and.push(l.objectBy(e,t))):i[e]=t},this),o(i,n+1)},this):s.push(e)};return o(t,0),{$or:s}},simplifyQuery:function(t){var s={};return l.iter(t,function(t,e){if(e in this.SYNTAX_PAIR_KEYS){var i=[],n=!1;l.iter(t,function(t){var e=this.simplifyQuery(t);o.is_empty(e)?n=!0:i.push(e)},this),("$and"===e&&0<i.length||"$or"===e&&!n)&&(s[e]=i)}else if(o.is_object(t)&&null!==t){var r=this.simplifyConditions(t);o.is_empty(r)||(s[e]=r)}else s[e]=t},this),s},simplifiedDNF:function(t,e){return t=this.simplifyQuery(this.disjunctiveNormalForm(t,!0)),o.is_empty(t)?{$or:[{}]}:t},simplifyConditions:function(u){var a={};return l.iter(["","ic"],function(t){if(u["$eq"+t]||u["$in"+t]){var e=l.filter(u["$eq"+t]?[u["$eq"+t]]:u["$in"+t],function(t){return this.evaluate_conditions(u,t)},this);a[(1===e.length?"$eq":"$in")+t]=1===e.length?e[0]:e}else{var i=null,n=null,r=!1,s=!1,o=d.byValue;u["$gt"+t]&&(i=u["$gt"+t]),u["$lt"+t]&&(i=u["$lt"+t]),u["$gte"+t]&&(null===i||o(i,u["$gte"+t])<0)&&(s=!0,i=u["$gte"+t]),u["$lte"+t]&&(null===n||0<o(n,u["$lte"+t]))&&(r=!0,n=u["$lte"+t]),null!==n&&(a[(r?"$lte":"$lt")+t]=n),null!==i&&(a[(s?"$gte":"$gt")+t]=i)}},this),a},mapKeyValue:function(t,e,i){return this.mapKeyValueQuery(t,e,i)},mapKeyValueQuery:function(t,i,n){var r={};return l.iter(t,function(t,e){r=l.extend(r,this.mapKeyValuePair(t,e,i,n))},this),r},mapKeyValueQueries:function(t,e,i){return l.map(t,function(t){return this.mapKeyValueQuery(t,e,i)},this)},mapKeyValuePair:function(t,i,n,r){if(i in this.SYNTAX_PAIR_KEYS)return l.objectBy(i,this.mapKeyValueQueries(t,n,r));if(this.is_query_atom(t))return n.call(r,i,t);var s={};return l.iter(t,function(t,e){s[e]=this.mapKeyValueCondition(t,i,n,r)},this),l.objectBy(i,s)},mapKeyValueCondition:function(t,e,i,n){var r=o.is_array(t);r||(t=[t]);var s=l.map(t,function(t){return l.peek(i.call(n,e,t))},this);return r?s:s[0]},queryDeterminedByAttrs:function(t,i,n){return l.exists(t,function(t,e){return"$and"===e?l.exists(t,function(t){return this.queryDeterminedByAttrs(t,i,n)},this):"$or"===e?l.all(t,function(t){return this.queryDeterminedByAttrs(t,i,n)},this):e in i&&(!n||i[e]!==t)},this)},searchTextQuery:function(t,e){return{$regex:s.regexEscape(t||""),$options:e?"i":""}}}}),a.extend("module:Queries.AbstractQueryBuilder",["base:Class","base:Comparators","base:Events.EventsMixin","base:Objs"],function(t,e,i,n,r){return t.extend({scoped:r},[i,function(t){return{constructor:function(){t.constructor.call(this),this.__query={}},_queryChanged:function(){var t=this._buildQuery();e.deepEqual(this.__query,t)||(this.__query=t,this.trigger("change"))},getQuery:function(){return n.clone(this.__query,1)},_buildQuery:function(){throw"Not implemented"}}}])}),a.extend("module:Queries.SimpleQueryBuilder",["module:Queries.AbstractQueryBuilder"],function(t,e){return t.extend({scoped:e},function(n){return{constructor:function(t,e,i){n.constructor.call(this),this.__queryMap=e,this.__queryCtx=i,this.__userQuery=null,this.setQuery(t)},setQuery:function(t){this.__userQuery=t?this.__queryMap?this.__queryMap.call(this.__queryCtx||this,t):t:{},this._queryChanged()},_buildQuery:function(){return this.__userQuery}}})}),a.extend("module:Queries.AndQueryBuilder",["module:Queries.AbstractQueryBuilder","base:Objs","base:Types"],function(t,e,i,n){return t.extend({scoped:n},function(t){return{constructor:function(){t.constructor.call(this),this.__queries={}},destroy:function(){e.iter(this.__queries,this.removeQuery,this),t.destroy.call(this)},addQuery:function(t){return(this.__queries[t.cid()]=t).on("change",this._queryChanged,this),this._queryChanged(),t},removeQuery:function(t){return delete this.__queries[t.cid()],t.off(null,null,this),this._queryChanged(),t},_buildQuery:function(){var t=e.values(this.__queries).map(function(t){return t.getQuery()}).filter(function(t){return!i.is_empty(t)});switch(t.length){case 0:return{};case 1:return t[0];default:return{$and:t}}}}})}),a.extend("module:Queries.ConstrainedQueryBuilder",["base:Class","base:Comparators","base:Events.EventsMixin"],function(t,e,i,n){return t.extend({scoped:n},[i,function(i){return{constructor:function(t,e){i.constructor.call(this),this.__queryBuilder=t,this.__options=e||{},this.__queryBuilder.on("change",function(){this.trigger("change")},this)},destroy:function(){this.__queryBuilder.off(null,null,this),i.destroy.call(this)},getOptions:function(){return this.__options},setOptions:function(t){t=t||{},e.deepEqual(t,this.__options)||(this.__options=t,this.trigger("change"))},getQuery:function(){return this.getQueryBuilder().getQuery()},getQueryBuilder:function(){return this.__queryBuilder},getConstrainedQuery:function(){return{query:this.getQuery(),options:this.getOptions()}}}}])}),a.extend("module:Queries.RangeQueryBuilder",["module:Queries.AbstractQueryBuilder","base:Objs"],function(t,e,i){return t.extend({scoped:i},function(n){return{constructor:function(t,e,i){n.constructor.call(this),this.__key=t,this.__lowerBound=e,this.__upperBound=i,this._queryChanged()},_buildQuery:function(){return e.objectBy(this.__key,{$gte:this.__lowerBound,$lte:this.__upperBound})},touch:function(t,e){e=e||t;var i=!1;t<this.__lowerBound&&(i=!0,this.__lowerBound=t),e>this.__upperBound&&(i=!0,this.__upperBound=e),i&&this._queryChanged()},setLowerBound:function(t){this.__lowerBound=t,this._queryChanged()},setUpperBound:function(t){this.__upperBound=t,this._queryChanged()}}})}),a.define("module:Queries.Engine",["module:Queries","module:Queries.Constrained","base:Strings","base:Types","base:Objs","base:Promise","base:Comparators","base:Iterators.SkipIterator","base:Iterators.LimitIterator","base:Iterators.SortedIterator","base:Iterators.FilteredIterator","base:Iterators.SortedOrIterator","base:Iterators.PartiallySortedIterator","base:Iterators.ArrayIterator","base:Iterators.LazyMultiArrayIterator"],function(c,_,t,p,m,r,y,v,g,S,b,s,o,x,k){return{indexQueryConditionsSize:function(t,e,i){var n=i?"_ic":"",r=e.info(),s=r.row_count,o=r.row_count/Math.max(r["key_count"+n],1);if(t.$eq)s=o;else if(t.$in)s=o*t.$in.length;else{var u=0,a=null;(t.$gt||t.$gte)&&(a=t.$gt||t.$gte,t.$gt&&u--);var c=null;(t.$lt||t.$lte)&&(c=t.$lt||t.$lte,t.$lt&&u--),null!==a&&null!==c?u+=e["key_count_distance"+n](a,c):null!==a?u+=e["key_count_right"+n](a):null!==c&&(u+=e["key_count_left"+n](c)),s=u*o}return s},indexQuerySize:function(t,n,r){var s=0,o=r.info();return m.iter(t.$or,function(t){if(!(n in t))return s=null,!1;var e=t[n],i=o.row_count;r.options().exact&&(i=Math.min(i,this.indexQueryConditionsSize(e,r,!1))),r.options().ignoreCase&&(i=Math.min(i,this.indexQueryConditionsSize(e,r,!0))),s+=i},this),s},queryPartially:function(t,e){var i={query:t.query,options:{}};if(t.options.sort){var n=m.ithKey(t.options.sort,0);i.options.sort={},i.options.sort[n]=t.options.sort[n]}return _.validate(i,e)},compileQuery:function(t,e,i,n){t=_.rectify(t);var r=_.sortValidate(t.options,e),s=c.validate(t.query,e.query||{}),o=_.skipValidate(t.options,e),u=_.limitValidate(t.options,e),a={skip:null,limit:null,filter:null,sort:null};return s&&r&&o||(a.skip=t.options.skip,delete t.options.skip,"limit"in t.options&&u&&s&&r&&(t.options.limit+=a.skip)),s&&r&&u||(a.limit=t.options.limit,delete t.options.limit),r||(a.sort=t.options.sort,delete t.options.sort),s||(a.filter=t.query,t.query={}),i.call(n,t).mapSuccess(function(t){return t=this._queryResultRectify(t,!1),a.filter&&(t=new b(t,function(t){return c.evaluate(a.filter,t)}).auto_destroy(t,!0)),a.sort&&(t=new S(t,y.byObject(a.sort)).auto_destroy(t,!0)),a.skip&&(t=new v(t,a.skip).auto_destroy(t,!0)),a.limit&&(t=new g(t,a.limit).auto_destroy(t,!0)),t},this)},compileIndexQuery:function(e,_,h){var t,i=m.exists(e.query.$or,function(t){return!(_ in t)}),l=e.options.sort&&m.ithKey(e.options.sort,0)===_,d=l?e.options.sort[_]:1,f=!h.options().exact;if(i){var n=[];h["itemIterate"+(f?"_ic":"")](null,d,function(t,e){n.push(e)}),t=new x(n)}else t=new s(m.map(e.query.$or,function(t){var e,n=t[_];!l&&h.options().ignoreCase&&h.options().exact&&this.indexQueryConditionsSize(n,h,!0)<this.indexQueryConditionsSize(n,h,!1)&&(f=!0);var r=f?"_ic":"";if(n.$eq||!p.is_object(n)){var i=[],s=p.is_object(n)?n.$eq:n;h["itemIterate"+r](s,d,function(t,e){if(t!==s)return!1;i.push(e)}),e=new x(i)}else if(n.$in){var o=0;e=new k(function(){if(o>=n.$in.length)return null;var i=[];return h["itemIterate"+r](n.$in[o],d,function(t,e){if(t!==n["in"][o])return!1;i.push(e)}),o++,i})}else{var u=null,a=null;if((n.$gt||n.$gte)&&(u=n.$gt||n.$gte),(n.$lt||n.$lte)&&(a=n.$lt||n.$lte),d<0){var c=u;u=a,a=c}e=new k(function(){if(null!==u&&null!==a&&Math.sign(h.comparator()(u,a))===Math.sign(d))return null;var i=[];return h["itemIterate"+r](u,d,function(t,e){if(null===u&&(u=t),t!==u)return u=t,!1;i.push(e)}),i})}return e},this),h.comparator());return t=new b(t,function(t){return c.evaluate(e.query,t)}).auto_destroy(t,!0),e.options.sort&&(t=l?new o(t,y.byObject(e.options.sort),function(t,e){return t[_]===e[_]}).auto_destroy(t,!0):new S(t,y.byObject(e.options.sort)).auto_destroy(t,!0)),e.options.skip&&(t=new v(t,e.options.skip).auto_destroy(t,!0)),e.options.limit&&(t=new g(t,e.options.limit).auto_destroy(t,!0)),r.value(t)},compileIndexedQuery:function(t,e,i,n,r){if(t=_.rectify(t),r=r||{},this.queryPartially(t,e)||p.is_empty(r))return this.compileQuery(t,e,i,n);var s=c.simplifiedDNF(t.query,!0);if(t.options.sort){var o=m.ithKey(t.options.sort,0);if(r[o])return this.compileIndexQuery({query:s,options:t.options},o,r[o])}var u=null,a=null;return m.iter(r,function(t,e){var i=this.indexQuerySize(s,e,t);null!==i&&(null===u||i<u)&&(u=i,a=e)},this),null!==a?this.compileIndexQuery({query:s,options:t.options},a,r[a]):this.compileQuery(t,e,i,n)},_queryResultRectify:function(t,e){return t=t||[],p.is_array(t)===e?t:e?t.asArray():new x(t)}}}),a.define("module:Stores.AssocStore",["module:Stores.BaseStore","base:Promise","base:Objs"],function(t,n,r,e){return t.extend({scoped:e},function(e){return{_read_key:function(t){},_write_key:function(t,e){},_remove_key:function(t){},_iterate:function(){},constructor:function(t){(t=t||{}).create_ids=!0,e.constructor.call(this,t)},_insert:function(t){return n.tryCatch(function(){return this._write_key(t[this._id_key],t),t},this)},_remove:function(e){return n.tryCatch(function(){var t=this._read_key(e);return t&&!this._remove_key(e)?null:t},this)},_get:function(t){return n.tryCatch(function(){return this._read_key(t)},this)},_update:function(e,i){return n.tryCatch(function(){var t=this._read_key(e);return t&&(this._id_key in i&&(this._remove_key(e),e=i[this._id_key],delete i[this._id_key]),r.extend(t,i),this._write_key(e,t)),t},this)},_query:function(t,e){return n.tryCatch(function(){return this._iterate()},this)}}})}),a.define("module:Stores.MemoryMapStore",["module:Stores.AssocStore","base:Iterators.FilteredIterator","base:Iterators.NativeMapIterator","base:Objs"],function(t,i,n,e,r){return t.extend({scoped:r},function(e){return{constructor:function(t){e.constructor.call(this,t),this.__map=new Map},_read_key:function(t){return this.__map.get(t+"")},_write_key:function(t,e){this.__map.set(t+"",e)},_remove_key:function(t){this.__map["delete"](t+"")},_iterate:function(){var t=new n(this.__map);return new i(t,function(t){return!!t}).auto_destroy(t,!0)},_count:function(t){return t?e._count.call(this,t):this.__map.size}}})}),a.define("module:Stores.MemoryStore",["module:Stores.AssocStore","base:Iterators.FilteredIterator","base:Iterators.ArrayIterator","base:Objs","base:Promise"],function(t,i,n,e,r,s){return t.extend({scoped:s},function(e){return{constructor:function(t){e.constructor.call(this,t),this.__dataByIndex=[null],this.__indexById={},this.__count=0},_read_key:function(t){var e=this.__indexById[t];return e?this.__dataByIndex[e]:undefined},_write_key:function(t,e){var i=this.__indexById[t];i||(i=this.__dataByIndex.length,this.__indexById[t]=i,this.__count++),this.__dataByIndex[i]=e},_remove_key:function(t){var e=this.__indexById[t];e&&(delete this.__indexById[t],delete this.__dataByIndex[e],this.__count--)},_iterate:function(){var t=new n(this.__dataByIndex);return new i(t,function(t){return!!t}).auto_destroy(t,!0)},_count:function(t){return t?e._count.call(this,t):r.value(this.__count)}}})}),a.define("module:Stores.BaseStore",["base:Class","base:Events.EventsMixin","module:Stores.ReadStoreMixin","module:Stores.WriteStoreMixin","base:Promise","base:Objs","module:Stores.MemoryIndex"],function(t,e,i,n,r,s,o,u){return t.extend({scoped:u},[e,i,n,function(e){return{constructor:function(t){e.constructor.call(this),this._initializeReadStore(t),this._initializeWriteStore(t)},_ensure_index:function(t){t in this.indices||(this.indices[t]=new o(this,t))},ensure_index:function(t){return this._ensure_index(t)},getBy:function(t,e,i){return t===this.id_key()?this.get(e,i):this.query(s.objectBy(t,e),{limit:1}).mapSuccess(function(t){var e=t.next();return t.destroy(),e})},clear:function(n){return this.query(null,null,n).mapSuccess(function(t){for(var e=r.and();t.hasNext();){var i=t.next();e=e.and(this.remove(i[this._id_key],n))}return t.destroy(),e},this)}}}])}),a.define("module:Stores.ReadStoreMixin",["module:Queries.Engine","module:Stores.StoreException","base:Promise","base:Objs"],function(n,r,s,o){return{_initializeReadStore:function(t){t=t||{},this.indices={},this._watcher=t.watcher||null,this._capabilities=t.capabilities||{}},watcher:function(){return this._watcher},_get:function(t,e){return s.create(null,new r("unsupported: get"))},_query_capabilities:function(){return this._capabilities},_query:function(t,e,i){return s.create(null,new r("unsupported: query"))},get:function(t,e){return this._get(t,e)},count:function(t,e){return this._count(t,e)},_count:function(t,e){return this.query(t,{},e).mapSuccess(function(t){return t.asArray().length})},query:function(t,e,i){return t=o.clone(t||{},-1),(e=o.clone(e,-1))&&(e.limit&&(e.limit=parseInt(e.limit,10)),e.skip&&(e.skip=parseInt(e.skip,10))),n.compileIndexedQuery({query:t,options:e||{}},this._query_capabilities(),function(t){return this._query(t.query,t.options,i)},this,this.indices)},findBy:function(t,e){return this.query(t,{limit:1},e).mapSuccess(function(t){return t.next()})},serialize:function(t){return this.query({},{},t).mapSuccess(function(t){return t.asArray()})}}}),a.define("module:Stores.ReadStore",["base:Class","module:Stores.ReadStoreMixin"],function(t,e,i){return t.extend({scoped:i},[e,function(e){return{constructor:function(t){e.constructor.call(this),this._initializeReadStore(t)}}}])}),a.define("module:Stores.StoreException",["base:Exceptions.Exception"],function(t,e){return t.extend({scoped:e},{})}),a.define("module:Stores.StoreHistory",["base:Class","base:Events.EventsMixin","base:Objs","base:Types","base:Promise","module:Stores.MemoryStore"],function(t,e,h,l,d,r,i){return t.extend({scoped:i},[e,function(n){return{constructor:function(t,e,i){n.constructor.call(this),this._options=h.extend({combine_update_update:!1,combine_insert_update:!1,combine_insert_remove:!1,combine_update_remove:!1,source_id_key:t?t.id_key():"id",row_data:{},filter_data:{}},i),this.historyStore=e||this.auto_destroy(new r),this.sourceStore=t,this.commitId=1,t&&(t.on("insert",this.sourceInsert,this),t.on("remove",this.sourceRemove,this),t.on("update",this.sourceUpdate,this))},lockCommits:function(){this.lockedCommits=this.commitId},unlockCommits:function(){delete this.lockedCommits},sourceInsert:function(t){return this.commitId++,this.historyStore.insert(h.extend({row:t,type:"insert",row_id:t[this._options.source_id_key],commit_id:this.commitId},this._options.row_data)),this.trigger("insert",this.commitId),this.commitId},sourceUpdate:function(t,i,e,n){this.commitId++;var r=l.is_object(t)?t[this._options.source_id_key]:t,s="update",o=d.create();if(this._options.combine_insert_update||this._options.combine_update_update){var u=[];this._options.combine_insert_update&&u.push({type:"insert"}),this._options.combine_update_update&&u.push({type:"update"});var a={},c=[],_=h.extend({row_id:r},this._options.filter_data);this.lockedCommits&&(_.commit_id={$gt:this.lockedCommits}),1===u.length?_=h.extend(_,u[0]):_.$or=u,this.historyStore.query(_,{sort:{commit_id:1}}).success(function(t){for(;t.hasNext();){var e=t.next();"insert"===e.type&&(s="insert"),a=h.extend(a,e.row),c.push(this.historyStore.id_of(e))}t.destroy(),i=h.extend(a,i),this.historyStore.removeAllByIds(c),o.asyncSuccess(!0)},this)}else o.asyncSuccess(!0);o.success(function(){this.historyStore.insert(h.extend({row:i,pre_data:n,type:s,row_id:r,commit_id:this.commitId},this._options.row_data)),this.trigger("update",this.commitId),this.trigger("update:"+r,this.commitId)},this)},sourceRemove:function(e,t){this.commitId++;var i=d.create();this._options.combine_insert_remove?this.historyStore.query(h.extend({type:"insert",row_id:e},this._options.filter_data)).success(function(t){t.hasNext()?this.historyStore.removeAllByQuery(h.extend({row_id:e},this._options.filter_data)):(i.asyncSuccess(!0),t.destroy())},this):i.asyncSuccess(!0),i.success(function(){this._options.combine_update_remove&&this.historyStore.removeAllByQuery(h.extend({type:"update",row_id:e},this._options.filter_data)),this.historyStore.insert(h.extend({type:"remove",row_id:e,row:t,commit_id:this.commitId},this._options.row_data)),this.trigger("remove",this.commitId),this.trigger("remove:"+e,this.commitId)},this)},getCommitById:function(t){return this.historyStore.query({commit_id:t},{limit:1}).mapSuccess(function(t){var e=t.next();return t.destroy(),e})},undoCommit:function(t){return"insert"===t.type?this.sourceStore.remove(t.row_id):"remove"===t.type?this.sourceStore.insert(t.row):"update"===t.type?this.sourceStore.update(t.row_id,t.pre_data||{}):void 0},undoCommitById:function(t){return this.getCommitById(t).mapSuccess(function(t){return this.undoCommit(t).success(function(){this.historyStore.remove(this.historyStore.id_of(t))},this)},this)}}}])}),a.define("module:Stores.WriteStoreMixin",["module:Stores.StoreException","base:Promise","base:IdGenerators.TimedIdGenerator","base:Objs"],function(n,r,e,u){return{_initializeWriteStore:function(t){t=t||{},this._id_key=t.id_key||"id",this._create_ids=t.create_ids||!1,this._validate_ids=t.validate_ids||!1,this._id_lock=t.id_lock||!1,this.preserve_preupdate_data=t.preserve_preupdate_data||!1,this._create_ids&&(this._id_generator=t.id_generator||this._auto_destroy(new e)),this._validate_ids&&(this._id_validator=t.id_validator||this._id_generator)},id_key:function(){return this._id_key},id_of:function(t){return t[this.id_key()]},id_row:function(t){var e={};return e[this._id_key]=t,e},_inserted:function(t,e){this.trigger("insert",t,e),this.trigger("write","insert",t,e)},_removed:function(t,e,i){this.trigger("remove",t,e,i),this.trigger("write","remove",t,e,i)},_updated:function(t,e,i,n,r){this.trigger("update",t,e,i,n,r),this.trigger("write","update",t,e,i,n,r)},insert_all:function(t,e){var i=r.and();return(t||[]).forEach(function(t){i=i.and(this.insert(t,e))},this),i.end()},_insert:function(t,e){return r.create(null,new n("unsupported: insert"))},_remove:function(t,e){return r.create(null,new n("unsupported: remove"))},_update:function(t,e,i){return r.create(null,new n("unsupported: update"))},insert:function(t,e){return t?this._id_key in t&&t[this._id_key]&&this._id_lock?r.create(null,new n("id lock")):(!this._create_ids||this._id_key in t&&t[this._id_key]||(t[this._id_key]=this._id_generator.generate(e)),this._id_validator&&this._id_key in t&&t[this._id_key]&&!this._id_validator.valid(t[this._id_key],e)?r.create(null,new n("invalid id")):this._insert(t,e).success(function(t){this._inserted(t,e)},this)):r.create(null,new n("empty insert"))},remove:function(e,i){return this._remove(e,i).success(function(t){this._removed(e,i,t)},this)},removeAllByIds:function(t,e){return r.and(t.map(function(t){return this.remove(t,e)},this))},removeAllByQuery:function(t,e,i){return this.query(t,e,i).mapSuccess(function(t){return this.removeAllByIds(t.asArray().map(this.id_of,this))},this)},update:function(n,r,s,o){return this.preserve_preupdate_data?this.get(n,s).mapSuccess(function(t){var e={};for(var i in r)e[i]=t[i];return this._update(n,r,s,o).success(function(t){this._updated(u.extend(u.objectBy(this._id_key,n),t),r,s,e,o)},this)},this):this._update(n,r,s,o).success(function(t){this._updated(u.extend(u.objectBy(this._id_key,n),t),r,s,undefined,o)},this)},unserialize:function(t,e){return this.insert_all(t,e)}}}),a.define("module:Stores.WriteStore",["base:Class","base:Events.EventsMixin","module:Stores.WriteStoreMixin"],function(t,e,i,n){return t.extend({scoped:n},[e,i,function(e){return{constructor:function(t){e.constructor.call(this),this._initializeWriteStore(t)},_ensure_index:function(t){},ensure_index:function(t){return this._ensure_index(t)}}}])}),a.define("module:Stores.AsyncStore",["module:Stores.BaseStore","base:Promise","base:Async"],function(t,n,r,e){return t.extend({scoped:e},function(i){return{constructor:function(t,e){this.__store=t,(e=e||{}).id_key=t.id_key(),i.constructor.call(this,e),this.__time=e.time||0,e.destroy_store&&this._auto_destroy(t)},_query_capabilities:function(){return this.__store._query_capabilities()},__async:function(t,e){var i=n.create();return r.eventually(function(){t.apply(this.__store,e).forwardCallback(i)},this,this.__time),i},_insert:function(){return this.__async(this.__store.insert,arguments)},_remove:function(){return this.__async(this.__store.remove,arguments)},_get:function(){return this.__async(this.__store.get,arguments)},_update:function(){return this.__async(this.__store.update,arguments)},_query:function(){return this.__async(this.__store.query,arguments)},_ensure_index:function(t){return this.__store.ensure_index(t)},_store:function(){return this.__store}}})}),a.define("module:Stores.ConcatStore",["module:Stores.BaseStore"],function(t,e){return t.extend({scoped:e},function(n){return{constructor:function(t,e,i){this.__primary=t,this.__secondary=e,n.constructor.call(this,i)},_query_capabilities:function(){return this._primary()._query_capabilities()},_count:function(){return this._primary().count.apply(this._primary(),arguments).and(this._secondary().count.apply(this._secondary(),arguments)).mapSuccess(function(t){return t[0]+t[1]})},_insert:function(){var t=arguments;return this._primary().insert.apply(this._primary(),t).mapError(function(){return this._secondary().insert.apply(this._secondary(),t)},this)},_remove:function(){var t=arguments;return this._primary().remove.apply(this._primary(),t).mapError(function(){return this._secondary().remove.apply(this._secondary(),t)},this)},_get:function(){var i=arguments;return this._primary().get.apply(this._primary(),i).mapCallback(function(t,e){return e||this._secondary().get.apply(this._secondary(),i)},this)},_update:function(){var t=arguments;return this._primary().update.apply(this._primary(),t).mapError(function(){return this._secondary().update.apply(this._secondary(),t)},this)},_query:function(t,i,n){return i=i||{},this._primary().query(t,i,n).mapSuccess(function(e){return e=e.asArray(),i.limit&&e.length>=i.limit?e:(i.limit&&(i.limit-=e.length),this._secondary().query(t,i,n).mapSuccess(function(t){return e.concat(t.asArray())},this))},this)},_primary:function(){return this.__primary},_secondary:function(){return this.__secondary}}})}),a.define("module:Stores.ContextualizedStore",["module:Stores.BaseStore","base:Iterators.MappedIterator"],function(t,n,e){return t.extend({scoped:e},function(i){return{constructor:function(t,e){this.__store=t,(e=e||{}).id_key=t.id_key(),this.__context=e.context||this,this.__decode=e.decode,this.__encode=e.encode,i.constructor.call(this,e),e.destroy_store&&this._auto_destroy(t)},_decode:function(t){return this.__decode.call(this.__context,t)},_encode:function(t,e){return this.__encode.call(this.__context,t,e)},_decodeId:function(t){var e=this._decode(this.id_row(t));return{id:this.id_of(e.data),ctx:e.ctx}},_query_capabilities:function(){return this.__store._query_capabilities()},_insert:function(t){var e=this._decode(t);return this.__store.insert(e.data,e.ctx).mapSuccess(function(t){return this._encode(t,e.ctx)},this)},_remove:function(t){var e=this._decodeId(t);return this.__store.remove(e.id,e.ctx).mapSuccess(function(){return t},this)},_get:function(t){var e=this._decodeId(t);return this.__store.get(e.id,e.ctx).mapSuccess(function(t){return this._encode(t,e.ctx)},this)},_update:function(t,e){var i=this._decodeId(t);this.__store.update(i.id,e,i.ctx).mapSuccess(function(t){return t},this)},_query:function(t,e){var i=this._decode(t);return this.__store.query(i.data,e,i.ctx).mapSuccess(function(t){return new n(t,function(t){return this._encode(t,i.ctx)},this).auto_destroy(t,!0)},this)},_ensure_index:function(t){return this.__store.ensure_index(t)},_store:function(){return this.__store}}})}),a.define("module:Stores.AbstractDecontextualizedStore",["module:Stores.BaseStore","base:Iterators.MappedIterator","base:Promise"],function(t,n,i,e){return t.extend({scoped:e},function(r){return{constructor:function(t,e){this.__store=t,(e=e||{}).id_key=t.id_key(),r.constructor.call(this,e),e.destroy_store&&this._auto_destroy(t)},_query_capabilities:function(){return this.__store._query_capabilities()},_ensure_index:function(t){return this.__store.ensure_index(t)},_store:function(){return this.__store},_get:function(t,e){return this._rawGet(t,e).mapSuccess(function(t){return this._decodeRow(t,e)},this)},_rawQuery:function(t,e,i){return this.__store.query(this._encodeQuery(t,i),e)},_rawGet:function(t,e){return this._rawQuery(this.id_row(t),{limit:1},e).mapSuccess(function(t){var e=t.hasNext()?t.next():null;return t.destroy(),e},this)},_query:function(t,e,i){return this._rawQuery(t,e,i).mapSuccess(function(t){return new n(t,function(t){return this._decodeRow(t,i)},this).auto_destroy(t,!0)},this)},_insert:function(t,e){return i.value(this._encodeRow(t,e)).mapSuccess(function(t){return this.__store.insert(t).mapSuccess(function(t){return this._undecodedInserted(t,e),this._decodeRow(t,e)},this)},this)},_undecodedInserted:function(t,e){},_remove:function(i,n){return this._rawGet(i,n).mapSuccess(function(t){if(!t)return!0;var e=this._encodeRemove(i,t,n);return e?this.__store.update(i,e):this.__store.remove(i)},this)},_update:function(i,n,r){return this._rawGet(i,r).mapSuccess(function(e){if(!e)return!0;var t=this._encodeUpdate(i,n,r,e);return this.__store.update(i,t).mapSuccess(function(t){return this._undecodedUpdated(i,t,r,e),this._decodeRow(t,r)},this)},this)},_undecodedUpdated:function(t,e,i){},_encodeRow:function(t,e){throw"Abstract"},_encodeQuery:function(t,e){throw"Abstract"},_decodeRow:function(t,e){throw"Abstract"},_encodeRemove:function(t,e,i){throw"Abstract"},_encodeUpdate:function(t,e,i,n){throw"Abstract"},_inserted:function(t,e){r._inserted.call(this,this._decodeRow(t,e),e)},_removed:function(t,e,i){r._removed.call(this,t,e,this._decodeRow(i,e))},_updated:function(t,e,i,n){r._updated.call(this,this._decodeRow(t,i),this._decodeRow(e,i),i,this._decodeRow(n,i))}}})}),a.define("module:Stores.DecontextualizedSelectStore",["module:Stores.AbstractDecontextualizedStore","base:Objs"],function(t,n,e){return t.extend({scoped:e},function(t){return{_encodeRow:function(t,e){return n.extend(n.clone(t,1),e)},_encodeQuery:function(t,e){return n.extend(n.clone(t,1),e)},_decodeRow:function(i,t){return i&&(i=n.clone(i,1),n.iter(t,function(t,e){delete i[e]})),i},_encodeRemove:function(t,e,i){return!1},_encodeUpdate:function(t,e,i,n){return this._encodeRow(e,i)}}})}),a.define("module:Stores.DecontextualizedMultiAccessStore",["module:Stores.AbstractDecontextualizedStore","base:Objs","base:Promise","base:Types"],function(t,u,s,e,i){return t.extend({scoped:i},function(o){return{constructor:function(t,e){o.constructor.call(this,t,e),this.__contextKey=e.contextKey,this.__subContext=e.subContext||"$eq",this.__newContextSupplements=e.newContextSupplements||{},this.__contextAttributes=e.contextAttributes||[],this.__contextAccessKey=e.contextAccessKey,this.__immediateRemove=e.immediateRemove,this.__keepContextAccessKey=e.keepContextAccessKey,this.__contextAccessExpander=e.contextAccessExpander||function(){return[]},this.__contextDataCloner=e.contextDataCloner||function(e){var i={};return this.__contextAttributes.forEach(function(t){i[t]=e[t]},this),i},this.__contextDataUpdater=e.contextDataUpdater},_encodeQuery:function(e,i){return e=u.extend(u.objectBy(this.__contextAccessKey,{$elemMatch:u.objectBy(this.__subContext,i[this.__contextKey])}),e),this.__contextAttributes.forEach(function(t){t in e&&(e[t+"."+i[this.__contextKey]]=e[t],delete e[t],delete e[this.__contextAccessKey])},this),e},_encodeRemove:function(e,i,t){var n=t[this.__contextKey];if(this.__immediateRemove)return i[this.__contextAccessKey].forEach(function(t){t!==n&&o._removed.call(this,e,t,i)},this),!1;var r=i[this.__contextAccessKey].filter(function(t){return t!==n},this);if(0===r.length)return!1;var s=u.objectBy(this.__contextAccessKey,r);return this.__contextAttributes.forEach(function(t){s[t]=u.clone(i[t],1),delete s[t][n]},this),s},_decodeRow:function(e,t){if(!e)return e;e=u.clone(e,2);var i=t[this.__contextKey];return this.__keepContextAccessKey||delete e[this.__contextAccessKey],this.__contextAttributes.forEach(function(t){e[t]&&(e[t]=e[t][i])},this),e},_encodeUpdate:function(t,i,e,n){i=u.clone(i,1);var r=e[this.__contextKey];return this.__contextAttributes.forEach(function(t){if(t in i){var e=i[t];i[t]=n[t],i[t][r]=e}},this),this.__contextDataUpdater&&(i=this.__contextDataUpdater(t,i,e,n)),i},_encodeRow:function(r,i){var n=i[this.__contextKey];r=u.clone(r,1);var e={},t=n;return"$eq"!==this.__subContext&&(t=u.extend(this.__newContextSupplements,u.objectBy(this.__subContext,n))),r[this.__contextAccessKey]=[t],this.__contextAttributes.forEach(function(t){e[t]=r[t],r[t]=u.objectBy(n,e[t])},this),s.value(this.__contextAccessExpander.call(this,r,i)).mapSuccess(function(t){t=t.filter(function(t){return"$eq"===this.__subContext?t!==n:t[this.__subContext]!==n},this),r[this.__contextAccessKey]=r[this.__contextAccessKey].concat(t);var e=t.map(function(t){return s.value(this.__contextDataCloner.call(this,r,i,t))},this);return s.and(e).mapSuccess(function(n){return t.forEach(function(e,t){var i=n[t];this.__contextAttributes.forEach(function(t){r[t]["$eq"===this.__subContext?e:e[this.__subContext]]=i[t]},this)},this),r},this)},this)},_undecodedUpdated:function(t,i,n,r){r[this.__contextAccessKey].forEach(function(t){if(n[this.__contextKey]!==t){var e=u.objectBy(this.__contextKey,t);this._updated(r,i,e,r)}},this)},_undecodedInserted:function(i,n){i[this.__contextAccessKey].forEach(function(t){if(n[this.__contextKey]!==t){var e=u.objectBy(this.__contextKey,t);this._inserted(i,e)}},this)}}})}),a.define("module:Stores.KeyMapStore",["module:Stores.TransformationStore","base:Objs"],function(t,r,e){return t.extend({scoped:e},function(n){return{constructor:function(t,e,i){n.constructor.call(this,t,e),this.__encodeMap=i,this.__decodeMap=r.inverseKeyValue(i)},__mapBy:function(t,i){var n={};return r.iter(t,function(t,e){n[i[e]||e]=t}),n},_encodeData:function(t){return this.__mapBy(t,this.__encodeMap)},_decodeData:function(t){return this.__mapBy(t,this.__decodeMap)}}})}),a.define("module:Stores.MultiplexerStore",["module:Stores.BaseStore","module:Queries.Constrained","base:Promise"],function(t,i,n,e){return t.extend({scoped:e},function(e){return{constructor:function(t){e.constructor.call(this,t),this.__context=t.context||this,this.__acquireStore=t.acquireStore,this.__releaseStore=t.releaseStore,this.__mapContext=t.mapContext},_acquireStore:function(t){return n.value(this.__acquireStore?this.__acquireStore.call(this.__context,t):t)},_releaseStore:function(t,e){this.__releaseStore&&this.__releaseStore.call(this.__context,t,e)},_mapContext:function(t){return this.__mapContext?this.__mapContext.call(this.__context,t):null},_query_capabilities:function(){return i.fullConstrainedQueryCapabilities()},_insert:function(e,i){return this._acquireStore(i).mapSuccess(function(t){return t.insert(e,this._mapContext(i)).callback(function(){this._releaseStore(i,t)},this)},this)},_remove:function(e,i){return this._acquireStore(i).mapSuccess(function(t){return t.remove(e,this._mapContext(i)).callback(function(){this._releaseStore(i,t)},this)},this)},_update:function(e,i,n){return this._acquireStore(n).mapSuccess(function(t){return t.update(e,i,this._mapContext(n)).callback(function(){this._releaseStore(n,t)},this)},this)},_get:function(e,i){return this._acquireStore(i).mapSuccess(function(t){return t.get(e,this._mapContext(i)).callback(function(){this._releaseStore(i,t)},this)},this)},_query:function(e,i,n){return this._acquireStore(n).mapSuccess(function(t){return t.query(e,i,this._mapContext(n)).callback(function(){this._releaseStore(n,t)},this)},this)}}})}),a.define("module:Stores.PassthroughStore",["module:Stores.BaseStore","base:Promise"],function(t,n,e){return t.extend({scoped:e},function(i){return{constructor:function(t,e){this.__store=t,(e=e||{}).id_key=e.id_key||t.id_key(),this.__preserves=e.preserves,i.constructor.call(this,e),e.destroy_store&&this._auto_destroy(t),this.delegateEvents(["insert","update","remove"],this.__store)},_query_capabilities:function(){return this.__store._query_capabilities()},_insert:function(i,e){return this._preInsert(i).mapSuccess(function(t){return this.__store.insert(t,e).mapSuccess(function(t){var e=this._postInsert(t);return this.__preserves?e.mapSuccess(function(e){return this.__preserves.forEach(function(t){t in i&&!(t in e)&&(e[t]=i[t])}),e},this):e},this)},this)},_remove:function(t,e){return this._preRemove(t).mapSuccess(function(t){return this.__store.remove(t,e).mapSuccess(function(){return this._postRemove(t)},this)},this)},_get:function(t,e){return this._preGet(t).mapSuccess(function(t){return this.__store.get(t,e).mapSuccess(function(t){return this._postGet(t)},this)},this)},_update:function(t,e,i,n){return this._preUpdate(t,e).mapSuccess(function(t){return this.__store.update(t.id,t.data,i,n).mapSuccess(function(t){return this._postUpdate(t)},this)},this)},_query:function(t,e,i){return this._preQuery(t,e).mapSuccess(function(t){return this.__store.query(t.query,t.options,i).mapSuccess(function(t){return this._postQuery(t)},this)},this)},unserialize:function(t){return this._preUnserialize(t).mapSuccess(function(t){return this.__store.unserialize(t).mapSuccess(function(t){return this._postUnserialize(t)},this)},this)},serialize:function(t){return this._preSerialize(t).mapSuccess(function(t){return this.__store.serialize(t).mapSuccess(function(t){return this._postSerialize(t)},this)},this)},_ensure_index:function(t){return this.__store.ensure_index(t)},_store:function(){return this.__store},_preInsert:function(t){return n.value(t)},_postInsert:function(t){return n.value(t)},_preRemove:function(t){return n.value(t)},_postRemove:function(t){return n.value(!0)},_preGet:function(t){return n.value(t)},_postGet:function(t){return n.value(t)},_preUpdate:function(t,e){return n.value({id:t,data:e})},_postUpdate:function(t){return n.value(t)},_preQuery:function(t,e){return n.value({query:t,options:e})},_postQuery:function(t){return n.value(t)},_preSerialize:function(t){return n.value(t)},_postSerialize:function(t){return n.value(t)},_preUnserialize:function(t){return n.value(t)},_postUnserialize:function(t){return n.value(t)},watcher:function(){return this.__store.watcher()}}})}),a.define("module:Stores.ReadyStore",["module:Stores.PassthroughStore","base:Promise","base:Objs"],function(t,i,e,n){return t.extend({scoped:n},function(t){return{__ready:!1,ready:function(){this.__ready=!0,e.iter(this.__promises,function(t){t.promise.forwardCallback(t.stalling)}),delete this.__promises},__execute:function(t){if(this.__ready)return t;var e=i.create();return this.__promises=this.__promises||[],this.__promises.push({stalling:e,promise:t}),e},_preInsert:function(){return this.__execute(t._preInsert.apply(this,arguments))},_preRemove:function(){return this.__execute(t._preRemove.apply(this,arguments))},_preGet:function(){return this.__execute(t._preGet.apply(this,arguments))},_preUpdate:function(){return this.__execute(t._preUpdate.apply(this,arguments))},_preQuery:function(){return this.__execute(t._preQuery.apply(this,arguments))},_preSerialize:function(){return this.__execute(t._preSerialize.apply(this,arguments))},_preUnserialize:function(){return this.__execute(t._preUnserialize.apply(this,arguments))}}})}),a.define("module:Stores.ResilientStore",["module:Stores.BaseStore","base:Promise"],function(t,n,e){return t.extend({scoped:e},function(i){return{constructor:function(t,e){this.__store=t,(e=e||{}).id_key=t.id_key(),i.constructor.call(this,e),this._resilience=e.resilience||10,e.destroy_store&&this._auto_destroy(t)},_query_capabilities:function(){return this.__store._query_capabilities()},_insert:function(){return n.resilientCall(this._store.insert,this._store,this._resilience,arguments)},_remove:function(){return n.resilientCall(this._store.remove,this._store,this._resilience,arguments)},_get:function(){return n.resilientCall(this._store.get,this._store,this._resilience,arguments)},_update:function(t,e){return n.resilientCall(this._store.update,this._store,this._resilience,arguments)},_query:function(t,e){return n.resilientCall(this._store.update,this._store,this._resilience,arguments)},_ensure_index:function(t){return this.__store.ensure_index(t)},_store:function(){return this.__store}}})}),a.define("module:Stores.SimulatorStore",["module:Stores.PassthroughStore","base:Promise"],function(t,e,i){return t.extend({scoped:i},function(t){return{online:!0,_preInsert:function(){return this.online?t._preInsert.apply(this,arguments):e.error("Offline")},_preRemove:function(){return this.online?t._preRemove.apply(this,arguments):e.error("Offline")},_preGet:function(){return this.online?t._preGet.apply(this,arguments):e.error("Offline")},_preUpdate:function(){return this.online?t._preUpdate.apply(this,arguments):e.error("Offline")},_preQuery:function(){return this.online?t._preQuery.apply(this,arguments):e.error("Offline")}}})}),a.define("module:Stores.TableStore",["module:Stores.BaseStore","base:Iterators.MappedIterator","module:Queries.Constrained"],function(t,n,e,i){return t.extend({scoped:i},function(i){return{constructor:function(t,e){this.__table=t,(e=e||{}).id_key=t.primary_key(),i.constructor.call(this,e),this.__options={insertTags:e.insertTags||[],readTags:e.readTags||[],updateTags:e.updateTags||[]}},_query_capabilities:function(){return e.fullConstrainedQueryCapabilities()},_insert:function(t,e){var i=this.__table.newModel({},null,e);return i.setByTags(t,this.__options.insertTags),i.save().mapSuccess(function(){var t=i.asRecord(this.__options.readTags);return i.decreaseRef(),t},this)},_remove:function(t,e){return this.__table.findById(t,e).mapSuccess(function(t){if(!t)return t;t.remove();var e=t.asRecord(this.__options.readTags);return t.decreaseRef(),e},this)},_get:function(t,e){return this.__table.findById(t,e).mapSuccess(function(t){if(!t)return t;var e=t.asRecord(this.__options.readTags);return t.decreaseRef(),e},this)},_update:function(t,i,e){return this.__table.findById(t,e).mapSuccess(function(e){return e?(e.setByTags(i,this.__options.updateTags),e.save().mapSuccess(function(){var t=e.asRecord(this.__options.readTags);return e.decreaseRef(),t},this)):e},this)},_query:function(t,e,i){return this.__table.query(t,e,i).mapSuccess(function(t){return new n(t,function(t){var e=t.asRecord(this.__options.readTags);return t.decreaseRef(),e},this).auto_destroy(t,!0)},this)}}})}),a.define("module:Stores.TransformationStore",["module:Stores.PassthroughStore","module:Queries","base:Iterators.MappedIterator","base:Objs","base:Types","base:Promise"],function(t,n,e,r,s,i,o){return t.extend({scoped:o},function(t){return{_encodeData:function(t){return t},_decodeData:function(t){return t},_encodeSort:function(t){return this._encodeData(t)},_encodeId:function(t){return this._store().id_of(this._encodeData(r.objectBy(this.id_key(),t)))},_decodeId:function(t){return this.id_of(this._decodeData(r.objectBy(this._store().id_key(),t)))},_encodeQuery:function(t,e){var i=r.clone(e);return i.sort&&(i.sort=s.is_object(i.sort)?this._encodeSort(i.sort):{}),{query:n.mapKeyValue(t,function(t,e){return this._encodeData(r.objectBy(t,e))},this),options:i}},_preInsert:function(t){return i.create(this._encodeData(t))},_postInsert:function(t){return i.create(this._decodeData(t))},_preRemove:function(t){return i.create(this._encodeId(t))},_postRemove:function(t){return i.create(!0)},_preGet:function(t){return i.create(this._encodeId(t))},_postGet:function(t){return i.create(this._decodeData(t))},_preUpdate:function(t,e){return i.create({id:this._encodeId(t),data:this._encodeData(e)})},_postUpdate:function(t){return i.create(this._decodeData(t))},_preQuery:function(t,e){return i.create(this._encodeQuery(t,e))},_postQuery:function(t){return i.create(new e(t,function(t){return this._decodeData(t)},this).auto_destroy(t,!0))}}})}),a.define("module:Stores.AssocDumbStore",["module:Stores.DumbStore"],function(t,e){return t.extend({scoped:e},{_read_key:function(t){},_write_key:function(t,e){},_remove_key:function(t){},__read_id:function(t){var e=this._read_key(t);return e?parseInt(e,10):null},_read_last_id:function(){return this.__read_id("last_id")},_write_last_id:function(t){this._write_key("last_id",t)},_remove_last_id:function(){this._remove_key("last_id")},_read_first_id:function(){return this.__read_id("first_id")},_write_first_id:function(t){this._write_key("first_id",t)},_remove_first_id:function(){this._remove_key("first_id")},_read_item:function(t){return this._read_key("item_"+t)},_write_item:function(t,e){this._write_key("item_"+t,e)},_remove_item:function(t){this._remove_key("item_"+t)},_read_next_id:function(t){return this.__read_id("next_"+t)},_write_next_id:function(t,e){this._write_key("next_"+t,e)},_remove_next_id:function(t){this._remove_key("next_"+t)},_read_prev_id:function(t){return this.__read_id("prev_"+t)},_write_prev_id:function(t,e){this._write_key("prev_"+t,e)},_remove_prev_id:function(t){this._remove_key("prev_"+t)}})}),a.define("module:Stores.DumbStore",["module:Stores.BaseStore","base:Promise","base:Objs","base:Iterators.Iterator"],function(t,r,n,s,e){return t.extend({scoped:e},function(e){return{_read_last_id:function(){},_write_last_id:function(t){},_remove_last_id:function(){},_read_first_id:function(){},_write_first_id:function(t){},_remove_first_id:function(){},_read_item:function(t){},_write_item:function(t,e){},_remove_item:function(t){},_read_next_id:function(t){},_write_next_id:function(t,e){},_remove_next_id:function(t){},_read_prev_id:function(t){},_write_prev_id:function(t,e){},_remove_prev_id:function(t){},constructor:function(t){(t=t||{}).create_ids=!0,e.constructor.call(this,t)},_insert:function(i){return r.tryCatch(function(){var t=this._read_last_id(),e=i[this._id_key];return null!==t?(this._write_next_id(t,e),this._write_prev_id(e,t)):this._write_first_id(e),this._write_last_id(e),this._write_item(e,i),i},this)},_remove:function(n){return r.tryCatch(function(){var t=this._read_item(n);if(t){this._remove_item(n);var e=this._read_next_id(n),i=this._read_prev_id(n);null!==e?(this._remove_next_id(n),null!==i?(this._remove_prev_id(n),this._write_next_id(i,e),this._write_prev_id(e,i)):(this._remove_prev_id(e),this._write_first_id(e))):null!==i?(this._remove_next_id(i),this._write_last_id(i)):(this._remove_first_id(),this._remove_last_id())}return t},this)},_get:function(t){return r.tryCatch(function(){return this._read_item(t)},this)},_update:function(e,i){return r.tryCatch(function(){var t=this._get(e);return t&&(delete i[this._id_key],n.extend(t,i),this._write_item(e,t)),t},this)},_query:function(i,t){return r.tryCatch(function(){var t=new s,e=this._read_first_id();return n.extend(t,{__id:null===e?1:e,__store:this,__query:i,hasNext:function(){var t=this.__store._read_last_id();if(null===t)return!1;for(;this.__id<t&&!this.__store._read_item(this.__id);)this.__id++;return this.__id<=t},next:function(){if(this.hasNext()){var t=this.__store.get(this.__id);return this.__id==this.__store._read_last_id()?this.__id++:this.__id=this.__store._read_next_id(this.__id),t}return null}}),t},this)}}})}),a.define("module:Stores.LocalStore",["module:Stores.AssocDumbStore"],function(t,e){return t.extend({scoped:e},function(e){return{constructor:function(t){e.constructor.call(this,t),this.__prefix=t.prefix,this.__localStorage=a.getGlobal("localStorage")},__key:function(t){return this.__prefix+t},_read_key:function(t){try{return JSON.parse(this.__localStorage.getItem(this.__key(t)))}catch(e){return null}},_write_key:function(t,e){this.__localStorage.setItem(this.__key(t),JSON.stringify(e))},_remove_key:function(t){this.__localStorage.removeItem(this.__key(t))}}})}),a.define("module:Stores.Invokers.RestInvokeeAjaxInvoker",["base:Class","base:Net.Uri","base:Net.HttpHeader","module:Stores.Invokers.RestInvokee"],function(t,r,s,e,i){return t.extend({scoped:i},[e,function(e){return{constructor:function(t){e.constructor.call(this),this.__ajax=t},restInvoke:function(t,e,i,n){return this.__ajax.execute({method:t,data:i,uri:r.appendUriParams(e,n)}).mapError(function(t){return{error:t.status_code(),data:t.data?t.data():null,invalid:t.status_code()===s.HTTP_STATUS_PRECONDITION_FAILED}},this)}}}])}),a.define("module:Stores.Invokers.StoreInvokee",[],function(){return{storeInvoke:function(t,e,i){},storeInvokeWatcher:function(t,e,i){}}}),a.define("module:Stores.Invokers.RestInvokee",[],function(){return{restInvoke:function(t,e,i,n,r){}}}),a.define("module:Stores.Invokers.RouteredRestInvokee",[],function(){return{routeredRestInvoke:function(t,e,i,n,r){}}}),a.define("module:Stores.Invokers.AbstractInvokerStore",["module:Stores.BaseStore","module:Queries.Constrained"],function(t,e,i){return t.extend({scoped:i},function(t){return{_query_capabilities:function(){return e.fullConstrainedQueryCapabilities()},_invoke:function(t,e,i){throw"Abstract method invoke"},_invokeWatcher:function(t,e,i){throw"Abstract method invokeWatcher"},_insert:function(t,e){return this._invoke("insert",t,e)},_remove:function(t,e){return this._invoke("remove",t,e)},_get:function(t,e){return this._invoke("get",t,e)},_update:function(t,e,i,n){return this._invoke("update",{id:t,data:e,transaction_id:n},i)},_query:function(t,e,i){return this._invoke("query",{query:t,options:e},i)}}})}),a.define("module:Stores.Invokers.InvokerStoreWatcher",["module:Stores.Watchers.LocalWatcher"],function(t,e){return t.extend({scoped:e},{_watchItem:function(t){this._store._invokeWatcher("watchItem",t)},_unwatchItem:function(t){this._store._invokeWatcher("unwatchItem",t)},_watchInsert:function(t){this._store._invokeWatcher("watchInsert",t)},_unwatchInsert:function(t){this._store._invokeWatcher("unwatchInsert",t)}})}),a.define("module:Stores.Invokers.InvokerStore",["module:Stores.Invokers.AbstractInvokerStore"],function(t,e){return t.extend({scoped:e},function(i){return{constructor:function(t,e){i.constructor.call(this,e),this.__storeInvokee=t},_invoke:function(t,e,i){return this.__storeInvokee.storeInvoke(t,e,i)}}})}),a.define("module:Stores.Invokers.StoreInvokeeInvoker",["base:Class","module:Stores.Invokers.StoreInvokee"],function(t,e,i){return t.extend({scoped:i},[e,function(e){return{constructor:function(t){e.constructor.apply(this),this.__store=t},_store:function(){return this.__store},storeInvoke:function(t,e,i){return this["__"+t](e,i)},storeInvokeWatcher:function(t,e,i){return this["__"+t](e,i),!0},__insert:function(t,e){return this._store().insert(t,e)},__remove:function(t,e){return this._store().remove(t,e)},__get:function(t,e){return this._store().get(t,e)},__update:function(t,e){return this._store().update(t.id,t.data,e,t.transaction_id)},__query:function(t,e){return this._store().query(t.query,t.options,e).mapSuccess(function(t){var e=t.asArray();return t.decreaseRef(),e})},__watchItem:function(t,e){this._store().watcher()&&this._store().watcher().watchItem(t,e)},__unwatchItem:function(t,e){this._store().watcher()&&this._store().watcher().unwatchItem(t,e)},__watchInsert:function(t,e){this._store().watcher()&&this._store().watcher().watchInsert(t,e)},__unwatchInsert:function(t,e){this._store().watcher()&&this._store().watcher().unwatchInsert(t,e)}}}])}),a.define("module:Stores.Invokers.StoreInvokeeRestInvoker",["base:Class","base:Objs","base:Types","module:Stores.Invokers.StoreInvokee"],function(t,n,s,e,i){return t.extend({scoped:i},[e,function(i){return{constructor:function(t,e){i.constructor.call(this),this.__restInvokee=t,this.__options=n.tree_extend({methodMap:{insert:"POST",get:"GET",remove:"DELETE",update:"PUT",query:"GET"},toMethod:null,dataMap:{insert:function(t,e){return t},update:function(t,e){return t.data}},toData:null,getMap:{query:function(t,e){var i={};return t.query&&!s.is_empty(t.query)&&(i.query=JSON.stringify(t.query)),(i=n.extend(i,t.options)).sort&&(i.sort=JSON.stringify(i.sort)),i}},toGet:null,baseURI:"/",uriMap:{get:function(t,e){return t},remove:function(t,e){return t},update:function(t,e){return t.id}},toURI:null,context:this},e)},storeInvoke:function(t,e,i){return this.__restInvokee.restInvoke(this._toMethod(t,e,i),this._toURI(t,e,i),this._toData(t,e,i),this._toGet(t,e,i))},_toMethod:function(t,e,i){var n=null;return this.__options.toMethod&&(n=this.__options.toMethod.call(this.__options.context,t,e,i)),n||this.__options.methodMap[t]},_toURI:function(t,e,i){var n=s.is_function(this.__options.baseURI)?this.__options.baseURI.call(this.__options.context,i):this.__options.baseURI;if(this.__options.toURI){var r=this.__options.toURI.call(this.__options.context,t,e,i);if(r)return n+r}return n+(t in this.__options.uriMap?s.is_function(this.__options.uriMap[t])?this.__options.uriMap[t].call(this.__options.context,e,i):this.__options.uriMap[t]:"")},_toData:function(t,e,i){var n=null;return this.__options.toData&&(n=this.__options.toData.call(this.__options.context,t,e,i)),n||(t in this.__options.dataMap?this.__options.dataMap[t].call(this.__options.context,e,i):null)},_toGet:function(t,e,i){var n=null;return this.__options.toGet&&(n=this.__options.toGet.call(this.__options.context,t,e,i)),n||(t in this.__options.getMap?this.__options.getMap[t].call(this.__options.context,e,i):null)}}}])}),a.define("module:Stores.Invokers.RouteredRestInvokeeStoreInvoker",["base:Class","base:Objs","base:Types","module:Stores.Invokers.RouteredRestInvokee"],function(t,a,c,e,i){return t.extend({scoped:i},[e,function(i){return{constructor:function(t,e){i.constructor.call(this),this.__storeInvokee=t,this.__options=a.tree_extend({dataMap:{insert:function(t,e,i,n,r){return i},update:function(t,e,i,n,r){return{id:e.id,data:i}},get:function(t,e,i,n,r){return e.id},remove:function(t,e,i,n,r){return e.id},query:function(t,e,i,n,r){var s={};try{n.query&&(s.query=JSON.parse(n.query))}catch(u){}var o=a.clone(n,1);delete o.query,c.is_empty(o)||(s.options=o);try{s.options.sort&&(s.options.sort=JSON.parse(s.options.sort))}catch(u){}return s}},toData:null,contextMap:{},toContext:function(t,e,i,n,r){return r},context:this},e)},routeredRestInvoke:function(t,e,i,n,r){return this.__storeInvokee.storeInvoke(t,this._toData(t,e,i,n,r),this._toContext(t,e,i,n,r))},_toData:function(t,e,i,n,r){var s=null;return this.__options.toData&&(s=this.__options.toData.call(this.__options.context,t,e,i,n,r)),s||(t in this.__options.dataMap?this.__options.dataMap[t].call(this.__options.context,t,e,i,n,r):null)},_toContext:function(t,e,i,n,r){var s=null;return this.__options.toContext&&(s=this.__options.toContext.call(this.__options.context,t,e,i,n,r)),s||(t in this.__options.contextMap?this.__options.contextMap[t].call(this.__options.context,t,e,i,n,r):null)}}}])}),a.define("module:Stores.Invokers.RestInvokeeStoreInvoker",["module:Stores.Invokers.RouteredRestInvokeeStoreInvoker","module:Stores.Invokers.RestInvokee","base:Router.RouteParser","base:Objs","base:Types"],function(t,e,n,r,s,i){return t.extend({scoped:i},[e,function(i){return{constructor:function(t,e){i.constructor.call(this,t,r.tree_extend({baseURI:"/",methodMap:{insert:"POST",get:"GET",remove:"DELETE",update:"PUT",query:"GET"},toMethod:null,uriMap:{get:"(id:.+)",remove:"(id:.+)",update:"(id:.+)"},toURI:null},e)),this.__routes={},r.iter(this.__options.methodMap,function(t,e){var i="",n=s.is_function(this.__options.baseURI)?this.__options.baseURI.call(this.__options.context):this.__options.baseURI;if(this.__options.toURI){var r=this.__options.toURI.call(this.__options.context,e);r&&(i=n+r)}i||(i=n+(e in this.__options.uriMap?s.is_function(this.__options.uriMap[e])?this.__options.uriMap[e].call(this.__options.context):this.__options.uriMap[e]:"")),this.__routes[e]=t+" "+i},this),this.__routeParser=this.auto_destroy(new n(this.__routes))},restInvoke:function(t,e,i,n,r){var s=this.__routeParser.parse(t+" "+e);return this.routeredRestInvoke(s.name,s.args,i,n,r)}}}])}),a.define("module:Stores.CachedStore",["module:Stores.BaseStore","module:Stores.MemoryStore","module:Queries","module:Queries.Constrained","module:Stores.CacheStrategies.ExpiryCacheStrategy","base:Promise","base:Objs","base:Types","base:Iterators.ArrayIterator","base:Iterators.MappedIterator","base:Timers.Timer"],function(t,n,_,e,r,h,l,s,d,f,o,i){return t.extend({scoped:i},function(i){return{constructor:function(t,e){i.constructor.call(this),this.remoteStore=t,this._options=l.extend({itemMetaKey:"meta",queryMetaKey:"meta",queryKey:"query",cacheKey:null,suppAttrs:{},optimisticRead:!1},e),this._online=!0,this.itemCache=this._options.itemCache||this.auto_destroy(new n({id_key:this._options.cacheKey||this.remoteStore.id_key()})),this._options.cacheKey=this.itemCache.id_key(),this._id_key=this.itemCache.id_key(),this._foreignKey=this.itemCache.id_key()!==this.remoteStore.id_key(),this.queryCache=this._options.queryCache||this.auto_destroy(new n),this.cacheStrategy=this._options.cacheStrategy||this.auto_destroy(new r),this._options.auto_cleanup&&this.auto_destroy(new o({fire:this.cleanup,context:this,start:!0,delay:this._options.auto_cleanup}))},_query_capabilities:function(){return e.fullConstrainedQueryCapabilities()},_insert:function(t,e){return this.cacheInsert(t,{lockItem:!0,silent:!0,refreshMeta:!1,accessMeta:!0},e)},_update:function(t,e,i,n){return this.cacheUpdate(t,e,{ignoreLock:!1,silent:!0,lockAttrs:!0,refreshMeta:!1,accessMeta:!0},i,n)},_remove:function(t,e){return this.cacheRemove(t,{ignoreLock:!0,silent:!0},e)},_get:function(t,e){return this.cacheGet(t,{silentInsert:!0,silentUpdate:!0,silentRemove:!0,refreshMeta:!0,accessMeta:!0},e)},_query:function(t,e,i){return this.cacheQuery(t,e,{silent:!0,queryRefreshMeta:!0,queryAccessMeta:!0,refreshMeta:!0,accessMeta:!0},i)},cacheInsert:function(e,i,n){var t={lockedItem:i.lockItem,lockedAttrs:{},refreshMeta:i.refreshMeta?this.cacheStrategy.itemRefreshMeta():null,accessMeta:i.accessMeta?this.cacheStrategy.itemAccessMeta():null};return this.itemCache.insert(this.addItemSupp(this.addItemMeta(e,t)),n).mapSuccess(function(t){return e=this.removeItemMeta(t),i.silent||this._inserted(e,n),e},this)},cacheUpdate:function(t,e,r,s,o){return(r.foreignKey&&this._foreignKey?this.itemCache.getBy(this.remoteStore.id_key(),t,s):this.itemCache.get(t,s)).mapSuccess(function(i){if(!i)return null;var n=this.readItemMeta(i);return r.unlockItem&&(n.lockedItem=!1,n.lockedAttrs={}),e=l.filter(e,function(t,e){return(r.ignoreLock||!n.lockedItem&&!n.lockedAttrs[e])&&(!(e in i)||i[e]!=t)},this),r.lockAttrs&&l.iter(e,function(t,e){n.lockedAttrs[e]=!0},this),r.refreshMeta&&(n.refreshMeta=this.cacheStrategy.itemRefreshMeta(n.refreshMeta)),r.accessMeta&&(n.accessMeta=this.cacheStrategy.itemAccessMeta(n.accessMeta)),this.itemCache.update(this.itemCache.id_of(i),this.addItemMeta(e,n),s,o).mapSuccess(function(t){return t=this.removeItemMeta(t),r.silent||this._updated(t,e,s,o),t},this)},this)},cacheInsertUpdate:function(n,r,s,o){return(r.foreignKey&&this._foreignKey?this.itemCache.getBy(this.remoteStore.id_key(),this.remoteStore.id_of(n),s):this.itemCache.get(this.itemCache.id_of(n),s)).mapSuccess(function(t){if(r.foreignKey=!1,!t)return this.cacheInsert(n,r,s);var e=l.clone(n,1),i=this.itemCache.id_of(t);return e[this.itemCache.id_key()]=i,this.cacheUpdate(i,n,r,s,o).mapSuccess(function(t){return l.extend(e,t)})},this)},cacheRemove:function(t,n,r){return(n.foreignKey&&this._foreignKey?this.itemCache.getBy(this.remoteStore.id_key(),t,r):this.itemCache.get(t,r)).mapSuccess(function(t){if(!t)return t;var e=this.readItemMeta(t);if(!n.ignoreLock&&(e.lockedItem||!s.is_empty(e.lockedAttrs)))return h.error("locked item");var i=this.itemCache.id_of(t);return this.itemCache.remove(i,r).mapSuccess(function(){return n.silent||this._removed(i,r,t),t},this)},this)},cacheOnlyGet:function(t,e,i){return(e=e||{}).foreignKey&&this._foreignKey?this.itemCache.getBy(this.remoteStore.id_key(),t,i):this.itemCache.get(t,i)},cacheGet:function(r,s,o){var u=s.foreignKey&&this._foreignKey;return this.cacheOnlyGet(r,s,o).mapSuccess(function(t){if(!t)return!u&&this._foreignKey?t:this.remoteStore.get(r,o).mapSuccess(function(t){return this.online(),t?this.cacheInsert(t,{lockItem:!1,silent:s.silentInsert,accessMeta:!0,refreshMeta:!0},o):t},this);var e=this.readItemMeta(t),i=this.itemCache.id_of(t),n=this.remoteStore.id_of(t);return this.cacheStrategy.validItemRefreshMeta(e.refreshMeta)||e.lockedItem?(s.accessMeta&&(e.accessMeta=this.cacheStrategy.itemAccessMeta(e.accessMeta),this.itemCache.update(i,this.addItemMeta({},e),o)),this.removeItemMeta(t)):this.remoteStore.get(n,o).mapSuccess(function(t){return this.online(),t?this.cacheUpdate(i,t,{ignoreLock:!1,lockAttrs:!1,silent:s.silentUpdate,accessMeta:!0,refreshMeta:!0},o):this.cacheRemove(i,{ignoreLock:!1,silent:s.silentRemove},o)},this).mapError(function(){return this.offline(),h.value(t)},this)},this)},__itemCacheQuery:function(t,i,n){return this.itemCache.query(t,i,n).mapSuccess(function(t){t=t.asArray(),l.iter(t,function(t){this.cacheUpdate(this.itemCache.id_of(t),{},{lockItem:!1,lockAttrs:!1,silent:!0,accessMeta:i.accessMeta,refreshMeta:!1},n)},this);var e=new d(t);return new f(e,this.removeItemMeta,this).auto_destroy(e,!0)},this)},cacheQuery:function(s,o,u,a){var c=e.serialize({query:s,options:o}),t=l.objectBy(this._options.queryKey,c);return this.queryCache.query(t,{limit:1},a).mapSuccess(function(t){var e=t.hasNext()?t.next():null;if(t.destroy(),e){var i=this.readQueryMeta(e),n=this.queryCache.id_of(e);if(this.cacheStrategy.validQueryRefreshMeta(i.refreshMeta))return u.queryAccessMeta&&(i.accessMeta=this.cacheStrategy.queryAccessMeta(i.accessMeta),this.queryCache.update(n,this.addQueryMeta({},i),a)),this.__itemCacheQuery(s,o,a);this.queryCache.remove(n,a)}if(_.queryDeterminedByAttrs(s,this._options.suppAttrs,!0))return this.itemCache.query(s,o,a);var r=this.remoteStore.query(this.removeItemSupp(s),o,a).mapSuccess(function(t){this.online(),t=t.asArray();var e={refreshMeta:u.queryRefreshMeta?this.cacheStrategy.queryRefreshMeta():null,accessMeta:u.queryAccessMeta?this.cacheStrategy.queryAccessMeta():null};this.queryCache.insert(l.objectBy(this._options.queryKey,c,this._options.queryMetaKey,e),a);var i=[];return l.iter(t,function(t){i.push(this.cacheInsertUpdate(t,{lockItem:!1,lockAttrs:!1,silent:u.silent&&!this._options.optimisticRead,accessMeta:u.accessMeta,refreshMeta:u.refreshMeta,foreignKey:!0},a))},this),h.and(i).mapSuccess(function(t){var e=new d(t);return new f(e,this.addItemSupp,this).auto_destroy(e,!0)},this)},this).mapError(function(){if(this.offline(),!this._options.optimisticRead)return this.__itemCacheQuery(s,o,a)},this);return this._options.optimisticRead?this.__itemCacheQuery(s,o,a):r},this)},online:function(){this.trigger("online"),this._online=!0},offline:function(){this.trigger("offline"),this._online=!1},addItemMeta:function(t,e){return(t=l.clone(t,1))[this._options.itemMetaKey]=e,t},addItemSupp:function(t){return l.extend(l.clone(this._options.suppAttrs,1),t)},removeItemSupp:function(t){return this._options.suppAttrs?l.filter(t,function(t,e){return!(e in this._options.suppAttrs)},this):t},addQueryMeta:function(t,e){return(t=l.clone(t,1))[this._options.queryMetaKey]=e,t},removeItemMeta:function(t){return delete(t=l.clone(t,1))[this._options.itemMetaKey],t},removeQueryMeta:function(t){return delete(t=l.clone(t,1))[this._options.queryMetaKey],t},readItemMeta:function(t){return t[this._options.itemMetaKey]},readQueryMeta:function(t){return t[this._options.queryMetaKey]},unlockItem:function(i,n){this.itemCache.get(i,n).success(function(t){if(t){var e=this.readItemMeta(t);e.lockedItem=!1,e.lockedAttrs={},this.itemCache.update(i,this.addItemMeta({},e),n)}},this)},cleanup:function(){this._online&&(this.queryCache.query().success(function(t){for(;t.hasNext();){var e=t.next(),i=this.readQueryMeta(e);this.cacheStrategy.validQueryRefreshMeta(i.refreshMeta)&&this.cacheStrategy.validQueryAccessMeta(i.accessMeta)||this.queryCache.remove(this.queryCache.id_of(e))}t.destroy()},this),this.itemCache.query().success(function(t){for(;t.hasNext();){var e=t.next(),i=this.readItemMeta(e);i.lockedItem||!s.is_empty(i.lockedAttrs)||this.cacheStrategy.validItemRefreshMeta(i.refreshMeta)&&this.cacheStrategy.validItemAccessMeta(i.accessMeta)||this.itemCache.remove(this.itemCache.id_of(e))}t.destroy()},this))},cachedIdToRemoteId:function(t){return this._foreignKey?this.itemCache.get(t).mapSuccess(function(t){return t?this.remoteStore.id_of(t):null},this):h.value(t)},serialize:function(){return this.itemCache.serialize().mapSuccess(function(e){return this.queryCache.serialize().mapSuccess(function(t){return{items:e,queries:t}},this)},this)},unserialize:function(e){return this.itemCache.unserialize(e.items).mapSuccess(function(t){return this.queryCache.unserialize(e.queries),t.map(function(t){return this.removeItemMeta(t)},this)},this)}}})}),a.define("module:Stores.CacheStrategies.CacheStrategy",["base:Class"],function(t,e){return t.extend({scoped:e},{itemRefreshMeta:function(t){},queryRefreshMeta:function(t){},itemAccessMeta:function(t){},queryAccessMeta:function(t){},validItemRefreshMeta:function(t){},validQueryRefreshMeta:function(t){},validItemAccessMeta:function(t){},validQueryAccessMeta:function(t){}})}),a.define("module:Stores.CacheStrategies.ExpiryCacheStrategy",["module:Stores.CacheStrategies.CacheStrategy","base:Time","base:Objs"],function(t,i,n,e){return t.extend({scoped:e},function(e){return{constructor:function(t){e.constructor.call(this),this._options=n.extend({itemRefreshTime:144e4,itemAccessTime:36e6,queryRefreshTime:144e4,queryAccessTime:36e6,now:function(){return i.now()}},t)},itemRefreshMeta:function(t){return t||(null===this._options.itemRefreshTime?null:this._options.now()+this._options.itemRefreshTime)},queryRefreshMeta:function(t){return t||(null===this._options.queryRefreshTime?null:this._options.now()+this._options.queryRefreshTime)},itemAccessMeta:function(t){return null===this._options.itemAccessTime?null:this._options.now()+this._options.itemAccessTime},queryAccessMeta:function(t){return null===this._options.queryAccessTime?null:this._options.now()+this._options.queryAccessTime},validItemRefreshMeta:function(t){return null===this._options.itemRefreshTime||t>=this._options.now()},validQueryRefreshMeta:function(t){return null===this._options.queryRefreshTime||t>=this._options.now()},validItemAccessMeta:function(t){return null===this._options.itemAccessTime||t>=this._options.now()},validQueryAccessMeta:function(t){return null===this._options.queryAccessTime||t>=this._options.now()}}})}),a.define("module:Stores.PartialStoreWriteStrategies.WriteStrategy",["base:Class"],function(t,e){return t.extend({scoped:e},function(t){return{init:function(t){this.partialStore=t},insert:function(t,e){},remove:function(t,e){},update:function(t,e,i){}}})}),a.define("module:Stores.PartialStoreWriteStrategies.PostWriteStrategy",["module:Stores.PartialStoreWriteStrategies.WriteStrategy","base:Types","base:Objs"],function(t,o,u,e){return t.extend({scoped:e},function(t){return{insert:function(t,e){return this.partialStore.remoteStore.insert(t,e).mapSuccess(function(t){return this.partialStore.cachedStore.cacheInsert(t,{lockItem:!1,silent:!0,refreshMeta:!0,accessMeta:!0},e)},this)},remove:function(e,i){return this.partialStore.cachedStore.cachedIdToRemoteId(e).mapSuccess(function(t){return this.partialStore.remoteStore.remove(t,i).mapSuccess(function(){return this.partialStore.cachedStore.cacheRemove(e,{ignoreLock:!0,silent:!0},i)},this)},this)},update:function(i,n,r,s){var e=function(t){var e=u.extend(u.clone(n,1),t);return this.partialStore.cachedStore.cacheUpdate(i,e,{ignoreLock:!1,lockAttrs:!1,silent:!0,refreshMeta:!0,accessMeta:!0},r,s)};return!o.is_empty(this.partialStore.cachedStore.removeItemSupp(n))?this.partialStore.cachedStore.cachedIdToRemoteId(i).mapSuccess(function(t){return this.partialStore.remoteStore.update(t,n,r,s).mapSuccess(function(t){return e.call(this,t)},this)},this):e.call(this)}}})}),a.define("module:Stores.PartialStoreWriteStrategies.PreWriteStrategy",["module:Stores.PartialStoreWriteStrategies.WriteStrategy","base:Objs"],function(t,n,e){return t.extend({scoped:e},function(i){return{constructor:function(t,e){i.constructor.call(this),this._options=e||{}},insert:function(t){return this.partialStore.cachedStore.cacheInsert(t,{lockItem:!0,silent:!0,refreshMeta:!0,accessMeta:!0}).mapSuccess(function(e){nosuppdata=this.partialStore.cachedStore.removeItemSupp(e);var t=this.partialStore.remoteStore.insert(nosuppdata).mapSuccess(function(t){return this.partialStore.cachedStore.cacheUpdate(this.partialStore.cachedStore.id_of(e),t,{silent:!0,unlockItem:!0}).mapSuccess(function(t){return n.extend(n.clone(e,1),t)},this)},this).error(function(){this.partialStore.cachedStore.cacheRemove(this.partialStore.cachedStore.id_of(e),{ignoreLock:!0,silent:!1})},this);return this._options.optimistic?e:t},this)},remove:function(i){return this.partialStore.cachedStore.cachedIdToRemoteId(i).mapSuccess(function(t){var e=this.partialStore.cachedStore.cacheRemove(i,{ignoreLock:!0,silent:!0}).success(function(){this.partialStore.remoteStore.remove(t)},this);return this._options.optimistic?data:e},this)},update:function(i,n,r,s){return this.partialStore.cachedStore.cachedIdToRemoteId(i).mapSuccess(function(e){var t=this.partialStore.cachedStore.cacheUpdate(i,n,{lockAttrs:!0,ignoreLock:!1,silent:!0,refreshMeta:!1,accessMeta:!0},r,s).success(function(t){t=this.partialStore.cachedStore.removeItemSupp(t),this.partialStore.remoteStore.update(e,t,r,s).success(function(){this.partialStore.cachedStore.unlockItem(i)},this)},this);return this._options.optimistic?n:t},this)}}})}),a.define("module:Stores.PartialStoreWriteStrategies.CommitStrategy",["module:Stores.PartialStoreWriteStrategies.WriteStrategy","module:Stores.StoreHistory","module:Stores.MemoryStore","base:Objs","base:Timers.Timer","base:Promise"],function(t,e,n,a,r,c,i){return t.extend({scoped:i},function(i){return{constructor:function(t,e){i.constructor.call(this),this._options=e||{},this.historyStore=this._options.historyStore||this.auto_destroy(new n)},init:function(t){i.init.call(this,t),this.storeHistory=this.auto_destroy(new e(null,this.historyStore,a.extend({source_id_key:t.cachedStore.itemCache.id_key(),row_data:{pushed:!1,success:!1},filter_data:{pushed:!1},pushedStateOnFail:!0},this._options))),this._options.auto_push&&(this._timer=this.auto_destroy(new r({fire:function(){this.push(this.partialStore)},context:this,start:!0,delay:this._options.auto_push})))},insert:function(t){return this.partialStore.cachedStore.cacheInsert(t,{lockItem:!0,silent:!0,refreshMeta:!0,accessMeta:!0}).success(function(t){t=this.partialStore.cachedStore.removeItemSupp(t),this.storeHistory.sourceInsert(t)},this)},remove:function(i){return this.partialStore.cachedStore.cachedIdToRemoteId(i).mapSuccess(function(e){return this.partialStore.cachedStore.cacheRemove(i,{ignoreLock:!0,silent:!0}).mapSuccess(function(t){return this.storeHistory.sourceRemove(i,this.partialStore.remoteStore.id_row(e)),t},this)},this)},update:function(t,e,i,n){return this.partialStore.cachedStore.cacheUpdate(t,e,{lockAttrs:!0,ignoreLock:!0,silent:!0,refreshMeta:!1,accessMeta:!0},i,n).success(function(){e=this.partialStore.cachedStore.removeItemSupp(e),this.storeHistory.sourceUpdate(t,e)},this)},push:function(){if(this.pushing)return c.value(!0);var n={},r={},s=this.storeHistory.historyStore;this.storeHistory.lockCommits();var o=s.query({success:!1},{sort:{commit_id:1}}).value(),u=function(){if(!o.hasNext())return this.pushing=!1,this.storeHistory.unlockCommits(),a.iter(r,function(t,e){t&&(!0===t?this.partialStore.cachedStore.unlockItem(e):this.partialStore.cachedStore.cacheUpdate(e,t,{unlockItem:!0,silent:!0}))},this),o.destroy(),c.value(!0);var e=o.next(),i=s.id_of(e);if(i in n)return s.update(i,{pushed:this._options.pushedStateOnFail,success:!1}),u.apply(this);var t=null;return"insert"===e.type?t=this.partialStore.remoteStore.insert(e.row):"update"===e.type?t=this.partialStore.cachedStore.cachedIdToRemoteId(e.row_id).mapSuccess(function(t){return this.partialStore.remoteStore.update(t,e.row)},this):"remove"===e.type&&(t=this.partialStore.remoteStore.remove(e.row?this.partialStore.remoteStore.id_of(e.row):e.row_id)),t.mapSuccess(function(t){return s.update(i,{pushed:!0,success:!0}),e.row_id in r||(r[e.row_id]=!0,"insert"===e.type&&(r[e.row_id]=t)),u.apply(this)},this).mapError(function(){return s.update(i,{pushed:this._options.pushedStateOnFail,success:!1}),n[i]=!0,r[e.row_id]=!1,u.apply(this)},this)};return u.apply(this)}}})}),a.define("module:Stores.PartialStoreWriteStrategies.DelegatedWriteStrategy",["module:Stores.PartialStoreWriteStrategies.WriteStrategy"],function(t,e){return t.extend({scoped:e},function(n){return{constructor:function(t,e,i){n.constructor.call(this),this._insertWriteStrategy=t,this._updateWriteStrategy=e,this._removeWriteStrategy=i},init:function(t){n.init.call(this,t),this._insertWriteStrategy.init(t),this._updateWriteStrategy.init(t),this._removeWriteStrategy.init(t)},insert:function(){return this._insertWriteStrategy.insert.apply(this._insertWriteStrategy,arguments)},remove:function(){return this._updateWriteStrategy.remove.apply(this._updateWriteStrategy,arguments)},update:function(){return this._removeWriteStrategy.update.apply(this._removeWriteStrategy,arguments)}}})}),a.define("module:Stores.PartialStore",["module:Stores.BaseStore","module:Stores.CachedStore","module:Stores.PartialStoreWriteStrategies.PostWriteStrategy","module:Stores.PartialStoreWatcher","base:Objs","base:Types"],function(t,n,r,s,o,u,e){return t.extend({scoped:e},function(i){return{constructor:function(t,e){i.constructor.call(this,e),this._options=o.extend({},e),this._options.remoteWatcher&&(this.remoteWatcher=this._options.remoteWatcher),this.remoteStore=t,this.cachedStore=new n(t,this._options),this.writeStrategy=this._options.writeStrategy||this.auto_destroy(new r),this.remoteWatcher&&(this.remoteWatcher.on("insert",this._remoteInsert,this),this.remoteWatcher.on("update",this._remoteUpdate,this),this.remoteWatcher.on("remove",this._remoteRemove,this),this._watcher=new s(this)),this.cachedStore.on("insert",this._inserted,this),this.cachedStore.on("remove",this._removed,this),this.cachedStore.on("update",this._updated,this),this.writeStrategy.init(this)},id_key:function(){return this.cachedStore.id_key()},destroy:function(){this.remoteWatcher&&this.remoteWatcher.off(null,null,this),this._watcher&&this._watcher.destroy(),this.cachedStore.destroy(),i.destroy.call(this)},_insert:function(t,e){return this.writeStrategy.insert(t,e)},_remove:function(t,e){return this.writeStrategy.remove(t,e)},_update:function(i,n,r,s){return this.cachedStore.cacheOnlyGet(i,{},r).mapSuccess(function(t){var e=o.diff(n,t);return u.is_empty(e)?t:this.writeStrategy.update(i,n,r,s)},this)},_get:function(t,e){return this.cachedStore.get(t,e)},_query:function(t,e,i){return this.cachedStore.query(t,e,i)},_query_capabilities:function(){return this.cachedStore._query_capabilities()},_remoteInsert:function(t,e){this.cachedStore.cacheInsertUpdate(t,{lockItem:!1,silent:!1,refreshMeta:!0,accessMeta:!0,foreignKey:!0},e)},_remoteUpdate:function(t,e,i){var n=this.remoteStore.id_of(t);this.cachedStore.cacheUpdate(n,e,{ignoreLock:!1,lockAttrs:!1,silent:!1,accessMeta:!0,refreshMeta:!0,foreignKey:!0},i)},_remoteRemove:function(t,e){this.cachedStore.cacheRemove(t,{ignoreLock:!1,silent:!1,foreignKey:!0},e)},serialize:function(){return this.cachedStore.serialize()},unserialize:function(t){return this.cachedStore.unserialize(t).success(function(t){t.forEach(function(t){this._inserted(t)},this)},this)}}})}),a.define("module:Stores.PartialStoreWatcher",["module:Stores.Watchers.LocalWatcher"],function(t,e){return t.extend({scoped:e},function(e){return{_watchItem:function(t){e.watchItem.call(this,t),this._store.cachedStore.cachedIdToRemoteId(t).success(function(t){this._store.remoteWatcher.watchItem(t,this)},this)},_unwatchItem:function(t){e.unwatchItem.call(this,t),this._store.cachedStore.cachedIdToRemoteId(t).success(function(t){this._store.remoteWatcher.unwatchItem(t,this)},this)},_watchInsert:function(t){e.watchInsert.call(this,t),this._store.remoteWatcher.watchInsert(t,this)},_unwatchInsert:function(t){e.unwatchInsert.call(this,t),this._store.remoteWatcher.unwatchInsert(t,this)}}})}),a.define("module:Stores.ChannelClientStore",["module:Stores.Invokers.AbstractInvokerStore","base:Channels.TransportChannel","base:Functions"],function(t,r,s,e){return t.extend({scoped:e},function(n){return{constructor:function(t,e,i){n.constructor.call(this,i),this.transport=this.auto_destroy(new r(t,e)),this.transport._reply=s.as_method(function(t,e){"event"===t&&this.trigger.apply(this,[e.event].concat(e.args))},this)},_invoke:function(t,e,i){return this.transport.send("invoke",{member:t,data:e,context:i})},_invokeWatcher:function(t,e,i){return this.transport.send("invokewatcher",{member:t,data:e,context:i})}}})}),a.define("module:Stores.ChannelServerStore",["module:Stores.Invokers.StoreInvokeeInvoker","base:Channels.TransportChannel","base:Functions"],function(t,r,s,e){return t.extend({scoped:e},function(n){return{constructor:function(t,e,i){n.constructor.call(this,i),this.transport=this.auto_destroy(new r(t,e)),this.transport._reply=s.as_method(function(t,e){return"invoke"===t?this.storeInvoke(e.member,e.data,e.context):"invokewatcher"===t?this.storeInvokeWatcher(e.member,e.data,e.context):void 0},this),i.on("all",function(t){this.transport.send("event",{event:t,args:s.getArguments(arguments,1)},{stateless:!0})},this)}}})}),a.define("module:Stores.RemoteStore",["module:Stores.Invokers.InvokerStore","module:Stores.Invokers.StoreInvokeeRestInvoker","module:Stores.Invokers.RestInvokeeAjaxInvoker"],function(t,o,u,e){return t.extend({scoped:e},function(s){return{constructor:function(t,e,i){var n=new u(t),r=new o(n,e);s.constructor.call(this,r,i),this.auto_destroy(r),this.auto_destroy(n)}}})}),a.define("module:Stores.SocketStore",["module:Stores.BaseStore","base:Objs"],function(t,i,e){return t.extend({scoped:e},function(n){return{constructor:function(t,e,i){n.constructor.call(this,t),this.__socket=e,this.__prefix=i},__send:function(t,e){this.__socket.emit(this.__prefix+":"+t,e)},_insert:function(t){this.__send("insert",t)},_remove:function(t){this.__send("remove",t)},_update:function(t,e){this.__send("update",i.objectBy(t,e))}}})}),a.define("module:Stores.Watchers.ConsumerWatcher",["module:Stores.Watchers.StoreWatcher"],function(t,e){return t.extend({scoped:e},function(n){return{constructor:function(t,e,i){n.constructor.call(this,i),this._receiver=e,this._sender=t,e.on("receive",function(t,e){"insert"===t&&this._insertedWatchedInsert(e),"update"===t?this._updatedWatchedItem(e.row,e.data):"remove"===t&&this._removedWatchedItem(e)},this)},destroy:function(){this._receiver.off(null,null,this),n.destroy.apply(this)},_watchItem:function(t){this._sender.send("watch_item",t)},_unwatchItem:function(t){this._sender.send("unwatch_item",t)},_watchInsert:function(t){this._sender.send("watch_insert",t)},_unwatchInsert:function(t){this._sender.send("unwatch_insert",t)}}})}),a.define("module:Stores.Watchers.ProducerWatcher",["base:Class"],function(t,e){return t.extend({scoped:e},function(e){return{constructor:function(i,t,n){e.constructor.apply(this),this._watcher=n,(this._receiver=t).on("receive",function(t,e){"watch_item"===t?n.watchItem(e,this):"unwatch_item"===t?n.unwatchItem(e,this):"watch_insert"===t?n.watchInsert(e,this):"unwatch_insert"===t&&n.unwatchInsert(e,this)},this),n.on("insert",function(t){i.send("insert",t)},this).on("update",function(t,e){i.send("update",{row:t,data:e})},this).on("remove",function(t){i.send("remove",t)},this)},destroy:function(){this._receiver.off(null,null,this),this._watcher.off(null,null,this),e.destroy.apply(this)}}})}),a.define("module:Stores.Watchers.ListWatcher",["module:Stores.Watchers.StoreWatcher","base:Objs"],function(t,i,e){return t.extend({scoped:e},function(n){return{constructor:function(t,e,i){(i=i||{}).id_key=t.id_key(),this.__watchers={},n.constructor.call(this,i),e&&e.forEach(this.addWatcher,this)},addWatcher:function(t){return this.__watchers[t.cid()]||(this.delegateEvents(["insert","update","remove"],t),this.itemsIterator().iterate(t.watchItem,t),this.insertsIterator().iterate(t.watchInsert,t),this.__watchers[t.cid()]=t),this},removeWatcher:function(t){return this.__watchers[t.cid()]&&(t.off(null,null,this),this.itemsIterator().iterate(t.unwatchItem,t),this.insertsIterator().iterate(t.unwatchInsert,t),delete this.__watchers[t.cid()]),this},getWatchers:function(){return i.values(this.__watchers)},__forEachWatcher:function(t,e){i.iter(this.__watchers,t,e||this)},destroy:function(){this.__forEachWatcher(this.removeWatcher),n.destroy.apply(this)},_watchItem:function(e){this.__forEachWatcher(function(t){t.watchItem(e)})},_unwatchItem:function(e){this.__forEachWatcher(function(t){t.unwatchItem(e)})},_watchInsert:function(e){this.__forEachWatcher(function(t){t.watchInsert(e)})},_unwatchInsert:function(e){this.__forEachWatcher(function(t){t.unwatchInsert(e)})}}})}),a.define("module:Stores.Watchers.LocalWatcher",["module:Stores.Watchers.StoreWatcher"],function(t,e){return t.extend({scoped:e},function(i){return{constructor:function(t,e){(e=e||{}).id_key=t.id_key(),i.constructor.call(this,e),this._store=t,this._store.on("insert",function(t,e){this._insertedInsert(t,e)},this).on("update",function(t,e,i){this._updatedItem(t,e,i)},this).on("remove",function(t,e){this._removedItem(t,e)},this)},destroy:function(){this._store.off(null,null,this),i.destroy.apply(this)}}})}),a.define("module:Stores.Watchers.PollWatcher",["module:Stores.Watchers.StoreWatcher","base:Comparators","base:Objs","base:Timers.Timer"],function(t,r,s,n,e){return t.extend({scoped:e},function(i){return{constructor:function(t,e){(e=e||{}).id_key=t.id_key(),i.constructor.call(this,e),this._store=t,this.__itemCache={},this.__lastKey=null,this.__lastKeyIds={},this.__insertsCount=0,this.__increasingKey=e.increasing_key||this.id_key,this.__ignoreUpdates=e.ignore_updates,e.auto_poll&&this.auto_destroy(new n({fire:this.poll,context:this,start:!0,delay:e.auto_poll}))},_watchItem:function(t,e){this.__itemCache[t]={context:e,value:null}},_unwatchItem:function(t){delete this.__itemCache[t]},_queryLastKey:function(){return this._store.query({},{limit:1,sort:s.objectBy(this.__increasingKey,-1)}).mapSuccess(function(t){var e=t.hasNext()?t.next()[this.__increasingKey]:null;return t.destroy(),e},this).mapError(function(){return null})},_watchInsert:function(t){0===this.__insertsCount&&this._queryLastKey().success(function(t){this.__lastKey=t,this.__lastKeyIds={}},this),this.__insertsCount++},_unwatchInsert:function(t){this.__insertsCount--,0===this.__insertsCount&&(this.__lastKey=null)},poll:function(){this.__ignoreUpdates||s.iter(this.__itemCache,function(i,n){this._store.get(n,i.context).success(function(t){if(t){var e=i.value&&!r.deepEqual(i.value,t,-1);i.value=s.clone(t,1),e&&this._updatedItem(t,t)}else this._removedItem(n)},this).error(function(t){t&&t.error&&404==t.error&&this._removedItem(n)},this)},this),this.destroyed()||(this.__lastKey?this.insertsIterator().iterate(function(t){var e=t.query,i=t.options,n=s.objectBy(this.__increasingKey,{$gte:this.__lastKey});this._store.query(s.extend(n,e),i).success(function(t){for(;t.hasNext();){var e=t.next(),i=e[this.__increasingKey];this.__lastKeyIds[i]||this._insertedInsert(e),this.__lastKeyIds[i]=!0,i>this.__lastKey&&(this.__lastKey=i)}t.destroy()},this)},this):this._queryLastKey().success(function(t){t!==this.__lastKey&&(this.__lastKey=t,this.__lastKeyIds={})},this))}}})}),a.define("module:Stores.Watchers.StoreWatcherMixin",[],function(){return{watchItem:function(t,e){},unwatchItem:function(t,e){},watchInsert:function(t,e){},unwatchInsert:function(t,e){},_removedWatchedItem:function(t){this.trigger("remove",t)},_updatedWatchedItem:function(t,e){this.trigger("update",t,e)},_insertedWatchedInsert:function(t){this.trigger("insert",t)},delegateStoreEvents:function(i){this.on("insert",function(t){i.trigger("insert",t)},i).on("update",function(t,e){i.trigger("update",t,e)},i).on("remove",function(t){i.trigger("remove",t)},i)},undelegateStoreEvents:function(t){this.off(null,null,t)}}}),a.define("module:Stores.Watchers.StoreWatcher",["base:Class","base:Events.EventsMixin","base:Classes.ContextRegistry","base:Comparators","module:Stores.Watchers.StoreWatcherMixin","module:Queries"],function(t,e,i,n,r,s,o){return t.extend({scoped:o},[e,r,function(e){return{constructor:function(t){e.constructor.call(this),(t=t||{}).id_key?this.id_key=t.id_key:this.id_key="id",this.__ctx=t.ctx,this.__customCtxFilter=t.customCtxFilter,this.__items=new i,this.__inserts=new i(s.serialize,s)},destroy:function(){this.insertsIterator().iterate(this.unwatchInsert,this),this.itemsIterator().iterate(this.unwatchItem,this),this.__inserts.destroy(),this.__items.destroy(),e.destroy.call(this)},insertsIterator:function(){return this.__inserts.iterator()},itemsIterator:function(){return this.__items.iterator()},watchItem:function(t,e){this.__items.register(t,e)&&this._watchItem(t)},unwatchItem:function(t,e){this.__items.unregister(t,e).forEach(this._unwatchItem,this)},watchInsert:function(t,e){this.__inserts.register(t,e)&&this._watchInsert(t)},unwatchInsert:function(t,e){this.__inserts.unregister(t,e).forEach(this._unwatchInsert,this)},_ctxFilter:function(t,e){return!this.__ctx||!t||n.deepEqual(this.__ctx,t,2)||this.__customCtxFilter&&this.__customCtxFilter(this.__ctx,t,e)},_removedItem:function(t,e){this._ctxFilter(e)&&this.__items.get(t)&&this._removedWatchedItem(t)},_updatedItem:function(t,e,i){if(this._ctxFilter(i,t)){var n=t[this.id_key];this.__items.get(n)&&this._updatedWatchedItem(t,e)}},_insertedInsert:function(t,e){if(this._ctxFilter(e,t)){for(var i=!1,n=this.__inserts.iterator();!i&&n.hasNext();)i=s.evaluate(n.next().query,t);i&&this._insertedWatchedInsert(t)}},unregisterItem:function(t,e){this.__items.unregister(t,e)&&this._unregisterItem(t)},_watchItem:function(t){},_unwatchItem:function(t){},_watchInsert:function(t){},_unwatchInsert:function(t){},reconnect:function(){this.itemsIterator().iterate(this._watchItem,this),this.insertsIterator().iterate(this._watchInsert,this)}}}])}),a.extend("module:Modelling.ActiveModel",["base:Properties.Properties","base:Async","base:Objs","base:Promise","module:Queries"],function(e,i,s,n,o,t){return e.extend({scoped:t},function(r){return{constructor:function(t,e,i,n){r.constructor.call(this),this._options=n||{},this._table=t,this._query=e,this._queryopts=i||{},this.set("model",null),this._unregisterModel(),this._options.inactive||(this._watcher()&&this._watcher().watchInsert({query:this._query,options:s.extend({limit:1},this._queryopts)},this),this._table.on("create",function(t){o.evaluate(this._query,t)&&(!this._queryopts.sort&&this.get("model")||(this.get("model")?this._unregisterModel():this._registerModel(this._table.materialize(t))))},this))},destroy:function(){this._watcher()&&(this._watcher().unwatchInsert(null,this),this._watcher().unwatchItem(null,this)),this.get("model")&&(this.get("model").off(null,null,this),this.get("model").decreaseRef()),this._table.off(null,null,this),r.destroy.call(this)},assertExistence:function(){if(this.get("model"))return n.value(this.get("model"));if(!this.__find_by_acquiring)return n.error("Not found");var t=n.create();return this.once("find-by-acquired",function(){this.get("model")?t.asyncSuccess(this.get("model")):t.asyncError("Not found")},this),t},_watcher:function(){return this._table.store().watcher()},update:function(t){this._query=t,this.get("model")&&e.is_class_instance(this.get("model"))&&o.evaluate(this._query,this.get("model").data())||this._unregisterModel()},_registerModel:function(t){this.set("model",t),t.increaseRef(),this._watcher()&&!t.isNew()&&this._watcher().watchItem(t.id(),this),t.on("change",function(){o.evaluate(this._query,t.data())||this._unregisterModel()},this),t.on("remove",function(){this._unregisterModel()},this)},_unregisterModel:function(){var t=this.get("model");t&&e.is_class_instance(t)&&i.eventually(function(){t.decreaseRef()}),this._watcher()&&this._watcher().unwatchItem(null,this),this.set("model",null),this.__find_by_acquiring=!0,this._table.findBy(this._query,this._queryopts).success(function(t){t?this._registerModel(t):this._options.create_virtual?this._registerModel(this._options.create_virtual.call(this._options.create_virtual_ctx||this,this._query)):this._options.create_on_demand&&(t=this._table.newModel(this._query),this._registerModel(t),t.save())},this).callback(function(){this.__find_by_acquiring=!1,this.trigger("find-by-acquired")},this)}}})}),a.define("module:Modelling.Associations.Association",["base:Class"],function(t,e){return t.extend({scoped:e},function(i){return{constructor:function(t,e){i.constructor.call(this),this._model=t,this._options=e||{}}}})}),a.define("module:Modelling.Associations.BelongsToAssociation",["module:Modelling.Associations.OneAssociation","base:Objs"],function(t,i,e){return t.extend({scoped:e},function(t){return{constructor:function(){t.constructor.apply(this,arguments),this._model.on("change:"+this._foreign_key,this._queryChanged,this)},_buildQuery:function(t){var e=this._model.get(this._foreign_key);return this._options.map&&(e=this._options.map.call(this._options.mapctx||this,e)),i.extend(i.objectBy(this._options.foreign_attr||this._foreignTable().primary_key(),e),t)},_unset:function(){this._model.set(this._foreign_key,null)},_set:function(t){this._model.set(this._foreign_key,t.id())}}})}),a.define("module:Modelling.Associations.HasManyAssociation",["module:Modelling.Associations.TableAssociation","base:Classes.SharedObjectFactory","base:Classes.SharedObjectFactoryPool","module:Collections.TableQueryCollection","base:Objs","base:Functions"],function(t,e,i,r,s,n,o){return t.extend({scoped:o},function(t){return{constructor:function(){t.constructor.apply(this,arguments),this.collection=this.newPooledCollection(),this.collectionPool=new i(this.newPooledCollection,this),this._model&&this._model.isNew&&!this._model.destroyed()&&(this._model.isNew()&&this._model.once("save",this._queryChanged,this),this._options.delete_cascade&&this._model.once("remove",this.removeAll,this))},destroy:function(){this.collectionPool.destroy(),this.collection.destroy(),this._model&&this._model.off(null,null,this),t.destroy.call(this)},customCollection:function(){return this.collectionPool.acquire.apply(this.collectionPool,arguments)},newPooledCollection:function(){var t=new e(this.newCollection,this,n.getArguments(arguments));return t.add=n.as_method(this.add,this),t.remove=n.as_method(this.remove,this),t},_buildQuery:function(t,e){},buildQuery:function(t,e){return this._buildQuery(s.extend(t,this._options.query),s.extend(e,this._options.queryOpts))},_queryChanged:function(){var t=this.collection.value();t&&t.update(this.buildQuery())},allBy:function(t,e){var i=this.buildQuery(t,e);return this._foreignTable().allBy(i.query,i.options)},_queryCollectionUpdated:function(t){},newCollection:function(t,e){var i=this.buildQuery(t,e),n=new r(this._foreignTable(),i.query,s.extend(s.extend(i.options,this._options.collectionOptions),e));return n.on("replaced-objects collection-updated",function(){this._queryCollectionUpdated(n)},this,{norecursion:!0}),this._queryCollectionUpdated(n),n},remove:function(t){return t&&!t.destroyed()&&this._options.delete_cascade&&t.weaklyRemove(),this._remove(t)},removeAll:function(){this.allBy().success(function(t){for(;t.hasNext();)this.remove(t.next())},this)},_remove:function(t){},add:function(t){return this.collection.isAcquired()&&this.collection.value().add(t),this._add(t)},_add:function(t){}}})}),a.define("module:Modelling.Associations.HasManyCustomAssociation",["module:Modelling.Associations.HasManyAssociation","base:Objs"],function(t,i,e){return t.extend({scoped:e},function(t){return{_buildQuery:function(t,e){return{query:this._foreign_key,options:i.clone(e||{},1)}}}})}),a.define("module:Modelling.Associations.HasManyInArrayAssociation",["module:Modelling.Associations.HasManyAssociation","base:Objs"],function(t,i,e){return t.extend({scoped:e},function(t){return{_buildQuery:function(t,e){return{query:i.objectBy(this._foreign_key,{$elemMatch:{$eq:this._model.id()}})}},_remove:function(t){t.set(this._foreign_key,t.get(this._foreign_key).filter(function(t){return t!==this._model.id()},this))},_add:function(t){var e=i.clone(t.get(this._foreign_key),1);e.some(function(t){return t===this._model.id()},this)||(e.push(this._model.id()),t.set(this._foreign_key,e))}}})}),a.define("module:Modelling.Associations.HasManyKeyAssociation",["module:Modelling.Associations.HasManyAssociation","base:Objs"],function(t,i,e){return t.extend({scoped:e},function(t){return{_buildQuery:function(t,e){return{query:i.extend(i.objectBy(this._foreign_key,this._model.id()),t),options:e}},_remove:function(t){t.set(this._foreign_key,null)},_add:function(t){t.set(this._foreign_key,this._model.id())}}})}),a.define("module:Modelling.Associations.HasManyThroughArrayAssociation",["module:Modelling.Associations.HasManyAssociation","base:Objs","base:Types","base:Functions"],function(t,r,s,e,i){return t.extend({scoped:i},function(t){return{__foreignKeyArray:function(){return s.is_array(this._foreign_key)?this._foreign_key:[this._foreign_key]},__arrayMapToKeys:function(t){return this._options.sub_key?t.map(function(t){return t[this._options.sub_key]},this):t},__readForeignKey:function(){var e=[];return this.__foreignKeyArray().forEach(function(t){e=e.concat(this._model.get(t)||[])},this),this.__arrayMapToKeys(e)},constructor:function(){t.constructor.apply(this,arguments),this._options.collectionOptions=r.extend({secondary_ident:e.as_method(this._mapItemValue,this)},this._options.collectionOptions),this.__foreignKeyArray().forEach(function(t){this._model.on("change:"+t,this._queryChanged,this)},this)},_buildQuery:function(t,e){var i=this.__readForeignKey();return this._options.map&&(i=i.map(this._options.map,this._options.mapctx||this)),{query:r.extend(r.objectBy(this._options.foreign_attr||this._foreignTable().primary_key(),r.objectBy("$in",i)),t)}},_queryCollectionUpdated:function(t){this._options.create_virtual&&this.__readForeignKey().forEach(function(e){var i=[],n=0;for(t.iterate(function(t){this._matchItem(t,e)&&(t.hasId()?n=1:i.push(t))},this);1<i.length+n;)t.remove(i.shift());i.length+n===0&&t.add(this._options.create_virtual.call(this._options.create_virtual_ctx||this,e))},this)},_mapValue:function(t){return this._options.map&&(t=this._options.map.call(this._options.mapctx||this,t)),t},_mapItemValue:function(t){return this._mapValue(t.get(this._options.foreign_attr||this._foreignTable().primary_key()))},_matchItem:function(t,e){return this._mapItemValue(t)===this._mapValue(e)},_remove:function(e){this.__foreignKeyArray().forEach(function(t){this._model.set(t,this._model.get(t).filter(function(t){return!this._matchItem(e,this._options.sub_key?t[this._options.sub_key]:t)},this))},this),this._options.create_virtual&&this.collection.value()&&!e.destroyed()&&this.collection.value().remove(e)},_add:function(e){if(!this.__readForeignKey().some(function(t){return this._matchItem(e,t)},this)){var t=s.is_array(this._foreign_key)?this._foreign_key[0]:this._foreign_key,i=r.clone(this._model.get(t)||[],1),n=e.get(this._options.foreign_attr||this._foreignTable().primary_key());i.push(this._options.sub_key?r.objectBy(this._options.sub_key,n):n),this._options.create_virtual&&this.collection.value()&&this.collection.value().add(e),this._model.set(t,i)}}}})}),a.define("module:Modelling.Associations.HasOneAssociation",["module:Modelling.Associations.OneAssociation","base:Objs"],function(t,i,e){return t.extend({scoped:e},function(t){return{_buildQuery:function(t,e){return i.extend(i.objectBy(this._foreign_key,this._model.id()),t)},_unset:function(){this.active.value()&&this.active.value().get("model")&&this.active.value().get("model").set(this._foreign_key,null)},_set:function(t){t.set(this._foreign_key,this._model.id()),this._unset()}}})}),a.define("module:Modelling.Associations.OneAssociation",["module:Modelling.Associations.TableAssociation","base:Classes.SharedObjectFactory","module:Modelling.ActiveModel","base:Objs"],function(t,e,i,n,r){return t.extend({scoped:r},function(t){return{constructor:function(){t.constructor.apply(this,arguments),this.active=new e(this.newActiveModel,this),this._model&&this._model.isNew&&!this._model.destroyed()&&this._options.delete_cascade&&this._model.once("remove",this.remove,this)},destroy:function(){this.active.destroy(),t.destroy.apply(this)},_buildQuery:function(t){},buildQuery:function(t){return this._buildQuery(n.extend(t,this._options.query))},_queryChanged:function(){var t=this.active.value();t&&t.update(this.buildQuery())},findBy:function(t,e){var i=this.buildQuery(t);return this._foreignTable().findBy(i,null,e)},newActiveModel:function(t){var e=this.buildQuery(t);return new i(this._foreignTable(),e,this._options.queryOpts,this._options.activeOpts)},assertExistence:function(t){return this.active.acquire(t).assertExistence()},remove:function(){this.assertExistence().success(function(t){t.increaseRef(),this.active.destroy(),t.weaklyRemove(),t.weakDestroy(),this.active=new e(this.newActiveModel,this)},this)},unset:function(){return this._unset()},_unset:function(){},set:function(t){return this._set(t)},_set:function(t){}}})}),a.define("module:Modelling.Associations.PolymorphicBelongsToAssociation",["module:Modelling.Associations.BelongsToAssociation","base:Objs"],function(t,e,i){return t.extend({scoped:i},function(s){return{constructor:function(t,e,i,n,r){s.constructor.call(this,t,null,e,r),this._foreign_type_key=i,this._table_lookup_function=n},_foreignTable:function(){return this._table_lookup_function(this._model.get(this._foreign_type_key))},_unset:function(){s._unset.call(this),this._model.set(this._foreign_type_key,null)},_set:function(t){s._set.call(this,t),this._model.set(this._foreign_type_key,t.type())}}})}),a.define("module:Modelling.Associations.PolymorphicHasManyKeyAssociation",["module:Modelling.Associations.HasManyKeyAssociation","base:Objs"],function(t,i,e){return t.extend({scoped:e},function(s){return{constructor:function(t,e,i,n,r){s.constructor.call(this,t,e,i,r),this._foreign_type_key=n},_buildQuery:function(t,e){return i.extend({query:i.extend(i.objectBy(this._foreign_key,this._model.id(),this._foreign_type_key,this._model.type()),t)},e)},_remove:function(t){s._remove.call(this,t),t.set(this._foreign_type_key,null)},_add:function(t){s._add.call(this,t),t.set(this._foreign_type_key,this._model.type())}}})}),a.define("module:Modelling.Associations.TableAssociation",["module:Modelling.Associations.Association"],function(t,e){return t.extend({scoped:e},function(r){return{constructor:function(t,e,i,n){r.constructor.call(this,t,n),this._foreign_table=e,this._foreign_key=i},_foreignTable:function(){return this._foreign_table}}})}),a.define("module:Modelling.ModelException",["base:Exceptions.Exception"],function(t,e){return t.extend({scoped:e},function(i){return{constructor:function(t,e){i.constructor.call(this,e),this.__model=t},model:function(){return this.__model}}})}),a.define("module:Modelling.ModelMissingIdException",["module:Modelling.ModelException"],function(t,e){return t.extend({scoped:e},function(e){return{constructor:function(t){e.constructor.call(this,t,"No id given.")}}})}),a.define("module:Modelling.ModelInvalidException",["module:Modelling.ModelException","base:Objs"],function(t,r,e){return t.extend({scoped:e},function(n){return{constructor:function(t,e){var i=r.values(t.errors()).join("\n")||e;n.constructor.call(this,t,i)}}})}),a.define("module:Modelling.GroupedProperties",["module:Modelling.AssociatedProperties","base:Objs","base:Types","base:Collections.Collection"],function(t,a,c,n,e){return t.extend({scoped:e},function(i){return{constructor:function(t,e){i.constructor.call(this,t);var o=!1,u=e||this.auto_destroy(new n);this[this.cls.groupedItemsKey]=u,this.set(this.cls.groupedItemsCount,u.count()),u.on("add remove",function(){this.set(this.cls.groupedItemsCount,u.count())},this),a.extend(this,a.map(this.cls.groupedMethods,function(t,e){return c.is_string(t)&&(t=this.cls.methodsHelper[t]),function(){return t(u,e,arguments)}},this)),a.iter(this.cls.groupedSetters,function(e,i){c.is_string(e)&&(e=this.cls.settersHelper[e]),this.on("change:"+i,function(t){o||e(u,i,t)})},this),a.iter(this.cls.groupedGetters,function(n,r){if(c.is_string(n)){if(!this.cls.gettersHelper[n])return void console.warn("Unknown Getter: "+n);n=this.cls.gettersHelper[n]}var s=null;n.add&&this.on("items:add",function(t){s=n.add(s,t.get(r),t),o=!0,this.set(r,n.map?n.map(s):s),o=!1},this),n.remove&&this.on("items:remove",function(t){s=n.remove(s,t.get(r),t),o=!0,this.set(r,n.map?n.map(s):s),o=!1},this),n.update&&u.on("change:"+r,function(t,e,i){s=n.update(s,e,i,u.getIndex(t),u.count(),t),o=!0,this.set(r,n.map?n.map(s):s),o=!1},this),n.first&&this.on("items:add items:reindexed",function(t){0===u.getIndex(t)&&(s=n.first(s,t.get(r))),o=!0,this.set(r,n.map?n.map(s):s),o=!1},this),n.last&&this.on("items:add items:reindexed",function(t){u.getIndex(t)===u.count()-1&&(s=n.last(s,t.get(r))),o=!0,this.set(r,n.map?n.map(s):s),o=!1},this)},this),u.iterate(function(t){this.trigger("items:add",t)},this),this.delegateEvents(["add","remove","reindexed"],u,"items")},destroy:function(){this[this.cls.groupedItemsKey].off(null,null,this),i.destroy.call(this)}}},{groupedItemsKey:"items",groupedItemsCount:"count",groupedMethods:{},groupedSetters:{},groupedGetters:{},methodsHelper:{all:function(t,e,i){var n=null;return t.iterate(function(t){n=t[e].apply(t,i)||n}),n},first:function(t,e,i){var n=t.first();return n?n[e].apply(n,i):undefined},last:function(t,e,i){var n=t.last();return n?n[e].apply(n,i):undefined}},settersHelper:{all:function(t,e,i){t.iterate(function(t){t.set(e,i)})},first:function(t,e,i){var n=t.first();n&&n.set(e,i)},last:function(t,e,i){var n=t.last();n&&n.set(e,i)}},gettersHelper:{exists:{add:function(t,e){return(t||0)+(e?1:0)},remove:function(t,e){return(t||0)-(e?1:0)},update:function(t,e,i){return(t||0)-(i?1:0)+(e?1:0)},map:function(t){return!!t}},all:{add:function(t,e){return(t||0)+(e?0:1)},remove:function(t,e){return(t||0)-(e?0:1)},update:function(t,e,i){return(t||0)-(i?0:1)+(e?0:1)},map:function(t){return!t}},first:{first:function(t,e){return e},update:function(t,e,i,n){return 0===n?e:t}},last:{last:function(t,e){return e},update:function(t,e,i,n,r){return n===r-1?e:t}},uniqueUnion:{add:function(t,e,i){var n=a.clone(t||{},1);return e&&c.is_array(e)||(e=[]),e.forEach(function(t){n[t]=n[t]||{},n[t][i.cid()]=!0}),n},remove:function(t,e,i){var n=a.clone(t||{},1);return e&&c.is_array(e)||(e=[]),e.forEach(function(t){n[t]&&(delete n[t][i.cid()],c.is_empty(n[t])&&delete n[t])}),n},update:function(t,e,i,n,r,s){var o=a.clone(t||{},1);return(i||[]).forEach(function(t){o[t]&&(delete o[t][s.cid()],c.is_empty(o[t])&&delete o[t])}),(e||[]).forEach(function(t){o[t]=o[t]||{},o[t][s.cid()]=!0}),o},map:function(t){return a.keys(t)}}}})}),a.define("module:Modelling.Model",["module:Modelling.AssociatedProperties","module:Modelling.ModelInvalidException","base:Objs","base:Promise","base:Types","base:Strings","base:Tokens","module:Modelling.Table"],function(t,o,u,a,c,e,s,i,n){return t.extend({scoped:n},function(r){return{constructor:function(t,e,i,n){this.__table=e,this.__options=u.extend({newModel:!0,removed:!1,canWeaklyRemove:!1},i),this.__ctx=n,this.__silent=1,r.constructor.call(this,t),this.__transactionPrefix=s.generate_token(),this.__silent=0,this.__removeOnDestroy=!1,this.isNew()||(this._properties_changed={},this._registerEvents()),this.option("auto_create")&&this.isNew()&&this.save()},destroy:function(){this.__removeOnDestroy&&this.remove(),this.table()&&this.table().off(null,null,this),this.trigger("destroy"),r.destroy.call(this)},newTransactionId:function(){return this.__transactionPrefix+"-"+s.generate_token()},isMyTransactionId:function(t){return t&&0===t.indexOf(this.__transactionPrefix)},ctx:function(){return this.__ctx},saveOnChange:function(t){return this.__saveOnChange=!0,this.__saveOnChangeWeak=!!t,this},disableSaveOnChange:function(){this.__disableSaveOnChange=!0},enableSaveOnChange:function(){this.__disableSaveOnChange=!1},option:function(t){return(t in this.__options||!this.table()?this.__options:this.table().options())[t]},type:function(){return this.cls.type()},table:function(){return this.__table},isSaved:function(){return this.isRemoved()||!this.isNew()&&!this.isChanged()},isNew:function(){return this.option("newModel")},isRemoved:function(){return this.option("removed")},setAllNoChange:function(t){for(var e in this.__silent++,t)this._properties_changed[e]||(this.set(e,t[e]),delete this._properties_changed[e]);this.__silent--},_registerEvents:function(){this.table().options().active_models&&(this.__table.on("update:"+this.id(),function(t,e,i,n){this.isRemoved()||this.isMyTransactionId(n)||this.setAllNoChange(t)},this),this.__table.on("remove:"+this.id(),function(){this.isRemoved()||(this.__options.removed=!0,this.trigger("remove"))},this))},update:function(t){return this.__silent++,this.suspendEvents(),this.setAll(t),this.__silent--,(this.isNew()?a.create(!0):this.save()).callback(this.resumeEvents,this)},_afterSet:function(t,e,i,n){r._afterSet.call(this,t,e,i,n),t in this.cls.scheme()&&!(0<this.__silent)&&(!this.option("auto_update")||this.isNew()&&(this.__disableSaveOnChange||!this.__saveOnChange||this.__saveOnChangeWeak&&!e)||this.save())},save:function(){return this.isRemoved()?a.create({}):(this.option("save_invalid")?a.value(!0):this.validate()).mapSuccess(function(t){if(!t)return a.create(null,new o(this));var e;if(this.isNew()){if(e=this.cls.filterPersistent(this.get_all_properties()),this.option("type_column")){var i=this.cls.classname,n=this.option("type_column"),r=this.get(n);this.option("types")&&"object"==typeof this.option("types")&&(this.option("types")[r]?i=r:u.iter(u.values(this.option("types")),function(t){this instanceof t&&(i=t)},this)),e[this.option("type_column")]=i}}else if(e=this.cls.filterPersistent(this.properties_changed()),c.is_empty(e))return a.create(e);var s=this.isNew();return(this.isNew()?this.__table._insertModel(e,this.__ctx):this.__table._updateModel(this.id(),e,this.__ctx,this.newTransactionId())).mapCallback(function(t,e){return this.destroyed()?this:t?(t.data&&u.iter(t.data,function(t,e){this.setError(e,t)},this),new o(this,t)):(this.__silent++,this.setAll(e),this.__silent--,this._properties_changed={},this.trigger("save"),s&&(this.__options.newModel=!1,this._registerEvents(),this._createdModel()),this)},this)},this)},_createdModel:function(){},isRemoving:function(){return this.__removing},canWeaklyRemove:function(){return this.option("can_weakly_remove")},weaklyRemove:function(){return this.canWeaklyRemove()?this.remove():a.error("Cannot remove weakly")},remove:function(){return this.isNew()||this.isRemoved()?a.create(!0):(this.__removing=!0,this.__table.store().remove(this.id(),this.__ctx).callback(function(){this.__removing=!1},this).success(function(){this.destroyed()||(this.__options.removed=!0,this.trigger("remove"))},this))},removeOnDestroy:function(){return this.__removeOnDestroy=!0,this}}},{type:function(){return e.last_after(this.classname,".").toLowerCase()},createTable:function(t,e){return new i(t,this,e)}})}),a.define("module:Modelling.SchemedProperties",["base:Properties.Properties","base:Types","base:Promise","base:Objs"],function(t,s,r,a,e){return t.extend({scoped:e},function(n){return{constructor:function(t){n.constructor.call(this);var e=this.cls.scheme();for(var i in this._properties_changed={},this.__errors={},e)"def"in e[i]?this.set(i,s.is_function(e[i].def)?e[i].def(t):e[i].def):e[i].auto_create?this.set(i,e[i].auto_create(this)):this.set(i,null);for(i in this._properties_changed={},this.__errors={},t)this.set(i,t[i])},_unsetChanged:function(t){delete this._properties_changed[t]},_beforeSet:function(t,e,i){var n=this.cls.scheme();if(!(t in n))return e;var r=n[t];return r.type&&(e=s.parseType(e,r.type)),r.transform&&(e=r.transform.call(this,e,i)),e},_afterSet:function(t,e){var i=this.cls.scheme();t in i&&(this._properties_changed[t]=e,delete this.__errors[t],i[t].after_set&&(s.is_string(i[t].after_set)?this[i[t].after_set]:i[t].after_set).apply(this,[e]))},isChanged:function(){return!s.is_empty(this._properties_changed)},properties_changed:function(){return this._properties_changed},get_all_properties:function(){var t={},e=this.cls.scheme();for(var i in e)t[i]=this.get(i);return t},validate:function(){this.trigger("validate");var t=[];for(var e in this.cls.scheme())t.push(this._validateAttr(e));return t.push(r.box(this._customValidate,this)),r.and(t).end().mapSuccess(function(t){var e=!0;return a.iter(t,function(t){e=e&&t}),e})},_customValidate:function(){return!0},_validateAttr:function(i){delete this.__errors[i];var t=this.cls.scheme()[i].validate;if(!t)return r.value(!0);s.is_array(t)||(t=[t]);var e=this.get(i),n=[];return a.iter(t,function(t){n.push(r.box(t.validate,t,[e,this,i]))},this),r.and(n).end().mapSuccess(function(t){var e=!0;return a.iter(t,function(t){null!==t&&(e=!1,this.__errors[i]=t)},this),this.trigger("validate:"+i,e,this.__errors[i]),e},this)},setError:function(t,e){this.__errors[t]=e,this.trigger("validate:"+t,!(t in this.__errors),this.__errors[t])},errors:function(){return this.__errors},getError:function(t){return this.__errors[t]},asRecord:function(r){var s={},o=this.cls.scheme(),u=this.get_all_properties();r=r||[];var t=function(t){var e=o[t].tags||[],i={};a.iter(e,function(t){i[t]=!0});var n=!0;a.iter(r,function(t){n=n&&t in i},this),n&&(s[t]=u[t])};for(var e in u)e in o&&t.call(this,e);return s},setByTags:function(r,s){var o=this.cls.scheme();s=s||{};var t=function(t){var e=o[t].tags||[],i={};a.iter(e,function(t){i[t]=!0});var n=!0;a.iter(s,function(t){n=n&&t in i},this),n&&this.set(t,r[t])};for(var e in r)e in o&&t.call(this,e)}}},{_initializeScheme:function(){return{}},asRecords:function(t,e){return t.map(function(t){return t.asRecord(e)})},filterPersistent:function(t){var e={},i=this.scheme();for(var n in t)s.is_defined(i[n].persistent)&&!i[n].persistent||!s.is_defined(t[n])||(e[n]=t[n]);return e}},{scheme:function(){return this.__scheme=this.__scheme||this._initializeScheme(),this.__scheme}})}),a.define("module:Modelling.AssociatedProperties",["module:Modelling.SchemedProperties","base:Objs"],function(t,i,e){return t.extend({scoped:e},function(e){return{constructor:function(t){e.constructor.call(this,t),this.assocs=this._initializeAssociations()},_initializeAssociations:function(){return{}},destroy:function(){i.iter(this.assocs,function(t){t&&t.weakDestroy&&t.weakDestroy()}),e.destroy.call(this)},id:function(){return this.get(this.cls.primary_key())},pid:function(){return this.id()},hasId:function(){return this.has(this.cls.primary_key())&&null!==this.get(this.cls.primary_key())}}},{primary_key:function(){return"id"},_initializeScheme:function(){var t={};return t[this.primary_key()]={type:"id",tags:["read"],after_set:null,persistent:!0},t}})}),a.define("module:Modelling.Table",["base:Class","base:Events.EventsMixin","base:Objs","base:Types","base:Iterators.MappedIterator","base:Classes.ObjectCache","base:Promise"],function(t,e,r,i,s,o,u,n){return t.extend({scoped:n},[e,function(n){return{constructor:function(t,e,i){n.constructor.call(this),this.__store=t,this.__model_type=e,this.__options=r.extend({type_column:null,types:null,auto_create:!1,auto_update:!0,save_invalid:!1,cache_models:!1,can_weakly_remove:!1,oblivious_updates:!1,oblivious_inserts:!1,active_models:!0,id_generator:null,keep_primary_keys:!1},i||{}),this.__filteredInserts={},this.__store.on("insert",function(t){t[this.primary_key()]in this.__filteredInserts?delete this.__filteredInserts[t[this.primary_key()]]:this.trigger("create",t)},this),this.__store.on("update",function(t,e,i,n,r){var s=t[this.primary_key()];this.trigger("update",s,e,t,n,r),this.trigger("update:"+s,e,t,n,r)},this),this.__store.on("remove",function(t,e,i){this.trigger("remove",t,e,i),this.trigger("remove:"+t,e,i)},this),this.__options.cache_models&&(this.model_cache=this.auto_destroy(new o(function(t){return t.id()})))},modelClass:function(t){return t=t||this.__model_type,this.__options.types&&"object"==typeof this.__options.types&&(t=this.__options.types[t]||t),i.is_string(t)?a.getGlobal(t):t},newModel:function(t,e,i){e&&void 0!==e||(e=this.__options.type_column&&t[this.__options.type_column]?t[this.__options.type_column]:null);var n=new(e=this.modelClass(e))(t,this,{},i);return this.__options.auto_create&&n.save(),this.model_cache&&(n.hasId()?this.model_cache.register(n):n.once("save",function(){this.model_cache.register(n)},this)),n},materialize:function(t,e){if(!t)return null;var i=this.modelClass(this.__options.type_column&&t[this.__options.type_column]?t[this.__options.type_column]:null);if(this.model_cache){var n=this.model_cache.get(t[this.primary_key()]);if(n)return n.setAll(t),n}var r=new i(t,this,{newModel:!1},e);return this.model_cache&&this.model_cache.register(r),r},options:function(){return this.__options},store:function(){return this.__store},findById:function(t,e){return this.__store.get(t,e).mapSuccess(function(t){return this.materialize(t,e)},this)},findByIdStrict:function(t,e){return this.findById(t,e).mapSuccess(function(t){return t||u.error("Not found")})},findBy:function(t,e,i){return this.allBy(t,r.extend({limit:1},e),i).mapSuccess(function(t){var e=t.next();return t.destroy(),e})},findByStrict:function(t,e,i){return this.findBy(t,e,i).mapSuccess(function(t){return t||u.error("Not found")})},allBy:function(t,e,i){return this.__store.query(t,e,i).mapSuccess(function(t){return new s(t,function(t){return this.materialize(t,i)},this).auto_destroy(t,!0)},this)},primary_key:function(){return(i.is_string(this.__model_type)?a.getGlobal(this.__model_type):this.__model_type).primary_key()},all:function(t,e){return this.allBy({},t,e)},query:function(){return this.allBy.apply(this,arguments)},scheme:function(){return this.__model_type.scheme()},ensure_indices:function(){if(!("ensure_index"in this.__store))return!1;var t=this.scheme();for(var e in t)t[e].index&&this.__store.ensure_index(e);return!0},_insertModel:function(t,e){if(this.__options.keep_primary_keys||delete t[this.primary_key()],!this.__options.oblivious_inserts)return this.store().insert(t,e);var i=this.__options.id_generator.generate();return t[this.primary_key()]=i,this.__filteredInserts[i]=!0,this.trigger("create",t),this.store().insert(t,e),u.value(t)},_updateModel:function(t,e,i,n){var r=this.store().update(t,e,i,n);return this.__options.oblivious_updates?u.value(e):r}}}])}),a.define("module:Modelling.Validators.ConditionalValidator",["module:Modelling.Validators.Validator","base:Types"],function(t,n,e){return t.extend({scoped:e},function(i){return{constructor:function(t,e){i.constructor.call(this),this.__condition=t,this.__validator=n.is_array(e)?e:[e]},validate:function(t,e){if(!this.__condition(t,e))return null;for(var i=0;i<this.__validator.length;++i){var n=this.__validator[i].validate(t,e);if(null!==n)return n}return null}}})}),a.define("module:Modelling.Validators.EmailValidator",["module:Modelling.Validators.Validator","base:Strings"],function(t,i,e){return t.extend({scoped:e},function(e){return{constructor:function(t){e.constructor.call(this),this.__error_string=t||"Not a valid email address"},validate:function(t,e){return i.is_email_address(t)?null:this.__error_string}}})}),a.define("module:Modelling.Validators.LengthValidator",["module:Modelling.Validators.Validator","base:Types","base:Objs"],function(t,e,i,n){return t.extend({scoped:n},function(e){return{constructor:function(t){e.constructor.call(this),t=i.extend({min_length:null,max_length:null,error_string:null,max_action:null},t),this.__min_length=t.min_length,this.__max_length=t.max_length,this.__error_string=t.error_string,this.__max_action=t.max_action,this.__error_string||(null!==this.__min_length?null!==this.__max_length?this.__error_string="Between "+this.__min_length+" and "+this.__max_length+" characters":this.__error_string="At least "+this.__min_length+" characters":null!==this.__max_length&&(this.__error_string="At most "+this.__max_length+" characters"))},validate:function(t,e,i){if(null!==this.__min_length&&(!t||t&&t.length<this.__min_length))return this.__error_string;var n=null;if(null!==this.__max_length&&t&&t.length>this.__max_length&&(n=this.__error_string,this.__max_action))switch(this.__max_action){case"truncate":e.set(i,t.substr(0,this.__max_length)),n=null;break;case"empty":e.set(i,""),n=null}return n}}})}),a.define("module:Modelling.Validators.MinMaxValidator",["module:Modelling.Validators.Validator","base:Types","base:Objs"],function(t,n,i,e){return t.extend({scoped:e},function(e){return{constructor:function(t){if(e.constructor.call(this),(t=i.extend({min_value:null,max_value:null,error_string:null},t)).min_value&&!n.isNumber(t.min_value))throw new Error("Min value must be a number.");if(t.max_value&&!n.isNumber(t.max_value))throw new Error("Max value must be a number.");this.__min_value=t.min_value,this.__max_value=t.max_value,this.__error_string=t.error_string,this.__error_string||(null!==this.__min_value?null!==this.__max_value?this.__error_string="Between "+this.__min_value+" and "+this.__max_value:this.__error_string="At least "+this.__min_value:null!==this.__max_value&&(this.__error_string="At most "+this.__max_value))},validate:function(t,e,i){if(!n.isNumber(t))throw new Error("MinMax Validator is for numbers only.");return null!==this.__min_value&&(!t||t<this.__min_value)?this.__error_string:null!==this.__max_value&&t&&t>this.__max_value?this.__error_string:null}}})}),a.define("module:Modelling.Validators.PresentValidator",["module:Modelling.Validators.Validator","base:Types"],function(t,i,e){return t.extend({scoped:e},function(e){return{constructor:function(t){e.constructor.call(this),this.__error_string=t||"Field is required"},validate:function(t,e){return i.is_null(t)||""===t?this.__error_string:null}}})}),a.define("module:Modelling.Validators.RegexValidator",["module:Modelling.Validators.Validator","base:Strings"],function(t,e,i){return t.extend({scoped:i},function(e){return{constructor:function(t){e.constructor.call(this),this.__regex=t.regex?new RegExp(t.regex):null,this.__function=t.use_function?t.use_function:"test",this.__error_string=t.error_string?t.error_string:"String doesn't match regular expression."},validate:function(t,e){return this.__regex?-1===["test","match"].indexOf(this.__function)?"You must choose between 'test' and 'match' to validate the regex.":"test"===this.__function?this.__regex.test(t)?null:this.__error_string:"match"===this.__function&&t.match(this.__regex)?null:this.__error_string:"You must add a regex to use this validator."}}})}),a.define("module:Modelling.Validators.UniqueValidator",["module:Modelling.Validators.Validator"],function(t,e){return t.extend({scoped:e},function(r){return{constructor:function(t,e,i,n){r.constructor.call(this),this.__key=t,this.__error_string=e||"Key already present",this.__ignore_if_null=i,this.__query=n},validate:function(t,e){if(null==t&&this.__ignore_if_null)return null;var i={};return i[this.__key]=t,this.__query&&Array.isArray(this.__query)&&this.__query.forEach(function(t){t!==this.__key&&(i[t]=e.get(t))},this),e.table().findBy(i).mapSuccess(function(t){return!t||!e.isNew()&&e.id()==t.id()?null:this.__error_string},this)}}})}),a.define("module:Modelling.Validators.Validator",["base:Class"],function(t,e){return t.extend({scoped:e},{validate:function(t,e){return null}})}),a.define("module:Modelling.Validators.ValueValidator",["module:Modelling.Validators.Validator","base:Types"],function(t,e,i){return t.extend({scoped:i},function(e){return{constructor:function(t){e.constructor.call(this),this.__values=t},validate:function(t,e){return this.__values.indexOf(t),null}}})})}).call(Scoped);