/*!
betajs-data - v1.0.42 - 2017-03-14
Copyright (c) Oliver Friedmann
Apache-2.0 Software License.
*/
(function(){var a=this.subScope();a.binding("module","global:BetaJS.Data"),a.binding("base","global:BetaJS"),a.define("module:",function(){return{guid:"70ed7146-bb6d-4da4-97dc-5a8e2d23a23f",version:"1.0.42"}}),a.assumeVersion("base:version","~1.0.96"),a.define("module:Collections.AbstractQueryCollection",["base:Collections.Collection","base:Objs","base:Types","base:Comparators","base:Promise","base:Class","module:Queries.Constrained","module:Queries"],function(a,b,c,d,e,f,g,h,i){return a.extend({scoped:i},function(a){return{constructor:function(c,d,e){a.constructor.call(this,{release_references:!0}),e=e||{},this._id_key=this._id_key||e.id_key||"id",this._source=c,this._complete=!1,this._active=e.active||!1,this._incremental="incremental"in e?e.incremental:!0,this._active_bounds="active_bounds"in e?e.active_bounds:!0,this._enabled=!1,this._range=e.range||null,this._forward_steps=e.forward_steps||null,this._backward_steps=e.backward_steps||null,this._async=e.async||!1,this._active&&(this.on("add",function(a){this._watchItem(a.get(this._id_key))},this),this.on("remove",function(a){this._unwatchItem(a.get(this._id_key))},this)),this._query={query:{},options:{skip:0,limit:null,sort:null}},this.update(b.tree_extend({query:{},options:{skip:e.skip||0,limit:e.limit||e.range||null,sort:e.sort||null}},d?d.query||d.options?d:{query:d}:{})),e.auto&&this.enable()},destroy:function(){this.disable(),this._watcher()&&(this._watcher().unwatchInsert(null,this),this._watcher().unwatchItem(null,this)),a.destroy.call(this)},paginate:function(a){return this.update({options:{skip:a*this._range,limit:this._range}})},paginate_index:function(){return Math.floor(this.getSkip()/this._range)},paginate_next:function(){return this.isComplete()?e.create(!0):this.paginate(this.paginate_index()+1)},paginate_prev:function(){return this.paginate_index()>0?this.paginate(this.paginate_index()-1):e.create(!0)},increase_forwards:function(a){return a=a||this._forward_steps,this.isComplete()?e.create(!0):this.update({options:{limit:this.getLimit()+a}})},increase_backwards:function(a){return a=a||this._backward_steps,this.getSkip()?this.update({options:{skip:Math.max(this.getSkip()-a,0),limit:this.getLimit()?this.getLimit()+this.getSkip()-Math.max(this.getSkip()-a,0):null}}):e.create(!0)},get_ident:function(a){return f.is_class_instance(a)?a.get(this._id_key):a[this._id_key]},getQuery:function(){return this._query},getSkip:function(){return this._query.options.skip||0},getLimit:function(){return this._query.options.limit||null},update:function(a){var c=!!a.query;a=g.rectify(a);var d=this._query.options.skip||0,f=this._query.options.limit||null;if(a.query&&(this._query.query=a.query),this._query.options=b.extend(this._query.options,a.options),!this._enabled)return e.create(!0);if(c||"sort"in a.options||!this._incremental)return this.refresh(!0);var h="skip"in a.options?a.options.skip||0:d,i="limit"in a.options?a.options.limit||null:f;if(h===d&&i===f)return e.create(!0);if(i&&d>=h+i||f&&h>=d+f)return this.refresh(!0);for(;h>d&&(null===f||f>0);)this.remove(this.getByIndex(0)),d++,f--;var j=e.create(!0);if(d>h){var k=d-h;null!==i&&(k=Math.min(k,i)),j=this._execute(b.tree_extend(b.clone(this._query,2),{options:{skip:h,limit:k}},2),!0),h+=k,null!==i&&(i-=k)}if(!f||i&&f>=i){if(i)for(;this.count()>i;)this.remove(this.getByIndex(this.count()-1));return j}return j.and(this._execute(b.tree_extend(b.clone(this._query,2),{options:{skip:d+f,limit:i?i-f:null}},2),!0))},enable:function(){this._enabled||(this._enabled=!0,this.refresh())},disable:function(){this._enabled&&(this._enabled=!1,this.clear(),this._unwatchInsert())},refresh:function(a){return a&&!this._incremental&&this.clear(),this._query.options.sort&&!c.is_empty(this._query.options.sort)?this.set_compare(d.byObject(this._query.options.sort)):this.set_compare(null),this._unwatchInsert(),this._active&&this._watchInsert(this._query),this._execute(this._query,!(a&&this._incremental))},isEnabled:function(){return this._enabled},_execute:function(a,b){return this.__executePromise?this.__executePromise.mapCallback(function(){return this._execute(a,b)},this):this._subExecute(a.query,a.options).mapSuccess(function(a){return a.hasNext()?b&&this._async?(this.__executePromise=a.asyncIterate(this.replace_object,this),this.__executePromise.callback(function(){this.__executePromise=null},this),!0):(this.replace_objects(a.asArray(),b),!0):(this._complete=!0,!0)},this)},_subExecute:function(a,b){return this._source.query(a,b)},isComplete:function(){return this._complete},isValid:function(a){return h.evaluate(this._query.query,a)},_materialize:function(a){return a},_activeCreate:function(a){this._active&&this._enabled&&this.isValid(a)&&(this.add(this._materialize(a)),this._query.options.limit&&this.count()>this._query.options.limit&&(this._active_bounds?this._query.options.limit++:this.remove(this.getByIndex(this.count()-1))))},_activeRemove:function(a){if(this._active&&this._enabled){var b=this.getById(a);b&&(this.remove(b),null!==this._query.options.limit&&this._active_bounds&&this._query.options.limit--)}},_activeUpdate:function(a,c,d){if(this._active&&this._enabled){var e=this.getById(a),f=b.extend(d,c);e?this.isValid(f)?e.setAll(c):this._activeRemove(a):this._activeCreate(f)}},_watcher:function(){return null},_watchInsert:function(a){this._watcher()&&this._watcher().watchInsert(a,this)},_unwatchInsert:function(){this._watcher()&&this._watcher().unwatchInsert(null,this)},_watchItem:function(a){this._watcher()&&this._watcher().watchItem(a,this)},_unwatchItem:function(a){this._watcher()&&this._watcher().unwatchItem(a,this)}}})}),a.define("module:Collections.StoreQueryCollection",["module:Collections.AbstractQueryCollection","base:Objs"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(c,d,e){a.constructor.call(this,c,d,b.extend({id_key:c.id_key()},e)),this._source=c,c.on("insert",this._activeCreate,this),c.on("remove",this._activeRemove,this),c.on("update",function(a,b){this._activeUpdate(c.id_of(a),b,a)},this)},destroy:function(){this._source.off(null,null,this),a.destroy.call(this)},get_ident:function(a){return a.get(this._source.id_key())},_watcher:function(){return this._source.watcher()}}})}),a.define("module:Collections.TableQueryCollection",["module:Collections.AbstractQueryCollection","base:Objs"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(c,d,e){a.constructor.call(this,c,d,b.extend({id_key:c.primary_key()},e)),c.on("create",this._activeCreate,this),c.on("remove",this._activeRemove,this),c.on("update",this._activeUpdate,this)},destroy:function(){this._source.off(null,null,this),a.destroy.call(this)},_materialize:function(a){return this._source.materialize(a)},_watcher:function(){return this._source.store().watcher()}}})}),a.define("module:Stores.AbstractIndex",["base:Class","base:Comparators","base:Objs","base:Functions"],function(a,b,c,d,e){return a.extend({scoped:e},function(a){return{constructor:function(d,e,f,g){a.constructor.call(this),this._options=c.extend({exact:!0,ignoreCase:!1},g),this._compare=f||b.byValue,this._store=d,this.__row_count=0,this._initialize();var h=d.id_key();d.query({}).value().iterate(function(a){this.__row_count++,this._insert(a[h],a[e])},this),d.on("insert",function(a){this.__row_count++,this._insert(a[h],a[e])},this),d.on("remove",function(a){this.__row_count--,this._remove(a)},this),d.on("update",function(a,b){e in b&&this._update(a,b[e])},this)},_initialize:function(){},destroy:function(){this._store.off(null,null,this),a.destroy.call(this)},compare:function(){return this._compare.apply(arguments)},comparator:function(){return d.as_method(this,this._compare)},info:function(){return{row_count:this.__row_count,key_count:this._key_count(),key_count_ic:this._key_count_ic()}},options:function(){return this._options},iterate:function(a,b,c,d){this._iterate(a,b,c,d)},itemIterate:function(a,b,c,d){this.iterate(a,b,function(a,b){return c.call(d,a,this._store.get(b).value())},this)},iterate_ic:function(a,b,c,d){this._iterate_ic(a,b,c,d)},itemIterateIc:function(a,b,c,d){this.iterate_ic(a,b,function(a,b){return c.call(d,a,this._store.get(b).value())},this)},_iterate:function(a,b,c,d){},_iterate_ic:function(a,b,c,d){},_insert:function(a,b){},_remove:function(a){},_update:function(a,b){},_key_count:function(){},_key_count_ic:function(){},key_count_left_ic:function(a){},key_count_right_ic:function(a){},key_count_distance_ic:function(a,b){},key_count_left:function(a){},key_count_right:function(a){},key_count_distance:function(a,b){}}})}),a.define("module:Stores.MemoryIndex",["module:Stores.AbstractIndex","base:Structures.TreeMap","base:Objs","base:Types"],function(a,b,c,d,e){return a.extend({scoped:e},function(a){return{_initialize:function(){this._options.exact&&(this._exactMap=b.empty(this._compare)),this._options.ignoreCase&&(this._ignoreCaseMap=b.empty(this._compare)),this._idToKey={}},__insert:function(a,d,e){var f=b.find(d,e);return f?f[a]=!0:e=b.add(d,c.objectBy(a,!0),e),e},_insert:function(a,b){this._idToKey[a]=b,this._options.exact&&(this._exactMap=this.__insert(a,b,this._exactMap)),this._options.ignoreCase&&(this._ignoreCaseMap=this.__insert(a,b,this._ignoreCaseMap))},__remove:function(a,c,e){var f=b.find(a,c);return delete f[e],d.is_empty(f)&&(c=b.remove(a,c)),c},_remove:function(a){var b=this._idToKey[a];delete this._idToKey[a],this._options.exact&&(this._exactMap=this.__remove(b,this._exactMap,a)),this._options.ignoreCase&&(this._ignoreCaseMap=this.__remove(b,this._ignoreCaseMap,a))},_update:function(a,b){var c=this._idToKey[a];c!=b&&(this._remove(a),this._insert(a,b))},_iterate:function(a,c,d,e){b.iterate_from(a,this._exactMap,function(a,b){for(var c in b)if(d.call(e,a,c)===!1)return!1;return!0},this,!c)},_iterate_ic:function(a,c,d,e){b.iterate_from(a,this._ignoreCaseMap,function(a,b){for(var c in b)if(d.call(e,a,c)===!1)return!1;return!0},this,!c)},_key_count:function(){return this._options.exact?b.length(this._exactMap):0},_key_count_ic:function(){return this._options.ignoreCase?b.length(this._ignoreCaseMap):0},key_count_left_ic:function(a){return b.treeSizeLeft(a,this._ignoreCaseMap)},key_count_right_ic:function(a){return b.treeSizeRight(a,this._ignoreCaseMap)},key_count_distance_ic:function(a,c){return b.distance(a,c,this._ignoreCaseMap)},key_count_left:function(a){return b.treeSizeLeft(a,this._exactMap)},key_count_right:function(a){return b.treeSizeRight(a,this._exactMap)},key_count_distance:function(a,c){return b.distance(a,c,this._exactMap)}}})}),a.define("module:Queries.Constrained",["module:Queries","base:Types","base:Objs","base:Tokens","base:Comparators"],function(a,b,c,d,e){return{rectify:function(a){var b="options"in a||"query"in a?a:{query:a};return c.extend({query:{},options:{}},b)},skipValidate:function(a,b){return"skip"in a&&b?b.skip:!0},limitValidate:function(a,b){return"limit"in a&&b?b.limit:!0},sortValidate:function(a,d){if("sort"in a){if(d&&!d.sort)return!1;if(d&&b.is_object(d.sort)){var e=c.all(a.sort,function(a,b){return b in d.sort});if(!e)return!1}}return!0},constraintsValidate:function(a,b){return c.all(["skip","limit","sort"],function(c){return this[c+"Validate"].call(this,a,b)},this)},validate:function(b,c){return b=this.rectify(b),this.constraintsValidate(b.options,c)&&a.validate(b.query,c.query||{})},fullConstrainedQueryCapabilities:function(b){return{query:b||a.fullQueryCapabilities(),skip:!0,limit:!0,sort:!0}},normalize:function(b){return b=this.rectify(b),{query:a.normalize(b.query),options:b.options}},serialize:function(a){return JSON.stringify(this.rectify(a))},unserialize:function(a){return JSON.parse(a)},hash:function(a){return d.simple_hash(this.serialize(a))},subsumizes:function(b,c){b=this.rectify(b),c=this.rectify(c);var d=b.options.skip||0,e=c.options.skip||0,f=b.options.limit||null,g=c.options.limit||null,h=b.options.sort,i=b.options.sort;if(d>e)return!1;if(f){if(!g)return!1;if(g+e>f+d)return!1}return(d||f)&&(h||i)&&JSON.stringify(h)!=JSON.stringify(i)?!1:a.subsumizes(b.query,c.query)},mergeable:function(b,c){if(b=this.rectify(b),c=this.rectify(c),a.serialize(b.query)!=a.serialize(c.query))return!1;var d=b.options,e=c.options;return JSON.stringify(d.sort||{})!=JSON.stringify(e.sort||{})?!1:"skip"in d?"skip"in e?d.skip<=e.skip?!d.limit||d.skip+d.limit>=e.skip:!e.limit||e.skip+e.limit>=d.skip:!e.limit||e.limit>=d.skip:!("skip"in e)||!d.limit||d.limit>=e.skip},merge:function(a,b){a=this.rectify(a),b=this.rectify(b);var c=a.options,d=b.options;return{query:a.query,options:{skip:"skip"in c&&"skip"in d?Math.min(c.skip,d.skip):null,limit:"limit"in c&&"limit"in d?Math.max(c.limit,d.limit):null,sort:a.sort}}}}}),a.define("module:Queries",["base:Types","base:Sort","base:Objs","base:Class","base:Tokens","base:Iterators.ArrayIterator","base:Iterators.FilteredIterator","base:Strings","base:Comparators"],function(a,b,c,d,e,f,g,h,i){var j={$or:{evaluate_combine:c.exists},$and:{evaluate_combine:c.all}},k={$in:{target:"atoms",evaluate_combine:c.exists,evaluate_single:function(a,b){return a===b}},$gt:{target:"atom",evaluate_single:function(a,b){return a>b}},$lt:{target:"atom",evaluate_single:function(a,b){return b>a}},$gte:{target:"atom",evaluate_single:function(a,b){return a>=b}},$le:{target:"atom",evaluate_single:function(a,b){return b>=a}},$sw:{target:"atom",evaluate_single:function(b,c){return b===c||a.is_string(b)&&0===b.indexOf(c)}},$ct:{target:"atom",no_index_support:!0,evaluate_single:function(b,c){return b===c||a.is_string(b)&&b.indexOf(c)>=0}},$eq:{target:"atom",evaluate_single:function(a,b){return a===b}}};return c.iter(c.clone(k,1),function(b,d){var e=c.clone(b,1);e.evaluate_single=function(c,d){return b.evaluate_single(a.is_string(c)?c.toLowerCase():c,a.is_string(d)?d.toLowerCase():d)},e.ignore_case=!0,k[d+"ic"]=e}),{SYNTAX_PAIR_KEYS:j,SYNTAX_CONDITION_KEYS:k,validate:function(a,b){return this.validate_query(a,b)},validate_atoms:function(b,d){return a.is_array(b)&&c.all(b,function(a){return this.validate_atom(a,d)},this)},validate_atom:function(a,b){return!b||!!b.atom},validate_queries:function(b,d){return a.is_array(b)&&c.all(b,function(a){return this.validate_query(a,d)},this)},validate_query:function(b,d){return a.is_object(b)&&c.all(b,function(a,b){return this.validate_pair(a,b,d)},this)},validate_pair:function(a,b,c){return b in this.SYNTAX_PAIR_KEYS?!c||c.bool&&b in c.bool?this.validate_queries(a,c):!1:this.validate_value(a,c)},is_query_atom:function(b){return null===b||!a.is_object(b)||"[object Object]"!==b.toString()||c.all(b,function(a,b){return!(b in this.SYNTAX_CONDITION_KEYS)},this)},validate_value:function(a,b){return this.is_query_atom(a)?this.validate_atom(a,b):this.validate_conditions(a,b)},validate_conditions:function(b,d){return a.is_object(b)&&c.all(b,function(a,b){return this.validate_condition(a,b,d)},this)},validate_condition:function(a,b,c){if(c&&(!c.conditions||!(b in c.conditions)))return!1;var d=this.SYNTAX_CONDITION_KEYS[b];return d&&("atoms"===d.target?this.validate_atoms(a):this.validate_atom(a))},normalize:function(a){return b.deep_sort(a)},serialize:function(a){return JSON.stringify(a)},unserialize:function(a){return JSON.parse(a)},hash:function(a){return e.simple_hash(this.serialize(a))},dependencies:function(a){return Object.keys(this.dependencies_query(a,{}))},dependencies_queries:function(a,b){return c.iter(a,function(a){b=this.dependencies_query(a,b)},this),b},dependencies_query:function(a,b){return c.iter(a,function(a,c){b=this.dependencies_pair(a,c,b)},this),b},dependencies_pair:function(a,b,c){return b in this.SYNTAX_PAIR_KEYS?this.dependencies_queries(a,c):this.dependencies_key(b,c)},dependencies_key:function(a,b){return b[a]=(b[a]||0)+1,b},evaluate:function(a,b){return this.evaluate_query(a,b)},evaluate_query:function(a,b){return c.all(a,function(a,c){return this.evaluate_pair(a,c,b)},this)},evaluate_pair:function(a,b,d){return b in this.SYNTAX_PAIR_KEYS?this.SYNTAX_PAIR_KEYS[b].evaluate_combine.call(c,a,function(a){return this.evaluate_query(a,d)},this):this.evaluate_value(a,d[b])},evaluate_value:function(a,b){return this.is_query_atom(a)?this.evaluate_atom(a,b):this.evaluate_conditions(a,b)},evaluate_atom:function(a,b){return a===b},evaluate_conditions:function(a,b){return c.all(a,function(a,c){return this.evaluate_condition(a,c,b)},this)},evaluate_condition:function(a,b,d){var e=this.SYNTAX_CONDITION_KEYS[b];return"atoms"===e.target?e.evaluate_combine.call(c,a,function(a){return e.evaluate_single.call(this,d,a)},this):e.evaluate_single.call(this,d,a)},subsumizes:function(b,c){if(!a.is_object(b)||!a.is_object)return b==c;for(var d in b)if(!(d in c&&this.subsumizes(b[d],c[d])))return!1;return!0},fullQueryCapabilities:function(){var a={};c.iter(this.SYNTAX_PAIR_KEYS,function(b,c){a[c]=!0});var b={};return c.iter(this.SYNTAX_CONDITION_KEYS,function(a,c){b[c]=!0}),{atom:!0,bool:a,conditions:b}},mergeConditions:function(b,d){a.is_object(b)||(b={$eq:b}),a.is_object(d)||(d={$eq:d});var e=!1,f=c.clone(b,1);return c.iter(d,function(a,b){if(e)return!1;if(b in f){var d=f[b];h.starts_with(b,"$eq")&&(e=!0),h.starts_with(b,"$in")&&(d=c.objectify(d),f[b]=[],e=!0,c.iter(a,function(a){d[a]&&(f[b].push(a),e=!1)})),h.starts_with(b,"$sw")&&(h.starts_with(d,a)?f[b]=a:h.starts_with(a,d)||(e=!0)),h.starts_with(b,"$gt")&&i.byValue(d,a)<0&&(f[b]=a),h.starts_with(b,"$lt")&&i.byValue(d,a)>0&&(f[b]=a)}else f[b]=a},this),e&&(f={$in:[]}),f},disjunctiveNormalForm:function(a,b){a=c.clone(a,1);var d=[];if(a.$or){var e=[];c.iter(a.$or,function(a){c.iter(this.disjunctiveNormalForm(a,b).$or,function(a){e.push(a)},this)},this),d.push(e),delete a.$or}a.$and&&(c.iter(a.$and,function(a){var e=[];c.iter(this.disjunctiveNormalForm(a,b).$or,function(a){e.push(a)},this),d.push(e)},this),delete a.$and);var f=[],g=function(a,e){e<d.length?c.iter(d[e],function(d){var f=c.clone(a,1);c.iter(d,function(a,d){d in f?b?f[d]=this.mergeConditions(f[d],a):(f.$and||(f.$and=[]),f.$and.push(c.objectBy(d,a))):f[d]=a},this),g(f,e+1)},this):f.push(a)};return g(a,0),{$or:f}},simplifyQuery:function(b){var d={};return c.iter(b,function(b,e){if(e in this.SYNTAX_PAIR_KEYS){var f=[],g=!1;c.iter(b,function(b){var c=this.simplifyQuery(b);a.is_empty(c)?g=!0:f.push(c)},this),("$and"===e&&f.length>0||"$or"===e&&!g)&&(d[e]=f)}else if(a.is_object(b)){var h=this.simplifyConditions(b);a.is_empty(h)||(d[e]=h)}else d[e]=b},this),d},simplifiedDNF:function(b,c){return b=this.simplifyQuery(this.disjunctiveNormalForm(b,!0)),a.is_empty(b)?{$or:[{}]}:b},simplifyConditions:function(a){var b={};return c.iter(["","ic"],function(d){if(a["$eq"+d]||a["$in"+d]){var e=c.filter(a["$eq"+d]?[a["$eq"+d]]:a["$in"+d],function(b){return this.evaluate_conditions(a,b)},this);b[(1===e.length?"$eq":"$in")+d]=1===e.length?e[0]:e}else{var f=null,g=null,h=!1,j=!1,k=i.byValue;if(a["$gt"+d]&&(f=a["$gt"+d]),a["$lt"+d]&&(f=a["$lt"+d]),a["$gte"+d]&&(null===f||k(f,a["$gte"+d])<0)&&(j=!0,f=a["$gte"+d]),a["$lte"+d]&&(null===g||k(g,a["$lte"+d])>0)&&(h=!0,g=a["$lte"+d]),a["$sw"+d]){var l=a["$sw"+d];(null===f||k(f,l)<=0)&&(j=!0,f=l);var m=null;"number"==typeof l?m=l+1:"string"==typeof l&&l.length>0&&(m=l.substring(0,l.length-1)+String.fromCharCode(l.charCodeAt(l.length-1)+1)),null!==m&&(null===g||k(g,m)>=0)&&(h=!0,g=m)}null!==g&&(b[(h?"$lte":"$lt")+d]=g),null!==f&&(b[(j?"$gte":"$gt")+d]=f),a["$ct"+d]&&(b["$ct"+d]=a["$ct"+d])}},this),b},mapKeyValue:function(a,b,c){return this.mapKeyValueQuery(a,b,c)},mapKeyValueQuery:function(a,b,d){var e={};return c.iter(a,function(a,f){e=c.extend(e,this.mapKeyValuePair(a,f,b,d))},this),e},mapKeyValueQueries:function(a,b,d){return c.map(a,function(a){return this.mapKeyValueQuery(a,b,d)},this)},mapKeyValuePair:function(a,b,d,e){if(b in this.SYNTAX_PAIR_KEYS)return c.objectBy(b,this.mapKeyValueQueries(a,d,e));if(this.is_query_atom(a))return d.call(e,b,a);var f={};return c.iter(a,function(a,c){f[c]=this.mapKeyValueCondition(a,b,d,e)},this),c.objectBy(b,f)},mapKeyValueCondition:function(b,d,e,f){var g=a.is_array(b);g||(b=[b]);var h=c.map(b,function(a){return c.peek(e.call(f,d,a))},this);return g?h:h[0]},queryDeterminedByAttrs:function(a,b){return c.exists(a,function(a,d){return"$and"===d?c.exists(a,function(a){return this.queryDeterminedByAttrs(a,b)},this):"$or"===d?c.all(a,function(a){return this.queryDeterminedByAttrs(a,b)},this):b[d]},this)}}}),a.define("module:Queries.Engine",["module:Queries","module:Queries.Constrained","base:Strings","base:Types","base:Objs","base:Promise","base:Comparators","base:Iterators.SkipIterator","base:Iterators.LimitIterator","base:Iterators.SortedIterator","base:Iterators.FilteredIterator","base:Iterators.SortedOrIterator","base:Iterators.PartiallySortedIterator","base:Iterators.ArrayIterator","base:Iterators.LazyMultiArrayIterator"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){return{indexQueryConditionsSize:function(a,b,c){var d=c?"ic":"",e=c?"_ic":"",f=b.info(),g=f.row_count,h=f.row_count/Math.max(f["key_count"+e],1);if(a["$eq"+d])g=h;else if(a["$in"+d])g=h*a["$in"+d].length;else{var i=0,j=null;(a["$gt"+d]||a["$gte"+d])&&(j=a["$gt"+d]||a["$gte"+d],a["$gt"+d]&&i--);var k=null;(a["$lt"+d]||a["$lte"+d])&&(k=a["$lt"+d]||a["$lte"+d],a["$lt"+d]&&i--),null!==j&&null!==k?i+=b["key_count_distance"+e](j,k):null!==j?i+=b["key_count_right"+e](j):null!==k&&(i+=b["key_count_left"+e](k)),g=i*h}return g},indexQuerySize:function(a,b,c){var d=0,f=c.info();return e.iter(a.$or,function(a){if(!(b in a))return d=null,!1;var e=a[b],g=f.row_count;c.options().exact&&(g=Math.min(g,this.indexQueryConditionsSize(e,c,!1))),c.options().ignoreCase&&(g=Math.min(g,this.indexQueryConditionsSize(e,c,!0))),d+=g},this),d},queryPartially:function(a,c){var d={query:a.query,options:{}};if(a.options.sort){var f=e.ithKey(a.options.sort,0);d.options.sort={},d.options.sort[f]=a.options.sort[f]}return b.validate(d,c)},compileQuery:function(c,d,e,f){c=b.rectify(c);var l=b.sortValidate(c.options,d),m=a.validate(c.query,d.query||{}),n=b.skipValidate(c.options,d),o=b.limitValidate(c.options,d),p={skip:null,limit:null,filter:null,sort:null};m&&l&&n||(p.skip=c.options.skip,delete c.options.skip,"limit"in c.options&&o&&m&&l&&(c.options.limit+=p.skip)),m&&l&&o||(p.limit=c.options.limit,delete c.options.limit),l||(p.sort=c.options.sort,delete c.options.sort),m||(p.filter=c.query,c.query={});var q=e.call(f,c);return q.mapSuccess(function(b){return b=this._queryResultRectify(b,!1),p.filter&&(b=new k(b,function(b){return a.evaluate(p.filter,b)})),p.sort&&(b=new j(b,g.byObject(p.sort))),p.skip&&(b=new h(b,p.skip)),p.limit&&(b=new i(b,p.limit)),b},this)},compileIndexQuery:function(b,c,p){var q,r=e.exists(b.query.$or,function(a){return!(c in a)}),s=b.options.sort&&e.ithKey(b.options.sort,0)===c,t=s?b.options.sort[c]:1,u=!p.options().exact;if(r){var v=[];p["itemIterate"+(u?"_ic":"")](null,t,function(a,b){v.push(b)}),q=new n(v)}else q=new l(e.map(b.query.$or,function(a){var b=a[c];!s&&p.options().ignoreCase&&p.options().exact&&this.indexQueryConditionsSize(b,p,!0)<this.indexQueryConditionsSize(b,p,!1)&&(u=!0);var e=u?"ic":"",f=u?"_ic":"";if(b["$eq"+e]||!d.is_object(b)){var g=[],h=d.is_object(b)?b["$eq"+e]:b;p["itemIterate"+f](h,t,function(a,b){return a!==h?!1:void g.push(b)}),q=new n(g)}else if(b["$in"+e]){var i=0;q=new o(function(){if(i>=b["$in"+e].length)return null;var a=[];return p["itemIterate"+f](b["$in"+e][i],t,function(c,d){return c!==b["in"+e][i]?!1:void a.push(d)}),i++,a})}else{var j=null,k=null;if((b["$gt"+e]||b["$gte"+e])&&(j=b["$gt"+e]||b["$gte"+e]),(b["$lt"+e]||b["$lte"+e])&&(k=b["$lt"+e]||b["$lte"+e]),0>t){var l=j;j=k,k=l}q=new o(function(){if(null!==j&&null!==k&&Math.sign(p.comparator()(j,k))===Math.sign(t))return null;var a=[];return p["itemIterate"+f](j,t,function(b,c){return null===j&&(j=b),b!==j?(j=b,!1):void a.push(c)}),a})}return q},this),p.comparator());return q=new k(q,function(c){return a.evaluate(b.query,c)}),b.options.sort&&(q=s?new m(q,g.byObject(b.options.sort),function(a,b){return a[c]===b[c]}):new j(q,g.byObject(b.options.sort))),b.options.skip&&(q=new h(q,b.options.skip)),b.options.limit&&(q=new i(q,b.options.limit)),f.value(q)},compileIndexedQuery:function(c,f,g,h,i){if(c=b.rectify(c),i=i||{},this.queryPartially(c,f)||d.is_empty(i))return this.compileQuery(c,f,g,h);var j=a.simplifiedDNF(c.query,!0);if(c.options.sort){var k=e.ithKey(c.options.sort,0);if(i[k])return this.compileIndexQuery({query:j,options:c.options},k,i[k])}var l=null,m=null;return e.iter(i,function(a,b){var c=this.indexQuerySize(j,b,a);null!==c&&(null===l||l>c)&&(l=c,m=b)},this),null!==m?this.compileIndexQuery({query:j,options:c.options},m,i[m]):this.compileQuery(c,f,g,h)},_queryResultRectify:function(a,b){return a=a||[],d.is_array(a)==b?a:b?a.asArray():new n(a)}}}),a.define("module:Stores.AssocStore",["module:Stores.BaseStore","base:Promise","base:Objs"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{_read_key:function(a){},_write_key:function(a,b){},_remove_key:function(a){},_iterate:function(){},constructor:function(b){b=b||{},b.create_ids=!0,a.constructor.call(this,b)},_insert:function(a){return b.tryCatch(function(){return this._write_key(a[this._id_key],a),a},this)},_remove:function(a){return b.tryCatch(function(){var b=this._read_key(a);return b&&!this._remove_key(a)?null:b},this)},_get:function(a){return b.tryCatch(function(){return this._read_key(a)},this)},_update:function(a,d){return b.tryCatch(function(){var b=this._read_key(a);return b&&(this._id_key in d&&(this._remove_key(a),a=d[this._id_key],delete d[this._id_key]),c.extend(b,d),this._write_key(a,b)),b},this)},_query:function(a,c){return b.tryCatch(function(){return this._iterate()},this)}}})}),a.define("module:Stores.MemoryMapStore",["module:Stores.AssocStore","base:Iterators.FilteredIterator","base:Iterators.NativeMapIterator","base:Objs"],function(a,b,c,d,e){return a.extend({scoped:e},function(a){return{constructor:function(b){a.constructor.call(this,b),this.__map=new Map},_read_key:function(a){return this.__map.get(a+"")},_write_key:function(a,b){this.__map.set(a+"",b)},_remove_key:function(a){this.__map["delete"](a+"")},_iterate:function(){return new b(new c(this.__map),function(a){return!!a})},_count:function(b){return b?a._count.call(this,b):this.__map.size}}})}),a.define("module:Stores.MemoryStore",["module:Stores.AssocStore","base:Iterators.FilteredIterator","base:Iterators.ArrayIterator","base:Objs"],function(a,b,c,d,e){return a.extend({scoped:e},function(a){return{constructor:function(b){a.constructor.call(this,b),this.__dataByIndex=[null],this.__indexById={},this.__count=0},_read_key:function(a){var b=this.__indexById[a];return b?this.__dataByIndex[b]:void 0},_write_key:function(a,b){var c=this.__indexById[a];c||(c=this.__dataByIndex.length,this.__indexById[a]=c,this.__count++),this.__dataByIndex[c]=b},_remove_key:function(a){var b=this.__indexById[a];b&&(delete this.__indexById[a],delete this.__dataByIndex[b],this.__count--)},_iterate:function(){return new b(new c(this.__dataByIndex),function(a){return!!a})},_count:function(b){return b?a._count.call(this,b):this.__count}}})}),a.define("module:Stores.BaseStore",["base:Class","base:Events.EventsMixin","module:Stores.ReadStoreMixin","module:Stores.WriteStoreMixin","base:Promise","base:Objs","module:Stores.MemoryIndex"],function(a,b,c,d,e,f,g,h){return a.extend({scoped:h},[b,c,d,function(a){return{constructor:function(b){a.constructor.call(this),this._initializeReadStore(b),this._initializeWriteStore(b)},_ensure_index:function(a){a in this.indices||(this.indices[a]=new g(this,a))},ensure_index:function(a){return this._ensure_index(a)},getBy:function(a,b,c){return a===this.id_key()?this.get(b,c):this.query(f.objectBy(a,b),{limit:1}).mapSuccess(function(a){return a.next()})},clear:function(a){return this.query(null,null,a).mapSuccess(function(b){for(var c=e.and();b.hasNext();){var d=b.next();c=c.and(this.remove(d[this._id_key],a))}return c},this)}}}])}),a.define("module:Stores.ReadStoreMixin",["module:Queries.Engine","module:Stores.StoreException","base:Promise","base:Objs"],function(a,b,c,d){return{_initializeReadStore:function(a){a=a||{},this.indices={},this._watcher=a.watcher||null,this._capabilities=a.capabilities||{}},watcher:function(){return this._watcher},_get:function(a,d){return c.create(null,new b("unsupported: get"))},_query_capabilities:function(){return this._capabilities},_query:function(a,d,e){return c.create(null,new b("unsupported: query"))},get:function(a,b){return this._get(a,b)},count:function(a,b){return this._count(a,b)},_count:function(a,b){return this.query(a,{},b).mapSuccess(function(a){return a.asArray().length})},query:function(b,c,e){return b=d.clone(b||{},-1),c=d.clone(c,-1),c&&(c.limit&&(c.limit=parseInt(c.limit,10)),c.skip&&(c.skip=parseInt(c.skip,10))),a.compileIndexedQuery({query:b,options:c||{}},this._query_capabilities(),function(a){return this._query(a.query,a.options,e)},this,this.indices)},serialize:function(a){return this.query({},{},a).mapSuccess(function(a){return a.asArray()})}}}),a.define("module:Stores.ReadStore",["base:Class","module:Stores.ReadStoreMixin"],function(a,b,c){return a.extend({scoped:c},[b,function(a){return{constructor:function(b){a.constructor.call(this),this._initializeReadStore(b)}}}])}),a.define("module:Stores.StoreException",["base:Exceptions.Exception"],function(a,b){return a.extend({scoped:b},{})}),a.define("module:Stores.StoreHistory",["base:Class","base:Events.EventsMixin","base:Objs","base:Types","module:Stores.MemoryStore"],function(a,b,c,d,e,f){return a.extend({scoped:f},[b,function(a){return{constructor:function(b,d,f){a.constructor.call(this),this._options=c.extend({combine_update_update:!1,combine_insert_update:!1,combine_insert_remove:!1,combine_update_remove:!1,source_id_key:b?b.id_key():"id",row_data:{},filter_data:{}},f),this.historyStore=d||new e,this.sourceStore=b,this.commitId=1,b&&(b.on("insert",this.sourceInsert,this),b.on("remove",this.sourceRemove,this),b.on("update",this.sourceUpdate,this))},sourceInsert:function(a){return this.commitId++,this.historyStore.insert(c.extend({row:a,type:"insert",row_id:a[this._options.source_id_key],commit_id:this.commitId},this._options.row_data)),this.trigger("insert",this.commitId),this.commitId},sourceUpdate:function(a,b,e,f){this.commitId++;var g=d.is_object(a)?a[this._options.source_id_key]:a,h="update";if(this._options.combine_insert_update||this._options.combine_update_update){var i=[];this._options.combine_insert_update&&i.push("insert"),this._options.combine_update_update&&i.push("update");for(var j={},k=[],l=this.historyStore.query(c.extend({type:{$or:i},row_id:g},this._options.filter_data),{sort:{commit_id:1}}).value();l.hasNext();){var m=l.next();"insert"===m.type&&(h="insert"),j=c.extend(j,m.row),k.push(this.historyStore.id_of(m))}b=c.extend(j,b),c.iter(k,this.historyStore.remove,this.historyStore)}return this.historyStore.insert(c.extend({row:b,pre_data:f,type:h,row_id:g,commit_id:this.commitId},this._options.row_data)),this.trigger("update",this.commitId),this.trigger("update:"+g,this.commitId),this.commitId},sourceRemove:function(a,b){this.commitId++;{if(!this._options.combine_insert_remove||!this.historyStore.query(c.extend({type:"insert",row_id:a},this._options.filter_data)).value().hasNext()){if(this._options.combine_update_remove)for(var d=this.historyStore.query(c.extend({type:"update",row_id:a},this._options.filter_data)).value();d.hasNext();)this.historyStore.remove(this.historyStore.id_of(d.next()));return this.historyStore.insert(c.extend({type:"remove",row_id:a,row:b,commit_id:this.commitId},this._options.row_data)),this.trigger("remove",this.commitId),this.trigger("remove:"+a,this.commitId),this.commitId}for(var e=this.historyStore.query(c.extend({row_id:a},this._options.filter_data)).value();e.hasNext();)this.historyStore.remove(this.historyStore.id_of(e.next()))}},getCommitById:function(a){return this.historyStore.query({commit_id:a},{limit:1}).mapSuccess(function(a){return a.next()})},undoCommit:function(a){return"insert"===a.type?this.sourceStore.remove(a.row_id):"remove"===a.type?this.sourceStore.insert(a.row):"update"===a.type?this.sourceStore.update(a.row_id,a.pre_data||{}):void 0;
},undoCommitById:function(a){return this.getCommitById(a).mapSuccess(function(a){return this.undoCommit(a).success(function(){this.historyStore.remove(this.historyStore.id_of(a))},this)},this)}}}])}),a.define("module:Stores.WriteStoreMixin",["module:Stores.StoreException","base:Promise","base:IdGenerators.TimedIdGenerator","base:Types"],function(a,b,c,d){return{_initializeWriteStore:function(a){a=a||{},this._id_key=a.id_key||"id",this._create_ids=a.create_ids||!1,this.preserve_preupdate_data=a.preserve_preupdate_data||!1,this._create_ids&&(this._id_generator=a.id_generator||this._auto_destroy(new c))},id_key:function(){return this._id_key},id_of:function(a){return a[this.id_key()]},id_row:function(a){var b={};return b[this._id_key]=a,b},_inserted:function(a,b){this.trigger("insert",a,b),this.trigger("write","insert",a,b)},_removed:function(a,b){this.trigger("remove",a,b),this.trigger("write","remove",a,b)},_updated:function(a,b,c,d){this.trigger("update",a,b,c,d),this.trigger("write","update",a,b,c,d)},insert_all:function(a,c){for(var d=b.and(),e=0;e<a.length;++e)d=d.and(this.insert(a[e],c));return d.end()},_insert:function(c,d){return b.create(null,new a("unsupported: insert"))},_remove:function(c,d){return b.create(null,new a("unsupported: remove"))},_update:function(c,d,e){return b.create(null,new a("unsupported: update"))},insert:function(c,d){return c?(!this._create_ids||this._id_key in c&&c[this._id_key]||(c[this._id_key]=this._id_generator.generate()),this._insert(c,d).success(function(a){this._inserted(a,d)},this)):b.create(null,new a("empty insert"))},remove:function(a,b){return this._remove(a,b).success(function(){this._removed(a,b)},this)},update:function(a,b,c){return this.preserve_preupdate_data?this.get(a,c).mapSuccess(function(d){var e={};for(var f in b)e[f]=d[f];return this._update(a,b,c).success(function(a){this._updated(a,b,c,e)},this)},this):this._update(a,b,c).success(function(a){this._updated(a,b,c)},this)},unserialize:function(a,b){return this.insert_all(a,b)}}}),a.define("module:Stores.WriteStore",["base:Class","base:Events.EventsMixin","module:Stores.WriteStoreMixin"],function(a,b,c,d){return a.extend({scoped:d},[b,c,function(a){return{constructor:function(b){a.constructor.call(this),this._initializeWriteStore(b)},_ensure_index:function(a){},ensure_index:function(a){return this._ensure_index(a)}}}])}),a.define("module:Stores.AsyncStore",["module:Stores.BaseStore","base:Promise","base:Async"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(b,c){this.__store=b,c=c||{},c.id_key=b.id_key(),a.constructor.call(this,c),this.__time=c.time||0,c.destroy_store&&this._auto_destroy(b)},_query_capabilities:function(){return this.__store._query_capabilities()},__async:function(a,d){var e=b.create();return c.eventually(function(){a.apply(this.__store,d).forwardCallback(e)},this,this.__time),e},_insert:function(){return this.__async(this.__store.insert,arguments)},_remove:function(){return this.__async(this.__store.remove,arguments)},_get:function(){return this.__async(this.__store.get,arguments)},_update:function(){return this.__async(this.__store.update,arguments)},_query:function(){return this.__async(this.__store.query,arguments)},_ensure_index:function(a){return this.__store.ensure_index(a)},_store:function(){return this.__store}}})}),a.define("module:Stores.ContextualizedStore",["module:Stores.BaseStore","base:Iterators.MappedIterator","base:Promise"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(b,c){this.__store=b,c=c||{},c.id_key=b.id_key(),this.__context=c.context||this,this.__decode=c.decode,this.__encode=c.encode,a.constructor.call(this,c),c.destroy_store&&this._auto_destroy(b)},_decode:function(a){return this.__decode.call(this.__context,a)},_encode:function(a,b){return this.__encode.call(this.__context,a,b)},_decodeId:function(a){var b=this._decode(this.id_row(a));return{id:this.id_of(b.data),ctx:b.ctx}},_query_capabilities:function(){return this.__store._query_capabilities()},_insert:function(a){var b=this._decode(a);return this.__store.insert(b.data,b.ctx).mapSuccess(function(a){return this._encode(a,b.ctx)},this)},_remove:function(a){var b=this._decodeId(a);return this.__store.remove(b.id,b.ctx).mapSuccess(function(){return a},this)},_get:function(a){var b=this._decodeId(a);return this.__store.get(b.id,b.ctx).mapSuccess(function(a){return this._encode(a,b.ctx)},this)},_update:function(a,b){var c=this._decodeId(a);this.__store.update(c.id,b,c.ctx).mapSuccess(function(a){return a},this)},_query:function(a,c){var d=this._decode(a);return this.__store.query(d.data,c,d.ctx).mapSuccess(function(a){return new b(a,function(a){return this._encode(a,d.ctx)},this)},this)},_ensure_index:function(a){return this.__store.ensure_index(a)},_store:function(){return this.__store}}})}),a.define("module:Stores.DecontextualizedSelectStore",["module:Stores.BaseStore","base:Iterators.MappedIterator","base:Promise","base:Objs"],function(a,b,c,d,e){return a.extend({scoped:e},function(a){return{constructor:function(b,c){this.__store=b,c=c||{},c.id_key=b.id_key(),a.constructor.call(this,c),c.destroy_store&&this._auto_destroy(b)},_decode:function(a,b){return a=d.clone(a,1),d.iter(b,function(b,c){delete a[c]}),a},_encode:function(a,b){return d.extend(d.clone(a,1),b)},_query_capabilities:function(){return this.__store._query_capabilities()},_insert:function(a,b){return this.__store.insert(this._encode(a,b)).mapSuccess(function(a){return this._decode(a,b)},this)},_query:function(a,c,d){return this.__store.query(this._encode(a,d),c).mapSuccess(function(a){return new b(a,function(a){return this._decode(a,d)},this)},this)},_ensure_index:function(a){return this.__store.ensure_index(a)},_store:function(){return this.__store},_get:function(a,b){return this.query(this.id_row(a),{limit:1},b).mapSuccess(function(a){return a.hasNext()?this._decode(a.next(),b):null},this)},_remove:function(a,b){return this.query(this.id_row(a),{limit:1},b).mapSuccess(function(a){return a.hasNext()?this.__store.remove(this.__store.id_of(this._decode(a.next(),b))):null},this)},_update:function(a,b,c){return this.query(this.id_row(a),{limit:1},c).mapSuccess(function(a){return a.hasNext()?this.__store.update(this.__store.id_of(this._decode(a.next(),c)),b):null},this)}}})}),a.define("module:Stores.KeyMapStore",["module:Stores.TransformationStore","base:Objs"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(c,d,e){a.constructor.call(this,c,d),this.__encodeMap=e,this.__decodeMap=b.inverseKeyValue(e)},__mapBy:function(a,c){var d={};return b.iter(a,function(a,b){d[c[b]||b]=a}),d},_encodeData:function(a){return this.__mapBy(a,this.__encodeMap)},_decodeData:function(a){return this.__mapBy(a,this.__decodeMap)}}})}),a.define("module:Stores.MultiplexerStore",["module:Stores.BaseStore","module:Queries.Constrained","base:Promise"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(b){a.constructor.call(this,b),this.__context=b.context||this,this.__acquireStore=b.acquireStore,this.__releaseStore=b.releaseStore,this.__mapContext=b.mapContext},_acquireStore:function(a){return c.value(this.__acquireStore?this.__acquireStore.call(this.__context,a):a)},_releaseStore:function(a,b){this.__releaseStore&&this.__releaseStore.call(this.__context,a,b)},_mapContext:function(a){return this.__mapContext?this.__mapContext.call(this.__context,a):null},_query_capabilities:function(){return b.fullConstrainedQueryCapabilities()},_insert:function(a,b){return this._acquireStore(b).mapSuccess(function(c){return c.insert(a,this._mapContext(b)).callback(function(){this._releaseStore(b,c)},this)},this)},_remove:function(a,b){return this._acquireStore(b).mapSuccess(function(c){return c.remove(a,this._mapContext(b)).callback(function(){this._releaseStore(b,c)},this)},this)},_update:function(a,b,c){return this._acquireStore(c).mapSuccess(function(d){return d.update(a,b,this._mapContext(c)).callback(function(){this._releaseStore(c,d)},this)},this)},_get:function(a,b){return this._acquireStore(b).mapSuccess(function(c){return c.get(a,this._mapContext(b)).callback(function(){this._releaseStore(b,c)},this)},this)},_query:function(a,b,c){return this._acquireStore(c).mapSuccess(function(d){return d.query(a,b,this._mapContext(c)).callback(function(){this._releaseStore(c,d)},this)},this)}}})}),a.define("module:Stores.PassthroughStore",["module:Stores.BaseStore","base:Promise"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(b,c){this.__store=b,c=c||{},c.id_key=c.id_key||b.id_key(),a.constructor.call(this,c),c.destroy_store&&this._auto_destroy(b),this.delegateEvents(["insert","update","remove"],this.__store)},_query_capabilities:function(){return this.__store._query_capabilities()},_insert:function(a){return this._preInsert(a).mapSuccess(function(a){return this.__store.insert(a).mapSuccess(function(a){return this._postInsert(a)},this)},this)},_remove:function(a){return this._preRemove(a).mapSuccess(function(a){return this.__store.remove(a).mapSuccess(function(){return this._postRemove(a)},this)},this)},_get:function(a){return this._preGet(a).mapSuccess(function(a){return this.__store.get(a).mapSuccess(function(a){return this._postGet(a)},this)},this)},_update:function(a,b){return this._preUpdate(a,b).mapSuccess(function(a){return this.__store.update(a.id,a.data).mapSuccess(function(a){return this._postUpdate(a)},this)},this)},_query:function(a,b){return this._preQuery(a,b).mapSuccess(function(a){return this.__store.query(a.query,a.options).mapSuccess(function(a){return this._postQuery(a)},this)},this)},unserialize:function(a){return this._preUnserialize(a).mapSuccess(function(a){return this.__store.unserialize(a).mapSuccess(function(a){return this._postUnserialize(a)},this)},this)},serialize:function(a){return this._preSerialize(a).mapSuccess(function(a){return this.__store.serialize(a).mapSuccess(function(a){return this._postSerialize(a)},this)},this)},_ensure_index:function(a){return this.__store.ensure_index(a)},_store:function(){return this.__store},_preInsert:function(a){return b.value(a)},_postInsert:function(a){return b.value(a)},_preRemove:function(a){return b.value(a)},_postRemove:function(a){return b.value(!0)},_preGet:function(a){return b.value(a)},_postGet:function(a){return b.value(a)},_preUpdate:function(a,c){return b.value({id:a,data:c})},_postUpdate:function(a){return b.value(a)},_preQuery:function(a,c){return b.value({query:a,options:c})},_postQuery:function(a){return b.value(a)},_preSerialize:function(a){return b.value(a)},_postSerialize:function(a){return b.value(a)},_preUnserialize:function(a){return b.value(a)},_postUnserialize:function(a){return b.value(a)},watcher:function(){return this.__store.watcher()}}})}),a.define("module:Stores.ReadyStore",["module:Stores.PassthroughStore","base:Promise","base:Objs"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{__ready:!1,ready:function(){this.__ready=!0,c.iter(this.__promises,function(a){a.promise.forwardCallback(a.stalling)}),delete this.__promises},__execute:function(a){if(this.__ready)return a;var c=b.create();return this.__promises=this.__promises||[],this.__promises.push({stalling:c,promise:a}),c},_preInsert:function(){return this.__execute(a._preInsert.apply(this,arguments))},_preRemove:function(){return this.__execute(a._preRemove.apply(this,arguments))},_preGet:function(){return this.__execute(a._preGet.apply(this,arguments))},_preUpdate:function(){return this.__execute(a._preUpdate.apply(this,arguments))},_preQuery:function(){return this.__execute(a._preQuery.apply(this,arguments))},_preSerialize:function(){return this.__execute(a._preSerialize.apply(this,arguments))},_preUnserialize:function(){return this.__execute(a._preUnserialize.apply(this,arguments))}}})}),a.define("module:Stores.ResilientStore",["module:Stores.BaseStore","base:Promise"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(b,c){this.__store=b,c=c||{},c.id_key=b.id_key(),a.constructor.call(this,c),this._resilience=c.resilience||10,c.destroy_store&&this._auto_destroy(b)},_query_capabilities:function(){return this.__store._query_capabilities()},_insert:function(){return b.resilientCall(this._store.insert,this._store,this._resilience,arguments)},_remove:function(){return b.resilientCall(this._store.remove,this._store,this._resilience,arguments)},_get:function(){return b.resilientCall(this._store.get,this._store,this._resilience,arguments)},_update:function(a,c){return b.resilientCall(this._store.update,this._store,this._resilience,arguments)},_query:function(a,c){return b.resilientCall(this._store.update,this._store,this._resilience,arguments)},_ensure_index:function(a){return this.__store.ensure_index(a)},_store:function(){return this.__store}}})}),a.define("module:Stores.SimulatorStore",["module:Stores.PassthroughStore","base:Promise"],function(a,b,c){return a.extend({scoped:c},function(a){return{online:!0,_preInsert:function(){return this.online?a._preInsert.apply(this,arguments):b.error("Offline")},_preRemove:function(){return this.online?a._preRemove.apply(this,arguments):b.error("Offline")},_preGet:function(){return this.online?a._preGet.apply(this,arguments):b.error("Offline")},_preUpdate:function(){return this.online?a._preUpdate.apply(this,arguments):b.error("Offline")},_preQuery:function(){return this.online?a._preQuery.apply(this,arguments):b.error("Offline")}}})}),a.define("module:Stores.TableStore",["module:Stores.BaseStore","base:Iterators.MappedIterator","module:Queries.Constrained"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(b,c){this.__table=b,c=c||{},c.id_key=b.primary_key(),a.constructor.call(this,c),this.__options={insertTags:c.insertTags||[],readTags:c.readTags||[],updateTags:c.updateTags||[]}},_query_capabilities:function(){return c.fullConstrainedQueryCapabilities()},_insert:function(a,b){var c=this.__table.newModel({},null,b);return c.setByTags(a,this.__options.insertTags),c.save().mapSuccess(function(){return c.asRecord(this.__options.readTags)},this)},_remove:function(a,b){return this.__table.findById(a,b).mapSuccess(function(a){return a?a.remove():a},this)},_get:function(a,b){return this.__table.findById(a,b).mapSuccess(function(a){return a?a.asRecord(this.__options.readTags):a},this)},_update:function(a,b,c){return this.__table.findById(a,c).mapSuccess(function(a){return a?(a.setByTags(b,this.__options.updateTags),a.save().mapSuccess(function(){return a.asRecord(this.__options.readTags)},this)):a},this)},_query:function(a,c,d){return this.__table.query(a,c,d).mapSuccess(function(a){return new b(a,function(a){return a.asRecord(this.__options.readTags)},this)},this)}}})}),a.define("module:Stores.TransformationStore",["module:Stores.PassthroughStore","module:Queries","base:Iterators.MappedIterator","base:Objs","base:Types","base:Promise"],function(a,b,c,d,e,f,g){return a.extend({scoped:g},function(a){return{_encodeData:function(a){return a},_decodeData:function(a){return a},_encodeSort:function(a){return this._encodeData(a)},_encodeId:function(a){return this.id_of(this._encodeData(d.objectBy(this.id_key(),a)))},_decodeId:function(a){return this.id_of(this._decodeData(d.objectBy(this.id_key(),a)))},_encodeQuery:function(a,c){var f=d.clone(c);return f.sort&&(f.sort=e.is_object(f.sort)?this._encodeSort(f.sort):{}),{query:b.mapKeyValue(a,function(a,b){return this._encodeData(d.objectBy(a,b))},this),options:f}},_preInsert:function(a){return f.create(this._encodeData(a))},_postInsert:function(a){return f.create(this._decodeData(a))},_preRemove:function(a){return f.create(this._encodeId(a))},_postRemove:function(a){return f.create(!0)},_preGet:function(a){return f.create(this._encodeId(a))},_postGet:function(a){return f.create(this._decodeData(a))},_preUpdate:function(a,b){return f.create({id:this._encodeId(a),data:this._encodeData(b)})},_postUpdate:function(a){return f.create(this._decodeData(a))},_preQuery:function(a,b){return f.create(this._encodeQuery(a,b))},_postQuery:function(a){return f.create(new c(a,function(a){return this._decodeData(a)},this))}}})}),a.define("module:Stores.AssocDumbStore",["module:Stores.DumbStore"],function(a,b){return a.extend({scoped:b},{_read_key:function(a){},_write_key:function(a,b){},_remove_key:function(a){},__read_id:function(a){var b=this._read_key(a);return b?parseInt(b,10):null},_read_last_id:function(){return this.__read_id("last_id")},_write_last_id:function(a){this._write_key("last_id",a)},_remove_last_id:function(){this._remove_key("last_id")},_read_first_id:function(){return this.__read_id("first_id")},_write_first_id:function(a){this._write_key("first_id",a)},_remove_first_id:function(){this._remove_key("first_id")},_read_item:function(a){return this._read_key("item_"+a)},_write_item:function(a,b){this._write_key("item_"+a,b)},_remove_item:function(a){this._remove_key("item_"+a)},_read_next_id:function(a){return this.__read_id("next_"+a)},_write_next_id:function(a,b){this._write_key("next_"+a,b)},_remove_next_id:function(a){this._remove_key("next_"+a)},_read_prev_id:function(a){return this.__read_id("prev_"+a)},_write_prev_id:function(a,b){this._write_key("prev_"+a,b)},_remove_prev_id:function(a){this._remove_key("prev_"+a)}})}),a.define("module:Stores.DumbStore",["module:Stores.BaseStore","base:Promise","base:Objs","base:Iterators.Iterator"],function(a,b,c,d,e){return a.extend({scoped:e},function(a){return{_read_last_id:function(){},_write_last_id:function(a){},_remove_last_id:function(){},_read_first_id:function(){},_write_first_id:function(a){},_remove_first_id:function(){},_read_item:function(a){},_write_item:function(a,b){},_remove_item:function(a){},_read_next_id:function(a){},_write_next_id:function(a,b){},_remove_next_id:function(a){},_read_prev_id:function(a){},_write_prev_id:function(a,b){},_remove_prev_id:function(a){},constructor:function(b){b=b||{},b.create_ids=!0,a.constructor.call(this,b)},_insert:function(a){return b.tryCatch(function(){var b=this._read_last_id(),c=a[this._id_key];return null!==b?(this._write_next_id(b,c),this._write_prev_id(c,b)):this._write_first_id(c),this._write_last_id(c),this._write_item(c,a),a},this)},_remove:function(a){return b.tryCatch(function(){var b=this._read_item(a);if(b){this._remove_item(a);var c=this._read_next_id(a),d=this._read_prev_id(a);null!==c?(this._remove_next_id(a),null!==d?(this._remove_prev_id(a),this._write_next_id(d,c),this._write_prev_id(c,d)):(this._remove_prev_id(c),this._write_first_id(c))):null!==d?(this._remove_next_id(d),this._write_last_id(d)):(this._remove_first_id(),this._remove_last_id())}return b},this)},_get:function(a){return b.tryCatch(function(){return this._read_item(a)},this)},_update:function(a,d){return b.tryCatch(function(){var b=this._get(a);return b&&(delete d[this._id_key],c.extend(b,d),this._write_item(a,b)),b},this)},_query:function(a,e){return b.tryCatch(function(){var b=new d,e=this,f=this._read_first_id();return c.extend(b,{__id:null===f?1:f,__store:e,__query:a,hasNext:function(){var a=this.__store._read_last_id();if(null===a)return!1;for(;this.__id<a&&!this.__store._read_item(this.__id);)this.__id++;return this.__id<=a},next:function(){if(this.hasNext()){var a=this.__store.get(this.__id);return this.__id==this.__store._read_last_id()?this.__id++:this.__id=this.__store._read_next_id(this.__id),a}return null}}),b},this)}}})}),a.define("module:Stores.LocalStore",["module:Stores.AssocDumbStore"],function(b,c){return b.extend({scoped:c},function(b){return{constructor:function(c){b.constructor.call(this,c),this.__prefix=c.prefix,this.__localStorage=a.getGlobal("localStorage")},__key:function(a){return this.__prefix+a},_read_key:function(a){try{return JSON.parse(this.__localStorage.getItem(this.__key(a)))}catch(b){return null}},_write_key:function(a,b){this.__localStorage.setItem(this.__key(a),JSON.stringify(b))},_remove_key:function(a){this.__localStorage.removeItem(this.__key(a))}}})}),a.define("module:Stores.Invokers.RestInvokeeAjaxInvoker",["base:Class","base:Net.Uri","base:Net.HttpHeader","module:Stores.Invokers.RestInvokee"],function(a,b,c,d,e){return a.extend({scoped:e},[d,function(a){return{constructor:function(b){a.constructor.call(this),this.__ajax=b},restInvoke:function(a,d,e,f){return this.__ajax.execute({method:a,data:e,uri:b.appendUriParams(d,f)}).mapError(function(a){return{error:a.status_code(),data:a.data(),invalid:a.status_code()===c.HTTP_STATUS_PRECONDITION_FAILED}},this)}}}])}),a.define("module:Stores.Invokers.StoreInvokee",[],function(){return{storeInvoke:function(a,b,c){}}}),a.define("module:Stores.Invokers.RestInvokee",[],function(){return{restInvoke:function(a,b,c,d,e){}}}),a.define("module:Stores.Invokers.RouteredRestInvokee",[],function(){return{routeredRestInvoke:function(a,b,c,d,e){}}}),a.define("module:Stores.Invokers.InvokerStore",["module:Stores.BaseStore","module:Queries.Constrained"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(b,c){a.constructor.call(this,c),this.__storeInvokee=b},_query_capabilities:function(){return b.fullConstrainedQueryCapabilities()},__invoke:function(a,b,c){return this.__storeInvokee.storeInvoke(a,b,c)},_insert:function(a,b){return this.__invoke("insert",a,b)},_remove:function(a,b){return this.__invoke("remove",a,b)},_get:function(a,b){return this.__invoke("get",a,b)},_update:function(a,b,c){return this.__invoke("update",{id:a,data:b},c)},_query:function(a,b,c){return this.__invoke("query",{query:a,options:b},c)}}})}),a.define("module:Stores.Invokers.StoreInvokeeInvoker",["base:Class","module:Stores.Invokers.StoreInvokee"],function(a,b,c){return a.extend({scoped:c},[b,function(a){return{constructor:function(b){a.constructor.apply(this),this.__store=b},storeInvoke:function(a,b,c){return this["__"+a](b,c)},__insert:function(a,b){return this.__store.insert(a,b)},__remove:function(a,b){return this.__store.remove(a,b)},__get:function(a,b){return this.__store.get(a,b)},__update:function(a,b){return this.__store.update(a.id,a.data,b)},__query:function(a,b){return this.__store.query(a.query,a.options,b)}}}])}),a.define("module:Stores.Invokers.StoreInvokeeRestInvoker",["base:Class","base:Objs","base:Types","module:Stores.Invokers.StoreInvokee"],function(a,b,c,d,e){return a.extend({scoped:e},[d,function(a){return{constructor:function(d,e){a.constructor.call(this),this.__restInvokee=d,this.__options=b.tree_extend({methodMap:{insert:"POST",get:"GET",remove:"DELETE",update:"PUT",query:"GET"},toMethod:null,dataMap:{insert:function(a,b){return a},update:function(a,b){return a.data}},toData:null,getMap:{query:function(a,d){var e={};return a.query&&!c.is_empty(a.query)&&(e.query=JSON.stringify(a.query)),e=b.extend(e,a.options),e.sort&&(e.sort=JSON.stringify(e.sort)),e}},toGet:null,baseURI:"/",uriMap:{get:function(a,b){return a},remove:function(a,b){return a},update:function(a,b){return a.id}},toURI:null,context:this},e)},storeInvoke:function(a,b,c){return this.__restInvokee.restInvoke(this._toMethod(a,b,c),this._toURI(a,b,c),this._toData(a,b,c),this._toGet(a,b,c))},_toMethod:function(a,b,c){var d=null;return this.__options.toMethod&&(d=this.__options.toMethod.call(this.__options.context,a,b,c)),d||this.__options.methodMap[a]},_toURI:function(a,b,d){var e=c.is_function(this.__options.baseURI)?this.__options.baseURI.call(this.__options.context,d):this.__options.baseURI;if(this.__options.toURI){var f=this.__options.toURI.call(this.__options.context,a,b,d);if(f)return e+f}return e+(a in this.__options.uriMap?c.is_function(this.__options.uriMap[a])?this.__options.uriMap[a].call(this.__options.context,b,d):this.__options.uriMap[a]:"")},_toData:function(a,b,c){var d=null;return this.__options.toData&&(d=this.__options.toData.call(this.__options.context,a,b,c)),d||(a in this.__options.dataMap?this.__options.dataMap[a].call(this.__options.context,b,c):null)},_toGet:function(a,b,c){var d=null;return this.__options.toGet&&(d=this.__options.toGet.call(this.__options.context,a,b,c)),d||(a in this.__options.getMap?this.__options.getMap[a].call(this.__options.context,b,c):null)}}}])}),a.define("module:Stores.Invokers.RouteredRestInvokeeStoreInvoker",["base:Class","base:Objs","base:Types","module:Stores.Invokers.RouteredRestInvokee"],function(a,b,c,d,e){return a.extend({scoped:e},[d,function(a){return{constructor:function(d,e){a.constructor.call(this),this.__storeInvokee=d,this.__options=b.tree_extend({dataMap:{insert:function(a,b,c,d,e){return c},update:function(a,b,c,d,e){return{id:b.id,data:c}},get:function(a,b,c,d,e){return b.id},remove:function(a,b,c,d,e){return b.id},query:function(a,d,e,f,g){var h={};try{f.query&&(h.query=JSON.parse(f.query))}catch(i){}var j=b.clone(f,1);delete j.query,c.is_empty(j)||(h.options=j);try{h.options.sort&&(h.options.sort=JSON.parse(h.options.sort))}catch(i){}return h}},toData:null,contextMap:{},toContext:function(a,b,c,d,e){return e},context:this},e)},routeredRestInvoke:function(a,b,c,d,e){return this.__storeInvokee.storeInvoke(a,this._toData(a,b,c,d,e),this._toContext(a,b,c,d,e))},_toData:function(a,b,c,d,e){var f=null;return this.__options.toData&&(f=this.__options.toData.call(this.__options.context,a,b,c,d,e)),f||(a in this.__options.dataMap?this.__options.dataMap[a].call(this.__options.context,a,b,c,d,e):null)},_toContext:function(a,b,c,d,e){var f=null;return this.__options.toContext&&(f=this.__options.toContext.call(this.__options.context,a,b,c,d,e)),f||(a in this.__options.contextMap?this.__options.contextMap[a].call(this.__options.context,a,b,c,d,e):null)}}}])}),a.define("module:Stores.Invokers.RestInvokeeStoreInvoker",["module:Stores.Invokers.RouteredRestInvokeeStoreInvoker","module:Stores.Invokers.RestInvokee","base:Router.RouteParser","base:Objs","base:Types"],function(a,b,c,d,e,f){return a.extend({scoped:f},[b,function(a){return{constructor:function(b,f){a.constructor.call(this,b,d.tree_extend({baseURI:"/",methodMap:{insert:"POST",get:"GET",remove:"DELETE",update:"PUT",query:"GET"},toMethod:null,uriMap:{get:"(id:.+)",remove:"(id:.+)",update:"(id:.+)"},toURI:null},f)),this.__routes={},d.iter(this.__options.methodMap,function(a,b){var c="",d=e.is_function(this.__options.baseURI)?this.__options.baseURI.call(this.__options.context):this.__options.baseURI;if(this.__options.toURI){var f=this.__options.toURI.call(this.__options.context,b);f&&(c=d+f)}c||(c=d+(b in this.__options.uriMap?e.is_function(this.__options.uriMap[b])?this.__options.uriMap[b].call(this.__options.context):this.__options.uriMap[b]:"")),this.__routes[b]=a+" "+c},this),this.__routeParser=this.auto_destroy(new c(this.__routes))},restInvoke:function(a,b,c,d,e){var f=this.__routeParser.parse(a+" "+b);return this.routeredRestInvoke(f.name,f.args,c,d,e)}}}])}),a.define("module:Stores.CachedStore",["module:Stores.BaseStore","module:Stores.MemoryStore","module:Queries","module:Queries.Constrained","module:Stores.CacheStrategies.ExpiryCacheStrategy","base:Promise","base:Objs","base:Types","base:Iterators.ArrayIterator","base:Iterators.MappedIterator","base:Timers.Timer"],function(a,b,c,d,e,f,g,h,i,j,k,l){return a.extend({scoped:l},function(a){return{constructor:function(c,d){a.constructor.call(this),this.remoteStore=c,this._options=g.extend({itemMetaKey:"meta",queryMetaKey:"meta",queryKey:"query",cacheKey:null,suppAttrs:{},optimisticRead:!1},d),this._online=!0,this.itemCache=this._options.itemCache||this.auto_destroy(new b({id_key:this._options.cacheKey||this.remoteStore.id_key()})),this._options.cacheKey=this.itemCache.id_key(),this._id_key=this.itemCache.id_key(),this._foreignKey=this.itemCache.id_key()!==this.remoteStore.id_key(),this.queryCache=this._options.queryCache||this.auto_destroy(new b),this.cacheStrategy=this._options.cacheStrategy||this.auto_destroy(new e),this._options.auto_cleanup&&this.auto_destroy(new k({fire:this.cleanup,context:this,start:!0,delay:this._options.auto_cleanup}))},_query_capabilities:function(){return d.fullConstrainedQueryCapabilities()},_insert:function(a,b){return this.cacheInsert(a,{lockItem:!0,silent:!0,refreshMeta:!1,accessMeta:!0},b)},_update:function(a,b,c){return this.cacheUpdate(a,b,{ignoreLock:!1,silent:!0,lockAttrs:!0,refreshMeta:!1,accessMeta:!0},c)},_remove:function(a,b){return this.cacheRemove(a,{ignoreLock:!0,silent:!0},b)},_get:function(a,b){return this.cacheGet(a,{silentInsert:!0,silentUpdate:!0,silentRemove:!0,refreshMeta:!0,accessMeta:!0},b)},_query:function(a,b,c){return this.cacheQuery(a,b,{silent:!0,queryRefreshMeta:!0,queryAccessMeta:!0,refreshMeta:!0,accessMeta:!0},c)},cacheInsert:function(a,b,c){var d={lockedItem:b.lockItem,lockedAttrs:{},refreshMeta:b.refreshMeta?this.cacheStrategy.itemRefreshMeta():null,accessMeta:b.accessMeta?this.cacheStrategy.itemAccessMeta():null};return this.itemCache.insert(this.addItemSupp(this.addItemMeta(a,d)),c).mapSuccess(function(d){return a=this.removeItemMeta(d),b.silent||this._inserted(a,c),a},this)},cacheUpdate:function(a,b,c,d){var e=c.foreignKey&&this._foreignKey,f=e?this.itemCache.getBy(this.remoteStore.id_key(),a,d):this.itemCache.get(a,d);return f.mapSuccess(function(a){if(!a)return null;var e=this.readItemMeta(a);return c.unlockItem&&(e.lockedItem=!1,e.lockedAttrs={}),b=g.filter(b,function(a,b){return c.ignoreLock||!e.lockedItem&&!e.lockedAttrs[b]},this),h.is_empty(b)?this.removeItemMeta(a):(c.lockAttrs&&g.iter(b,function(a,b){e.lockedAttrs[b]=!0},this),c.refreshMeta&&(e.refreshMeta=this.cacheStrategy.itemRefreshMeta(e.refreshMeta)),c.accessMeta&&(e.accessMeta=this.cacheStrategy.itemAccessMeta(e.accessMeta)),this.itemCache.update(this.itemCache.id_of(a),this.addItemMeta(b,e),d).mapSuccess(function(a){return a=this.removeItemMeta(a),c.silent||this._updated(a,b,d),a},this))},this)},cacheInsertUpdate:function(a,b,c){var d=b.foreignKey&&this._foreignKey,e=d?this.itemCache.getBy(this.remoteStore.id_key(),this.remoteStore.id_of(a),c):this.itemCache.get(this.itemCache.id_of(a),c);return e.mapSuccess(function(d){return b.foreignKey=!1,d?this.cacheUpdate(this.itemCache.id_of(d),a,b,c):this.cacheInsert(a,b,c)},this)},cacheRemove:function(a,b,c){var d=b.foreignKey&&this._foreignKey,e=d?this.itemCache.getBy(this.remoteStore.id_key(),a,c):this.itemCache.get(a,c);return e.mapSuccess(function(a){if(!a)return a;var d=this.readItemMeta(a);if(!b.ignoreLock&&(d.lockedItem||!h.is_empty(d.lockedAttrs)))return f.error("locked item");var e=this.itemCache.id_of(a);return this.itemCache.remove(e,c).success(function(){b.silent||this._removed(e,c)},this)},this)},cacheOnlyGet:function(a,b,c){var d=b.foreignKey&&this._foreignKey,e=d?this.itemCache.getBy(this.remoteStore.id_key(),a,c):this.itemCache.get(a,c);return e},cacheGet:function(a,b,c){var d=b.foreignKey&&this._foreignKey;return this.cacheOnlyGet(a,b,c).mapSuccess(function(e){if(!e)return!d&&this._foreignKey?e:this.remoteStore.get(a,c).mapSuccess(function(a){return this.online(),a?this.cacheInsert(a,{lockItem:!1,silent:b.silentInsert,accessMeta:!0,refreshMeta:!0},c):a},this);var g=this.readItemMeta(e),h=this.itemCache.id_of(e),i=this.remoteStore.id_of(e);return this.cacheStrategy.validItemRefreshMeta(g.refreshMeta)||g.lockedItem?(b.accessMeta&&(g.accessMeta=this.cacheStrategy.itemAccessMeta(g.accessMeta),this.itemCache.update(h,this.addItemMeta({},g),c)),this.removeItemMeta(e)):this.remoteStore.get(i,c).mapSuccess(function(a){return this.online(),a?this.cacheUpdate(h,a,{ignoreLock:!1,lockAttrs:!1,silent:b.silentUpdate,accessMeta:!0,refreshMeta:!0},c):this.cacheRemove(h,{ignoreLock:!1,silent:b.silentRemove},c)},this).mapError(function(){return this.offline(),f.value(e)},this)},this)},__itemCacheQuery:function(a,b,c){return this.itemCache.query(a,b,c).mapSuccess(function(a){return a=a.asArray(),g.iter(a,function(a){this.cacheUpdate(this.itemCache.id_of(a),{},{lockItem:!1,lockAttrs:!1,silent:!0,accessMeta:b.accessMeta,refreshMeta:!1},c)},this),new j(new i(a),this.removeItemMeta,this)},this)},cacheQuery:function(a,b,e,h){var k=d.serialize({
query:a,options:b}),l=g.objectBy(this._options.queryKey,k);return this.queryCache.query(l,{limit:1},h).mapSuccess(function(d){if(d=d.hasNext()?d.next():null){var l=this.readQueryMeta(d),m=this.queryCache.id_of(d);if(this.cacheStrategy.validQueryRefreshMeta(l.refreshMeta))return e.queryAccessMeta&&(l.accessMeta=this.cacheStrategy.queryAccessMeta(l.accessMeta),this.queryCache.update(m,this.addQueryMeta({},l),h)),this.__itemCacheQuery(a,e,h);this.queryCache.remove(m,h)}if(c.queryDeterminedByAttrs(a,this._options.suppAttrs))return this.itemCache.query(a,e,h);var n=this.remoteStore.query(a,b,h).mapSuccess(function(a){this.online(),a=a.asArray();var b={refreshMeta:e.queryRefreshMeta?this.cacheStrategy.queryRefreshMeta():null,accessMeta:e.queryAccessMeta?this.cacheStrategy.queryAccessMeta():null};this.queryCache.insert(g.objectBy(this._options.queryKey,k,this._options.queryMetaKey,b),h);var c=[];return g.iter(a,function(a){c.push(this.cacheInsertUpdate(a,{lockItem:!1,lockAttrs:!1,silent:e.silent&&!this._options.optimisticRead,accessMeta:e.accessMeta,refreshMeta:e.refreshMeta,foreignKey:!0},h))},this),f.and(c).mapSuccess(function(a){return new j(new i(a),this.addItemSupp,this)},this)},this).mapError(function(){return this.offline(),this._options.optimisticRead?void 0:this.__itemCacheQuery(a,e,h)},this);return this._options.optimisticRead?this.__itemCacheQuery(a,e,h):n},this)},online:function(){this.trigger("online"),this._online=!0},offline:function(){this.trigger("offline"),this._online=!1},addItemMeta:function(a,b){return a=g.clone(a,1),a[this._options.itemMetaKey]=b,a},addItemSupp:function(a){return g.extend(g.clone(this._options.suppAttrs,1),a)},removeItemSupp:function(a){return this._options.suppAttrs?g.filter(a,function(a,b){return!(b in this._options.suppAttrs)},this):a},addQueryMeta:function(a,b){return a=g.clone(a,1),a[this._options.queryMetaKey]=b,a},removeItemMeta:function(a){return a=g.clone(a,1),delete a[this._options.itemMetaKey],a},removeQueryMeta:function(a){return a=g.clone(a,1),delete a[this._options.queryMetaKey],a},readItemMeta:function(a){return a[this._options.itemMetaKey]},readQueryMeta:function(a){return a[this._options.queryMetaKey]},unlockItem:function(a,b){this.itemCache.get(a,b).success(function(c){if(c){var d=this.readItemMeta(c);d.lockedItem=!1,d.lockedAttrs={},this.itemCache.update(a,this.addItemMeta({},d),b)}},this)},cleanup:function(){this._online&&(this.queryCache.query().success(function(a){for(;a.hasNext();){var b=a.next(),c=this.readQueryMeta(b);this.cacheStrategy.validQueryRefreshMeta(c.refreshMeta)&&this.cacheStrategy.validQueryAccessMeta(c.accessMeta)||this.queryCache.remove(this.queryCache.id_of(b))}},this),this.itemCache.query().success(function(a){for(;a.hasNext();){var b=a.next(),c=this.readItemMeta(b);c.lockedItem||!h.is_empty(c.lockedAttrs)||this.cacheStrategy.validItemRefreshMeta(c.refreshMeta)&&this.cacheStrategy.validItemAccessMeta(c.accessMeta)||this.itemCache.remove(this.itemCache.id_of(b))}},this))},cachedIdToRemoteId:function(a){return this._foreignKey?this.itemCache.get(a).mapSuccess(function(a){return a?this.remoteStore.id_of(a):null},this):f.value(a)},serialize:function(){return this.itemCache.serialize().mapSuccess(function(a){return this.queryCache.serialize().mapSuccess(function(b){return{items:a,queries:b}},this)},this)},unserialize:function(a){return this.itemCache.unserialize(a.items).mapSuccess(function(b){return this.queryCache.unserialize(a.queries),b.map(function(a){return this.removeItemMeta(a)},this)},this)}}})}),a.define("module:Stores.CacheStrategies.CacheStrategy",["base:Class"],function(a,b){return a.extend({scoped:b},{itemRefreshMeta:function(a){},queryRefreshMeta:function(a){},itemAccessMeta:function(a){},queryAccessMeta:function(a){},validItemRefreshMeta:function(a){},validQueryRefreshMeta:function(a){},validItemAccessMeta:function(a){},validQueryAccessMeta:function(a){}})}),a.define("module:Stores.CacheStrategies.ExpiryCacheStrategy",["module:Stores.CacheStrategies.CacheStrategy","base:Time","base:Objs"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(d){a.constructor.call(this),this._options=c.extend({itemRefreshTime:144e4,itemAccessTime:36e6,queryRefreshTime:144e4,queryAccessTime:36e6,now:function(){return b.now()}},d)},itemRefreshMeta:function(a){return a?a:null===this._options.itemRefreshTime?null:this._options.now()+this._options.itemRefreshTime},queryRefreshMeta:function(a){return a?a:null===this._options.queryRefreshTime?null:this._options.now()+this._options.queryRefreshTime},itemAccessMeta:function(a){return null===this._options.itemAccessTime?null:this._options.now()+this._options.itemAccessTime},queryAccessMeta:function(a){return null===this._options.queryAccessTime?null:this._options.now()+this._options.queryAccessTime},validItemRefreshMeta:function(a){return null===this._options.itemRefreshTime||a>=this._options.now()},validQueryRefreshMeta:function(a){return null===this._options.queryRefreshTime||a>=this._options.now()},validItemAccessMeta:function(a){return null===this._options.itemAccessTime||a>=this._options.now()},validQueryAccessMeta:function(a){return null===this._options.queryAccessTime||a>=this._options.now()}}})}),a.define("module:Stores.PartialStore",["module:Stores.BaseStore","module:Stores.CachedStore","module:Stores.PartialStoreWriteStrategies.PostWriteStrategy","module:Stores.PartialStoreWatcher","base:Objs","base:Types"],function(a,b,c,d,e,f,g){return a.extend({scoped:g},function(a){return{constructor:function(f,g){a.constructor.call(this,g),this._options=e.extend({},g),this._options.remoteWatcher&&(this.remoteWatcher=this._options.remoteWatcher),this.remoteStore=f,this.cachedStore=new b(f,this._options),this.writeStrategy=this._options.writeStrategy||this.auto_destroy(new c),this.remoteWatcher&&(this.remoteWatcher.on("insert",this._remoteInsert,this),this.remoteWatcher.on("update",this._remoteUpdate,this),this.remoteWatcher.on("remove",this._remoteRemove,this),this._watcher=new d(this)),this.cachedStore.on("insert",this._inserted,this),this.cachedStore.on("remove",this._removed,this),this.cachedStore.on("update",this._updated,this),this.writeStrategy.init(this)},id_key:function(){return this.cachedStore.id_key()},destroy:function(){this.remoteWatcher&&this.remoteWatcher.off(null,null,this),this._watcher&&this._watcher.destroy(),this.cachedStore.destroy(),a.destroy.call(this)},_insert:function(a,b){return this.writeStrategy.insert(a,b)},_remove:function(a,b){return this.writeStrategy.remove(a,b)},_update:function(a,b,c){return this.cachedStore.cacheOnlyGet(a,{},c).mapSuccess(function(d){var g=e.diff(b,d);return f.is_empty(g)?d:this.writeStrategy.update(a,b,c)},this)},_get:function(a,b){return this.cachedStore.get(a,b)},_query:function(a,b,c){return this.cachedStore.query(a,b,c)},_query_capabilities:function(){return this.cachedStore._query_capabilities()},_remoteInsert:function(a,b){this.cachedStore.cacheInsertUpdate(a,{lockItem:!1,silent:!1,refreshMeta:!0,accessMeta:!0,foreignKey:!0},b)},_remoteUpdate:function(a,b,c){var d=this.remoteStore.id_of(a);this.cachedStore.cacheUpdate(d,b,{ignoreLock:!1,lockAttrs:!1,silent:!1,accessMeta:!0,refreshMeta:!0,foreignKey:!0},c)},_remoteRemove:function(a,b){this.cachedStore.cacheRemove(a,{ignoreLock:!1,silent:!1,foreignKey:!0},b)},serialize:function(){return this.cachedStore.serialize()},unserialize:function(a){return this.cachedStore.unserialize(a).success(function(a){a.forEach(function(a){this._inserted(a)},this)},this)}}})}),a.define("module:Stores.PartialStoreWatcher",["module:Stores.Watchers.LocalWatcher"],function(a,b){return a.extend({scoped:b},function(a){return{_watchItem:function(b){a.watchItem.call(this,b),this._store.cachedStore.cachedIdToRemoteId(b).success(function(a){this._store.remoteWatcher.watchItem(a,this)},this)},_unwatchItem:function(b){a.unwatchItem.call(this,b),this._store.cachedStore.cachedIdToRemoteId(b).success(function(a){this._store.remoteWatcher.unwatchItem(a,this)},this)},_watchInsert:function(b){a.watchInsert.call(this,b),this._store.remoteWatcher.watchInsert(b,this)},_unwatchInsert:function(b){a.unwatchInsert.call(this,b),this._store.remoteWatcher.unwatchInsert(b,this)}}})}),a.define("module:Stores.PartialStoreWriteStrategies.WriteStrategy",["base:Class"],function(a,b){return a.extend({scoped:b},function(a){return{init:function(a){this.partialStore=a},insert:function(a,b){},remove:function(a,b){},update:function(a,b){}}})}),a.define("module:Stores.PartialStoreWriteStrategies.PostWriteStrategy",["module:Stores.PartialStoreWriteStrategies.WriteStrategy"],function(a,b){return a.extend({scoped:b},function(a){return{insert:function(a,b){return this.partialStore.remoteStore.insert(a,b).mapSuccess(function(a){return this.partialStore.cachedStore.cacheInsert(a,{lockItem:!1,silent:!0,refreshMeta:!0,accessMeta:!0},b)},this)},remove:function(a,b){return this.partialStore.cachedStore.cachedIdToRemoteId(a).mapSuccess(function(c){return this.partialStore.remoteStore.remove(c,b).mapSuccess(function(){return this.partialStore.cachedStore.cacheRemove(a,{ignoreLock:!0,silent:!0},b)},this)},this)},update:function(a,b,c){return this.partialStore.cachedStore.cachedIdToRemoteId(a).mapSuccess(function(d){return this.partialStore.remoteStore.update(d,b,c).mapSuccess(function(){return this.partialStore.cachedStore.cacheUpdate(a,b,{ignoreLock:!1,lockAttrs:!1,silent:!0,refreshMeta:!0,accessMeta:!0},c)},this)})}}})}),a.define("module:Stores.PartialStoreWriteStrategies.PreWriteStrategy",["module:Stores.PartialStoreWriteStrategies.WriteStrategy","base:Objs"],function(a,b,c){return a.extend({scoped:c},function(a){return{insert:function(a){return this.partialStore.cachedStore.cacheInsert(a,{lockItem:!0,silent:!0,refreshMeta:!0,accessMeta:!0}).mapSuccess(function(a){return nosuppdata=this.partialStore.cachedStore.removeItemSupp(a),this.partialStore.remoteStore.insert(nosuppdata).mapSuccess(function(c){return this.partialStore.cachedStore.cacheUpdate(this.partialStore.cachedStore.id_of(a),c,{silent:!0,unlockItem:!0}).mapSuccess(function(c){return b.extend(b.clone(a,1),c)},this)},this).error(function(){this.partialStore.cachedStore.cacheRemove(this.partialStore.cachedStore.id_of(a),{ignoreLock:!0,silent:!1})},this)},this)},remove:function(a){return this.partialStore.cachedStore.cachedIdToRemoteId(a).mapSuccess(function(b){return this.partialStore.cachedStore.cacheRemove(a,{ignoreLock:!0,silent:!0}).success(function(){this.partialStore.remoteStore.remove(b)},this)},this)},update:function(a,b){return this.partialStore.cachedStore.cachedIdToRemoteId(a).mapSuccess(function(c){return this.partialStore.cachedStore.cacheUpdate(a,b,{lockAttrs:!0,ignoreLock:!1,silent:!0,refreshMeta:!1,accessMeta:!0}).success(function(b){b=this.partialStore.cachedStore.removeItemSupp(b),this.partialStore.remoteStore.update(c,b).success(function(){this.partialStore.cachedStore.unlockItem(a)},this)},this)},this)}}})}),a.define("module:Stores.PartialStoreWriteStrategies.CommitStrategy",["module:Stores.PartialStoreWriteStrategies.WriteStrategy","module:Stores.StoreHistory","module:Stores.MemoryStore","base:Objs","base:Timers.Timer"],function(a,b,c,d,e,f){return a.extend({scoped:f},function(a){return{constructor:function(b,d){a.constructor.call(this),this._options=d||{},this.historyStore=this._options.historyStore||this.auto_destroy(new c)},init:function(c){a.init.call(this,c),this.storeHistory=this.auto_destroy(new b(null,this.historyStore,{source_id_key:c.cachedStore.itemCache.id_key(),row_data:{pushed:!1,success:!1},filter_data:{pushed:!1}})),this._options.auto_push&&this.auto_destroy(new e({fire:function(){this.push(this.partialStore)},context:this,start:!0,delay:this._options.auto_push}))},insert:function(a){return this.partialStore.cachedStore.cacheInsert(a,{lockItem:!0,silent:!0,refreshMeta:!0,accessMeta:!0}).success(function(a){a=this.partialStore.cachedStore.removeItemSupp(a),this.storeHistory.sourceInsert(a)},this)},remove:function(a){return this.partialStore.cachedStore.cachedIdToRemoteId(a).mapSuccess(function(b){return this.partialStore.cachedStore.cacheRemove(a,{ignoreLock:!0,silent:!0}).success(function(){this.storeHistory.sourceRemove(a,this.partialStore.remoteStore.id_row(b))},this)},this)},update:function(a,b){return this.partialStore.cachedStore.cacheUpdate(a,b,{lockAttrs:!0,ignoreLock:!1,silent:!0,refreshMeta:!1,accessMeta:!0}).success(function(){b=this.partialStore.cachedStore.removeItemSupp(b),this.storeHistory.sourceUpdate(a,b)},this)},push:function(){if(!this.pushing){var a={},b={},c=this.storeHistory.historyStore,e=c.query({success:!1},{sort:{commit_id:1}}).value(),f=function(){if(!e.hasNext())return this.pushing=!1,void d.iter(b,function(a,b){a&&(a===!0?this.partialStore.cachedStore.unlockItem(b):this.partialStore.cachedStore.cacheUpdate(b,a,{unlockItem:!0,silent:!0}))},this);var g=e.next(),h=c.id_of(g);if(h in a)c.update(h,{pushed:!0,success:!1}),f.apply(this);else{var i=null;"insert"===g.type?i=this.partialStore.remoteStore.insert(g.row):"update"===g.type?i=this.partialStore.cachedStore.cachedIdToRemoteId(g.row_id).mapSuccess(function(a){return this.partialStore.remoteStore.update(a,g.row)},this):"remove"===g.type&&(i=this.partialStore.remoteStore.remove(g.row?this.partialStore.remoteStore.id_of(g.row):g.row_id)),i.success(function(a){c.update(h,{pushed:!0,success:!0}),g.row_id in b||(b[g.row_id]=!0,"insert"===g.type&&(b[g.row_id]=a)),f.apply(this)},this).error(function(){c.update(h,{pushed:!0,success:!1}),a[h]=!0,b[g.row_id]=!1,f.apply(this)},this)}};f.apply(this)}}}})}),a.define("module:Stores.RemoteStore",["module:Stores.Invokers.InvokerStore","module:Stores.Invokers.StoreInvokeeRestInvoker","module:Stores.Invokers.RestInvokeeAjaxInvoker"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(d,e,f){var g=new c(d),h=new b(g,e);a.constructor.call(this,h,f),this.auto_destroy(h),this.auto_destroy(g)}}})}),a.define("module:Stores.SocketStore",["module:Stores.BaseStore","base:Objs"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(b,c,d){a.constructor.call(this,b),this.__socket=c,this.__prefix=d},__send:function(a,b){this.__socket.emit(this.__prefix+":"+a,b)},_insert:function(a){this.__send("insert",a)},_remove:function(a){this.__send("remove",a)},_update:function(a,c){this.__send("update",b.objectBy(a,c))}}})}),a.define("module:Stores.Watchers.ConsumerWatcher",["module:Stores.Watchers.StoreWatcher"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b,c,d){a.constructor.call(this,d),this._receiver=c,this._sender=b,c.on("receive",function(a,b){"insert"===a&&this._insertedWatchedInsert(b),"update"===a?this._updatedWatchedItem(b.row,b.data):"remove"===a&&this._removedWatchedItem(b)},this)},destroy:function(){this._receiver.off(null,null,this),a.destroy.apply(this)},_watchItem:function(a){this._sender.send("watch_item",a)},_unwatchItem:function(a){this._sender.send("unwatch_item",a)},_watchInsert:function(a){this._sender.send("watch_insert",a)},_unwatchInsert:function(a){this._sender.send("unwatch_insert",a)}}})}),a.define("module:Stores.Watchers.ProducerWatcher",["base:Class"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b,c,d){a.constructor.apply(this),this._watcher=d,this._receiver=c,c.on("receive",function(a,b){"watch_item"===a?d.watchItem(b,this):"unwatch_item"===a?d.unwatchItem(b,this):"watch_insert"===a?d.watchInsert(b,this):"unwatch_insert"===a&&d.unwatchInsert(b,this)},this),d.on("insert",function(a){b.send("insert",a)},this).on("update",function(a,c){b.send("update",{row:a,data:c})},this).on("remove",function(a){b.send("remove",a)},this)},destroy:function(){this._receiver.off(null,null,this),this._watcher.off(null,null,this),a.destroy.apply(this)}}})}),a.define("module:Stores.Watchers.ListWatcher",["module:Stores.Watchers.StoreWatcher","base:Objs"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(b,c,d){d=d||{},d.id_key=b.id_key(),this.__watchers=c,a.constructor.call(this,d),this.__forEachWatcher(function(a){this.delegateEvents(["insert","update","remove"],a)})},__forEachWatcher:function(a){b.iter(this.__watchers,a,this)},destroy:function(){this.__forEachWatcher(function(a){a.off(null,null,this)}),a.destroy.apply(this)},_watchItem:function(a){this.__forEachWatcher(function(b){b.watchItem(a)})},_unwatchItem:function(a){this.__forEachWatcher(function(b){b.unwatchItem(a)})},_watchInsert:function(a){this.__forEachWatcher(function(b){b.watchInsert(a)})},_unwatchInsert:function(a){this.__forEachWatcher(function(b){b.unwatchInsert(a)})}}})}),a.define("module:Stores.Watchers.LocalWatcher",["module:Stores.Watchers.StoreWatcher"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b,c){c=c||{},c.id_key=b.id_key(),a.constructor.call(this,c),this._store=b,this._store.on("insert",function(a){this._insertedInsert(a)},this).on("update",function(a,b){this._updatedItem(a,b)},this).on("remove",function(a){this._removedItem(a)},this)},destroy:function(){this._store.off(null,null,this),a.destroy.apply(this)}}})}),a.define("module:Stores.Watchers.PollWatcher",["module:Stores.Watchers.StoreWatcher","base:Comparators","base:Objs","base:Timers.Timer"],function(a,b,c,d,e){return a.extend({scoped:e},function(a){return{constructor:function(b,c){c=c||{},c.id_key=b.id_key(),a.constructor.call(this,c),this._store=b,this.__itemCache={},this.__lastKey=null,this.__lastKeyIds={},this.__insertsCount=0,this.__increasingKey=c.increasing_key||this.id_key,this.__ignoreUpdates=c.ignore_updates,c.auto_poll&&this.auto_destroy(new d({fire:this.poll,context:this,start:!0,delay:c.auto_poll}))},_watchItem:function(a){this.__itemCache[a]=null},_unwatchItem:function(a){delete this.__itemCache[a]},_queryLastKey:function(){return this._store.query({},{limit:1,sort:c.objectBy(this.__increasingKey,-1)}).mapSuccess(function(a){return a.hasNext()?a.next()[this.__increasingKey]:null},this).mapError(function(){return null})},_watchInsert:function(a){0===this.__insertsCount&&this._queryLastKey().success(function(a){this.__lastKey=a,this.__lastKeyIds={}},this),this.__insertsCount++},_unwatchInsert:function(a){this.__insertsCount--,0===this.__insertsCount&&(this.__lastKey=null)},poll:function(){this.__ignoreUpdates||c.iter(this.__itemCache,function(a,d){this._store.get(d).success(function(e){e?(this.__itemCache[d]=c.clone(e,1),a&&!b.deepEqual(a,e,-1)&&this._updatedItem(e,e)):this._removedItem(d)},this)},this),this.__lastKey?this.insertsIterator().iterate(function(a){var b=a.query,d=a.options,e=c.objectBy(this.__increasingKey,{$gte:this.__lastKey});this._store.query(c.extend(e,b),d).success(function(a){for(;a.hasNext();){var b=a.next(),c=b[this.__increasingKey];this.__lastKeyIds[c]||this._insertedInsert(b),this.__lastKeyIds[c]=!0,c>this.__lastKey&&(this.__lastKey=c)}},this)},this):this._queryLastKey().success(function(a){a!==this.__lastKey&&(this.__lastKey=a,this.__lastKeyIds={})},this)}}})}),a.define("module:Stores.Watchers.StoreWatcherMixin",[],function(){return{watchItem:function(a,b){},unwatchItem:function(a,b){},watchInsert:function(a,b){},unwatchInsert:function(a,b){},_removedWatchedItem:function(a){this.trigger("remove",a)},_updatedWatchedItem:function(a,b){this.trigger("update",a,b)},_insertedWatchedInsert:function(a){this.trigger("insert",a)},delegateStoreEvents:function(a){this.on("insert",function(b){a.trigger("insert",b)},a).on("update",function(b,c){a.trigger("update",b,c)},a).on("remove",function(b){a.trigger("remove",b)},a)},undelegateStoreEvents:function(a){this.off(null,null,a)}}}),a.define("module:Stores.Watchers.StoreWatcher",["base:Class","base:Events.EventsMixin","base:Classes.ContextRegistry","module:Stores.Watchers.StoreWatcherMixin","module:Queries"],function(a,b,c,d,e,f){return a.extend({scoped:f},[b,d,function(a){return{constructor:function(b){a.constructor.call(this),b=b||{},b.id_key?this.id_key=b.id_key:this.id_key="id",this.__items=new c,this.__inserts=new c(e.serialize,e)},destroy:function(){this.__inserts.iterator().iterate(this.unwatchInsert,this),this.__items.iterator().iterate(this.unwatchItem,this),this.__inserts.destroy(),this.__items.destroy(),a.destroy.call(this)},insertsIterator:function(){return this.__inserts.iterator()},watchItem:function(a,b){this.__items.register(a,b)&&this._watchItem(a)},unwatchItem:function(a,b){this.__items.unregister(a,b).forEach(this._unwatchItem,this)},watchInsert:function(a,b){this.__inserts.register(a,b)&&this._watchInsert(a)},unwatchInsert:function(a,b){this.__inserts.unregister(a,b).forEach(this._unwatchInsert,this)},_removedItem:function(a){this.__items.get(a)&&this._removedWatchedItem(a)},_updatedItem:function(a,b){var c=a[this.id_key];this.__items.get(c)&&this._updatedWatchedItem(a,b)},_insertedInsert:function(a){for(var b=!1,c=this.__inserts.iterator();!b&&c.hasNext();)b=e.evaluate(c.next().query,a);b&&this._insertedWatchedInsert(a)},unregisterItem:function(a,b){this.__items.unregister(a,b)&&this._unregisterItem(a)},_watchItem:function(a){},_unwatchItem:function(a){},_watchInsert:function(a){},_unwatchInsert:function(a){}}}])}),a.define("module:Modelling.Associations.Association",["base:Class","base:Promise","base:Iterators"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(b,c){a.constructor.call(this),this._model=b,this._options=c||{},c.delete_cascade&&b.on("remove",function(){this.__delete_cascade()},this)},__delete_cascade:function(){this.execute().success(function(a){for(a=c.ensure(a);a.hasNext();)a.next().remove({})},this)},execute:function(){if("__cache"in this)return b.create(this.__cache);var a=this._execute();return this._options.cached&&a.callback(function(a,b){this.__cache=a?null:b},this),a},invalidate:function(){delete this.__cache}}})}),a.define("module:Modelling.Associations.BelongsToAssociation",["module:Modelling.Associations.TableAssociation","base:Promise","base:Objs"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{_execute:function(){var a=this._model.get(this._foreign_key);return a?this._primary_key?this._foreign_table.findBy(c.objectBy(this._primary_key,a)):this._foreign_table.findById(a):b.value(null)}}})}),a.define("module:Modelling.Associations.ConditionalAssociation",["module:Modelling.Associations.Association","base:Objs"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(c,d){a.constructor.call(this,c,b.extend({conditional:function(){return!0}},d))},_execute:function(){var a=this.assoc();return a.execute.apply(a,arguments)},assoc:function(){return this._model.assocs[this._options.conditional(this._model)]}}})}),a.define("module:Modelling.Associations.HasManyAssociation",["module:Modelling.Associations.TableAssociation","base:Objs","base:Iterators.ArrayIterator"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{_id:function(){return this._primary_key?this._model.get(this._primary_key):this._model.id()},_execute:function(){return this.allBy()},execute:function(){return a.execute.call(this).mapSuccess(function(a){return new c(a)})},findBy:function(a){return this._foreign_table.findBy(b.objectBy(this._foreign_key,this._id()))},allBy:function(a,c){return this._foreign_table.allBy(b.extend(b.objectBy(this._foreign_key,c?c:this._id(),a)))}}})}),a.define("module:Modelling.Associations.HasManyThroughArrayAssociation",["module:Modelling.Associations.HasManyAssociation","base:Promise","base:Objs"],function(a,b,c,d){return a.extend({scoped:d},{_execute:function(){var a=b.create(),d=b.and();return c.iter(this._model.get(this._foreign_key),function(a){d=d.and(this._foreign_table.findById(a))},this),d.forwardError(a).success(function(b){a.asyncSuccess(c.filter(b,function(a){return!!a}))}),a}})}),a.define("module:Modelling.Associations.HasManyViaAssociation",["module:Modelling.Associations.HasManyAssociation","base:Objs","base:Promise"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(b,c,d,e,f,g){a.constructor.call(this,b,e,f,g),this._intermediate_table=c,this._intermediate_key=d},findBy:function(a){var d=c.create(),e=b.objectBy(this._intermediate_key,this._id());return this._intermediate_table.findBy(e).forwardError(d).success(function(c){if(c){var e=b.extend(b.clone(a,1),b.objectBy(this._foreign_table.primary_key(),c.get(this._foreign_key)));this._foreign_table.findBy(e).forwardCallback(d)}else d.asyncSuccess(null)},this),d},allBy:function(a,d){var e=c.create(),f=b.objectBy(this._intermediate_key,d?d:this._id());return this._intermediate_table.allBy(f).forwardError(e).success(function(d){for(var f=c.and();d.hasNext();){var g=d.next(),h=b.extend(b.clone(a,1),b.objectBy(this._foreign_table.primary_key(),g.get(this._foreign_key)));f=f.and(this._foreign_table.allBy(h))}f.forwardError(e).success(function(a){var c=[];b.iter(a,function(a){for(;a.hasNext();)c.push(a.next())}),e.asyncSuccess(c)},this)},this),e}}})}),a.define("module:Modelling.Associations.HasOneAssociation",["module:Modelling.Associations.TableAssociation","base:Objs"],function(a,b,c){return a.extend({scoped:c},{_execute:function(a){var c=a?a:this._primary_key?this._model.get(this._primary_key):this._model.id();return this._foreign_table.findBy(b.objectBy(this._foreign_key,c))}})}),a.define("module:Modelling.Associations.PolymorphicHasOneAssociation",["module:Modelling.Associations.Association","base:Objs"],function(b,c,d){return b.extend({scoped:d},function(b){return{constructor:function(a,c,d,e){b.constructor.call(this,a,e),this._foreign_table_key=c,this._foreign_key=d,e.primary_key&&(this._primary_key=e.primary_key)},_execute:function(b){var d=b?b:this._primary_key?this._model.get(this._primary_key):this._model.id(),e=a.getGlobal(this._model.get(this._foreign_table_key));return e.findBy(c.objectBy(this._foreign_key,d))}}})}),a.define("module:Modelling.Associations.TableAssociation",["module:Modelling.Associations.Association"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b,c,d,e){a.constructor.call(this,b,e),this._foreign_table=c,this._foreign_key=d}}})}),a.define("module:Modelling.ModelException",["base:Exceptions.Exception"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b,c){a.constructor.call(this,c),this.__model=b},model:function(){return this.__model}}})}),a.define("module:Modelling.ModelMissingIdException",["module:Modelling.ModelException"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b){a.constructor.call(this,b,"No id given.")}}})}),a.define("module:Modelling.ModelInvalidException",["module:Modelling.ModelException","base:Objs"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(c,d){var e=b.values(c.errors()).join("\n")||d;a.constructor.call(this,c,e)}}})}),a.define("module:Modelling.Model",["module:Modelling.AssociatedProperties","module:Modelling.ModelInvalidException","base:Objs","base:Promise","base:Types","module:Modelling.Table"],function(a,b,c,d,e,f,g){return a.extend({scoped:g},function(a){return{constructor:function(b,d,e,f){this.__table=d,this.__options=c.extend({newModel:!0,removed:!1},e),this.__ctx=f,this.__silent=1,a.constructor.call(this,b),this.__silent=0,this.isNew()||(this._properties_changed={},this._registerEvents()),this.option("auto_create")&&this.isNew()&&this.save()},destroy:function(){this.__table.off(null,null,this),this.trigger("destroy"),a.destroy.call(this)},option:function(a){var b=a in this.__options?this.__options:this.table().options();return b[a]},table:function(){return this.__table},isSaved:function(){return this.isRemoved()||!this.isNew()&&!this.isChanged()},isNew:function(){return this.option("newModel")},isRemoved:function(){return this.option("removed")},_registerEvents:function(){this.__table.on("update:"+this.id(),function(a){if(!this.isRemoved()){this.__silent++;for(var b in a)this._properties_changed[b]||this.set(b,a[b]);this.__silent--}},this),this.__table.on("remove:"+this.id(),function(){this.isRemoved()||(this.trigger("remove"),this.__options.removed=!0)},this)},update:function(a){return this.__silent++,this.setAll(a),this.__silent--,this.isNew()?d.create(!0):this.save()},_afterSet:function(b,c,d,e){a._afterSet.call(this,b,c,d,e);var f=this.cls.scheme();b in f&&!(this.__silent>0)&&this.option("auto_update")&&!this.isNew()&&this.save()},save:function(){if(this.isRemoved())return d.create({});var a=this.option("save_invalid")?d.value(!0):this.validate();return a.mapSuccess(function(a){if(!a)return d.create(null,new b(this));var f;if(this.isNew())f=this.cls.filterPersistent(this.get_all_properties()),this.__options.type_column&&(f[this.__options.type_column]=this.cls.classname);else if(f=this.cls.filterPersistent(this.properties_changed()),e.is_empty(f))return d.create(f);var g=this.isNew(),h=this.isNew()?this.__table.store().insert(f,this.__ctx):this.__table.store().update(this.id(),f,this.__ctx);return h.mapCallback(function(a,d){return this.destroyed()?this:a?(a.data&&c.iter(a.data,function(a,b){this.setError(b,a)},this),new b(this,a)):(this.__silent++,this.setAll(d),this.__silent--,this._properties_changed={},this.trigger("save"),g&&(this.__options.newModel=!1,this._registerEvents()),this)},this)},this)},remove:function(){return this.isNew()||this.isRemoved()?d.create(!0):this.__table.store().remove(this.id(),this.__ctx).success(function(){this.__options.removed=!0,this.trigger("remove")},this)}}},{createTable:function(a,b){return new f(a,this,b)}})}),a.define("module:Modelling.SchemedProperties",["base:Properties.Properties","base:Types","base:Promise","base:Objs"],function(a,b,c,d,e){return a.extend({scoped:e},function(a){return{constructor:function(c){a.constructor.call(this);var d=this.cls.scheme();this._properties_changed={},this.__errors={};for(var e in d)"def"in d[e]?this.set(e,b.is_function(d[e].def)?d[e].def(c):d[e].def):d[e].auto_create?this.set(e,d[e].auto_create(this)):this.set(e,null);this._properties_changed={},this.__errors={};for(e in c)this.set(e,c[e])},_unsetChanged:function(a){delete this._properties_changed[a]},_beforeSet:function(a,c){var d=this.cls.scheme();if(!(a in d))return c;var e=d[a];return e.type&&(c=b.parseType(c,e.type)),e.transform&&(c=e.transform.apply(this,[c])),c},_afterSet:function(a,c){var d=this.cls.scheme();if(a in d&&(this._properties_changed[a]=c,delete this.__errors[a],d[a].after_set)){var e=b.is_string(d[a].after_set)?this[d[a].after_set]:d[a].after_set;e.apply(this,[c])}},isChanged:function(){return!b.is_empty(this._properties_changed)},properties_changed:function(){return this._properties_changed},get_all_properties:function(){var a={},b=this.cls.scheme();for(var c in b)a[c]=this.get(c);return a},validate:function(){this.trigger("validate");var a=[];for(var b in this.cls.scheme())a.push(this._validateAttr(b));return a.push(c.box(this._customValidate,this)),c.and(a).end().mapSuccess(function(a){var b=!0;return d.iter(a,function(a){b=b&&a}),b})},_customValidate:function(){return!0},_validateAttr:function(a){delete this.__errors[a];var e=this.cls.scheme(),f=e[a],g=f.validate;if(!g)return c.value(!0);b.is_array(g)||(g=[g]);var h=this.get(a),i=[];return d.iter(g,function(a){i.push(c.box(a.validate,a,[h,this]))},this),c.and(i).end().mapSuccess(function(b){var c=!0;return d.iter(b,function(b){null!==b&&(c=!1,this.__errors[a]=b)},this),this.trigger("validate:"+a,c,this.__errors[a]),c},this)},setError:function(a,b){this.__errors[a]=b,this.trigger("validate:"+a,!(a in this.__errors),this.__errors[a])},errors:function(){return this.__errors},getError:function(a){return this.__errors[a]},asRecord:function(a){var b={},c=this.cls.scheme(),e=this.get_all_properties();a=a||[];var f=function(f){var g=c[f].tags||[],h={};d.iter(g,function(a){h[a]=!0});var i=!0;d.iter(a,function(a){i=i&&a in h},this),i&&(b[f]=e[f])};for(var g in e)g in c&&f.call(this,g);return b},setByTags:function(a,b){
var c=this.cls.scheme();b=b||{};var e=function(e){var f=c[e].tags||[],g={};d.iter(f,function(a){g[a]=!0});var h=!0;d.iter(b,function(a){h=h&&a in g},this),h&&this.set(e,a[e])};for(var f in a)f in c&&e.call(this,f)}}},{_initializeScheme:function(){return{}},asRecords:function(a,b){return a.map(function(a){return a.asRecord(b)})},filterPersistent:function(a){var c={},d=this.scheme();for(var e in a)b.is_defined(d[e].persistent)&&!d[e].persistent||!b.is_defined(a[e])||(c[e]=a[e]);return c}},{scheme:function(){return this.__scheme=this.__scheme||this._initializeScheme(),this.__scheme}})}),a.define("module:Modelling.AssociatedProperties",["module:Modelling.SchemedProperties"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b){a.constructor.call(this,b),this.assocs=this._initializeAssociations();for(var c in this.assocs)this.__addAssoc(c,this.assocs[c])},__addAssoc:function(a,b){this[a]=function(){return b.execute.apply(b,arguments)}},_initializeAssociations:function(){return{}},destroy:function(){for(var b in this.assocs)this.assocs[b].destroy();a.destroy.call(this)},id:function(){return this.get(this.cls.primary_key())},pid:function(){return this.id()},hasId:function(){return this.has(this.cls.primary_key())}}},{primary_key:function(){return"id"},_initializeScheme:function(){var a={};return a[this.primary_key()]={type:"id",tags:["read"],after_set:null,persistent:!0},a}})}),a.define("module:Modelling.Table",["base:Class","base:Events.EventsMixin","base:Objs","base:Types","base:Iterators.MappedIterator","base:Classes.ObjectCache"],function(b,c,d,e,f,g,h){return b.extend({scoped:h},[c,function(b){return{constructor:function(a,c,e){b.constructor.call(this),this.__store=a,this.__model_type=c,this.__options=d.extend({type_column:null,auto_create:!1,auto_update:!0,save_invalid:!1,cache_models:!1},e||{}),this.__store.on("insert",function(a){this.trigger("create",a)},this),this.__store.on("update",function(a,b){var c=a[this.primary_key()];this.trigger("update",c,b,a),this.trigger("update:"+c,b)},this),this.__store.on("remove",function(a){this.trigger("remove",a),this.trigger("remove:"+a)},this),this.__options.cache_models&&(this.model_cache=this.auto_destroy(new g(function(a){return a.id()})))},modelClass:function(b){return b=b||this.__model_type,e.is_string(b)?a.getGlobal(b):b},newModel:function(a,b,c){b=this.modelClass(b);var d=new b(a,this,{},c);return this.__options.auto_create&&d.save(),this.model_cache&&(d.hasId()?this.model_cache.register(d):d.once("save",function(){this.model_cache.register(d)},this)),d},materialize:function(a,b){if(!a)return null;var c=this.modelClass(this.__options.type_column&&a[this.__options.type_column]?this.__options.type_column:null);if(this.model_cache){var d=this.model_cache.get(a[this.primary_key()]);if(d)return d.setAll(a),d}var e=new c(a,this,{newModel:!1},b);return this.model_cache&&this.model_cache.register(e),e},options:function(){return this.__options},store:function(){return this.__store},findById:function(a,b){return this.__store.get(a,b).mapSuccess(function(a){return this.materialize(a,b)},this)},findBy:function(a,b,c){return this.allBy(a,d.extend({limit:1},b),c).mapSuccess(function(a){return a.next()})},allBy:function(a,b,c){return this.__store.query(a,b,c).mapSuccess(function(a){return new f(a,function(a){return this.materialize(a,c)},this)},this)},primary_key:function(){return(e.is_string(this.__model_type)?a.getGlobal(this.__model_type):this.__model_type).primary_key()},all:function(a,b){return this.allBy({},a,b)},query:function(){return this.allBy.apply(this,arguments)},scheme:function(){return this.__model_type.scheme()},ensure_indices:function(){if(!("ensure_index"in this.__store))return!1;var a=this.scheme();for(var b in a)a[b].index&&this.__store.ensure_index(b);return!0}}}])}),a.define("module:Modelling.Validators.ConditionalValidator",["module:Modelling.Validators.Validator","base:Types"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(c,d){a.constructor.call(this),this.__condition=c,this.__validator=b.is_array(d)?d:[d]},validate:function(a,b){if(!this.__condition(a,b))return null;for(var c=0;c<this.__validator.length;++c){var d=this.__validator[c].validate(a,b);if(null!==d)return d}return null}}})}),a.define("module:Modelling.Validators.EmailValidator",["module:Modelling.Validators.Validator","base:Strings"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(b){a.constructor.call(this),this.__error_string=b?b:"Not a valid email address"},validate:function(a,c){return b.is_email_address(a)?null:this.__error_string}}})}),a.define("module:Modelling.Validators.LengthValidator",["module:Modelling.Validators.Validator","base:Types","base:Objs"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(b){a.constructor.call(this),b=c.extend({min_length:null,max_length:null,error_string:null},b),this.__min_length=b.min_length,this.__max_length=b.max_length,this.__error_string=b.error_string,this.__error_string||(null!==this.__min_length?null!==this.__max_length?this.__error_string="Between "+this.__min_length+" and "+this.__max_length+" characters":this.__error_string="At least "+this.__min_length+" characters":null!==this.__max_length&&(this.__error_string="At most "+this.__max_length+" characters"))},validate:function(a,b){return null!==this.__min_length&&(!a||a.length<this.__min_length)?this.__error_string:null!==this.__max_length&&a.length>this.__max_length?this.__error_string:null}}})}),a.define("module:Modelling.Validators.PresentValidator",["module:Modelling.Validators.Validator","base:Types"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(b){a.constructor.call(this),this.__error_string=b?b:"Field is required"},validate:function(a,c){return b.is_null(a)||""===a?this.__error_string:null}}})}),a.define("module:Modelling.Validators.UniqueValidator",["module:Modelling.Validators.Validator"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b,c){a.constructor.call(this),this.__key=b,this.__error_string=c?c:"Key already present"},validate:function(a,b){var c={};return c[this.__key]=a,b.table().findBy(c).mapSuccess(function(a){return!a||!b.isNew()&&b.id()==a.id()?null:this.__error_string},this)}}})}),a.define("module:Modelling.Validators.Validator",["base:Class"],function(a,b){return a.extend({scoped:b},{validate:function(a,b){return null}})})}).call(Scoped);