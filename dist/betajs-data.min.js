/*!
betajs-data - v1.0.121 - 2018-09-15
Copyright (c) Oliver Friedmann
Apache-2.0 Software License.
*/

var Scoped=function(){function a(a){function b(a){return{route:"string"==typeof a.route?a.route:null,parent:"object"==typeof a.parent?a.parent:null,ready:"boolean"==typeof a.ready&&a.ready,children:{},watchers:[],data:{},lazy:[]}}function c(a){if(!a.ready){if(a.parent&&!a.parent.ready)return void c(a.parent);if(a.route&&a.parent&&a.route in a.parent.data){a.data=a.parent.data[a.route],a.ready=!0;for(var b=0;b<a.watchers.length;++b)a.watchers[b].callback.call(a.watchers[b].context||this,a.data);a.watchers=[];for(var d in a.children)c(a.children[d])}}}function d(a){if(!a.ready){a.parent&&!a.parent.ready&&d(a.parent),a.ready=!0,a.parent&&j.tree&&"object"==typeof a.parent.data&&(a.parent.data[a.route]=a.data);for(var b=0;b<a.watchers.length;++b)a.watchers[b].callback.call(a.watchers[b].context||this,a.data);a.watchers=[]}}function e(a,b){if("object"==typeof b&&a.ready)for(var e in b)a.data[e]=b[e];else a.data=b;if("object"==typeof b)for(var f in b)a.children[f]&&(a.children[f].data=b[f]);d(a);for(var g in a.children)c(a.children[g])}function f(a){if(a.ready&&a.data)for(var b in a.data)delete a.data[b]}function g(a){if(!a)return k;for(var d=a.split("."),e=k,f=0;f<d.length;++f)d[f]in e.children?e=e.children[d[f]]:(e.children[d[f]]=b({parent:e,route:d[f]}),e=e.children[d[f]],c(e));return e}function h(a,b,c){if(a.ready)b.call(c||this,a.data);else if(a.watchers.push({callback:b,context:c}),a.lazy.length>0){var d=function(a){if(a.lazy.length>0){var b=a.lazy.shift();b.callback.call(b.context||this,a.data),d(a)}};d(a)}}function i(a,b,c){a=a||k,c=c||[],!a.ready&&0===a.lazy.length&&a.watchers.length>0&&c.push(b);for(var d in a.children){var e=a.children[d];c=i(e,(b?b+".":"")+e.route,c)}return c}var j={tree:"boolean"==typeof a.tree&&a.tree,global:"boolean"==typeof a.global&&a.global,root:"object"==typeof a.root?a.root:{}},k=b({ready:!0});if(j.tree)if(j.global){try{window&&(k.data=window)}catch(l){}try{global&&(k.data=global)}catch(l){}try{self&&(k.data=self)}catch(l){}}else k.data=j.root;return{extend:function(a,b){e(g(a),b)},set:function(a,b){var c=g(a);c.data&&f(c),e(c,b)},get:function(a){var b=g(a);return b.ready?b.data:null},lazy:function(a,b,c){var d=g(a);d.ready?b(c||this,d.data):d.lazy.push({callback:b,context:c})},digest:function(a){c(g(a))},obtain:function(a,b,c){h(g(a),b,c)},unresolvedWatchers:function(a){return i(g(a),a)},__export:function(){return{options:j,nsRoot:k}},__import:function(a){j=a.options,k=a.nsRoot}}}function b(e,f,g,h){var i=null,j=[],k=f,l=g,m=h,n=a({tree:!0}),o=a({tree:!1}),p={global:{namespace:m},root:{namespace:l},local:{namespace:n},"default":{namespace:o},parent:{namespace:k},scope:{namespace:n,readonly:!1}},q=function(a,b,c){var e=d.matchArgs(a,{options:"object",namespaceLocator:!0,dependencies:"array",hiddenDependencies:"array",callback:!0,context:"object"}),f=d.extend({lazy:this.options.lazy},e.options||{}),g=this.resolve(e.namespaceLocator),h=function(){this.require(e.dependencies,e.hiddenDependencies,function(){for(var f=[],h=0;h<arguments.length;++h)f.push(arguments[h]);if(f[f.length-1].ns=g,this.options.compile){for(var i=[],j=0;j<a.length;++j)i.push(d.stringify(a[j]));this.compiled+=this.options.ident+"."+b+"("+i.join(", ")+");\n\n"}this.options.dependencies&&(this.dependencies[g.path]=this.dependencies[g.path]||{},e.dependencies&&e.dependencies.forEach(function(a){this.dependencies[g.path][this.resolve(a).path]=!0},this),e.hiddenDependencies&&e.hiddenDependencies.forEach(function(a){this.dependencies[g.path][this.resolve(a).path]=!0},this));var k=this.options.compile?{}:e.callback.apply(e.context||this,f);c.call(this,g,k)},this)};return f.lazy?g.namespace.lazy(g.path,h,this):h.apply(this),this};return{getGlobal:d.method(c,c.getPath),setGlobal:d.method(c,c.setPath),options:{lazy:!1,ident:"Scoped",compile:!1,dependencies:!1},compiled:"",dependencies:{},nextScope:function(){return i||(i=b(this,n,l,m)),i},subScope:function(){var a=this.nextScope();return j.push(a),i=null,a},binding:function(b,c,e){if(!p[b]||!p[b].readonly){var f;f="string"!=d.typeOf(c)?{namespace:a({tree:!0,root:c}),path:null}:this.resolve(c),p[b]=d.extend(e,f)}return this},resolve:function(a){var b=a.split(":");if(1==b.length)throw"The locator '"+b[0]+"' requires a namespace.";var c=p[b[0]];if(!c)throw"The namespace '"+b[0]+"' has not been defined (yet).";return{namespace:c.namespace,path:c.path&&b[1]?c.path+"."+b[1]:c.path||b[1]}},define:function(){return q.call(this,arguments,"define",function(a,b){if(a.namespace.get(a.path))throw"Scoped namespace "+a.path+" has already been defined. Use extend to extend an existing namespace instead";a.namespace.set(a.path,b)})},assumeVersion:function(){var a=d.matchArgs(arguments,{assumption:!0,dependencies:"array",callback:!0,context:"object",error:"string"}),b=a.dependencies||[];b.unshift(a.assumption),this.require(b,function(){var b=arguments,c=b[0].replace(/[^\d\.]/g,"");b[0]=c.split(".");for(var e=0;e<b[0].length;++e)b[0][e]=parseInt(b[0][e],10);if("function"===d.typeOf(a.callback)){if(!a.callback.apply(a.context||this,a))throw"Scoped Assumption '"+a.assumption+"' failed, value is "+c+(a.error?", but assuming "+a.error:"")}else for(var f=(a.callback+"").replace(/[^\d\.]/g,"").split("."),g=0;g<Math.min(b[0].length,f.length);++g)if(parseInt(f[g],10)>b[0][g])throw"Scoped Version Assumption '"+a.assumption+"' failed, value is "+c+", but assuming at least "+a.callback})},extend:function(){return q.call(this,arguments,"extend",function(a,b){a.namespace.extend(a.path,b)})},require:function(){var a=d.matchArgs(arguments,{dependencies:"array",hiddenDependencies:"array",callback:"function",context:"object"});a.callback=a.callback||function(){};var b=a.dependencies||[],c=b.concat(a.hiddenDependencies||[]),e=c.length,f=[],g={};if(e)for(var h=function(b){this.i<f.length&&(f[this.i]=b),0===--e&&(f.push(g),a.callback.apply(a.context||this.ctx,f))},i=0;i<c.length;++i){var j=this.resolve(c[i]);i<b.length&&f.push(null),j.namespace.obtain(j.path,h,{ctx:this,i:i})}else f.push(g),a.callback.apply(a.context||this,f);return this},digest:function(a){var b=this.resolve(a);return b.namespace.digest(b.path),this},unresolved:function(a){var b=this.resolve(a);return b.namespace.unresolvedWatchers(b.path)},__export:function(){return{parentNamespace:k.__export(),rootNamespace:l.__export(),globalNamespace:m.__export(),localNamespace:n.__export(),privateNamespace:o.__export()}},__import:function(a){k.__import(a.parentNamespace),l.__import(a.rootNamespace),m.__import(a.globalNamespace),n.__import(a.localNamespace),o.__import(a.privateNamespace)}}}var c=function(){return{get:function(a){return"undefined"!=typeof window?a?window[a]:window:"undefined"!=typeof global?a?global[a]:global:"undefined"!=typeof self?a?self[a]:self:undefined},set:function(a,b){return"undefined"!=typeof window&&(window[a]=b),"undefined"!=typeof global&&(global[a]=b),"undefined"!=typeof self&&(self[a]=b),b},getPath:function(a){if(!a)return this.get();var b=a.split(".");if(1==b.length)return this.get(a);for(var c=this.get(b[0]),d=1;d<b.length;++d){if(!c)return c;c=c[b[d]]}return c},setPath:function(a,b){var c=a.split(".");if(1==c.length)return this.set(a,b);for(var d=this.get(c[0])||this.set(c[0],{}),e=1;e<c.length-1;++e)c[e]in d||(d[c[e]]={}),d=d[c[e]];return d[c[c.length-1]]=b,b}}}.call(this),d=function(){return{method:function(a,b){return function(){return b.apply(a,arguments)}},extend:function(a,b){a=a||{},b=b||{};for(var c in b)a[c]=b[c];return a},typeOf:function(a){return"[object Array]"===Object.prototype.toString.call(a)?"array":typeof a},isEmpty:function(a){if(null===a||void 0===a)return!0;if("array"==this.typeOf(a))return 0===a.length;if("object"!=typeof a)return!1;for(var b in a)return!1;return!0},matchArgs:function(a,b){var c=0,d={};for(var e in b)!0===b[e]||this.typeOf(a[c])==b[e]?(d[e]=a[c],c++):"undefined"==this.typeOf(a[c])&&c++;return d},stringify:function(a){return"function"==this.typeOf(a)?""+a:JSON.stringify(a)}}}.call(this),e=function(){return{__namespace:"Scoped",__revert:null,upgrade:function(a){var b=c.get(a||e.__namespace);if(b&&"object"==d.typeOf(b)&&b.guid==this.guid&&"string"==d.typeOf(b.version)){for(var f=this.version.split("."),g=b.version.split("."),h=!1,i=0;i<Math.min(f.length,g.length)&&(h=parseInt(f[i],10)>parseInt(g[i],10),f[i]==g[i]);++i);return h?this.attach(a):b}return this.attach(a)},attach:function(a){a&&(e.__namespace=a);var b=c.get(e.__namespace);if(b==this)return this;if(e.__revert=b,b)try{var d=b.__exportScoped();this.__exportBackup=this.__exportScoped(),this.__importScoped(d)}catch(f){}return c.set(e.__namespace,this),this},detach:function(a){return a&&c.set(e.__namespace,null),"undefined"!=typeof e.__revert&&c.set(e.__namespace,e.__revert),delete e.__revert,e.__exportBackup&&this.__importScoped(e.__exportBackup),this},exports:function(a,b,c){return a=a||("undefined"!=typeof module?module:null),"object"==typeof a&&a&&"exports"in a&&(c||a.exports==this||!a.exports||d.isEmpty(a.exports))&&(a.exports=b||this),this}}}.call(this),f=a({tree:!0,global:!0}),g=a({tree:!0}),h=b(null,g,g,f),i=d.extend(h,function(){return{guid:"4b6878ee-cb6a-46b3-94ac-27d91f58d666",version:"0.0.19",upgrade:e.upgrade,attach:e.attach,detach:e.detach,exports:e.exports,__exportScoped:function(){return{globalNamespace:f.__export(),rootNamespace:g.__export(),rootScope:h.__export()}},__importScoped:function(a){f.__import(a.globalNamespace),g.__import(a.rootNamespace),h.__import(a.rootScope)}}}.call(this));return i=i.upgrade(),i.exports(),i}.call(this);(function(){var a=this.subScope();a.binding("module","global:BetaJS.Data"),a.binding("base","global:BetaJS"),a.define("module:",function(){return{guid:"70ed7146-bb6d-4da4-97dc-5a8e2d23a23f",version:"1.0.121"}}),a.assumeVersion("base:version","~1.0.141"),a.define("module:Collections.AbstractQueryCollection",["base:Collections.Collection","base:Objs","base:Types","base:Comparators","base:Promise","base:Class","module:Queries.Constrained","module:Queries","module:Queries.ConstrainedQueryBuilder"],function(a,b,c,d,e,f,g,h,i,j){return a.extend({scoped:j},function(a){return{constructor:function(c,d,e){e=e||{},a.constructor.call(this,{release_references:!0,uniqueness:e.uniqueness,indices:e.indices}),i.is_instance_of(d)&&(this._rangeQueryBuilder=e.range_query_builder,this.__queryBuilder=d,d=this.__queryBuilder.getQuery(),this._rangeQueryBuilder&&(d=b.extend(d,this._rangeQueryBuilder.getQuery())),e=b.extend(e,this.__queryBuilder.getOptions()),this.__queryBuilder.on("change",function(){var a=this.__queryBuilder.getConstrainedQuery();this._rangeQueryBuilder&&(a.query=b.extend(this._rangeQueryBuilder.getQuery(),a.query)),this.update(a)},this),this._rangeQueryBuilder&&this._rangeQueryBuilder.on("change",function(){var a=this.__queryBuilder.getConstrainedQuery();this.rangeSuperQueryIncrease(b.extend(this._rangeQueryBuilder.getQuery(),a.query))},this)),this._id_key=this._id_key||e.id_key||"id",this._secondary_ident=e.secondary_ident,this._source=c,this._complete=!1,this._active=e.active||!1,this._incremental=!("incremental"in e)||e.incremental,this._active_bounds=!("active_bounds"in e)||e.active_bounds,this._bounds_attribute=e.bounds_attribute,this._enabled=!1,this._range=e.range||null,this._forward_steps=e.forward_steps||null,this._backward_steps=e.backward_steps||null,this._async=e.async||!1,this._active_in_direction="active_in_direction"in e&&e.active_in_direction,this._active&&(this.on("add",function(a){this._watchItem(a.get(this._id_key))},this),this.on("remove",function(a){this._unwatchItem(a.get(this._id_key))},this)),this._query={query:{},options:{skip:0,limit:null,sort:null}},this.update(b.tree_extend({query:{},options:{skip:e.skip||0,limit:e.limit||e.range||null,sort:e.sort||null}},d?d.query||d.options?d:{query:d}:{})),e.auto&&this.enable()},destroy:function(){this.disable(),this._watcher()&&(this._watcher().unwatchInsert(null,this),this._watcher().unwatchItem(null,this)),this.__queryBuilder&&this.__queryBuilder.off(null,null,this),a.destroy.call(this)},source:function(){return this._source},paginate:function(a){return this.update({options:{skip:a*this._range,limit:this._range}})},paginate_index:function(){return Math.floor(this.getSkip()/this._range)},paginate_next:function(){return this.isComplete()?e.create(!0):this.paginate(this.paginate_index()+1)},paginate_prev:function(){return this.paginate_index()>0?this.paginate(this.paginate_index()-1):e.create(!0)},increase_forwards:function(a){return a=a||this._forward_steps,this.isComplete()?e.create(!0):this.update({options:{limit:this.getLimit()+a}})},increase_backwards:function(a){return a=a||this._backward_steps,this.getSkip()?this.update({options:{skip:Math.max(this.getSkip()-a,0),limit:this.getLimit()?this.getLimit()+this.getSkip()-Math.max(this.getSkip()-a,0):null}}):e.create(!0)},bounds_forwards:function(a){var c=this._query.query[this._bounds_attribute].$lt;this._query.query[this._bounds_attribute].$lt=a;var d=b.clone(this._query.query,2);return d[this._bounds_attribute].$gte=c,this._execute({query:d},!0)},bounds_backwards:function(a){var c=this._query.query[this._bounds_attribute].$gte;this._query.query[this._bounds_attribute].$gte=a;var d=b.clone(this._query.query,2);return d[this._bounds_attribute].$lt=c,this._execute({query:d},!0)},get_ident:function(a){var b=f.is_class_instance(a)?a.get(this._id_key):a[this._id_key];return!b&&this._secondary_ident&&(b=this._secondary_ident(a)),b},getQuery:function(){return this._query},getSkip:function(){return this._query.options.skip||0},getLimit:function(){return this._query.options.limit||null},update:function(a){return this.trigger("collection-updating"),this.__update(a).callback(function(){this.trigger("collection-updated")},this)},__update:function(a){var c=!!a.query;a=g.rectify(a);var d=this._query.options.skip||0,f=this._query.options.limit||null;if(c&&(this._query.query=a.query),this._query.options=b.extend(this._query.options,a.options),!this._enabled)return e.create(!0);if(c||"sort"in a.options||!this._incremental)return this.refresh(!0);var h="skip"in a.options?a.options.skip||0:d,i="limit"in a.options?a.options.limit||null:f;if(h===d&&i===f)return e.create(!0);if(i&&h+i<=d||f&&d+f<=h)return this.refresh(!0);for(;d<h&&(null===f||f>0);)this.remove(this.getByIndex(0)),d++,f--;var j=e.create(!0);if(h<d){var k=d-h;null!==i&&(k=Math.min(k,i)),j=this._execute(b.tree_extend(b.clone(this._query,2),{options:{skip:h,limit:k}},2),!0),h+=k,null!==i&&(i-=k)}if(!f||i&&i<=f){if(i)for(;this.count()>i;)this.remove(this.getByIndex(this.count()-1));return j}return j.and(this._execute(b.tree_extend(b.clone(this._query,2),{options:{skip:d+f,limit:i?i-f:null}},2),!0))},enable:function(){this._enabled||(this._enabled=!0,this.refresh())},disable:function(){this._enabled&&(this._enabled=!1,this.clear(),this._unwatchInsert())},refresh:function(a){return a&&!this._incremental&&this.clear(),this._query.options.sort&&!c.is_empty(this._query.options.sort)?this.set_compare(d.byObject(this._query.options.sort)):this.set_compare(null),this._unwatchInsert(),this._active&&this._watchInsert(this._query),this._execute(this._query,!(a&&this._incremental))},rangeSuperQueryIncrease:function(a){var b=h.rangeSuperQueryDiffQuery(a,this._query.query);if(!b)throw"Range Super Query expected";return this._query.query=a,this._unwatchInsert(),this._active&&this._watchInsert(this._query),this._execute({query:b,options:this._query.options},!0)},isEnabled:function(){return this._enabled},_execute:function(a,b){return this.__executePromise?this.__executePromise.mapCallback(function(){return this._execute(a,b)},this):this._subExecute(a.query,a.options).mapSuccess(function(a){return b&&this._async?a.hasNext()?(this.__executePromise=a.asyncIterate(this.replace_object,this),this.__executePromise.callback(function(){this.__executePromise=null},this),!0):(this._complete=!0,a.destroy(),!0):(this.replace_objects(a.asArray(),b),!0)},this)},_subExecute:function(a,b){return this._source.query(a,b)},isComplete:function(){return this._complete},isValid:function(a){return h.evaluate(this._query.query,a)},_materialize:function(a){return a},_activeCreate:function(a){if(this._active&&this._enabled&&this.isValid(a)){if(this._active_in_direction&&this._query.options.sort&&this._query.options.limit&&this.count()>=this._query.options.limit){var b=this.getByIndex(this.count()-1).getAll();if(d.byObject(this._query.options.sort)(b,a)<0)return}this.add(this._materialize(a)),this._query.options.limit&&this.count()>this._query.options.limit&&(this._active_bounds?this._query.options.limit++:this.remove(this.getByIndex(this.count()-1)))}},_activeRemove:function(a){if(this._active&&this._enabled){var b=this.getById(a);b&&(this.remove(b),null!==this._query.options.limit&&this._active_bounds&&this._query.options.limit--)}},_activeUpdate:function(a,c,d){if(this._active&&this._enabled){var e=this.getById(a),f=b.extend(d,c);e?this.isValid(f)?e.setAll(c):this._activeRemove(a):this._activeCreate(f)}},_watcher:function(){return null},_watchInsert:function(a){this._watcher()&&this._watcher().watchInsert(a,this)},_unwatchInsert:function(){this._watcher()&&this._watcher().unwatchInsert(null,this)},_watchItem:function(a){this._watcher()&&this._watcher().watchItem(a,this)},_unwatchItem:function(a){this._watcher()&&this._watcher().unwatchItem(a,this)}}})}),a.define("module:Collections.StoreQueryCollection",["module:Collections.AbstractQueryCollection","base:Objs"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(c,d,e){a.constructor.call(this,c,d,b.extend({id_key:c.id_key()},e)),this._source=c,c.on("insert",this._activeCreate,this),c.on("remove",this._activeRemove,this),c.on("update",function(a,b){this._activeUpdate(c.id_of(a),b,a)},this)},destroy:function(){this._source.off(null,null,this),a.destroy.call(this)},get_ident:function(a){return a.get(this._source.id_key())},_watcher:function(){return this._source.watcher()}}})}),a.define("module:Collections.TableQueryCollection",["module:Collections.AbstractQueryCollection","base:Objs"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(c,d,e){a.constructor.call(this,c,d,b.extend({id_key:c.primary_key()},e)),c.on("create",this._activeCreate,this),c.on("remove",this._activeRemove,this),c.on("update",this._activeUpdate,this)},destroy:function(){this._source.off(null,null,this),a.destroy.call(this)},_materialize:function(a){return this._source.materialize(a)},_watcher:function(){return this._source.store().watcher()}}})}),a.define("module:Stores.DatabaseStore",["module:Stores.BaseStore","base:Objs","module:Queries","module:Queries.Constrained","base:Iterators.MappedIterator"],function(a,b,c,d,e,f){return a.extend({scoped:f},function(a){return{constructor:function(b,c,d,e,f){this.__database=b,this.__table_name=c,this.__table=this.__database.getTable(this.__table_name,f),a.constructor.call(this,{id_key:d||this.__table.primary_key()}),this.__separate_ids=e,this.__map_ids=!this.__separate_ids&&this.id_key()!==this.__table.primary_key()},table:function(){return this.__table},_remove:function(a){return this.__separate_ids?this.table().removeRow(this.id_row(a)):this.table().removeById(a)},_get:function(a){var b=this.__separate_ids?this.table().findOne(this.id_row(a)):this.table().findById(a);return this.__map_ids?b.mapSuccess(function(a){return a&&(a[this.id_key()]=a[this.table().primary_key()],delete a[this.table().primary_key()]),a},this):b},_update:function(a,b){return this.__separate_ids?this.table().updateRow(this.id_row(a),b):this.table().updateById(a,b)},_query_capabilities:function(){return d.fullConstrainedQueryCapabilities(c.fullQueryCapabilities())},_insert:function(a){var b=this.table().insertRow(a);return this.__map_ids?b.mapSuccess(function(a){return a[this.id_key()]=a[this.table().primary_key()],delete a[this.table().primary_key()],a},this):b},_query:function(a,c){this.__map_ids&&a[this.id_key()]&&(a=b.clone(a,1),a[this.table().primary_key()]=a[this.id_key()],delete a[this.id_key()]);var d=this.table().find(a,c);return this.__map_ids?d.mapSuccess(function(a){return new e(a,function(a){return a[this.id_key()]=a[this.table().primary_key()],delete a[this.table().primary_key()],a},this).auto_destroy(a,!0)},this):d},_ensure_index:function(a){this.table().ensureIndex(a)},clear:function(b){return b?a.clear.call(b):this.table().clear()}}})}),a.define("module:Databases.DatabaseTable",["base:Class","base:Objs","base:Iterators.MappedIterator"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(b,c,d){a.constructor.call(this),this._database=b,this._table_name=c,this._table_options=d||{}},primary_key:function(){return"id"},findOne:function(a,b){return this._findOne(this._encode(a),b).mapSuccess(function(a){return a?this._decode(a):null},this)},_findOne:function(a,b){return b=b||{},b.limit=1,this._find(a,b).mapSuccess(function(a){var b=a.next();return a.destroy(),b})},_encode:function(a){return a},_decode:function(a){return a},_decodeMany:function(a){return a},_find:function(a,b){},find:function(a,b){return this._find(this._encode(a),b).mapSuccess(function(a){return new c(a,this._decode,this).auto_destroy(a,!0)},this)},findById:function(a){return this.findOne(b.objectBy(this.primary_key(),a))},count:function(a){return this._count(this._encode(a))},_insertRow:function(a){},_insertRows:function(a){},_removeRow:function(a){},_updateRow:function(a,b){},_count:function(a){return this.find(a).mapSuccess(function(a){for(var b=0;a.hasNext();)b++,a.next();return a.destroy(),b})},insertRow:function(a){return this._insertRow(this._encode(a)).mapSuccess(this._decode,this)},insertRows:function(a){var c=[];return b.iter(a,function(a,b){c.push(this._encode(a))},this),this._insertRows(c).mapSuccess(this._decodeMany,this)},removeRow:function(a){return this._removeRow(this._encode(a))},updateRow:function(a,b){return this._updateRow(this._encode(a),this._encode(b)).mapSuccess(this._decode,this)},removeById:function(a){return this.removeRow(b.objectBy(this.primary_key(),a))},updateById:function(a,c){return this.updateRow(b.objectBy(this.primary_key(),a),c)},ensureIndex:function(a){},_clear:function(){return this._removeRow({})},clear:function(){return this._clear()},renameTable:function(a){return this._renameTable(a).success(function(){this._database._renameTableCache(a,this._table_name),this._table_name=a},this)},_renameTable:function(a){throw"Unsupported"}}})}),a.define("module:Databases.Database",["base:Class"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(){a.constructor.apply(this),this.__tableCache={}},_tableClass:function(){return null},getTable:function(a,b){if(!this.__tableCache[a]){var c=this._tableClass();this.__tableCache[a]=this.auto_destroy(new c(this,a,b))}return this.__tableCache[a]},_renameTableCache:function(a,b){this.__tableCache[b]=this.__tableCache[a],delete this.__tableCache[a]}}})}),a.define("module:Databases.Migrator",["base:Class","base:Types"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(){a.constructor.call(this),this.__version=null,this.__migrations=[],this.__sorted=!0},version:function(a){return this.__version||(this.__version=this._getVersion()),this.__version},_getVersion:function(){},_setVersion:function(a){},_log:function(a){},migrations:function(){return this.__sorted||(this.__migrations.sort(function(a,b){return a.version-b.version}),this.__sorted=!0),this.__migrations},register:function(a){this.__migrations.push(a),this.__sorted=!1},_indexByVersion:function(a){for(var b=0;b<this.__migrations.length;++b){if(a==this.__migrations[b].version)return b;if(a<this.__migrations[b].version)return b-1}return this.__migrations.length},migrate:function(a){for(var c=this._indexByVersion(this.version()),d=b.is_defined(a)?this._indexByVersion(a):this.__migrations.length-1;c<d;){var e=this.__migrations[c+1];this._log("Migrate "+e.version+": "+e.title+" - "+e.description+"...\n");try{e.migrate(),this._setVersion(this.__migrations[c+1].version),c++,this._log("Successfully migrated "+e.version+".\n")}catch(f){this._log("Failure! Rolling back "+e.version+"...\n");try{if("partial_rollback"in e)e.partial_rollback();else{if(!("rollback"in e))throw"No rollback defined";e.rollback()}}catch(g){throw this._log("Failure! Couldn't roll back "+e.version+"!\n"),g}throw this._log("Rolled back "+e.version+"!\n"),f}}},rollback:function(a){for(var c=this._indexByVersion(this.version()),d=b.is_defined(a)?this._indexByVersion(a):c-1;c>d;){var e=this.__migrations[c];this._log("Rollback "+e.version+": "+e.title+" - "+e.description+"...\n");try{e.rollback(),this._setVersion(c>=1?this.__migrations[c-1].version:0),c--,this._log("Successfully rolled back "+e.version+".\n")}catch(f){throw this._log("Failure! Couldn't roll back "+e.version+"!\n"),f}}}}})}),a.define("module:Stores.AbstractIndex",["base:Class","base:Comparators","base:Objs","base:Functions"],function(a,b,c,d,e){return a.extend({scoped:e},function(a){return{constructor:function(d,e,f,g){a.constructor.call(this),this._options=c.extend({exact:!0,ignoreCase:!1},g),this._compare=f||b.byValue,this._store=d,this.__row_count=0,this._initialize();var h=d.id_key();d.query({}).value().iterate(function(a){this.__row_count++,this._insert(a[h],a[e])},this),d.on("insert",function(a){this.__row_count++,this._insert(a[h],a[e])},this),d.on("remove",function(a){this.__row_count--,this._remove(a)},this),d.on("update",function(a,b){e in b&&this._update(a,b[e])},this)},_initialize:function(){},destroy:function(){this._store.off(null,null,this),a.destroy.call(this)},compare:function(){return this._compare.apply(arguments)},comparator:function(){return d.as_method(this,this._compare)},info:function(){return{row_count:this.__row_count,key_count:this._key_count(),key_count_ic:this._key_count_ic()}},options:function(){return this._options},iterate:function(a,b,c,d){this._iterate(a,b,c,d)},itemIterate:function(a,b,c,d){this.iterate(a,b,function(a,b){return c.call(d,a,this._store.get(b).value())},this)},iterate_ic:function(a,b,c,d){this._iterate_ic(a,b,c,d)},itemIterateIc:function(a,b,c,d){this.iterate_ic(a,b,function(a,b){return c.call(d,a,this._store.get(b).value())},this)},_iterate:function(a,b,c,d){},_iterate_ic:function(a,b,c,d){},_insert:function(a,b){},_remove:function(a){},_update:function(a,b){},_key_count:function(){},_key_count_ic:function(){},key_count_left_ic:function(a){},key_count_right_ic:function(a){},key_count_distance_ic:function(a,b){},key_count_left:function(a){},key_count_right:function(a){},key_count_distance:function(a,b){}}})}),a.define("module:Stores.MemoryIndex",["module:Stores.AbstractIndex","base:Structures.TreeMap","base:Objs","base:Types"],function(a,b,c,d,e){return a.extend({scoped:e},function(a){return{_initialize:function(){this._options.exact&&(this._exactMap=b.empty(this._compare)),this._options.ignoreCase&&(this._ignoreCaseMap=b.empty(this._compare)),this._idToKey={}},__insert:function(a,d,e){var f=b.find(d,e);return f?f[a]=!0:e=b.add(d,c.objectBy(a,!0),e),e},_insert:function(a,b){this._idToKey[a]=b,this._options.exact&&(this._exactMap=this.__insert(a,b,this._exactMap)),this._options.ignoreCase&&(this._ignoreCaseMap=this.__insert(a,b,this._ignoreCaseMap))},__remove:function(a,c,e){var f=b.find(a,c);return delete f[e],d.is_empty(f)&&(c=b.remove(a,c)),c},_remove:function(a){var b=this._idToKey[a];delete this._idToKey[a],this._options.exact&&(this._exactMap=this.__remove(b,this._exactMap,a)),this._options.ignoreCase&&(this._ignoreCaseMap=this.__remove(b,this._ignoreCaseMap,a))},_update:function(a,b){this._idToKey[a]!=b&&(this._remove(a),this._insert(a,b))},_iterate:function(a,c,d,e){b.iterate_from(a,this._exactMap,function(a,b){for(var c in b)if(!1===d.call(e,a,c))return!1;return!0},this,!c)},_iterate_ic:function(a,c,d,e){b.iterate_from(a,this._ignoreCaseMap,function(a,b){for(var c in b)if(!1===d.call(e,a,c))return!1;return!0},this,!c)},_key_count:function(){return this._options.exact?b.length(this._exactMap):0},_key_count_ic:function(){return this._options.ignoreCase?b.length(this._ignoreCaseMap):0},key_count_left_ic:function(a){return b.treeSizeLeft(a,this._ignoreCaseMap)},key_count_right_ic:function(a){return b.treeSizeRight(a,this._ignoreCaseMap)},key_count_distance_ic:function(a,c){return b.distance(a,c,this._ignoreCaseMap)},key_count_left:function(a){return b.treeSizeLeft(a,this._exactMap)},key_count_right:function(a){return b.treeSizeRight(a,this._exactMap)},key_count_distance:function(a,c){return b.distance(a,c,this._exactMap)}}})}),a.define("module:Queries.Constrained",["module:Queries","base:Types","base:Objs","base:Tokens","base:Comparators"],function(a,b,c,d,e){return{rectify:function(a){var b="options"in a||"query"in a?a:{query:a};return c.extend({query:{},options:{}},b)},skipValidate:function(a,b){return!("skip"in a&&b)||b.skip},limitValidate:function(a,b){return!("limit"in a&&b)||b.limit},sortValidate:function(a,d){if("sort"in a){if(d&&!d.sort)return!1;if(d&&b.is_object(d.sort)){if(!c.all(a.sort,function(a,b){return b in d.sort}))return!1}}return!0},constraintsValidate:function(a,b){return c.all(["skip","limit","sort"],function(c){return this[c+"Validate"].call(this,a,b)},this)},validate:function(b,c){return b=this.rectify(b),this.constraintsValidate(b.options,c)&&a.validate(b.query,c.query||{})},fullConstrainedQueryCapabilities:function(b){return{query:b||a.fullQueryCapabilities(),skip:!0,limit:!0,sort:!0}},normalize:function(b){return b=this.rectify(b),{query:a.normalize(b.query),options:b.options}},serialize:function(a){return JSON.stringify(this.rectify(a))},unserialize:function(a){return JSON.parse(a)},hash:function(a){return d.simple_hash(this.serialize(a))},subsumizes:function(b,c){b=this.rectify(b),c=this.rectify(c);var d=b.options.skip||0,e=c.options.skip||0,f=b.options.limit||null,g=c.options.limit||null,h=b.options.sort,i=b.options.sort;if(d>e)return!1;if(f){if(!g)return!1;if(g+e>f+d)return!1}return(!d&&!f||!h&&!i||JSON.stringify(h)==JSON.stringify(i))&&a.subsumizes(b.query,c.query)},mergeable:function(b,c){if(b=this.rectify(b),c=this.rectify(c),a.serialize(b.query)!=a.serialize(c.query))return!1;var d=b.options,e=c.options;return JSON.stringify(d.sort||{})==JSON.stringify(e.sort||{})&&("skip"in d?"skip"in e?d.skip<=e.skip?!d.limit||d.skip+d.limit>=e.skip:!e.limit||e.skip+e.limit>=d.skip:!e.limit||e.limit>=d.skip:!("skip"in e)||!d.limit||d.limit>=e.skip)},merge:function(a,b){a=this.rectify(a),b=this.rectify(b);var c=a.options,d=b.options;return{query:a.query,options:{skip:"skip"in c&&"skip"in d?Math.min(c.skip,d.skip):null,limit:"limit"in c&&"limit"in d?Math.max(c.limit,d.limit):null,sort:a.sort}}}}}),a.define("module:Queries",["base:Types","base:Sort","base:Objs","base:Class","base:Tokens","base:Iterators.ArrayIterator","base:Iterators.FilteredIterator","base:Strings","base:Comparators"],function(a,b,c,d,e,f,g,h,i){var j={$or:{evaluate_combine:c.exists},$and:{evaluate_combine:c.all}},k={$in:{target:"atoms",evaluate_combine:c.exists,evaluate_single:function(a,b){return a===b}},$gt:{target:"atom",evaluate_single:function(a,b){return a>b}},$lt:{target:"atom",evaluate_single:function(a,b){return a<b}},$gte:{target:"atom",evaluate_single:function(a,b){return a>=b}},$lte:{target:"atom",evaluate_single:function(a,b){return a<=b}},$sw:{target:"atom",evaluate_single:function(b,c){return b===c||a.is_string(b)&&0===b.indexOf(c)}},$ct:{target:"atom",no_index_support:!0,evaluate_single:function(b,c){return b===c||a.is_string(b)&&b.indexOf(c)>=0}},$eq:{target:"atom",evaluate_single:function(a,b){return a===b}},$ne:{target:"atom",evaluate_single:function(a,b){return a!==b}},$elemMatch:{target:"query",no_index_support:!0,evaluate_combine:c.exists}};return c.iter(c.clone(k,1),function(b,d){var e=c.clone(b,1);e.evaluate_single=function(c,d){return b.evaluate_single(a.is_string(c)?c.toLowerCase():c,a.is_string(d)?d.toLowerCase():d)},e.ignore_case=!0,k[d+"ic"]=e}),{SYNTAX_PAIR_KEYS:j,
SYNTAX_CONDITION_KEYS:k,validate:function(a,b){return this.validate_query(a,b)},validate_atoms:function(b,d){return a.is_array(b)&&c.all(b,function(a){return this.validate_atom(a,d)},this)},validate_atom:function(a,b){return!b||!!b.atom},validate_queries:function(b,d){return a.is_array(b)&&c.all(b,function(a){return this.validate_query(a,d)},this)},validate_query:function(b,d){return a.is_object(b)&&c.all(b,function(a,b){return this.validate_pair(a,b,d)},this)},validate_pair:function(a,b,c){return b in this.SYNTAX_PAIR_KEYS?!(c&&!(c.bool&&b in c.bool))&&this.validate_queries(a,c):this.validate_value(a,c)},is_query_atom:function(b){return null===b||!a.is_object(b)||"[object Object]"!==b.toString()||c.all(b,function(a,b){return!(b in this.SYNTAX_CONDITION_KEYS)},this)},validate_value:function(a,b){return this.is_query_atom(a)?this.validate_atom(a,b):this.validate_conditions(a,b)},validate_conditions:function(b,d){return a.is_object(b)&&c.all(b,function(a,b){return this.validate_condition(a,b,d)},this)},validate_condition:function(a,b,c){if(c&&(!c.conditions||!(b in c.conditions)))return!1;var d=this.SYNTAX_CONDITION_KEYS[b];return!!d&&("atoms"===d.target?this.validate_atoms(a):"atom"===d.target?this.validate_atom(a):"query"===d.target&&this.validate_query(a,c))},normalize:function(a){return b.deep_sort(a)},serialize:function(a){return JSON.stringify(a)},unserialize:function(a){return JSON.parse(a)},hash:function(a){return e.simple_hash(this.serialize(a))},dependencies:function(a){return Object.keys(this.dependencies_query(a,{}))},dependencies_queries:function(a,b){return c.iter(a,function(a){b=this.dependencies_query(a,b)},this),b},dependencies_query:function(a,b){return c.iter(a,function(a,c){b=this.dependencies_pair(a,c,b)},this),b},dependencies_pair:function(a,b,c){return b in this.SYNTAX_PAIR_KEYS?this.dependencies_queries(a,c):this.dependencies_key(b,c)},dependencies_key:function(a,b){return b[a]=(b[a]||0)+1,b},evaluate:function(a,b){return this.evaluate_query(a,b)},evaluate_query:function(a,b){return c.all(a,function(a,c){return this.evaluate_pair(a,c,b)},this)},evaluate_pair:function(a,b,d){return b in this.SYNTAX_PAIR_KEYS?this.SYNTAX_PAIR_KEYS[b].evaluate_combine.call(c,a,function(a){return this.evaluate_query(a,d)},this):this.evaluate_value(a,d[b])},evaluate_value:function(a,b){return this.is_query_atom(a)?this.evaluate_atom(a,b):this.evaluate_conditions(a,b)},evaluate_atom:function(a,b){return a===b},evaluate_conditions:function(a,b){return c.all(a,function(a,c){return this.evaluate_condition(a,c,b)},this)},evaluate_condition:function(a,b,d){var e=this.SYNTAX_CONDITION_KEYS[b];return"atoms"===e.target?e.evaluate_combine.call(c,a,function(a){return e.evaluate_single.call(this,d,a)},this):"atom"===e.target?e.evaluate_single.call(this,d,a):"query"===e.target?e.evaluate_combine.call(c,d,function(b){return this.evaluate_query({value:a},{value:b})},this):void 0},rangeSuperQueryDiffQuery:function(a,b){if(!c.keyEquals(a,b))return!1;var d=c.objectify(["$gt","$lt","$gte","$lte"]),e=[],f={};return!!c.iter(a,function(a,g){a=c.clone(a,1);var h=c.clone(b[g],1);if(c.iter(d,function(b,c){a[c]&&h[c]&&a[c]===h[c]&&(delete a[c],delete h[c])}),i.deepEqual(a,h,-1))return f[g]=a,!0;var j=c.filter(a,function(a,b){return!d[b]}),k=c.filter(h,function(a,b){return!d[b]});if(!i.deepEqual(j,k,-1))return!1;var l=c.clone(a,1);if(h.$gt||h.$gte){if(h.$lt||h.$lte){if((a.$gt||a.$gte)&&(a.$gt||a.$gte)>(h.$gt||h.$gte))return!1;if((a.$lt||a.$lte)&&(a.$lt||a.$lte)<(h.$lt||h.$lte))return!1;var m=c.clone(l,1),n=c.clone(l,1);return delete m.$lt,delete m.$lte,m[h.$gt?"$lte":"$lt"]=h.$gt||h.$gte,delete n.$gt,delete n.$gte,n[h.$lt?"$gte":"$gt"]=h.$lt||h.$lte,e.push(c.objectBy(g,m)),e.push(c.objectBy(g,n)),!0}if(a.$lt||a.$lte)return!1;if((a.$gt||a.$gte)&&(a.$gt||a.$gte)>(h.$gt||h.$gte))return!1;l[h.$gt?"$lte":"$lt"]=h.$gt||h.$gte}else{if(!h.$lt&&!h.$lte)return!1;if(a.$gt||a.$gte)return!1;if((a.$lt||a.$lte)&&(a.$lt||a.$lte)<(h.$lt||h.$lte))return!1;l[h.$lt?"$gte":"$gt"]=h.$lt||h.$lte}f[g]=l})&&(e.length>0&&(f.$or=f.$or?f.$or.concat(e):e),f)},subsumizes:function(b,c){if(!a.is_object(b)||!a.is_object)return b==c;for(var d in b)if(!(d in c&&this.subsumizes(b[d],c[d])))return!1;return!0},fullQueryCapabilities:function(){var a={};c.iter(this.SYNTAX_PAIR_KEYS,function(b,c){a[c]=!0});var b={};return c.iter(this.SYNTAX_CONDITION_KEYS,function(a,c){b[c]=!0}),{atom:!0,bool:a,conditions:b}},mergeConditions:function(b,d){a.is_object(b)||(b={$eq:b}),a.is_object(d)||(d={$eq:d});var e=!1,f=c.clone(b,1);return c.iter(d,function(a,b){if(e)return!1;if(b in f){var d=f[b];h.starts_with(b,"$eq")&&(e=!0),h.starts_with(b,"$in")&&(d=c.objectify(d),f[b]=[],e=!0,c.iter(a,function(a){d[a]&&(f[b].push(a),e=!1)})),h.starts_with(b,"$sw")&&(h.starts_with(d,a)?f[b]=a:h.starts_with(a,d)||(e=!0)),h.starts_with(b,"$gt")&&i.byValue(d,a)<0&&(f[b]=a),h.starts_with(b,"$lt")&&i.byValue(d,a)>0&&(f[b]=a)}else f[b]=a},this),e&&(f={$in:[]}),f},disjunctiveNormalForm:function(a,b){a=c.clone(a,1);var d=[];if(a.$or){var e=[];c.iter(a.$or,function(a){c.iter(this.disjunctiveNormalForm(a,b).$or,function(a){e.push(a)},this)},this),d.push(e),delete a.$or}a.$and&&(c.iter(a.$and,function(a){var e=[];c.iter(this.disjunctiveNormalForm(a,b).$or,function(a){e.push(a)},this),d.push(e)},this),delete a.$and);var f=[],g=function(a,e){e<d.length?c.iter(d[e],function(d){var f=c.clone(a,1);c.iter(d,function(a,d){d in f?b?f[d]=this.mergeConditions(f[d],a):(f.$and||(f.$and=[]),f.$and.push(c.objectBy(d,a))):f[d]=a},this),g(f,e+1)},this):f.push(a)};return g(a,0),{$or:f}},simplifyQuery:function(b){var d={};return c.iter(b,function(b,e){if(e in this.SYNTAX_PAIR_KEYS){var f=[],g=!1;c.iter(b,function(b){var c=this.simplifyQuery(b);a.is_empty(c)?g=!0:f.push(c)},this),("$and"===e&&f.length>0||"$or"===e&&!g)&&(d[e]=f)}else if(a.is_object(b)&&null!==b){var h=this.simplifyConditions(b);a.is_empty(h)||(d[e]=h)}else d[e]=b},this),d},simplifiedDNF:function(b,c){return b=this.simplifyQuery(this.disjunctiveNormalForm(b,!0)),a.is_empty(b)?{$or:[{}]}:b},simplifyConditions:function(a){var b={};return c.iter(["","ic"],function(d){if(a["$eq"+d]||a["$in"+d]){var e=c.filter(a["$eq"+d]?[a["$eq"+d]]:a["$in"+d],function(b){return this.evaluate_conditions(a,b)},this);b[(1===e.length?"$eq":"$in")+d]=1===e.length?e[0]:e}else{var f=null,g=null,h=!1,j=!1,k=i.byValue;if(a["$gt"+d]&&(f=a["$gt"+d]),a["$lt"+d]&&(f=a["$lt"+d]),a["$gte"+d]&&(null===f||k(f,a["$gte"+d])<0)&&(j=!0,f=a["$gte"+d]),a["$lte"+d]&&(null===g||k(g,a["$lte"+d])>0)&&(h=!0,g=a["$lte"+d]),a["$sw"+d]){var l=a["$sw"+d];(null===f||k(f,l)<=0)&&(j=!0,f=l);var m=null;"number"==typeof l?m=l+1:"string"==typeof l&&l.length>0&&(m=l.substring(0,l.length-1)+String.fromCharCode(l.charCodeAt(l.length-1)+1)),null!==m&&(null===g||k(g,m)>=0)&&(h=!0,g=m)}null!==g&&(b[(h?"$lte":"$lt")+d]=g),null!==f&&(b[(j?"$gte":"$gt")+d]=f),a["$ct"+d]&&(b["$ct"+d]=a["$ct"+d])}},this),b},mapKeyValue:function(a,b,c){return this.mapKeyValueQuery(a,b,c)},mapKeyValueQuery:function(a,b,d){var e={};return c.iter(a,function(a,f){e=c.extend(e,this.mapKeyValuePair(a,f,b,d))},this),e},mapKeyValueQueries:function(a,b,d){return c.map(a,function(a){return this.mapKeyValueQuery(a,b,d)},this)},mapKeyValuePair:function(a,b,d,e){if(b in this.SYNTAX_PAIR_KEYS)return c.objectBy(b,this.mapKeyValueQueries(a,d,e));if(this.is_query_atom(a))return d.call(e,b,a);var f={};return c.iter(a,function(a,c){f[c]=this.mapKeyValueCondition(a,b,d,e)},this),c.objectBy(b,f)},mapKeyValueCondition:function(b,d,e,f){var g=a.is_array(b);g||(b=[b]);var h=c.map(b,function(a){return c.peek(e.call(f,d,a))},this);return g?h:h[0]},queryDeterminedByAttrs:function(a,b,d){return c.exists(a,function(a,e){return"$and"===e?c.exists(a,function(a){return this.queryDeterminedByAttrs(a,b,d)},this):"$or"===e?c.all(a,function(a){return this.queryDeterminedByAttrs(a,b,d)},this):e in b&&(!d||b[e]!==a)},this)}}}),a.extend("module:Queries.AbstractQueryBuilder",["base:Class","base:Comparators","base:Events.EventsMixin","base:Objs"],function(a,b,c,d,e){return a.extend({scoped:e},[c,function(a){return{constructor:function(){a.constructor.call(this),this.__query={}},_queryChanged:function(){var a=this._buildQuery();b.deepEqual(this.__query,a)||(this.__query=a,this.trigger("change"))},getQuery:function(){return d.clone(this.__query,1)},_buildQuery:function(){throw"Not implemented"}}}])}),a.extend("module:Queries.SimpleQueryBuilder",["module:Queries.AbstractQueryBuilder"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b,c,d){a.constructor.call(this),this.__queryMap=c,this.__queryCtx=d,this.__userQuery=null,this.setQuery(b)},setQuery:function(a){this.__userQuery=a?this.__queryMap?this.__queryMap.call(this.__queryCtx||this,a):a:{},this._queryChanged()},_buildQuery:function(){return this.__userQuery}}})}),a.extend("module:Queries.AndQueryBuilder",["module:Queries.AbstractQueryBuilder","base:Objs","base:Types"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(){a.constructor.call(this),this.__queries={}},destroy:function(){b.iter(this.__queries,this.removeQuery,this),a.destroy.call(this)},addQuery:function(a){return this.__queries[a.cid()]=a,a.on("change",this._queryChanged,this),this._queryChanged(),a},removeQuery:function(a){return delete this.__queries[a.cid()],a.off(null,null,this),this._queryChanged(),a},_buildQuery:function(){var a=b.values(this.__queries).map(function(a){return a.getQuery()}).filter(function(a){return!c.is_empty(a)});switch(a.length){case 0:return{};case 1:return a[0];default:return{$and:a}}}}})}),a.extend("module:Queries.ConstrainedQueryBuilder",["base:Class","base:Comparators","base:Events.EventsMixin"],function(a,b,c,d){return a.extend({scoped:d},[c,function(a){return{constructor:function(b,c){a.constructor.call(this),this.__queryBuilder=b,this.__options=c||{},this.__queryBuilder.on("change",function(){this.trigger("change")},this)},destroy:function(){this.__queryBuilder.off(null,null,this),a.destroy.call(this)},getOptions:function(){return this.__options},setOptions:function(a){a=a||{},b.deepEqual(a,this.__options)||(this.__options=a,this.trigger("change"))},getQuery:function(){return this.getQueryBuilder().getQuery()},getQueryBuilder:function(){return this.__queryBuilder},getConstrainedQuery:function(){return{query:this.getQuery(),options:this.getOptions()}}}}])}),a.extend("module:Queries.RangeQueryBuilder",["module:Queries.AbstractQueryBuilder","base:Objs"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(b,c,d){a.constructor.call(this),this.__key=b,this.__lowerBound=c,this.__upperBound=d,this._queryChanged()},_buildQuery:function(){return b.objectBy(this.__key,{$gte:this.__lowerBound,$lte:this.__upperBound})},touch:function(a,b){b=b||a;var c=!1;a<this.__lowerBound&&(c=!0,this.__lowerBound=a),b>this.__upperBound&&(c=!0,this.__upperBound=b),c&&this._queryChanged()},setLowerBound:function(a){this.__lowerBound=a,this._queryChanged()},setUpperBound:function(a){this.__upperBound=a,this._queryChanged()}}})}),a.define("module:Queries.Engine",["module:Queries","module:Queries.Constrained","base:Strings","base:Types","base:Objs","base:Promise","base:Comparators","base:Iterators.SkipIterator","base:Iterators.LimitIterator","base:Iterators.SortedIterator","base:Iterators.FilteredIterator","base:Iterators.SortedOrIterator","base:Iterators.PartiallySortedIterator","base:Iterators.ArrayIterator","base:Iterators.LazyMultiArrayIterator"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){return{indexQueryConditionsSize:function(a,b,c){var d=c?"ic":"",e=c?"_ic":"",f=b.info(),g=f.row_count,h=f.row_count/Math.max(f["key_count"+e],1);if(a["$eq"+d])g=h;else if(a["$in"+d])g=h*a["$in"+d].length;else{var i=0,j=null;(a["$gt"+d]||a["$gte"+d])&&(j=a["$gt"+d]||a["$gte"+d],a["$gt"+d]&&i--);var k=null;(a["$lt"+d]||a["$lte"+d])&&(k=a["$lt"+d]||a["$lte"+d],a["$lt"+d]&&i--),null!==j&&null!==k?i+=b["key_count_distance"+e](j,k):null!==j?i+=b["key_count_right"+e](j):null!==k&&(i+=b["key_count_left"+e](k)),g=i*h}return g},indexQuerySize:function(a,b,c){var d=0,f=c.info();return e.iter(a.$or,function(a){if(!(b in a))return d=null,!1;var e=a[b],g=f.row_count;c.options().exact&&(g=Math.min(g,this.indexQueryConditionsSize(e,c,!1))),c.options().ignoreCase&&(g=Math.min(g,this.indexQueryConditionsSize(e,c,!0))),d+=g},this),d},queryPartially:function(a,c){var d={query:a.query,options:{}};if(a.options.sort){var f=e.ithKey(a.options.sort,0);d.options.sort={},d.options.sort[f]=a.options.sort[f]}return b.validate(d,c)},compileQuery:function(c,d,e,f){c=b.rectify(c);var l=b.sortValidate(c.options,d),m=a.validate(c.query,d.query||{}),n=b.skipValidate(c.options,d),o=b.limitValidate(c.options,d),p={skip:null,limit:null,filter:null,sort:null};return m&&l&&n||(p.skip=c.options.skip,delete c.options.skip,"limit"in c.options&&o&&m&&l&&(c.options.limit+=p.skip)),m&&l&&o||(p.limit=c.options.limit,delete c.options.limit),l||(p.sort=c.options.sort,delete c.options.sort),m||(p.filter=c.query,c.query={}),e.call(f,c).mapSuccess(function(b){return b=this._queryResultRectify(b,!1),p.filter&&(b=new k(b,function(b){return a.evaluate(p.filter,b)}).auto_destroy(b,!0)),p.sort&&(b=new j(b,g.byObject(p.sort)).auto_destroy(b,!0)),p.skip&&(b=new h(b,p.skip).auto_destroy(b,!0)),p.limit&&(b=new i(b,p.limit).auto_destroy(b,!0)),b},this)},compileIndexQuery:function(b,c,p){var q,r=e.exists(b.query.$or,function(a){return!(c in a)}),s=b.options.sort&&e.ithKey(b.options.sort,0)===c,t=s?b.options.sort[c]:1,u=!p.options().exact;if(r){var v=[];p["itemIterate"+(u?"_ic":"")](null,t,function(a,b){v.push(b)}),q=new n(v)}else q=new l(e.map(b.query.$or,function(a){var b,e=a[c];!s&&p.options().ignoreCase&&p.options().exact&&this.indexQueryConditionsSize(e,p,!0)<this.indexQueryConditionsSize(e,p,!1)&&(u=!0);var f=u?"ic":"",g=u?"_ic":"";if(e["$eq"+f]||!d.is_object(e)){var h=[],i=d.is_object(e)?e["$eq"+f]:e;p["itemIterate"+g](i,t,function(a,b){if(a!==i)return!1;h.push(b)}),b=new n(h)}else if(e["$in"+f]){var j=0;b=new o(function(){if(j>=e["$in"+f].length)return null;var a=[];return p["itemIterate"+g](e["$in"+f][j],t,function(b,c){if(b!==e["in"+f][j])return!1;a.push(c)}),j++,a})}else{var k=null,l=null;if((e["$gt"+f]||e["$gte"+f])&&(k=e["$gt"+f]||e["$gte"+f]),(e["$lt"+f]||e["$lte"+f])&&(l=e["$lt"+f]||e["$lte"+f]),t<0){var m=k;k=l,l=m}b=new o(function(){if(null!==k&&null!==l&&Math.sign(p.comparator()(k,l))===Math.sign(t))return null;var a=[];return p["itemIterate"+g](k,t,function(b,c){if(null===k&&(k=b),b!==k)return k=b,!1;a.push(c)}),a})}return b},this),p.comparator());return q=new k(q,function(c){return a.evaluate(b.query,c)}).auto_destroy(q,!0),b.options.sort&&(q=s?new m(q,g.byObject(b.options.sort),function(a,b){return a[c]===b[c]}).auto_destroy(q,!0):new j(q,g.byObject(b.options.sort)).auto_destroy(q,!0)),b.options.skip&&(q=new h(q,b.options.skip).auto_destroy(q,!0)),b.options.limit&&(q=new i(q,b.options.limit).auto_destroy(q,!0)),f.value(q)},compileIndexedQuery:function(c,f,g,h,i){if(c=b.rectify(c),i=i||{},this.queryPartially(c,f)||d.is_empty(i))return this.compileQuery(c,f,g,h);var j=a.simplifiedDNF(c.query,!0);if(c.options.sort){var k=e.ithKey(c.options.sort,0);if(i[k])return this.compileIndexQuery({query:j,options:c.options},k,i[k])}var l=null,m=null;return e.iter(i,function(a,b){var c=this.indexQuerySize(j,b,a);null!==c&&(null===l||c<l)&&(l=c,m=b)},this),null!==m?this.compileIndexQuery({query:j,options:c.options},m,i[m]):this.compileQuery(c,f,g,h)},_queryResultRectify:function(a,b){return a=a||[],d.is_array(a)==b?a:b?a.asArray():new n(a)}}}),a.define("module:Stores.AssocStore",["module:Stores.BaseStore","base:Promise","base:Objs"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{_read_key:function(a){},_write_key:function(a,b){},_remove_key:function(a){},_iterate:function(){},constructor:function(b){b=b||{},b.create_ids=!0,a.constructor.call(this,b)},_insert:function(a){return b.tryCatch(function(){return this._write_key(a[this._id_key],a),a},this)},_remove:function(a){return b.tryCatch(function(){var b=this._read_key(a);return b&&!this._remove_key(a)?null:b},this)},_get:function(a){return b.tryCatch(function(){return this._read_key(a)},this)},_update:function(a,d){return b.tryCatch(function(){var b=this._read_key(a);return b&&(this._id_key in d&&(this._remove_key(a),a=d[this._id_key],delete d[this._id_key]),c.extend(b,d),this._write_key(a,b)),b},this)},_query:function(a,c){return b.tryCatch(function(){return this._iterate()},this)}}})}),a.define("module:Stores.MemoryMapStore",["module:Stores.AssocStore","base:Iterators.FilteredIterator","base:Iterators.NativeMapIterator","base:Objs"],function(a,b,c,d,e){return a.extend({scoped:e},function(a){return{constructor:function(b){a.constructor.call(this,b),this.__map=new Map},_read_key:function(a){return this.__map.get(a+"")},_write_key:function(a,b){this.__map.set(a+"",b)},_remove_key:function(a){this.__map["delete"](a+"")},_iterate:function(){var a=new c(this.__map);return new b(a,function(a){return!!a}).auto_destroy(a,!0)},_count:function(b){return b?a._count.call(this,b):this.__map.size}}})}),a.define("module:Stores.MemoryStore",["module:Stores.AssocStore","base:Iterators.FilteredIterator","base:Iterators.ArrayIterator","base:Objs","base:Promise"],function(a,b,c,d,e,f){return a.extend({scoped:f},function(a){return{constructor:function(b){a.constructor.call(this,b),this.__dataByIndex=[null],this.__indexById={},this.__count=0},_read_key:function(a){var b=this.__indexById[a];return b?this.__dataByIndex[b]:undefined},_write_key:function(a,b){var c=this.__indexById[a];c||(c=this.__dataByIndex.length,this.__indexById[a]=c,this.__count++),this.__dataByIndex[c]=b},_remove_key:function(a){var b=this.__indexById[a];b&&(delete this.__indexById[a],delete this.__dataByIndex[b],this.__count--)},_iterate:function(){var a=new c(this.__dataByIndex);return new b(a,function(a){return!!a}).auto_destroy(a,!0)},_count:function(b){return b?a._count.call(this,b):e.value(this.__count)}}})}),a.define("module:Stores.BaseStore",["base:Class","base:Events.EventsMixin","module:Stores.ReadStoreMixin","module:Stores.WriteStoreMixin","base:Promise","base:Objs","module:Stores.MemoryIndex"],function(a,b,c,d,e,f,g,h){return a.extend({scoped:h},[b,c,d,function(a){return{constructor:function(b){a.constructor.call(this),this._initializeReadStore(b),this._initializeWriteStore(b)},_ensure_index:function(a){a in this.indices||(this.indices[a]=new g(this,a))},ensure_index:function(a){return this._ensure_index(a)},getBy:function(a,b,c){return a===this.id_key()?this.get(b,c):this.query(f.objectBy(a,b),{limit:1}).mapSuccess(function(a){var b=a.next();return a.destroy(),b})},clear:function(a){return this.query(null,null,a).mapSuccess(function(b){for(var c=e.and();b.hasNext();){var d=b.next();c=c.and(this.remove(d[this._id_key],a))}return b.destroy(),c},this)}}}])}),a.define("module:Stores.ReadStoreMixin",["module:Queries.Engine","module:Stores.StoreException","base:Promise","base:Objs"],function(a,b,c,d){return{_initializeReadStore:function(a){a=a||{},this.indices={},this._watcher=a.watcher||null,this._capabilities=a.capabilities||{}},watcher:function(){return this._watcher},_get:function(a,d){return c.create(null,new b("unsupported: get"))},_query_capabilities:function(){return this._capabilities},_query:function(a,d,e){return c.create(null,new b("unsupported: query"))},get:function(a,b){return this._get(a,b)},count:function(a,b){return this._count(a,b)},_count:function(a,b){return this.query(a,{},b).mapSuccess(function(a){return a.asArray().length})},query:function(b,c,e){return b=d.clone(b||{},-1),c=d.clone(c,-1),c&&(c.limit&&(c.limit=parseInt(c.limit,10)),c.skip&&(c.skip=parseInt(c.skip,10))),a.compileIndexedQuery({query:b,options:c||{}},this._query_capabilities(),function(a){return this._query(a.query,a.options,e)},this,this.indices)},findBy:function(a,b){return this.query(a,{limit:1},b).mapSuccess(function(a){return a.next()})},serialize:function(a){return this.query({},{},a).mapSuccess(function(a){return a.asArray()})}}}),a.define("module:Stores.ReadStore",["base:Class","module:Stores.ReadStoreMixin"],function(a,b,c){return a.extend({scoped:c},[b,function(a){return{constructor:function(b){a.constructor.call(this),this._initializeReadStore(b)}}}])}),a.define("module:Stores.StoreException",["base:Exceptions.Exception"],function(a,b){return a.extend({scoped:b},{})}),a.define("module:Stores.StoreHistory",["base:Class","base:Events.EventsMixin","base:Objs","base:Types","module:Stores.MemoryStore"],function(a,b,c,d,e,f){return a.extend({scoped:f},[b,function(a){return{constructor:function(b,d,f){a.constructor.call(this),this._options=c.extend({combine_update_update:!1,combine_insert_update:!1,combine_insert_remove:!1,combine_update_remove:!1,source_id_key:b?b.id_key():"id",row_data:{},filter_data:{}},f),this.historyStore=d||this.auto_destroy(new e),this.sourceStore=b,this.commitId=1,b&&(b.on("insert",this.sourceInsert,this),b.on("remove",this.sourceRemove,this),b.on("update",this.sourceUpdate,this))},lockCommits:function(){this.lockedCommits=this.commitId},unlockCommits:function(){delete this.lockedCommits},sourceInsert:function(a){return this.commitId++,this.historyStore.insert(c.extend({row:a,type:"insert",row_id:a[this._options.source_id_key],commit_id:this.commitId},this._options.row_data)),this.trigger("insert",this.commitId),this.commitId},sourceUpdate:function(a,b,e,f){this.commitId++;var g=d.is_object(a)?a[this._options.source_id_key]:a,h="update";if(this._options.combine_insert_update||this._options.combine_update_update){var i=[];this._options.combine_insert_update&&i.push({type:"insert"}),this._options.combine_update_update&&i.push({type:"update"});var j={},k=[],l=c.extend({row_id:g},this._options.filter_data);this.lockedCommits&&(l.commit_id={$gt:this.lockedCommits}),1===i.length?l.type=i[0]:l.$or=i;for(var m=this.historyStore.query(l,{sort:{commit_id:1}}).value();m.hasNext();){var n=m.next();"insert"===n.type&&(h="insert"),j=c.extend(j,n.row),k.push(this.historyStore.id_of(n))}m.destroy(),b=c.extend(j,b),c.iter(k,this.historyStore.remove,this.historyStore)}return this.historyStore.insert(c.extend({row:b,pre_data:f,type:h,row_id:g,commit_id:this.commitId},this._options.row_data)),this.trigger("update",this.commitId),this.trigger("update:"+g,this.commitId),this.commitId},sourceRemove:function(a,b){if(this.commitId++,this._options.combine_insert_remove&&this.historyStore.query(c.extend({type:"insert",row_id:a},this._options.filter_data)).value().hasNext()){for(var d=this.historyStore.query(c.extend({row_id:a},this._options.filter_data)).value();d.hasNext();)this.historyStore.remove(this.historyStore.id_of(d.next()));return void d.destroy()}if(this._options.combine_update_remove){for(var e=this.historyStore.query(c.extend({type:"update",row_id:a},this._options.filter_data)).value();e.hasNext();)this.historyStore.remove(this.historyStore.id_of(e.next()));e.destroy()}return this.historyStore.insert(c.extend({type:"remove",row_id:a,row:b,commit_id:this.commitId},this._options.row_data)),this.trigger("remove",this.commitId),this.trigger("remove:"+a,this.commitId),this.commitId},getCommitById:function(a){return this.historyStore.query({commit_id:a},{limit:1}).mapSuccess(function(a){var b=a.next();return a.destroy(),b})},undoCommit:function(a){return"insert"===a.type?this.sourceStore.remove(a.row_id):"remove"===a.type?this.sourceStore.insert(a.row):"update"===a.type?this.sourceStore.update(a.row_id,a.pre_data||{}):void 0},undoCommitById:function(a){return this.getCommitById(a).mapSuccess(function(a){return this.undoCommit(a).success(function(){this.historyStore.remove(this.historyStore.id_of(a))},this)},this)}}}])}),a.define("module:Stores.WriteStoreMixin",["module:Stores.StoreException","base:Promise","base:IdGenerators.TimedIdGenerator","base:Types"],function(a,b,c,d){return{_initializeWriteStore:function(a){a=a||{},this._id_key=a.id_key||"id",this._create_ids=a.create_ids||!1,this._validate_ids=a.validate_ids||!1,this._id_lock=a.id_lock||!1,this.preserve_preupdate_data=a.preserve_preupdate_data||!1,this._create_ids&&(this._id_generator=a.id_generator||this._auto_destroy(new c)),this._validate_ids&&(this._id_validator=a.id_validator||this._id_generator)},id_key:function(){return this._id_key},id_of:function(a){return a[this.id_key()]},id_row:function(a){var b={};return b[this._id_key]=a,b},_inserted:function(a,b){this.trigger("insert",a,b),this.trigger("write","insert",a,b)},_removed:function(a,b,c){this.trigger("remove",a,b,c),this.trigger("write","remove",a,b,c)},_updated:function(a,b,c,d){this.trigger("update",a,b,c,d),this.trigger("write","update",a,b,c,d)},insert_all:function(a,c){var d=b.and();return(a||[]).forEach(function(a){d=d.and(this.insert(a,c))},this),d.end()},_insert:function(c,d){return b.create(null,new a("unsupported: insert"))},_remove:function(c,d){return b.create(null,new a("unsupported: remove"))},_update:function(c,d,e){return b.create(null,new a("unsupported: update"))},insert:function(c,d){return c?this._id_key in c&&c[this._id_key]&&this._id_lock?b.create(null,new a("id lock")):(!this._create_ids||this._id_key in c&&c[this._id_key]||(c[this._id_key]=this._id_generator.generate(d)),this._id_validator&&this._id_key in c&&c[this._id_key]&&!this._id_validator.valid(c[this._id_key],d)?b.create(null,new a("invalid id")):this._insert(c,d).success(function(a){this._inserted(a,d)},this)):b.create(null,new a("empty insert"))},remove:function(a,b){return this._remove(a,b).success(function(c){this._removed(a,b,c)},this)},update:function(a,b,c){return this.preserve_preupdate_data?this.get(a,c).mapSuccess(function(d){var e={};for(var f in b)e[f]=d[f];return this._update(a,b,c).success(function(a){this._updated(a,b,c,e)},this)},this):this._update(a,b,c).success(function(a){this._updated(a,b,c)},this)},unserialize:function(a,b){return this.insert_all(a,b)}}}),a.define("module:Stores.WriteStore",["base:Class","base:Events.EventsMixin","module:Stores.WriteStoreMixin"],function(a,b,c,d){return a.extend({scoped:d},[b,c,function(a){return{constructor:function(b){a.constructor.call(this),this._initializeWriteStore(b)},_ensure_index:function(a){},ensure_index:function(a){return this._ensure_index(a)}}}])}),a.define("module:Stores.AsyncStore",["module:Stores.BaseStore","base:Promise","base:Async"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(b,c){this.__store=b,c=c||{},c.id_key=b.id_key(),a.constructor.call(this,c),this.__time=c.time||0,c.destroy_store&&this._auto_destroy(b)},_query_capabilities:function(){return this.__store._query_capabilities()},__async:function(a,d){var e=b.create();return c.eventually(function(){a.apply(this.__store,d).forwardCallback(e)},this,this.__time),e},_insert:function(){return this.__async(this.__store.insert,arguments)},_remove:function(){return this.__async(this.__store.remove,arguments)},_get:function(){return this.__async(this.__store.get,arguments)},_update:function(){return this.__async(this.__store.update,arguments)},_query:function(){return this.__async(this.__store.query,arguments)},_ensure_index:function(a){return this.__store.ensure_index(a)},_store:function(){return this.__store}}})}),a.define("module:Stores.ConcatStore",["module:Stores.BaseStore"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b,c,d){this.__primary=b,this.__secondary=c,a.constructor.call(this,d)},_query_capabilities:function(){return this._primary()._query_capabilities()},_count:function(){return this._primary().count.apply(this._primary(),arguments).and(this._secondary().count.apply(this._secondary(),arguments)).mapSuccess(function(a){return a[0]+a[1]})},_insert:function(){var a=arguments;return this._primary().insert.apply(this._primary(),a).mapError(function(){return this._secondary().insert.apply(this._secondary(),a)},this)},_remove:function(){var a=arguments;return this._primary().remove.apply(this._primary(),a).mapError(function(){return this._secondary().remove.apply(this._secondary(),a)},this)},_get:function(){var a=arguments;return this._primary().get.apply(this._primary(),a).mapCallback(function(b,c){return c||this._secondary().get.apply(this._secondary(),a)},this)},_update:function(){var a=arguments;return this._primary().update.apply(this._primary(),a).mapError(function(){return this._secondary().update.apply(this._secondary(),a)},this)},_query:function(a,b,c){return b=b||{},this._primary().query(a,b,c).mapSuccess(function(d){return d=d.asArray(),b.limit&&d.length>=b.limit?d:(b.limit&&(b.limit-=d.length),this._secondary().query(a,b,c).mapSuccess(function(a){return d.concat(a.asArray())},this))},this)},_primary:function(){return this.__primary},_secondary:function(){return this.__secondary}}})}),a.define("module:Stores.ContextualizedStore",["module:Stores.BaseStore","base:Iterators.MappedIterator"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(b,c){this.__store=b,c=c||{},c.id_key=b.id_key(),this.__context=c.context||this,this.__decode=c.decode,this.__encode=c.encode,a.constructor.call(this,c),c.destroy_store&&this._auto_destroy(b)},_decode:function(a){return this.__decode.call(this.__context,a)},_encode:function(a,b){return this.__encode.call(this.__context,a,b)},_decodeId:function(a){var b=this._decode(this.id_row(a));return{id:this.id_of(b.data),ctx:b.ctx}},_query_capabilities:function(){return this.__store._query_capabilities()},_insert:function(a){var b=this._decode(a);return this.__store.insert(b.data,b.ctx).mapSuccess(function(a){return this._encode(a,b.ctx)},this)},_remove:function(a){var b=this._decodeId(a);return this.__store.remove(b.id,b.ctx).mapSuccess(function(){return a},this)},_get:function(a){var b=this._decodeId(a);return this.__store.get(b.id,b.ctx).mapSuccess(function(a){return this._encode(a,b.ctx)},this)},_update:function(a,b){var c=this._decodeId(a);this.__store.update(c.id,b,c.ctx).mapSuccess(function(a){return a},this)},_query:function(a,c){var d=this._decode(a);return this.__store.query(d.data,c,d.ctx).mapSuccess(function(a){return new b(a,function(a){return this._encode(a,d.ctx)},this).auto_destroy(a,!0)},this)},_ensure_index:function(a){return this.__store.ensure_index(a)},_store:function(){return this.__store}}})}),a.define("module:Stores.AbstractDecontextualizedStore",["module:Stores.BaseStore","base:Iterators.MappedIterator","base:Promise"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(b,c){this.__store=b,c=c||{},c.id_key=b.id_key(),a.constructor.call(this,c),c.destroy_store&&this._auto_destroy(b)},_query_capabilities:function(){return this.__store._query_capabilities()},_ensure_index:function(a){return this.__store.ensure_index(a)},_store:function(){return this.__store},_get:function(a,b){return this._rawGet(a,b).mapSuccess(function(a){return this._decodeRow(a,b)},this)},_rawQuery:function(a,b,c){return this.__store.query(this._encodeQuery(a,c),b)},_rawGet:function(a,b){return this._rawQuery(this.id_row(a),{limit:1},b).mapSuccess(function(a){var b=a.hasNext()?a.next():null;return a.destroy(),b},this)},_query:function(a,c,d){return this._rawQuery(a,c,d).mapSuccess(function(a){return new b(a,function(a){return this._decodeRow(a,d)},this).auto_destroy(a,!0)},this)},_insert:function(a,b){return c.value(this._encodeRow(a,b)).mapSuccess(function(a){return this.__store.insert(a).mapSuccess(function(a){return this._undecodedInserted(a,b),this._decodeRow(a,b)},this)},this)},_undecodedInserted:function(a,b){},_remove:function(a,b){return this._rawGet(a,b).mapSuccess(function(c){if(!c)return!0;var d=this._encodeRemove(a,c,b);return d?this.__store.update(a,d):this.__store.remove(a)},this)},_update:function(a,b,c){return this._rawGet(a,c).mapSuccess(function(d){if(!d)return!0;var e=this._encodeUpdate(a,b,c,d);return this.__store.update(a,e).mapSuccess(function(b){return this._undecodedUpdated(a,b,c,d),
this._decodeRow(b,c)},this)},this)},_undecodedUpdated:function(a,b,c){},_encodeRow:function(a,b){throw"Abstract"},_encodeQuery:function(a,b){throw"Abstract"},_decodeRow:function(a,b){throw"Abstract"},_encodeRemove:function(a,b,c){throw"Abstract"},_encodeUpdate:function(a,b,c,d){throw"Abstract"},_inserted:function(b,c){a._inserted.call(this,this._decodeRow(b,c),c)},_removed:function(b,c,d){a._removed.call(this,b,c,this._decodeRow(d,c))},_updated:function(b,c,d,e){a._updated.call(this,this._decodeRow(b,d),this._decodeRow(c,d),d,this._decodeRow(e,d))}}})}),a.define("module:Stores.DecontextualizedSelectStore",["module:Stores.AbstractDecontextualizedStore","base:Objs"],function(a,b,c){return a.extend({scoped:c},function(a){return{_encodeRow:function(a,c){return b.extend(b.clone(a,1),c)},_encodeQuery:function(a,c){return b.extend(b.clone(a,1),c)},_decodeRow:function(a,c){return a?(a=b.clone(a,1),b.iter(c,function(b,c){delete a[c]}),a):a},_encodeRemove:function(a,b,c){return!1},_encodeUpdate:function(a,b,c,d){return this._encodeRow(b,c)}}})}),a.define("module:Stores.DecontextualizedMultiAccessStore",["module:Stores.AbstractDecontextualizedStore","base:Objs","base:Promise","base:Types"],function(a,b,c,d,e){return a.extend({scoped:e},function(a){return{constructor:function(b,c){a.constructor.call(this,b,c),this.__contextKey=c.contextKey,this.__contextAttributes=c.contextAttributes||[],this.__contextAccessKey=c.contextAccessKey,this.__immediateRemove=c.immediateRemove,this.__contextAccessExpander=c.contextAccessExpander||function(){return[]},this.__contextDataCloner=c.contextDataCloner||function(a){var b={};return this.__contextAttributes.forEach(function(c){b[c]=a[c]},this),b},this.__contextDataUpdater=c.contextDataUpdater},_encodeQuery:function(a,c){return a=b.extend(b.objectBy(this.__contextAccessKey,{$elemMatch:{$eq:c[this.__contextKey]}}),a),this.__contextAttributes.forEach(function(b){b in a&&(a[b+"."+c[this.__contextKey]]=a[b],delete a[b],delete a[this.__contextAccessKey])},this),a},_encodeRemove:function(c,d,e){var f=e[this.__contextKey];if(this.__immediateRemove)return d[this.__contextAccessKey].forEach(function(b){b!==f&&a._removed.call(this,c,b,d)},this),!1;var g=d[this.__contextAccessKey].filter(function(a){return a!==f},this);if(0===g.length)return!1;var h=b.objectBy(this.__contextAccessKey,g);return this.__contextAttributes.forEach(function(a){h[a]=b.clone(d[a],1),delete h[a][f]},this),h},_decodeRow:function(a,c){if(!a)return a;a=b.clone(a,2);var d=c[this.__contextKey];return delete a[this.__contextAccessKey],this.__contextAttributes.forEach(function(b){a[b]&&(a[b]=a[b][d])},this),a},_encodeUpdate:function(a,c,d,e){c=b.clone(c,1);var f=d[this.__contextKey];return this.__contextAttributes.forEach(function(a){if(a in c){var b=c[a];c[a]=e[a],c[a][f]=b}},this),this.__contextDataUpdater&&(c=this.__contextDataUpdater(a,c,d,e)),c},_encodeRow:function(a,d){var e=d[this.__contextKey];a=b.clone(a,1);var f={};return a[this.__contextAccessKey]=[e],this.__contextAttributes.forEach(function(c){f[c]=a[c],a[c]=b.objectBy(e,f[c])},this),c.value(this.__contextAccessExpander.call(this,a,d)).mapSuccess(function(b){b=b.filter(function(a){return a!==e}),a[this.__contextAccessKey]=a[this.__contextAccessKey].concat(b);var f=b.map(function(b){return c.value(this.__contextDataCloner.call(this,a,d,b))},this);return c.and(f).mapSuccess(function(c){return b.forEach(function(b,d){var e=c[d];this.__contextAttributes.forEach(function(c){a[c][b]=e[c]},this)},this),a},this)},this)},_undecodedUpdated:function(a,c,d,e){e[this.__contextAccessKey].forEach(function(a){if(d[this.__contextKey]!=a){var f=b.objectBy(this.__contextKey,a);this._updated(e,c,f,e)}},this)},_undecodedInserted:function(a,c){a[this.__contextAccessKey].forEach(function(d){if(c[this.__contextKey]!=d){var e=b.objectBy(this.__contextKey,d);this._inserted(a,e)}},this)}}})}),a.define("module:Stores.KeyMapStore",["module:Stores.TransformationStore","base:Objs"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(c,d,e){a.constructor.call(this,c,d),this.__encodeMap=e,this.__decodeMap=b.inverseKeyValue(e)},__mapBy:function(a,c){var d={};return b.iter(a,function(a,b){d[c[b]||b]=a}),d},_encodeData:function(a){return this.__mapBy(a,this.__encodeMap)},_decodeData:function(a){return this.__mapBy(a,this.__decodeMap)}}})}),a.define("module:Stores.MultiplexerStore",["module:Stores.BaseStore","module:Queries.Constrained","base:Promise"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(b){a.constructor.call(this,b),this.__context=b.context||this,this.__acquireStore=b.acquireStore,this.__releaseStore=b.releaseStore,this.__mapContext=b.mapContext},_acquireStore:function(a){return c.value(this.__acquireStore?this.__acquireStore.call(this.__context,a):a)},_releaseStore:function(a,b){this.__releaseStore&&this.__releaseStore.call(this.__context,a,b)},_mapContext:function(a){return this.__mapContext?this.__mapContext.call(this.__context,a):null},_query_capabilities:function(){return b.fullConstrainedQueryCapabilities()},_insert:function(a,b){return this._acquireStore(b).mapSuccess(function(c){return c.insert(a,this._mapContext(b)).callback(function(){this._releaseStore(b,c)},this)},this)},_remove:function(a,b){return this._acquireStore(b).mapSuccess(function(c){return c.remove(a,this._mapContext(b)).callback(function(){this._releaseStore(b,c)},this)},this)},_update:function(a,b,c){return this._acquireStore(c).mapSuccess(function(d){return d.update(a,b,this._mapContext(c)).callback(function(){this._releaseStore(c,d)},this)},this)},_get:function(a,b){return this._acquireStore(b).mapSuccess(function(c){return c.get(a,this._mapContext(b)).callback(function(){this._releaseStore(b,c)},this)},this)},_query:function(a,b,c){return this._acquireStore(c).mapSuccess(function(d){return d.query(a,b,this._mapContext(c)).callback(function(){this._releaseStore(c,d)},this)},this)}}})}),a.define("module:Stores.PassthroughStore",["module:Stores.BaseStore","base:Promise"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(b,c){this.__store=b,c=c||{},c.id_key=c.id_key||b.id_key(),this.__preserves=c.preserves,a.constructor.call(this,c),c.destroy_store&&this._auto_destroy(b),this.delegateEvents(["insert","update","remove"],this.__store)},_query_capabilities:function(){return this.__store._query_capabilities()},_insert:function(a,b){return this._preInsert(a).mapSuccess(function(c){return this.__store.insert(c,b).mapSuccess(function(b){var c=this._postInsert(b);return this.__preserves?c.mapSuccess(function(b){return this.__preserves.forEach(function(c){c in a&&!(c in b)&&(b[c]=a[c])}),b},this):c},this)},this)},_remove:function(a,b){return this._preRemove(a).mapSuccess(function(a){return this.__store.remove(a,b).mapSuccess(function(){return this._postRemove(a)},this)},this)},_get:function(a,b){return this._preGet(a).mapSuccess(function(a){return this.__store.get(a,b).mapSuccess(function(a){return this._postGet(a)},this)},this)},_update:function(a,b,c){return this._preUpdate(a,b).mapSuccess(function(a){return this.__store.update(a.id,a.data,c).mapSuccess(function(a){return this._postUpdate(a)},this)},this)},_query:function(a,b,c){return this._preQuery(a,b).mapSuccess(function(a){return this.__store.query(a.query,a.options,c).mapSuccess(function(a){return this._postQuery(a)},this)},this)},unserialize:function(a){return this._preUnserialize(a).mapSuccess(function(a){return this.__store.unserialize(a).mapSuccess(function(a){return this._postUnserialize(a)},this)},this)},serialize:function(a){return this._preSerialize(a).mapSuccess(function(a){return this.__store.serialize(a).mapSuccess(function(a){return this._postSerialize(a)},this)},this)},_ensure_index:function(a){return this.__store.ensure_index(a)},_store:function(){return this.__store},_preInsert:function(a){return b.value(a)},_postInsert:function(a){return b.value(a)},_preRemove:function(a){return b.value(a)},_postRemove:function(a){return b.value(!0)},_preGet:function(a){return b.value(a)},_postGet:function(a){return b.value(a)},_preUpdate:function(a,c){return b.value({id:a,data:c})},_postUpdate:function(a){return b.value(a)},_preQuery:function(a,c){return b.value({query:a,options:c})},_postQuery:function(a){return b.value(a)},_preSerialize:function(a){return b.value(a)},_postSerialize:function(a){return b.value(a)},_preUnserialize:function(a){return b.value(a)},_postUnserialize:function(a){return b.value(a)},watcher:function(){return this.__store.watcher()}}})}),a.define("module:Stores.ReadyStore",["module:Stores.PassthroughStore","base:Promise","base:Objs"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{__ready:!1,ready:function(){this.__ready=!0,c.iter(this.__promises,function(a){a.promise.forwardCallback(a.stalling)}),delete this.__promises},__execute:function(a){if(this.__ready)return a;var c=b.create();return this.__promises=this.__promises||[],this.__promises.push({stalling:c,promise:a}),c},_preInsert:function(){return this.__execute(a._preInsert.apply(this,arguments))},_preRemove:function(){return this.__execute(a._preRemove.apply(this,arguments))},_preGet:function(){return this.__execute(a._preGet.apply(this,arguments))},_preUpdate:function(){return this.__execute(a._preUpdate.apply(this,arguments))},_preQuery:function(){return this.__execute(a._preQuery.apply(this,arguments))},_preSerialize:function(){return this.__execute(a._preSerialize.apply(this,arguments))},_preUnserialize:function(){return this.__execute(a._preUnserialize.apply(this,arguments))}}})}),a.define("module:Stores.ResilientStore",["module:Stores.BaseStore","base:Promise"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(b,c){this.__store=b,c=c||{},c.id_key=b.id_key(),a.constructor.call(this,c),this._resilience=c.resilience||10,c.destroy_store&&this._auto_destroy(b)},_query_capabilities:function(){return this.__store._query_capabilities()},_insert:function(){return b.resilientCall(this._store.insert,this._store,this._resilience,arguments)},_remove:function(){return b.resilientCall(this._store.remove,this._store,this._resilience,arguments)},_get:function(){return b.resilientCall(this._store.get,this._store,this._resilience,arguments)},_update:function(a,c){return b.resilientCall(this._store.update,this._store,this._resilience,arguments)},_query:function(a,c){return b.resilientCall(this._store.update,this._store,this._resilience,arguments)},_ensure_index:function(a){return this.__store.ensure_index(a)},_store:function(){return this.__store}}})}),a.define("module:Stores.SimulatorStore",["module:Stores.PassthroughStore","base:Promise"],function(a,b,c){return a.extend({scoped:c},function(a){return{online:!0,_preInsert:function(){return this.online?a._preInsert.apply(this,arguments):b.error("Offline")},_preRemove:function(){return this.online?a._preRemove.apply(this,arguments):b.error("Offline")},_preGet:function(){return this.online?a._preGet.apply(this,arguments):b.error("Offline")},_preUpdate:function(){return this.online?a._preUpdate.apply(this,arguments):b.error("Offline")},_preQuery:function(){return this.online?a._preQuery.apply(this,arguments):b.error("Offline")}}})}),a.define("module:Stores.TableStore",["module:Stores.BaseStore","base:Iterators.MappedIterator","module:Queries.Constrained"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(b,c){this.__table=b,c=c||{},c.id_key=b.primary_key(),a.constructor.call(this,c),this.__options={insertTags:c.insertTags||[],readTags:c.readTags||[],updateTags:c.updateTags||[]}},_query_capabilities:function(){return c.fullConstrainedQueryCapabilities()},_insert:function(a,b){var c=this.__table.newModel({},null,b);return c.setByTags(a,this.__options.insertTags),c.save().mapSuccess(function(){var a=c.asRecord(this.__options.readTags);return c.decreaseRef(),a},this)},_remove:function(a,b){return this.__table.findById(a,b).mapSuccess(function(a){if(!a)return a;a.remove();var b=a.asRecord(this.__options.readTags);return a.decreaseRef(),b},this)},_get:function(a,b){return this.__table.findById(a,b).mapSuccess(function(a){if(!a)return a;var b=a.asRecord(this.__options.readTags);return a.decreaseRef(),b},this)},_update:function(a,b,c){return this.__table.findById(a,c).mapSuccess(function(a){return a?(a.setByTags(b,this.__options.updateTags),a.save().mapSuccess(function(){var b=a.asRecord(this.__options.readTags);return a.decreaseRef(),b},this)):a},this)},_query:function(a,c,d){return this.__table.query(a,c,d).mapSuccess(function(a){return new b(a,function(a){var b=a.asRecord(this.__options.readTags);return a.decreaseRef(),b},this).auto_destroy(a,!0)},this)}}})}),a.define("module:Stores.TransformationStore",["module:Stores.PassthroughStore","module:Queries","base:Iterators.MappedIterator","base:Objs","base:Types","base:Promise"],function(a,b,c,d,e,f,g){return a.extend({scoped:g},function(a){return{_encodeData:function(a){return a},_decodeData:function(a){return a},_encodeSort:function(a){return this._encodeData(a)},_encodeId:function(a){return this._store().id_of(this._encodeData(d.objectBy(this.id_key(),a)))},_decodeId:function(a){return this.id_of(this._decodeData(d.objectBy(this._store().id_key(),a)))},_encodeQuery:function(a,c){var f=d.clone(c);return f.sort&&(f.sort=e.is_object(f.sort)?this._encodeSort(f.sort):{}),{query:b.mapKeyValue(a,function(a,b){return this._encodeData(d.objectBy(a,b))},this),options:f}},_preInsert:function(a){return f.create(this._encodeData(a))},_postInsert:function(a){return f.create(this._decodeData(a))},_preRemove:function(a){return f.create(this._encodeId(a))},_postRemove:function(a){return f.create(!0)},_preGet:function(a){return f.create(this._encodeId(a))},_postGet:function(a){return f.create(this._decodeData(a))},_preUpdate:function(a,b){return f.create({id:this._encodeId(a),data:this._encodeData(b)})},_postUpdate:function(a){return f.create(this._decodeData(a))},_preQuery:function(a,b){return f.create(this._encodeQuery(a,b))},_postQuery:function(a){return f.create(new c(a,function(a){return this._decodeData(a)},this).auto_destroy(a,!0))}}})}),a.define("module:Stores.AssocDumbStore",["module:Stores.DumbStore"],function(a,b){return a.extend({scoped:b},{_read_key:function(a){},_write_key:function(a,b){},_remove_key:function(a){},__read_id:function(a){var b=this._read_key(a);return b?parseInt(b,10):null},_read_last_id:function(){return this.__read_id("last_id")},_write_last_id:function(a){this._write_key("last_id",a)},_remove_last_id:function(){this._remove_key("last_id")},_read_first_id:function(){return this.__read_id("first_id")},_write_first_id:function(a){this._write_key("first_id",a)},_remove_first_id:function(){this._remove_key("first_id")},_read_item:function(a){return this._read_key("item_"+a)},_write_item:function(a,b){this._write_key("item_"+a,b)},_remove_item:function(a){this._remove_key("item_"+a)},_read_next_id:function(a){return this.__read_id("next_"+a)},_write_next_id:function(a,b){this._write_key("next_"+a,b)},_remove_next_id:function(a){this._remove_key("next_"+a)},_read_prev_id:function(a){return this.__read_id("prev_"+a)},_write_prev_id:function(a,b){this._write_key("prev_"+a,b)},_remove_prev_id:function(a){this._remove_key("prev_"+a)}})}),a.define("module:Stores.DumbStore",["module:Stores.BaseStore","base:Promise","base:Objs","base:Iterators.Iterator"],function(a,b,c,d,e){return a.extend({scoped:e},function(a){return{_read_last_id:function(){},_write_last_id:function(a){},_remove_last_id:function(){},_read_first_id:function(){},_write_first_id:function(a){},_remove_first_id:function(){},_read_item:function(a){},_write_item:function(a,b){},_remove_item:function(a){},_read_next_id:function(a){},_write_next_id:function(a,b){},_remove_next_id:function(a){},_read_prev_id:function(a){},_write_prev_id:function(a,b){},_remove_prev_id:function(a){},constructor:function(b){b=b||{},b.create_ids=!0,a.constructor.call(this,b)},_insert:function(a){return b.tryCatch(function(){var b=this._read_last_id(),c=a[this._id_key];return null!==b?(this._write_next_id(b,c),this._write_prev_id(c,b)):this._write_first_id(c),this._write_last_id(c),this._write_item(c,a),a},this)},_remove:function(a){return b.tryCatch(function(){var b=this._read_item(a);if(b){this._remove_item(a);var c=this._read_next_id(a),d=this._read_prev_id(a);null!==c?(this._remove_next_id(a),null!==d?(this._remove_prev_id(a),this._write_next_id(d,c),this._write_prev_id(c,d)):(this._remove_prev_id(c),this._write_first_id(c))):null!==d?(this._remove_next_id(d),this._write_last_id(d)):(this._remove_first_id(),this._remove_last_id())}return b},this)},_get:function(a){return b.tryCatch(function(){return this._read_item(a)},this)},_update:function(a,d){return b.tryCatch(function(){var b=this._get(a);return b&&(delete d[this._id_key],c.extend(b,d),this._write_item(a,b)),b},this)},_query:function(a,e){return b.tryCatch(function(){var b=new d,e=this,f=this._read_first_id();return c.extend(b,{__id:null===f?1:f,__store:e,__query:a,hasNext:function(){var a=this.__store._read_last_id();if(null===a)return!1;for(;this.__id<a&&!this.__store._read_item(this.__id);)this.__id++;return this.__id<=a},next:function(){if(this.hasNext()){var a=this.__store.get(this.__id);return this.__id==this.__store._read_last_id()?this.__id++:this.__id=this.__store._read_next_id(this.__id),a}return null}}),b},this)}}})}),a.define("module:Stores.LocalStore",["module:Stores.AssocDumbStore"],function(b,c){return b.extend({scoped:c},function(b){return{constructor:function(c){b.constructor.call(this,c),this.__prefix=c.prefix,this.__localStorage=a.getGlobal("localStorage")},__key:function(a){return this.__prefix+a},_read_key:function(a){try{return JSON.parse(this.__localStorage.getItem(this.__key(a)))}catch(b){return null}},_write_key:function(a,b){this.__localStorage.setItem(this.__key(a),JSON.stringify(b))},_remove_key:function(a){this.__localStorage.removeItem(this.__key(a))}}})}),a.define("module:Stores.Invokers.RestInvokeeAjaxInvoker",["base:Class","base:Net.Uri","base:Net.HttpHeader","module:Stores.Invokers.RestInvokee"],function(a,b,c,d,e){return a.extend({scoped:e},[d,function(a){return{constructor:function(b){a.constructor.call(this),this.__ajax=b},restInvoke:function(a,d,e,f){return this.__ajax.execute({method:a,data:e,uri:b.appendUriParams(d,f)}).mapError(function(a){return{error:a.status_code(),data:a.data?a.data():null,invalid:a.status_code()===c.HTTP_STATUS_PRECONDITION_FAILED}},this)}}}])}),a.define("module:Stores.Invokers.StoreInvokee",[],function(){return{storeInvoke:function(a,b,c){}}}),a.define("module:Stores.Invokers.RestInvokee",[],function(){return{restInvoke:function(a,b,c,d,e){}}}),a.define("module:Stores.Invokers.RouteredRestInvokee",[],function(){return{routeredRestInvoke:function(a,b,c,d,e){}}}),a.define("module:Stores.Invokers.AbstractInvokerStore",["module:Stores.BaseStore","module:Queries.Constrained"],function(a,b,c){return a.extend({scoped:c},function(a){return{_query_capabilities:function(){return b.fullConstrainedQueryCapabilities()},_invoke:function(a,b,c){throw"Abstract method invoke"},_insert:function(a,b){return this._invoke("insert",a,b)},_remove:function(a,b){return this._invoke("remove",a,b)},_get:function(a,b){return this._invoke("get",a,b)},_update:function(a,b,c){return this._invoke("update",{id:a,data:b},c)},_query:function(a,b,c){return this._invoke("query",{query:a,options:b},c)}}})}),a.define("module:Stores.Invokers.InvokerStore",["module:Stores.Invokers.AbstractInvokerStore"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b,c){a.constructor.call(this,c),this.__storeInvokee=b},_invoke:function(a,b,c){return this.__storeInvokee.storeInvoke(a,b,c)}}})}),a.define("module:Stores.Invokers.StoreInvokeeInvoker",["base:Class","module:Stores.Invokers.StoreInvokee"],function(a,b,c){return a.extend({scoped:c},[b,function(a){return{constructor:function(b){a.constructor.apply(this),this.__store=b},storeInvoke:function(a,b,c){return this["__"+a](b,c)},__insert:function(a,b){return this.__store.insert(a,b)},__remove:function(a,b){return this.__store.remove(a,b)},__get:function(a,b){return this.__store.get(a,b)},__update:function(a,b){return this.__store.update(a.id,a.data,b)},__query:function(a,b){return this.__store.query(a.query,a.options,b).mapSuccess(function(a){var b=a.asArray();return a.decreaseRef(),b})}}}])}),a.define("module:Stores.Invokers.StoreInvokeeRestInvoker",["base:Class","base:Objs","base:Types","module:Stores.Invokers.StoreInvokee"],function(a,b,c,d,e){return a.extend({scoped:e},[d,function(a){return{constructor:function(d,e){a.constructor.call(this),this.__restInvokee=d,this.__options=b.tree_extend({methodMap:{insert:"POST",get:"GET",remove:"DELETE",update:"PUT",query:"GET"},toMethod:null,dataMap:{insert:function(a,b){return a},update:function(a,b){return a.data}},toData:null,getMap:{query:function(a,d){var e={};return a.query&&!c.is_empty(a.query)&&(e.query=JSON.stringify(a.query)),e=b.extend(e,a.options),e.sort&&(e.sort=JSON.stringify(e.sort)),e}},toGet:null,baseURI:"/",uriMap:{get:function(a,b){return a},remove:function(a,b){return a},update:function(a,b){return a.id}},toURI:null,context:this},e)},storeInvoke:function(a,b,c){return this.__restInvokee.restInvoke(this._toMethod(a,b,c),this._toURI(a,b,c),this._toData(a,b,c),this._toGet(a,b,c))},_toMethod:function(a,b,c){var d=null;return this.__options.toMethod&&(d=this.__options.toMethod.call(this.__options.context,a,b,c)),d||this.__options.methodMap[a]},_toURI:function(a,b,d){var e=c.is_function(this.__options.baseURI)?this.__options.baseURI.call(this.__options.context,d):this.__options.baseURI;if(this.__options.toURI){var f=this.__options.toURI.call(this.__options.context,a,b,d);if(f)return e+f}return e+(a in this.__options.uriMap?c.is_function(this.__options.uriMap[a])?this.__options.uriMap[a].call(this.__options.context,b,d):this.__options.uriMap[a]:"")},_toData:function(a,b,c){var d=null;return this.__options.toData&&(d=this.__options.toData.call(this.__options.context,a,b,c)),d||(a in this.__options.dataMap?this.__options.dataMap[a].call(this.__options.context,b,c):null)},_toGet:function(a,b,c){var d=null;return this.__options.toGet&&(d=this.__options.toGet.call(this.__options.context,a,b,c)),d||(a in this.__options.getMap?this.__options.getMap[a].call(this.__options.context,b,c):null)}}}])}),a.define("module:Stores.Invokers.RouteredRestInvokeeStoreInvoker",["base:Class","base:Objs","base:Types","module:Stores.Invokers.RouteredRestInvokee"],function(a,b,c,d,e){return a.extend({scoped:e},[d,function(a){return{constructor:function(d,e){a.constructor.call(this),this.__storeInvokee=d,this.__options=b.tree_extend({dataMap:{insert:function(a,b,c,d,e){return c},update:function(a,b,c,d,e){return{id:b.id,data:c}},get:function(a,b,c,d,e){return b.id},remove:function(a,b,c,d,e){return b.id},query:function(a,d,e,f,g){var h={};try{f.query&&(h.query=JSON.parse(f.query))}catch(j){}var i=b.clone(f,1);delete i.query,c.is_empty(i)||(h.options=i);try{h.options.sort&&(h.options.sort=JSON.parse(h.options.sort))}catch(j){}return h}},toData:null,contextMap:{},toContext:function(a,b,c,d,e){return e},context:this},e)},routeredRestInvoke:function(a,b,c,d,e){return this.__storeInvokee.storeInvoke(a,this._toData(a,b,c,d,e),this._toContext(a,b,c,d,e))},_toData:function(a,b,c,d,e){var f=null;return this.__options.toData&&(f=this.__options.toData.call(this.__options.context,a,b,c,d,e)),f||(a in this.__options.dataMap?this.__options.dataMap[a].call(this.__options.context,a,b,c,d,e):null)},_toContext:function(a,b,c,d,e){var f=null;return this.__options.toContext&&(f=this.__options.toContext.call(this.__options.context,a,b,c,d,e)),f||(a in this.__options.contextMap?this.__options.contextMap[a].call(this.__options.context,a,b,c,d,e):null)}}}])}),a.define("module:Stores.Invokers.RestInvokeeStoreInvoker",["module:Stores.Invokers.RouteredRestInvokeeStoreInvoker","module:Stores.Invokers.RestInvokee","base:Router.RouteParser","base:Objs","base:Types"],function(a,b,c,d,e,f){return a.extend({scoped:f},[b,function(a){return{constructor:function(b,f){a.constructor.call(this,b,d.tree_extend({baseURI:"/",methodMap:{insert:"POST",get:"GET",remove:"DELETE",update:"PUT",query:"GET"},toMethod:null,uriMap:{get:"(id:.+)",remove:"(id:.+)",update:"(id:.+)"},toURI:null},f)),this.__routes={},d.iter(this.__options.methodMap,function(a,b){var c="",d=e.is_function(this.__options.baseURI)?this.__options.baseURI.call(this.__options.context):this.__options.baseURI;if(this.__options.toURI){var f=this.__options.toURI.call(this.__options.context,b);f&&(c=d+f)}c||(c=d+(b in this.__options.uriMap?e.is_function(this.__options.uriMap[b])?this.__options.uriMap[b].call(this.__options.context):this.__options.uriMap[b]:"")),this.__routes[b]=a+" "+c},this),this.__routeParser=this.auto_destroy(new c(this.__routes))},restInvoke:function(a,b,c,d,e){var f=this.__routeParser.parse(a+" "+b);return this.routeredRestInvoke(f.name,f.args,c,d,e)}}}])}),a.define("module:Stores.CachedStore",["module:Stores.BaseStore","module:Stores.MemoryStore","module:Queries","module:Queries.Constrained","module:Stores.CacheStrategies.ExpiryCacheStrategy","base:Promise","base:Objs","base:Types","base:Iterators.ArrayIterator","base:Iterators.MappedIterator","base:Timers.Timer"],function(a,b,c,d,e,f,g,h,i,j,k,l){return a.extend({scoped:l},function(a){return{constructor:function(c,d){a.constructor.call(this),this.remoteStore=c,this._options=g.extend({itemMetaKey:"meta",queryMetaKey:"meta",queryKey:"query",cacheKey:null,suppAttrs:{},optimisticRead:!1},d),this._online=!0,this.itemCache=this._options.itemCache||this.auto_destroy(new b({id_key:this._options.cacheKey||this.remoteStore.id_key()})),this._options.cacheKey=this.itemCache.id_key(),this._id_key=this.itemCache.id_key(),this._foreignKey=this.itemCache.id_key()!==this.remoteStore.id_key(),this.queryCache=this._options.queryCache||this.auto_destroy(new b),this.cacheStrategy=this._options.cacheStrategy||this.auto_destroy(new e),this._options.auto_cleanup&&this.auto_destroy(new k({fire:this.cleanup,context:this,start:!0,delay:this._options.auto_cleanup}))},_query_capabilities:function(){return d.fullConstrainedQueryCapabilities()},_insert:function(a,b){return this.cacheInsert(a,{lockItem:!0,silent:!0,refreshMeta:!1,accessMeta:!0},b)},_update:function(a,b,c){return this.cacheUpdate(a,b,{ignoreLock:!1,silent:!0,lockAttrs:!0,refreshMeta:!1,accessMeta:!0},c)},_remove:function(a,b){return this.cacheRemove(a,{ignoreLock:!0,silent:!0},b)},_get:function(a,b){return this.cacheGet(a,{silentInsert:!0,silentUpdate:!0,silentRemove:!0,refreshMeta:!0,accessMeta:!0},b)},_query:function(a,b,c){return this.cacheQuery(a,b,{silent:!0,queryRefreshMeta:!0,queryAccessMeta:!0,refreshMeta:!0,accessMeta:!0},c)},cacheInsert:function(a,b,c){var d={lockedItem:b.lockItem,lockedAttrs:{},refreshMeta:b.refreshMeta?this.cacheStrategy.itemRefreshMeta():null,accessMeta:b.accessMeta?this.cacheStrategy.itemAccessMeta():null};return this.itemCache.insert(this.addItemSupp(this.addItemMeta(a,d)),c).mapSuccess(function(d){return a=this.removeItemMeta(d),b.silent||this._inserted(a,c),a},this)},cacheUpdate:function(a,b,c,d){return(c.foreignKey&&this._foreignKey?this.itemCache.getBy(this.remoteStore.id_key(),a,d):this.itemCache.get(a,d)).mapSuccess(function(a){if(!a)return null;var e=this.readItemMeta(a);return c.unlockItem&&(e.lockedItem=!1,e.lockedAttrs={}),b=g.filter(b,function(b,d){return(c.ignoreLock||!e.lockedItem&&!e.lockedAttrs[d])&&(!(d in a)||a[d]!=b)},this),c.lockAttrs&&g.iter(b,function(a,b){e.lockedAttrs[b]=!0},this),c.refreshMeta&&(e.refreshMeta=this.cacheStrategy.itemRefreshMeta(e.refreshMeta)),c.accessMeta&&(e.accessMeta=this.cacheStrategy.itemAccessMeta(e.accessMeta)),this.itemCache.update(this.itemCache.id_of(a),this.addItemMeta(b,e),d).mapSuccess(function(a){return a=this.removeItemMeta(a),c.silent||this._updated(a,b,d),a},this)},this)},cacheInsertUpdate:function(a,b,c){return(b.foreignKey&&this._foreignKey?this.itemCache.getBy(this.remoteStore.id_key(),this.remoteStore.id_of(a),c):this.itemCache.get(this.itemCache.id_of(a),c)).mapSuccess(function(d){if(b.foreignKey=!1,!d)return this.cacheInsert(a,b,c);var e=g.clone(a,1),f=this.itemCache.id_of(d);return e[this.itemCache.id_key()]=f,this.cacheUpdate(f,a,b,c).mapSuccess(function(a){return g.extend(e,a)})},this)},cacheRemove:function(a,b,c){return(b.foreignKey&&this._foreignKey?this.itemCache.getBy(this.remoteStore.id_key(),a,c):this.itemCache.get(a,c)).mapSuccess(function(a){if(!a)return a;var d=this.readItemMeta(a);if(!b.ignoreLock&&(d.lockedItem||!h.is_empty(d.lockedAttrs)))return f.error("locked item");var e=this.itemCache.id_of(a);return this.itemCache.remove(e,c).mapSuccess(function(){return b.silent||this._removed(e,c,a),a},this)},this)},cacheOnlyGet:function(a,b,c){return b=b||{},b.foreignKey&&this._foreignKey?this.itemCache.getBy(this.remoteStore.id_key(),a,c):this.itemCache.get(a,c)},cacheGet:function(a,b,c){var d=b.foreignKey&&this._foreignKey;return this.cacheOnlyGet(a,b,c).mapSuccess(function(e){if(!e)return!d&&this._foreignKey?e:this.remoteStore.get(a,c).mapSuccess(function(a){return this.online(),a?this.cacheInsert(a,{lockItem:!1,silent:b.silentInsert,accessMeta:!0,refreshMeta:!0},c):a},this);var g=this.readItemMeta(e),h=this.itemCache.id_of(e),i=this.remoteStore.id_of(e);return this.cacheStrategy.validItemRefreshMeta(g.refreshMeta)||g.lockedItem?(b.accessMeta&&(g.accessMeta=this.cacheStrategy.itemAccessMeta(g.accessMeta),this.itemCache.update(h,this.addItemMeta({},g),c)),this.removeItemMeta(e)):this.remoteStore.get(i,c).mapSuccess(function(a){return this.online(),a?this.cacheUpdate(h,a,{ignoreLock:!1,lockAttrs:!1,silent:b.silentUpdate,accessMeta:!0,refreshMeta:!0},c):this.cacheRemove(h,{ignoreLock:!1,silent:b.silentRemove},c)},this).mapError(function(){return this.offline(),f.value(e)},this)},this)},__itemCacheQuery:function(a,b,c){return this.itemCache.query(a,b,c).mapSuccess(function(a){a=a.asArray(),g.iter(a,function(a){this.cacheUpdate(this.itemCache.id_of(a),{},{lockItem:!1,lockAttrs:!1,silent:!0,accessMeta:b.accessMeta,refreshMeta:!1},c)},this);var d=new i(a);return new j(d,this.removeItemMeta,this).auto_destroy(d,!0)},this)},cacheQuery:function(a,b,e,h){var k=d.serialize({query:a,options:b}),l=g.objectBy(this._options.queryKey,k);return this.queryCache.query(l,{limit:1},h).mapSuccess(function(d){var l=d.hasNext()?d.next():null;if(d.destroy(),l){var m=this.readQueryMeta(l),n=this.queryCache.id_of(l);if(this.cacheStrategy.validQueryRefreshMeta(m.refreshMeta))return e.queryAccessMeta&&(m.accessMeta=this.cacheStrategy.queryAccessMeta(m.accessMeta),this.queryCache.update(n,this.addQueryMeta({},m),h)),this.__itemCacheQuery(a,b,h);this.queryCache.remove(n,h)}if(c.queryDeterminedByAttrs(a,this._options.suppAttrs,!0))return this.itemCache.query(a,b,h);var o=this.remoteStore.query(this.removeItemSupp(a),b,h).mapSuccess(function(a){this.online(),a=a.asArray();var b={refreshMeta:e.queryRefreshMeta?this.cacheStrategy.queryRefreshMeta():null,accessMeta:e.queryAccessMeta?this.cacheStrategy.queryAccessMeta():null};this.queryCache.insert(g.objectBy(this._options.queryKey,k,this._options.queryMetaKey,b),h);var c=[];return g.iter(a,function(a){c.push(this.cacheInsertUpdate(a,{lockItem:!1,lockAttrs:!1,silent:e.silent&&!this._options.optimisticRead,accessMeta:e.accessMeta,refreshMeta:e.refreshMeta,foreignKey:!0},h))},this),f.and(c).mapSuccess(function(a){var b=new i(a);return new j(b,this.addItemSupp,this).auto_destroy(b,!0)},this)},this).mapError(function(){if(this.offline(),!this._options.optimisticRead)return this.__itemCacheQuery(a,b,h)},this);return this._options.optimisticRead?this.__itemCacheQuery(a,b,h):o},this)},online:function(){this.trigger("online"),this._online=!0},offline:function(){this.trigger("offline"),this._online=!1},addItemMeta:function(a,b){return a=g.clone(a,1),
a[this._options.itemMetaKey]=b,a},addItemSupp:function(a){return g.extend(g.clone(this._options.suppAttrs,1),a)},removeItemSupp:function(a){return this._options.suppAttrs?g.filter(a,function(a,b){return!(b in this._options.suppAttrs)},this):a},addQueryMeta:function(a,b){return a=g.clone(a,1),a[this._options.queryMetaKey]=b,a},removeItemMeta:function(a){return a=g.clone(a,1),delete a[this._options.itemMetaKey],a},removeQueryMeta:function(a){return a=g.clone(a,1),delete a[this._options.queryMetaKey],a},readItemMeta:function(a){return a[this._options.itemMetaKey]},readQueryMeta:function(a){return a[this._options.queryMetaKey]},unlockItem:function(a,b){this.itemCache.get(a,b).success(function(c){if(c){var d=this.readItemMeta(c);d.lockedItem=!1,d.lockedAttrs={},this.itemCache.update(a,this.addItemMeta({},d),b)}},this)},cleanup:function(){this._online&&(this.queryCache.query().success(function(a){for(;a.hasNext();){var b=a.next(),c=this.readQueryMeta(b);this.cacheStrategy.validQueryRefreshMeta(c.refreshMeta)&&this.cacheStrategy.validQueryAccessMeta(c.accessMeta)||this.queryCache.remove(this.queryCache.id_of(b))}a.destroy()},this),this.itemCache.query().success(function(a){for(;a.hasNext();){var b=a.next(),c=this.readItemMeta(b);c.lockedItem||!h.is_empty(c.lockedAttrs)||this.cacheStrategy.validItemRefreshMeta(c.refreshMeta)&&this.cacheStrategy.validItemAccessMeta(c.accessMeta)||this.itemCache.remove(this.itemCache.id_of(b))}a.destroy()},this))},cachedIdToRemoteId:function(a){return this._foreignKey?this.itemCache.get(a).mapSuccess(function(a){return a?this.remoteStore.id_of(a):null},this):f.value(a)},serialize:function(){return this.itemCache.serialize().mapSuccess(function(a){return this.queryCache.serialize().mapSuccess(function(b){return{items:a,queries:b}},this)},this)},unserialize:function(a){return this.itemCache.unserialize(a.items).mapSuccess(function(b){return this.queryCache.unserialize(a.queries),b.map(function(a){return this.removeItemMeta(a)},this)},this)}}})}),a.define("module:Stores.CacheStrategies.CacheStrategy",["base:Class"],function(a,b){return a.extend({scoped:b},{itemRefreshMeta:function(a){},queryRefreshMeta:function(a){},itemAccessMeta:function(a){},queryAccessMeta:function(a){},validItemRefreshMeta:function(a){},validQueryRefreshMeta:function(a){},validItemAccessMeta:function(a){},validQueryAccessMeta:function(a){}})}),a.define("module:Stores.CacheStrategies.ExpiryCacheStrategy",["module:Stores.CacheStrategies.CacheStrategy","base:Time","base:Objs"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(d){a.constructor.call(this),this._options=c.extend({itemRefreshTime:144e4,itemAccessTime:36e6,queryRefreshTime:144e4,queryAccessTime:36e6,now:function(){return b.now()}},d)},itemRefreshMeta:function(a){return a||(null===this._options.itemRefreshTime?null:this._options.now()+this._options.itemRefreshTime)},queryRefreshMeta:function(a){return a||(null===this._options.queryRefreshTime?null:this._options.now()+this._options.queryRefreshTime)},itemAccessMeta:function(a){return null===this._options.itemAccessTime?null:this._options.now()+this._options.itemAccessTime},queryAccessMeta:function(a){return null===this._options.queryAccessTime?null:this._options.now()+this._options.queryAccessTime},validItemRefreshMeta:function(a){return null===this._options.itemRefreshTime||a>=this._options.now()},validQueryRefreshMeta:function(a){return null===this._options.queryRefreshTime||a>=this._options.now()},validItemAccessMeta:function(a){return null===this._options.itemAccessTime||a>=this._options.now()},validQueryAccessMeta:function(a){return null===this._options.queryAccessTime||a>=this._options.now()}}})}),a.define("module:Stores.PartialStoreWriteStrategies.WriteStrategy",["base:Class"],function(a,b){return a.extend({scoped:b},function(a){return{init:function(a){this.partialStore=a},insert:function(a,b){},remove:function(a,b){},update:function(a,b){}}})}),a.define("module:Stores.PartialStoreWriteStrategies.PostWriteStrategy",["module:Stores.PartialStoreWriteStrategies.WriteStrategy","base:Types","base:Objs"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{insert:function(a,b){return this.partialStore.remoteStore.insert(a,b).mapSuccess(function(a){return this.partialStore.cachedStore.cacheInsert(a,{lockItem:!1,silent:!0,refreshMeta:!0,accessMeta:!0},b)},this)},remove:function(a,b){return this.partialStore.cachedStore.cachedIdToRemoteId(a).mapSuccess(function(c){return this.partialStore.remoteStore.remove(c,b).mapSuccess(function(){return this.partialStore.cachedStore.cacheRemove(a,{ignoreLock:!0,silent:!0},b)},this)},this)},update:function(a,d,e){var f=function(b){var f=c.extend(c.clone(d,1),b);return this.partialStore.cachedStore.cacheUpdate(a,f,{ignoreLock:!1,lockAttrs:!1,silent:!0,refreshMeta:!0,accessMeta:!0},e)};return b.is_empty(this.partialStore.cachedStore.removeItemSupp(d))?f.call(this):this.partialStore.cachedStore.cachedIdToRemoteId(a).mapSuccess(function(a){return this.partialStore.remoteStore.update(a,d,e).mapSuccess(function(a){return f.call(this,a)},this)},this)}}})}),a.define("module:Stores.PartialStoreWriteStrategies.PreWriteStrategy",["module:Stores.PartialStoreWriteStrategies.WriteStrategy","base:Objs"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(b,c){a.constructor.call(this),this._options=c||{}},insert:function(a){return this.partialStore.cachedStore.cacheInsert(a,{lockItem:!0,silent:!0,refreshMeta:!0,accessMeta:!0}).mapSuccess(function(a){nosuppdata=this.partialStore.cachedStore.removeItemSupp(a);var c=this.partialStore.remoteStore.insert(nosuppdata).mapSuccess(function(c){return this.partialStore.cachedStore.cacheUpdate(this.partialStore.cachedStore.id_of(a),c,{silent:!0,unlockItem:!0}).mapSuccess(function(c){return b.extend(b.clone(a,1),c)},this)},this).error(function(){this.partialStore.cachedStore.cacheRemove(this.partialStore.cachedStore.id_of(a),{ignoreLock:!0,silent:!1})},this);return this._options.optimistic?a:c},this)},remove:function(a){return this.partialStore.cachedStore.cachedIdToRemoteId(a).mapSuccess(function(b){var c=this.partialStore.cachedStore.cacheRemove(a,{ignoreLock:!0,silent:!0}).success(function(){this.partialStore.remoteStore.remove(b)},this);return this._options.optimistic?data:c},this)},update:function(a,b){return this.partialStore.cachedStore.cachedIdToRemoteId(a).mapSuccess(function(c){var d=this.partialStore.cachedStore.cacheUpdate(a,b,{lockAttrs:!0,ignoreLock:!1,silent:!0,refreshMeta:!1,accessMeta:!0}).success(function(b){b=this.partialStore.cachedStore.removeItemSupp(b),this.partialStore.remoteStore.update(c,b).success(function(){this.partialStore.cachedStore.unlockItem(a)},this)},this);return this._options.optimistic?b:d},this)}}})}),a.define("module:Stores.PartialStoreWriteStrategies.CommitStrategy",["module:Stores.PartialStoreWriteStrategies.WriteStrategy","module:Stores.StoreHistory","module:Stores.MemoryStore","base:Objs","base:Timers.Timer","base:Promise"],function(a,b,c,d,e,f,g){return a.extend({scoped:g},function(a){return{constructor:function(b,d){a.constructor.call(this),this._options=d||{},this.historyStore=this._options.historyStore||this.auto_destroy(new c)},init:function(c){a.init.call(this,c),this.storeHistory=this.auto_destroy(new b(null,this.historyStore,d.extend({source_id_key:c.cachedStore.itemCache.id_key(),row_data:{pushed:!1,success:!1},filter_data:{pushed:!1}},this._options))),this._options.auto_push&&(this._timer=this.auto_destroy(new e({fire:function(){this.push(this.partialStore)},context:this,start:!0,delay:this._options.auto_push})))},insert:function(a){return this.partialStore.cachedStore.cacheInsert(a,{lockItem:!0,silent:!0,refreshMeta:!0,accessMeta:!0}).success(function(a){a=this.partialStore.cachedStore.removeItemSupp(a),this.storeHistory.sourceInsert(a)},this)},remove:function(a){return this.partialStore.cachedStore.cachedIdToRemoteId(a).mapSuccess(function(b){return this.partialStore.cachedStore.cacheRemove(a,{ignoreLock:!0,silent:!0}).mapSuccess(function(c){return this.storeHistory.sourceRemove(a,this.partialStore.remoteStore.id_row(b)),c},this)},this)},update:function(a,b){return this.partialStore.cachedStore.cacheUpdate(a,b,{lockAttrs:!0,ignoreLock:!0,silent:!0,refreshMeta:!1,accessMeta:!0}).success(function(){b=this.partialStore.cachedStore.removeItemSupp(b),this.storeHistory.sourceUpdate(a,b)},this)},push:function(){if(this.pushing)return f.value(!0);var a={},b={},c=this.storeHistory.historyStore;this.storeHistory.lockCommits();var e=c.query({success:!1},{sort:{commit_id:1}}).value(),g=function(){if(!e.hasNext())return this.pushing=!1,this.storeHistory.unlockCommits(),d.iter(b,function(a,b){a&&(!0===a?this.partialStore.cachedStore.unlockItem(b):this.partialStore.cachedStore.cacheUpdate(b,a,{unlockItem:!0,silent:!0}))},this),e.destroy(),f.value(!0);var h=e.next(),i=c.id_of(h);if(i in a)return c.update(i,{pushed:!0,success:!1}),g.apply(this);var j=null;return"insert"===h.type?j=this.partialStore.remoteStore.insert(h.row):"update"===h.type?j=this.partialStore.cachedStore.cachedIdToRemoteId(h.row_id).mapSuccess(function(a){return this.partialStore.remoteStore.update(a,h.row)},this):"remove"===h.type&&(j=this.partialStore.remoteStore.remove(h.row?this.partialStore.remoteStore.id_of(h.row):h.row_id)),j.mapSuccess(function(a){return c.update(i,{pushed:!0,success:!0}),h.row_id in b||(b[h.row_id]=!0,"insert"===h.type&&(b[h.row_id]=a)),g.apply(this)},this).mapError(function(){return c.update(i,{pushed:!0,success:!1}),a[i]=!0,b[h.row_id]=!1,g.apply(this)},this)};return g.apply(this)}}})}),a.define("module:Stores.PartialStoreWriteStrategies.DelegatedWriteStrategy",["module:Stores.PartialStoreWriteStrategies.WriteStrategy"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b,c,d){a.constructor.call(this),this._insertWriteStrategy=b,this._updateWriteStrategy=c,this._removeWriteStrategy=d},init:function(b){a.init.call(this,b),this._insertWriteStrategy.init(b),this._updateWriteStrategy.init(b),this._removeWriteStrategy.init(b)},insert:function(){return this._insertWriteStrategy.insert.apply(this._insertWriteStrategy,arguments)},remove:function(){return this._updateWriteStrategy.remove.apply(this._updateWriteStrategy,arguments)},update:function(){return this._removeWriteStrategy.update.apply(this._removeWriteStrategy,arguments)}}})}),a.define("module:Stores.PartialStore",["module:Stores.BaseStore","module:Stores.CachedStore","module:Stores.PartialStoreWriteStrategies.PostWriteStrategy","module:Stores.PartialStoreWatcher","base:Objs","base:Types"],function(a,b,c,d,e,f,g){return a.extend({scoped:g},function(a){return{constructor:function(f,g){a.constructor.call(this,g),this._options=e.extend({},g),this._options.remoteWatcher&&(this.remoteWatcher=this._options.remoteWatcher),this.remoteStore=f,this.cachedStore=new b(f,this._options),this.writeStrategy=this._options.writeStrategy||this.auto_destroy(new c),this.remoteWatcher&&(this.remoteWatcher.on("insert",this._remoteInsert,this),this.remoteWatcher.on("update",this._remoteUpdate,this),this.remoteWatcher.on("remove",this._remoteRemove,this),this._watcher=new d(this)),this.cachedStore.on("insert",this._inserted,this),this.cachedStore.on("remove",this._removed,this),this.cachedStore.on("update",this._updated,this),this.writeStrategy.init(this)},id_key:function(){return this.cachedStore.id_key()},destroy:function(){this.remoteWatcher&&this.remoteWatcher.off(null,null,this),this._watcher&&this._watcher.destroy(),this.cachedStore.destroy(),a.destroy.call(this)},_insert:function(a,b){return this.writeStrategy.insert(a,b)},_remove:function(a,b){return this.writeStrategy.remove(a,b)},_update:function(a,b,c){return this.cachedStore.cacheOnlyGet(a,{},c).mapSuccess(function(d){var g=e.diff(b,d);return f.is_empty(g)?d:this.writeStrategy.update(a,b,c)},this)},_get:function(a,b){return this.cachedStore.get(a,b)},_query:function(a,b,c){return this.cachedStore.query(a,b,c)},_query_capabilities:function(){return this.cachedStore._query_capabilities()},_remoteInsert:function(a,b){this.cachedStore.cacheInsertUpdate(a,{lockItem:!1,silent:!1,refreshMeta:!0,accessMeta:!0,foreignKey:!0},b)},_remoteUpdate:function(a,b,c){var d=this.remoteStore.id_of(a);this.cachedStore.cacheUpdate(d,b,{ignoreLock:!1,lockAttrs:!1,silent:!1,accessMeta:!0,refreshMeta:!0,foreignKey:!0},c)},_remoteRemove:function(a,b){this.cachedStore.cacheRemove(a,{ignoreLock:!1,silent:!1,foreignKey:!0},b)},serialize:function(){return this.cachedStore.serialize()},unserialize:function(a){return this.cachedStore.unserialize(a).success(function(a){a.forEach(function(a){this._inserted(a)},this)},this)}}})}),a.define("module:Stores.PartialStoreWatcher",["module:Stores.Watchers.LocalWatcher"],function(a,b){return a.extend({scoped:b},function(a){return{_watchItem:function(b){a.watchItem.call(this,b),this._store.cachedStore.cachedIdToRemoteId(b).success(function(a){this._store.remoteWatcher.watchItem(a,this)},this)},_unwatchItem:function(b){a.unwatchItem.call(this,b),this._store.cachedStore.cachedIdToRemoteId(b).success(function(a){this._store.remoteWatcher.unwatchItem(a,this)},this)},_watchInsert:function(b){a.watchInsert.call(this,b),this._store.remoteWatcher.watchInsert(b,this)},_unwatchInsert:function(b){a.unwatchInsert.call(this,b),this._store.remoteWatcher.unwatchInsert(b,this)}}})}),a.define("module:Stores.ChannelClientStore",["module:Stores.Invokers.AbstractInvokerStore","base:Channels.TransportChannel","base:Functions"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(d,e,f){a.constructor.call(this,f),this.transport=this.auto_destroy(new b(d,e)),this.transport._reply=c.as_method(function(a,b){"event"===a&&this.trigger.apply(this,[b.event].concat(b.args))},this)},_invoke:function(a,b,c){return this.transport.send("invoke",{member:a,data:b,context:c})}}})}),a.define("module:Stores.ChannelServerStore",["module:Stores.Invokers.StoreInvokeeInvoker","base:Channels.TransportChannel","base:Functions"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(d,e,f){a.constructor.call(this,f),this.transport=this.auto_destroy(new b(d,e)),this.transport._reply=c.as_method(function(a,b){if("invoke"===a)return this.storeInvoke(b.member,b.data,b.context)},this),f.on("all",function(a){this.transport.send("event",{event:a,args:c.getArguments(arguments,1)},{stateless:!0})},this)}}})}),a.define("module:Stores.RemoteStore",["module:Stores.Invokers.InvokerStore","module:Stores.Invokers.StoreInvokeeRestInvoker","module:Stores.Invokers.RestInvokeeAjaxInvoker"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(d,e,f){var g=new c(d),h=new b(g,e);a.constructor.call(this,h,f),this.auto_destroy(h),this.auto_destroy(g)}}})}),a.define("module:Stores.SocketStore",["module:Stores.BaseStore","base:Objs"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(b,c,d){a.constructor.call(this,b),this.__socket=c,this.__prefix=d},__send:function(a,b){this.__socket.emit(this.__prefix+":"+a,b)},_insert:function(a){this.__send("insert",a)},_remove:function(a){this.__send("remove",a)},_update:function(a,c){this.__send("update",b.objectBy(a,c))}}})}),a.define("module:Stores.Watchers.ConsumerWatcher",["module:Stores.Watchers.StoreWatcher"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b,c,d){a.constructor.call(this,d),this._receiver=c,this._sender=b,c.on("receive",function(a,b){"insert"===a&&this._insertedWatchedInsert(b),"update"===a?this._updatedWatchedItem(b.row,b.data):"remove"===a&&this._removedWatchedItem(b)},this)},destroy:function(){this._receiver.off(null,null,this),a.destroy.apply(this)},_watchItem:function(a){this._sender.send("watch_item",a)},_unwatchItem:function(a){this._sender.send("unwatch_item",a)},_watchInsert:function(a){this._sender.send("watch_insert",a)},_unwatchInsert:function(a){this._sender.send("unwatch_insert",a)}}})}),a.define("module:Stores.Watchers.ProducerWatcher",["base:Class"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b,c,d){a.constructor.apply(this),this._watcher=d,this._receiver=c,c.on("receive",function(a,b){"watch_item"===a?d.watchItem(b,this):"unwatch_item"===a?d.unwatchItem(b,this):"watch_insert"===a?d.watchInsert(b,this):"unwatch_insert"===a&&d.unwatchInsert(b,this)},this),d.on("insert",function(a){b.send("insert",a)},this).on("update",function(a,c){b.send("update",{row:a,data:c})},this).on("remove",function(a){b.send("remove",a)},this)},destroy:function(){this._receiver.off(null,null,this),this._watcher.off(null,null,this),a.destroy.apply(this)}}})}),a.define("module:Stores.Watchers.ListWatcher",["module:Stores.Watchers.StoreWatcher","base:Objs"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(b,c,d){d=d||{},d.id_key=b.id_key(),this.__watchers={},a.constructor.call(this,d),c&&c.forEach(this.addWatcher,this)},addWatcher:function(a){return this.__watchers[a.cid()]||(this.delegateEvents(["insert","update","remove"],a),this.itemsIterator().iterate(a.watchItem,a),this.insertsIterator().iterate(a.watchInsert,a),this.__watchers[a.cid()]=a),this},removeWatcher:function(a){return this.__watchers[a.cid()]&&(a.off(null,null,this),this.itemsIterator().iterate(a.unwatchItem,a),this.insertsIterator().iterate(a.unwatchInsert,a),delete this.__watchers[a.cid()]),this},getWatchers:function(){return b.values(this.__watchers)},__forEachWatcher:function(a,c){b.iter(this.__watchers,a,c||this)},destroy:function(){this.__forEachWatcher(this.removeWatcher),a.destroy.apply(this)},_watchItem:function(a){this.__forEachWatcher(function(b){b.watchItem(a)})},_unwatchItem:function(a){this.__forEachWatcher(function(b){b.unwatchItem(a)})},_watchInsert:function(a){this.__forEachWatcher(function(b){b.watchInsert(a)})},_unwatchInsert:function(a){this.__forEachWatcher(function(b){b.unwatchInsert(a)})}}})}),a.define("module:Stores.Watchers.LocalWatcher",["module:Stores.Watchers.StoreWatcher"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b,c){c=c||{},c.id_key=b.id_key(),a.constructor.call(this,c),this._store=b,this._store.on("insert",function(a,b){this._insertedInsert(a,b)},this).on("update",function(a,b,c){this._updatedItem(a,b,c)},this).on("remove",function(a,b){this._removedItem(a,b)},this)},destroy:function(){this._store.off(null,null,this),a.destroy.apply(this)}}})}),a.define("module:Stores.Watchers.PollWatcher",["module:Stores.Watchers.StoreWatcher","base:Comparators","base:Objs","base:Timers.Timer"],function(a,b,c,d,e){return a.extend({scoped:e},function(a){return{constructor:function(b,c){c=c||{},c.id_key=b.id_key(),a.constructor.call(this,c),this._store=b,this.__itemCache={},this.__lastKey=null,this.__lastKeyIds={},this.__insertsCount=0,this.__increasingKey=c.increasing_key||this.id_key,this.__ignoreUpdates=c.ignore_updates,c.auto_poll&&this.auto_destroy(new d({fire:this.poll,context:this,start:!0,delay:c.auto_poll}))},_watchItem:function(a,b){this.__itemCache[a]={context:b,value:null}},_unwatchItem:function(a){delete this.__itemCache[a]},_queryLastKey:function(){return this._store.query({},{limit:1,sort:c.objectBy(this.__increasingKey,-1)}).mapSuccess(function(a){var b=a.hasNext()?a.next()[this.__increasingKey]:null;return a.destroy(),b},this).mapError(function(){return null})},_watchInsert:function(a){0===this.__insertsCount&&this._queryLastKey().success(function(a){this.__lastKey=a,this.__lastKeyIds={}},this),this.__insertsCount++},_unwatchInsert:function(a){0===--this.__insertsCount&&(this.__lastKey=null)},poll:function(){this.__ignoreUpdates||c.iter(this.__itemCache,function(a,d){this._store.get(d,a.context).success(function(e){if(e){var f=a.value&&!b.deepEqual(a.value,e,-1);a.value=c.clone(e,1),f&&this._updatedItem(e,e)}else this._removedItem(d)},this)},this),this.destroyed()||(this.__lastKey?this.insertsIterator().iterate(function(a){var b=a.query,d=a.options,e=c.objectBy(this.__increasingKey,{$gte:this.__lastKey});this._store.query(c.extend(e,b),d).success(function(a){for(;a.hasNext();){var b=a.next(),c=b[this.__increasingKey];this.__lastKeyIds[c]||this._insertedInsert(b),this.__lastKeyIds[c]=!0,c>this.__lastKey&&(this.__lastKey=c)}a.destroy()},this)},this):this._queryLastKey().success(function(a){a!==this.__lastKey&&(this.__lastKey=a,this.__lastKeyIds={})},this))}}})}),a.define("module:Stores.Watchers.StoreWatcherMixin",[],function(){return{watchItem:function(a,b){},unwatchItem:function(a,b){},watchInsert:function(a,b){},unwatchInsert:function(a,b){},_removedWatchedItem:function(a){this.trigger("remove",a)},_updatedWatchedItem:function(a,b){this.trigger("update",a,b)},_insertedWatchedInsert:function(a){this.trigger("insert",a)},delegateStoreEvents:function(a){this.on("insert",function(b){a.trigger("insert",b)},a).on("update",function(b,c){a.trigger("update",b,c)},a).on("remove",function(b){a.trigger("remove",b)},a)},undelegateStoreEvents:function(a){this.off(null,null,a)}}}),a.define("module:Stores.Watchers.StoreWatcher",["base:Class","base:Events.EventsMixin","base:Classes.ContextRegistry","base:Comparators","module:Stores.Watchers.StoreWatcherMixin","module:Queries"],function(a,b,c,d,e,f,g){return a.extend({scoped:g},[b,e,function(a){return{constructor:function(b){a.constructor.call(this),b=b||{},b.id_key?this.id_key=b.id_key:this.id_key="id",this.__ctx=b.ctx,this.__items=new c,this.__inserts=new c(f.serialize,f)},destroy:function(){this.insertsIterator().iterate(this.unwatchInsert,this),this.itemsIterator().iterate(this.unwatchItem,this),this.__inserts.destroy(),this.__items.destroy(),a.destroy.call(this)},insertsIterator:function(){return this.__inserts.iterator()},itemsIterator:function(){return this.__items.iterator()},watchItem:function(a,b){this.__items.register(a,b)&&this._watchItem(a)},unwatchItem:function(a,b){this.__items.unregister(a,b).forEach(this._unwatchItem,this)},watchInsert:function(a,b){this.__inserts.register(a,b)&&this._watchInsert(a)},unwatchInsert:function(a,b){this.__inserts.unregister(a,b).forEach(this._unwatchInsert,this)},_ctxFilter:function(a){return!this.__ctx||!a||d.deepEqual(this.__ctx,a,2)},_removedItem:function(a,b){this._ctxFilter(b)&&this.__items.get(a)&&this._removedWatchedItem(a)},_updatedItem:function(a,b,c){if(this._ctxFilter(c)){var d=a[this.id_key];this.__items.get(d)&&this._updatedWatchedItem(a,b)}},_insertedInsert:function(a,b){if(this._ctxFilter(b)){for(var c=!1,d=this.__inserts.iterator();!c&&d.hasNext();)c=f.evaluate(d.next().query,a);c&&this._insertedWatchedInsert(a)}},unregisterItem:function(a,b){this.__items.unregister(a,b)&&this._unregisterItem(a)},_watchItem:function(a){},_unwatchItem:function(a){},_watchInsert:function(a){},_unwatchInsert:function(a){},reconnect:function(){this.itemsIterator().iterate(this._watchItem,this),this.insertsIterator().iterate(this._watchInsert,this)}}}])}),a.extend("module:Modelling.ActiveModel",["base:Properties.Properties","base:Async","base:Objs","base:Promise","module:Queries"],function(a,b,c,d,e,f){return a.extend({scoped:f},function(f){return{constructor:function(a,b,d,g){f.constructor.call(this),this._options=g||{},this._table=a,this._query=b,this._queryopts=d||{},this.set("model",null),this._unregisterModel(),this._options.inactive||(this._watcher()&&this._watcher().watchInsert({query:this._query,options:c.extend({limit:1},this._queryopts)},this),this._table.on("create",function(a){e.evaluate(this._query,a)&&(!this._queryopts.sort&&this.get("model")||(this.get("model")?this._unregisterModel():this._registerModel(this._table.materialize(a))))},this))},destroy:function(){this._watcher()&&(this._watcher().unwatchInsert(null,this),this._watcher().unwatchItem(null,this)),this.get("model")&&this.get("model").weakDestroy(),this._table.off(null,null,this),f.destroy.call(this)},assertExistence:function(){if(this.get("model"))return d.value(this.get("model"));if(!this.__find_by_acquiring)return d.error("Not found");var a=d.create();return this.once("find-by-acquired",function(){this.get("model")?a.asyncSuccess(this.get("model")):a.asyncError("Not found")},this),a},_watcher:function(){return this._table.store().watcher()},update:function(b){this._query=b,this.get("model")&&a.is_class_instance(this.get("model"))&&e.evaluate(this._query,this.get("model").data())||this._unregisterModel()},_registerModel:function(a){this.set("model",a),this._watcher()&&!a.isNew()&&this._watcher().watchItem(a.id(),this),a.on("change",function(){e.evaluate(this._query,a.data())||this._unregisterModel()},this),a.on("remove",function(){this._unregisterModel()},this)},_unregisterModel:function(){var c=this.get("model");c&&a.is_class_instance(c)&&b.eventually(function(){c.weakDestroy()}),this._watcher()&&this._watcher().unwatchItem(null,this),this.set("model",null),this.__find_by_acquiring=!0,this._table.findBy(this._query,this._queryopts).success(function(a){a?this._registerModel(a):this._options.create_virtual&&this._registerModel(this._options.create_virtual.call(this._options.create_virtual_ctx||this,this._query))},this).callback(function(){this.__find_by_acquiring=!1,this.trigger("find-by-acquired")},this)}}})}),a.define("module:Modelling.Associations.Association",["base:Class"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b,c){a.constructor.call(this),this._model=b,this._options=c||{}}}})}),a.define("module:Modelling.Associations.BelongsToAssociation",["module:Modelling.Associations.OneAssociation","base:Objs"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(){a.constructor.apply(this,arguments),this._model.on("change:"+this._foreign_key,this._queryChanged,this)},_buildQuery:function(a){var c=this._model.get(this._foreign_key);return this._options.map&&(c=this._options.map.call(this._options.mapctx||this,c)),b.extend(b.objectBy(this._options.foreign_attr||this._foreignTable().primary_key(),c),a)},_unset:function(){this._model.set(this._foreign_key,null)},_set:function(a){this._model.set(this._foreign_key,a.id())}}})}),a.define("module:Modelling.Associations.HasManyAssociation",["module:Modelling.Associations.TableAssociation","base:Classes.SharedObjectFactory","base:Classes.SharedObjectFactoryPool","module:Collections.TableQueryCollection","base:Objs","base:Functions"],function(a,b,c,d,e,f,g){return a.extend({scoped:g},function(a){return{constructor:function(){a.constructor.apply(this,arguments),this.collection=this.newPooledCollection(),this.collectionPool=new c(this.newPooledCollection,this),this._model&&this._model.isNew&&!this._model.destroyed()&&(this._model.isNew()&&this._model.once("save",this._queryChanged,this),this._options.delete_cascade&&this._model.once("remove",this.removeAll,this))},destroy:function(){this.collectionPool.destroy(),this.collection.destroy(),this._model&&this._model.off(null,null,this),a.destroy.call(this)},customCollection:function(){return this.collectionPool.acquire.apply(this.collectionPool,arguments)},newPooledCollection:function(){var a=new b(this.newCollection,this,f.getArguments(arguments));return a.add=f.as_method(this.add,this),a.remove=f.as_method(this.remove,this),a},_buildQuery:function(a,b){},buildQuery:function(a,b){return this._buildQuery(e.extend(a,this._options.query),e.extend(b,this._options.queryOpts))},_queryChanged:function(){var a=this.collection.value();a&&a.update(this.buildQuery())},allBy:function(a,b){var c=this.buildQuery(a,b);return this._foreignTable().allBy(c.query,c.options)},_queryCollectionUpdated:function(a){},newCollection:function(a,b){var c=this.buildQuery(a,b),f=new d(this._foreignTable(),c.query,e.extend(e.extend(c.options,this._options.collectionOptions),b));return f.on("replaced-objects collection-updated",function(){this._queryCollectionUpdated(f)},this),this._queryCollectionUpdated(f),f},remove:function(a){return a&&!a.destroyed()&&this._options.delete_cascade&&a.weaklyRemove(),this._remove(a)},removeAll:function(){this.allBy().success(function(a){for(;a.hasNext();)this.remove(a.next())},this)},_remove:function(a){},add:function(a){return this._add(a)},_add:function(a){}}})}),a.define("module:Modelling.Associations.HasManyCustomAssociation",["module:Modelling.Associations.HasManyAssociation","base:Objs"],function(a,b,c){return a.extend({scoped:c},function(a){return{_buildQuery:function(a,c){return{query:this._foreign_key,options:b.clone(c||{},1)}}}})}),a.define("module:Modelling.Associations.HasManyInArrayAssociation",["module:Modelling.Associations.HasManyAssociation","base:Objs"],function(a,b,c){return a.extend({scoped:c},function(a){return{_buildQuery:function(a,c){return{query:b.objectBy(this._foreign_key,{$elemMatch:{$eq:this._model.id()}})}},_remove:function(a){a.set(this._foreign_key,a.get(this._foreign_key).filter(function(a){return a!==this._model.id()},this))},_add:function(a){var c=b.clone(a.get(this._foreign_key),1);c.some(function(a){return a===this._model.id()},this)||(c.push(this._model.id()),a.set(this._foreign_key,c))}}})}),a.define("module:Modelling.Associations.HasManyKeyAssociation",["module:Modelling.Associations.HasManyAssociation","base:Objs"],function(a,b,c){return a.extend({scoped:c},function(a){return{_buildQuery:function(a,c){return{query:b.extend(b.objectBy(this._foreign_key,this._model.id()),a),options:c}},_remove:function(a){a.set(this._foreign_key,null)},_add:function(a){a.set(this._foreign_key,this._model.id())}}})}),a.define("module:Modelling.Associations.HasManyThroughArrayAssociation",["module:Modelling.Associations.HasManyAssociation","base:Objs","base:Types","base:Functions"],function(a,b,c,d,e){return a.extend({scoped:e},function(a){return{__foreignKeyArray:function(){return c.is_array(this._foreign_key)?this._foreign_key:[this._foreign_key]},__readForeignKey:function(){var a=[];return this.__foreignKeyArray().forEach(function(b){a=a.concat(this._model.get(b)||[])},this),a},constructor:function(){a.constructor.apply(this,arguments),this._options.collectionOptions=b.extend({secondary_ident:d.as_method(this._mapItemValue,this)},this._options.collectionOptions),this.__foreignKeyArray().forEach(function(a){this._model.on("change:"+a,this._queryChanged,this)},this)},_buildQuery:function(a,c){var d=this.__readForeignKey();return this._options.map&&(d=d.map(this._options.map,this._options.mapctx||this)),{query:b.extend(b.objectBy(this._options.foreign_attr||this._foreignTable().primary_key(),b.objectBy(this._options.ignore_case?"$inic":"$in",d)),a)}},_queryCollectionUpdated:function(a){this._options.create_virtual&&this.__readForeignKey().filter(function(b){return!a.has(function(a){return this._matchItem(a,b)},this)},this).forEach(function(b){a.add(this._options.create_virtual.call(this._options.create_virtual_ctx||this,b))},this)},_mapValue:function(a){return this._options.map&&(a=this._options.map.call(this._options.mapctx||this,a)),this._options.ignore_case&&(a=a.toLowerCase()),a},_mapItemValue:function(a){return this._mapValue(a.get(this._options.foreign_attr||this._foreignTable().primary_key()))},_matchItem:function(a,b){return this._mapItemValue(a)===this._mapValue(b)},_remove:function(a){this.__foreignKeyArray().forEach(function(b){this._model.set(b,this._model.get(b).filter(function(b){return!this._matchItem(a,b)},this))},this),this._options.create_virtual&&this.collection.value()&&!a.destroyed()&&this.collection.value().remove(a)},_add:function(a){if(!this.__readForeignKey().some(function(b){return this._matchItem(a,b)},this)){var d=c.is_array(this._foreign_key)?this._foreign_key[0]:this._foreign_key,e=b.clone(this._model.get(d)||[],1);e.push(a.get(this._options.foreign_attr||this._foreignTable().primary_key())),this._options.create_virtual&&this.collection.value()&&this.collection.value().add(a),this._model.set(d,e)}}}})}),
a.define("module:Modelling.Associations.HasOneAssociation",["module:Modelling.Associations.OneAssociation","base:Objs"],function(a,b,c){return a.extend({scoped:c},function(a){return{_buildQuery:function(a,c){return b.extend(b.objectBy(this._foreign_key,this._model.id()),a)},_unset:function(){this.active.value()&&this.active.value().get("model")&&this.active.value().get("model").set(this._foreign_key,null)},_set:function(a){a.set(this._foreign_key,this._model.id()),this._unset()}}})}),a.define("module:Modelling.Associations.OneAssociation",["module:Modelling.Associations.TableAssociation","base:Classes.SharedObjectFactory","module:Modelling.ActiveModel","base:Objs"],function(a,b,c,d,e){return a.extend({scoped:e},function(a){return{constructor:function(){a.constructor.apply(this,arguments),this.active=new b(this.newActiveModel,this)},_buildQuery:function(a){},buildQuery:function(a){return this._buildQuery(d.extend(a,this._options.query))},_queryChanged:function(){var a=this.active.value();a&&a.update(this.buildQuery())},findBy:function(a,b){var c=this.buildQuery(a);return this._foreignTable().findBy(c,null,b)},newActiveModel:function(a){var b=this.buildQuery(a);return new c(this._foreignTable(),b,this._options.queryOpts,this._options.activeOpts)},assertExistence:function(a){return this.active.acquire(a).assertExistence()},unset:function(){return this._unset()},_unset:function(){},set:function(a){return this._set(a)},_set:function(a){}}})}),a.define("module:Modelling.Associations.PolymorphicBelongsToAssociation",["module:Modelling.Associations.BelongsToAssociation","base:Objs"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(b,c,d,e,f){a.constructor.call(this,b,null,c,f),this._foreign_type_key=d,this._table_lookup_function=e},_foreignTable:function(){return this._table_lookup_function(this._model.get(this._foreign_type_key))},_unset:function(){a._unset.call(this),this._model.set(this._foreign_type_key,null)},_set:function(b){a._set.call(this,b),this._model.set(this._foreign_type_key,b.type())}}})}),a.define("module:Modelling.Associations.PolymorphicHasManyKeyAssociation",["module:Modelling.Associations.HasManyKeyAssociation","base:Objs"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(b,c,d,e,f){a.constructor.call(this,b,c,d,f),this._foreign_type_key=e},_buildQuery:function(a,c){return b.extend({query:b.extend(b.objectBy(this._foreign_key,this._model.id(),this._foreign_type_key,this._model.type()),a)},c)},_remove:function(b){a._remove.call(this,b),b.set(this._foreign_type_key,null)},_add:function(b){a._add.call(this,b),b.set(this._foreign_type_key,this._model.type())}}})}),a.define("module:Modelling.Associations.TableAssociation",["module:Modelling.Associations.Association"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b,c,d,e){a.constructor.call(this,b,e),this._foreign_table=c,this._foreign_key=d},_foreignTable:function(){return this._foreign_table}}})}),a.define("module:Modelling.ModelException",["base:Exceptions.Exception"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b,c){a.constructor.call(this,c),this.__model=b},model:function(){return this.__model}}})}),a.define("module:Modelling.ModelMissingIdException",["module:Modelling.ModelException"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b){a.constructor.call(this,b,"No id given.")}}})}),a.define("module:Modelling.ModelInvalidException",["module:Modelling.ModelException","base:Objs"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(c,d){var e=b.values(c.errors()).join("\n")||d;a.constructor.call(this,c,e)}}})}),a.define("module:Modelling.GroupedProperties",["module:Modelling.AssociatedProperties","base:Objs","base:Types","base:Collections.Collection"],function(a,b,c,d,e){return a.extend({scoped:e},function(a){return{constructor:function(e,f){a.constructor.call(this,e);var g=!1,h=f||this.auto_destroy(new d);this[this.cls.groupedItemsKey]=h,this.set(this.cls.groupedItemsCount,h.count()),h.on("add remove",function(){this.set(this.cls.groupedItemsCount,h.count())},this),b.extend(this,b.map(this.cls.groupedMethods,function(a,b){return c.is_string(a)&&(a=this.cls.methodsHelper[a]),function(){return a(h,b,arguments)}},this)),b.iter(this.cls.groupedSetters,function(a,b){c.is_string(a)&&(a=this.cls.settersHelper[a]),this.on("change:"+b,function(c){g||a(h,b,c)})},this),b.iter(this.cls.groupedGetters,function(a,b){if(c.is_string(a)){if(!this.cls.gettersHelper[a])return void console.warn("Unknown Getter: "+a);a=this.cls.gettersHelper[a]}var d=null;a.add&&this.on("items:add",function(c){d=a.add(d,c.get(b),c),g=!0,this.set(b,a.map?a.map(d):d),g=!1},this),a.remove&&this.on("items:remove",function(c){d=a.remove(d,c.get(b),c),g=!0,this.set(b,a.map?a.map(d):d),g=!1},this),a.update&&h.on("change:"+b,function(c,e,f){d=a.update(d,e,f,h.getIndex(c),h.count(),c),g=!0,this.set(b,a.map?a.map(d):d),g=!1},this),a.first&&this.on("items:add items:reindexed",function(c){0===h.getIndex(c)&&(d=a.first(d,c.get(b))),g=!0,this.set(b,a.map?a.map(d):d),g=!1},this),a.last&&this.on("items:add items:reindexed",function(c){h.getIndex(c)===h.count()-1&&(d=a.last(d,c.get(b))),g=!0,this.set(b,a.map?a.map(d):d),g=!1},this)},this),h.iterate(function(a){this.trigger("items:add",a)},this),this.delegateEvents(["add","remove","reindexed"],h,"items")},destroy:function(){this[this.cls.groupedItemsKey].off(null,null,this),a.destroy.call(this)}}},{groupedItemsKey:"items",groupedItemsCount:"count",groupedMethods:{},groupedSetters:{},groupedGetters:{},methodsHelper:{all:function(a,b,c){var d=null;return a.iterate(function(a){d=a[b].apply(a,c)||d}),d},first:function(a,b,c){var d=a.first();return d?d[b].apply(d,c):undefined},last:function(a,b,c){var d=a.last();return d?d[b].apply(d,c):undefined}},settersHelper:{all:function(a,b,c){a.iterate(function(a){a.set(b,c)})},first:function(a,b,c){var d=a.first();d&&d.set(b,c)},last:function(a,b,c){var d=a.last();d&&d.set(b,c)}},gettersHelper:{exists:{add:function(a,b){return(a||0)+(b?1:0)},remove:function(a,b){return(a||0)-(b?1:0)},update:function(a,b,c){return(a||0)-(c?1:0)+(b?1:0)},map:function(a){return!!a}},all:{add:function(a,b){return(a||0)+(b?0:1)},remove:function(a,b){return(a||0)-(b?0:1)},update:function(a,b,c){return(a||0)-(c?0:1)+(b?0:1)},map:function(a){return!a}},first:{first:function(a,b){return b},update:function(a,b,c,d){return 0===d?b:a}},last:{last:function(a,b){return b},update:function(a,b,c,d,e){return d===e-1?b:a}},uniqueUnion:{add:function(a,d,e){var f=b.clone(a||{},1);return d&&c.is_array(d)||(d=[]),d.forEach(function(a){f[a]=f[a]||{},f[a][e.cid()]=!0}),f},remove:function(a,d,e){var f=b.clone(a||{},1);return d&&c.is_array(d)||(d=[]),d.forEach(function(a){f[a]&&(delete f[a][e.cid()],c.is_empty(f[a])&&delete f[a])}),f},update:function(a,d,e,f,g,h){var i=b.clone(a||{},1);return(e||[]).forEach(function(a){i[a]&&(delete i[a][h.cid()],c.is_empty(i[a])&&delete i[a])}),(d||[]).forEach(function(a){i[a]=i[a]||{},i[a][h.cid()]=!0}),i},map:function(a){return b.keys(a)}}}})}),a.define("module:Modelling.Model",["module:Modelling.AssociatedProperties","module:Modelling.ModelInvalidException","base:Objs","base:Promise","base:Types","base:Strings","module:Modelling.Table"],function(a,b,c,d,e,f,g,h){return a.extend({scoped:h},function(a){return{constructor:function(b,d,e,f){this.__table=d,this.__options=c.extend({newModel:!0,removed:!1,canWeaklyRemove:!1},e),this.__ctx=f,this.__silent=1,a.constructor.call(this,b),this.__silent=0,this.__removeOnDestroy=!1,this.isNew()||(this._properties_changed={},this._registerEvents()),this.option("auto_create")&&this.isNew()&&this.save()},destroy:function(){this.__removeOnDestroy&&this.remove(),this.table()&&this.table().off(null,null,this),this.trigger("destroy"),a.destroy.call(this)},ctx:function(){return this.__ctx},saveOnChange:function(a){return this.__saveOnChange=!0,this.__saveOnChangeWeak=!!a,this},disableSaveOnChange:function(){this.__disableSaveOnChange=!0},enableSaveOnChange:function(){this.__disableSaveOnChange=!1},option:function(a){return(a in this.__options||!this.table()?this.__options:this.table().options())[a]},type:function(){return this.cls.type()},table:function(){return this.__table},isSaved:function(){return this.isRemoved()||!this.isNew()&&!this.isChanged()},isNew:function(){return this.option("newModel")},isRemoved:function(){return this.option("removed")},_registerEvents:function(){this.table().options().active_models&&(this.__table.on("update:"+this.id(),function(a){if(!this.isRemoved()){this.__silent++;for(var b in a)this._properties_changed[b]||(this.set(b,a[b]),delete this._properties_changed[b]);this.__silent--}},this),this.__table.on("remove:"+this.id(),function(){this.isRemoved()||(this.trigger("remove"),this.__options.removed=!0)},this))},update:function(a){return this.__silent++,this.suspendEvents(),this.setAll(a),this.__silent--,(this.isNew()?d.create(!0):this.save()).callback(this.resumeEvents,this)},_afterSet:function(b,c,d,e){a._afterSet.call(this,b,c,d,e),b in this.cls.scheme()&&!(this.__silent>0)&&(!this.option("auto_update")||this.isNew()&&(this.__disableSaveOnChange||!this.__saveOnChange||this.__saveOnChangeWeak&&!c)||this.save())},save:function(){return this.isRemoved()?d.create({}):(this.option("save_invalid")?d.value(!0):this.validate()).mapSuccess(function(a){if(!a)return d.create(null,new b(this));var f;if(this.isNew())f=this.cls.filterPersistent(this.get_all_properties()),this.__options.type_column&&(f[this.__options.type_column]=this.cls.classname);else if(f=this.cls.filterPersistent(this.properties_changed()),e.is_empty(f))return d.create(f);var g=this.isNew();return(this.isNew()?this.__table.store().insert(f,this.__ctx):this.__table.store().update(this.id(),f,this.__ctx)).mapCallback(function(a,d){return this.destroyed()?this:a?(a.data&&c.iter(a.data,function(a,b){this.setError(b,a)},this),new b(this,a)):(this.__silent++,this.setAll(d),this.__silent--,this._properties_changed={},this.trigger("save"),g&&(this.__options.newModel=!1,this._registerEvents(),this._createdModel()),this)},this)},this)},_createdModel:function(){},isRemoving:function(){return this.__removing},canWeaklyRemove:function(){return this.option("can_weakly_remove")},weaklyRemove:function(){return this.canWeaklyRemove()?this.remove():d.error("Cannot remove weakly")},remove:function(){return this.isNew()||this.isRemoved()?d.create(!0):(this.__removing=!0,this.__table.store().remove(this.id(),this.__ctx).callback(function(){this.__removing=!1},this).success(function(){this.destroyed()||(this.__options.removed=!0,this.trigger("remove"))},this))},removeOnDestroy:function(){return this.__removeOnDestroy=!0,this}}},{type:function(){return f.last_after(this.classname,".").toLowerCase()},createTable:function(a,b){return new g(a,this,b)}})}),a.define("module:Modelling.SchemedProperties",["base:Properties.Properties","base:Types","base:Promise","base:Objs"],function(a,b,c,d,e){return a.extend({scoped:e},function(a){return{constructor:function(c){a.constructor.call(this);var d=this.cls.scheme();this._properties_changed={},this.__errors={};for(var e in d)"def"in d[e]?this.set(e,b.is_function(d[e].def)?d[e].def(c):d[e].def):d[e].auto_create?this.set(e,d[e].auto_create(this)):this.set(e,null);this._properties_changed={},this.__errors={};for(e in c)this.set(e,c[e])},_unsetChanged:function(a){delete this._properties_changed[a]},_beforeSet:function(a,c){var d=this.cls.scheme();if(!(a in d))return c;var e=d[a];return e.type&&(c=b.parseType(c,e.type)),e.transform&&(c=e.transform.apply(this,[c])),c},_afterSet:function(a,c){var d=this.cls.scheme();if(a in d&&(this._properties_changed[a]=c,delete this.__errors[a],d[a].after_set)){(b.is_string(d[a].after_set)?this[d[a].after_set]:d[a].after_set).apply(this,[c])}},isChanged:function(){return!b.is_empty(this._properties_changed)},properties_changed:function(){return this._properties_changed},get_all_properties:function(){var a={},b=this.cls.scheme();for(var c in b)a[c]=this.get(c);return a},validate:function(){this.trigger("validate");var a=[];for(var b in this.cls.scheme())a.push(this._validateAttr(b));return a.push(c.box(this._customValidate,this)),c.and(a).end().mapSuccess(function(a){var b=!0;return d.iter(a,function(a){b=b&&a}),b})},_customValidate:function(){return!0},_validateAttr:function(a){delete this.__errors[a];var e=this.cls.scheme(),f=e[a],g=f.validate;if(!g)return c.value(!0);b.is_array(g)||(g=[g]);var h=this.get(a),i=[];return d.iter(g,function(b){i.push(c.box(b.validate,b,[h,this,a]))},this),c.and(i).end().mapSuccess(function(b){var c=!0;return d.iter(b,function(b){null!==b&&(c=!1,this.__errors[a]=b)},this),this.trigger("validate:"+a,c,this.__errors[a]),c},this)},setError:function(a,b){this.__errors[a]=b,this.trigger("validate:"+a,!(a in this.__errors),this.__errors[a])},errors:function(){return this.__errors},getError:function(a){return this.__errors[a]},asRecord:function(a){var b={},c=this.cls.scheme(),e=this.get_all_properties();a=a||[];var f=function(f){var g=c[f].tags||[],h={};d.iter(g,function(a){h[a]=!0});var i=!0;d.iter(a,function(a){i=i&&a in h},this),i&&(b[f]=e[f])};for(var g in e)g in c&&f.call(this,g);return b},setByTags:function(a,b){var c=this.cls.scheme();b=b||{};var e=function(e){var f=c[e].tags||[],g={};d.iter(f,function(a){g[a]=!0});var h=!0;d.iter(b,function(a){h=h&&a in g},this),h&&this.set(e,a[e])};for(var f in a)f in c&&e.call(this,f)}}},{_initializeScheme:function(){return{}},asRecords:function(a,b){return a.map(function(a){return a.asRecord(b)})},filterPersistent:function(a){var c={},d=this.scheme();for(var e in a)b.is_defined(d[e].persistent)&&!d[e].persistent||!b.is_defined(a[e])||(c[e]=a[e]);return c}},{scheme:function(){return this.__scheme=this.__scheme||this._initializeScheme(),this.__scheme}})}),a.define("module:Modelling.AssociatedProperties",["module:Modelling.SchemedProperties"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b){a.constructor.call(this,b),this.assocs=this._initializeAssociations()},_initializeAssociations:function(){return{}},destroy:function(){for(var b in this.assocs)this.assocs[b].destroy();a.destroy.call(this)},id:function(){return this.get(this.cls.primary_key())},pid:function(){return this.id()},hasId:function(){return this.has(this.cls.primary_key())}}},{primary_key:function(){return"id"},_initializeScheme:function(){var a={};return a[this.primary_key()]={type:"id",tags:["read"],after_set:null,persistent:!0},a}})}),a.define("module:Modelling.Table",["base:Class","base:Events.EventsMixin","base:Objs","base:Types","base:Iterators.MappedIterator","base:Classes.ObjectCache","base:Promise"],function(b,c,d,e,f,g,h,i){return b.extend({scoped:i},[c,function(b){return{constructor:function(a,c,e){b.constructor.call(this),this.__store=a,this.__model_type=c,this.__options=d.extend({type_column:null,auto_create:!1,auto_update:!0,save_invalid:!1,cache_models:!1,can_weakly_remove:!1,active_models:!0},e||{}),this.__store.on("insert",function(a){this.trigger("create",a)},this),this.__store.on("update",function(a,b){var c=a[this.primary_key()];this.trigger("update",c,b,a),this.trigger("update:"+c,b)},this),this.__store.on("remove",function(a,b,c){this.trigger("remove",a,b,c),this.trigger("remove:"+a,b,c)},this),this.__options.cache_models&&(this.model_cache=this.auto_destroy(new g(function(a){return a.id()})))},modelClass:function(b){return b=b||this.__model_type,e.is_string(b)?a.getGlobal(b):b},newModel:function(a,b,c){b=this.modelClass(b);var d=new b(a,this,{},c);return this.__options.auto_create&&d.save(),this.model_cache&&(d.hasId()?this.model_cache.register(d):d.once("save",function(){this.model_cache.register(d)},this)),d},materialize:function(a,b){if(!a)return null;var c=this.modelClass(this.__options.type_column&&a[this.__options.type_column]?this.__options.type_column:null);if(this.model_cache){var d=this.model_cache.get(a[this.primary_key()]);if(d)return d.setAll(a),d}var e=new c(a,this,{newModel:!1},b);return this.model_cache&&this.model_cache.register(e),e},options:function(){return this.__options},store:function(){return this.__store},findById:function(a,b){return this.__store.get(a,b).mapSuccess(function(a){return this.materialize(a,b)},this)},findByIdStrict:function(a,b){return this.findById(a,b).mapSuccess(function(a){return a||h.error("Not found")})},findBy:function(a,b,c){return this.allBy(a,d.extend({limit:1},b),c).mapSuccess(function(a){var b=a.next();return a.destroy(),b})},findByStrict:function(a,b,c){return this.findBy(a,b,c).mapSuccess(function(a){return a||h.error("Not found")})},allBy:function(a,b,c){return this.__store.query(a,b,c).mapSuccess(function(a){return new f(a,function(a){return this.materialize(a,c)},this).auto_destroy(a,!0)},this)},primary_key:function(){return(e.is_string(this.__model_type)?a.getGlobal(this.__model_type):this.__model_type).primary_key()},all:function(a,b){return this.allBy({},a,b)},query:function(){return this.allBy.apply(this,arguments)},scheme:function(){return this.__model_type.scheme()},ensure_indices:function(){if(!("ensure_index"in this.__store))return!1;var a=this.scheme();for(var b in a)a[b].index&&this.__store.ensure_index(b);return!0}}}])}),a.define("module:Modelling.Validators.ConditionalValidator",["module:Modelling.Validators.Validator","base:Types"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(c,d){a.constructor.call(this),this.__condition=c,this.__validator=b.is_array(d)?d:[d]},validate:function(a,b){if(!this.__condition(a,b))return null;for(var c=0;c<this.__validator.length;++c){var d=this.__validator[c].validate(a,b);if(null!==d)return d}return null}}})}),a.define("module:Modelling.Validators.EmailValidator",["module:Modelling.Validators.Validator","base:Strings"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(b){a.constructor.call(this),this.__error_string=b||"Not a valid email address"},validate:function(a,c){return b.is_email_address(a)?null:this.__error_string}}})}),a.define("module:Modelling.Validators.LengthValidator",["module:Modelling.Validators.Validator","base:Types","base:Objs"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(b){a.constructor.call(this),b=c.extend({min_length:null,max_length:null,error_string:null,max_action:null},b),this.__min_length=b.min_length,this.__max_length=b.max_length,this.__error_string=b.error_string,this.__max_action=b.max_action,this.__error_string||(null!==this.__min_length?null!==this.__max_length?this.__error_string="Between "+this.__min_length+" and "+this.__max_length+" characters":this.__error_string="At least "+this.__min_length+" characters":null!==this.__max_length&&(this.__error_string="At most "+this.__max_length+" characters"))},validate:function(a,b,c){if(null!==this.__min_length&&(!a||a&&a.length<this.__min_length))return this.__error_string;var d=null;if(null!==this.__max_length&&a&&a.length>this.__max_length&&(d=this.__error_string,this.__max_action))switch(this.__max_action){case"truncate":b.set(c,a.substr(0,this.__max_length)),d=null;break;case"empty":b.set(c,""),d=null}return d}}})}),a.define("module:Modelling.Validators.PresentValidator",["module:Modelling.Validators.Validator","base:Types"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(b){a.constructor.call(this),this.__error_string=b||"Field is required"},validate:function(a,c){return b.is_null(a)||""===a?this.__error_string:null}}})}),a.define("module:Modelling.Validators.UniqueValidator",["module:Modelling.Validators.Validator"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b,c,d,e){a.constructor.call(this),this.__key=b,this.__error_string=c||"Key already present",this.__ignore_if_null=d,this.__query=e},validate:function(a,b){if(null==a&&this.__ignore_if_null)return null;var c={};return c[this.__key]=a,this.__query&&Array.isArray(this.__query)&&this.__query.forEach(function(a){a!==this.__key&&(c[a]=b.get(a))},this),b.table().findBy(c).mapSuccess(function(a){return!a||!b.isNew()&&b.id()==a.id()?null:this.__error_string},this)}}})}),a.define("module:Modelling.Validators.Validator",["base:Class"],function(a,b){return a.extend({scoped:b},{validate:function(a,b){return null}})}),a.define("module:Modelling.Validators.ValueValidator",["module:Modelling.Validators.Validator","base:Types"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(b){a.constructor.call(this),this.__values=b},validate:function(a,b){return this.__values.indexOf(a),null}}})})}).call(Scoped);