/*!
betajs-data - v1.0.9 - 2015-12-11
Copyright (c) Oliver Friedmann
MIT Software License.
*/
var Scoped=function(){function a(a){function b(a){return d.extend({route:null,parent:null,children:{},watchers:[],data:{},ready:!1,lazy:[]},a)}function c(a){if(!a.ready){if(a.parent&&!a.parent.ready)return void c(a.parent);if(a.route in a.parent.data){a.data=a.parent.data[a.route],a.ready=!0;for(var b=0;b<a.watchers.length;++b)a.watchers[b].callback.call(a.watchers[b].context||this,a.data);a.watchers=[];for(var d in a.children)c(a.children[d])}}}function e(b){if(!b.ready){b.parent&&!b.parent.ready&&e(b.parent),b.ready=!0,a.tree&&"object"==typeof b.parent.data&&(b.parent.data[b.route]=b.data);for(var c=0;c<b.watchers.length;++c)b.watchers[c].callback.call(b.watchers[c].context||this,b.data);b.watchers=[]}}function f(a,b){if("object"==typeof b)for(var d in b)a.data[d]=b[d],a.children[d]&&(a.children[d].data=b[d]);else a.data=b;e(a);for(var f in a.children)c(a.children[f])}function g(a){if(a.ready&&a.data)for(var b in a.data)delete a.data[b]}function h(a){if(!a)return k;for(var d=a.split("."),e=k,f=0;f<d.length;++f)d[f]in e.children?e=e.children[d[f]]:(e.children[d[f]]=b({parent:e,route:d[f]}),e=e.children[d[f]],c(e));return e}function i(a,b,c){if(a.ready)b.call(c||this,a.data);else if(a.watchers.push({callback:b,context:c}),a.lazy.length>0){var d=function(a){if(a.lazy.length>0){var b=a.lazy.shift();b.callback.call(b.context||this,a.data),d(a)}};d(a)}}function j(a,b,c){a=a||k,c=c||[],a.ready||c.push(b);for(var d in a.children){var e=a.children[d],f=(b?b+".":"")+e.route;c=j(e,f,c)}return c}a=d.extend({tree:!1,global:!1,root:{}},a);var k=b({ready:!0}),l=null;if(a.tree){if(a.global){try{window&&(l=window)}catch(m){}try{global&&(l=global)}catch(m){}}else l=a.root;k.data=l}return{extend:function(a,b){f(h(a),b)},set:function(a,b){var c=h(a);c.data&&g(c),f(c,b)},lazy:function(a,b,c){var d=h(a);d.ready?b(c||this,d.data):d.lazy.push({callback:b,context:c})},digest:function(a){c(h(a))},obtain:function(a,b,c){i(h(a),b,c)},unresolvedWatchers:function(a){return j(h(a),a)}}}function b(e,f,g,h){var i=null,j=[],k=a({tree:!0}),l=a({tree:!1}),m={global:{namespace:h},root:{namespace:g},local:{namespace:k},"default":{namespace:l},parent:{namespace:f},scope:{namespace:k,readonly:!1}},n=function(a,b,c){var e=d.matchArgs(a,{options:"object",namespaceLocator:!0,dependencies:"array",hiddenDependencies:"array",callback:!0,context:"object"}),f=d.extend({lazy:this.options.lazy},e.options||{}),g=this.resolve(e.namespaceLocator),h=function(){this.require(e.dependencies,e.hiddenDependencies,function(){if(arguments[arguments.length-1].ns=g,this.options.compile){for(var f=[],h=0;h<a.length;++h)f.push(d.stringify(a[h]));this.compiled+=this.options.ident+"."+b+"("+f.join(", ")+");\n\n"}var i=e.callback.apply(e.context||this,arguments);c.call(this,g,i)},this)};return f.lazy?g.namespace.lazy(g.path,h,this):h.apply(this),this};return{getGlobal:d.method(c,c.getPath),setGlobal:d.method(c,c.setPath),options:{lazy:!1,ident:"Scoped",compile:!1},compiled:"",nextScope:function(){return i||(i=b(this,k,g,h)),i},subScope:function(){var a=this.nextScope();return j.push(a),i=null,a},binding:function(b,c,e){if(!m[b]||!m[b].readonly){var f;f="string"!=d.typeOf(c)?{namespace:a({tree:!0,root:c}),path:null}:this.resolve(c),m[b]=d.extend(e,f)}return this},resolve:function(a){var b=a.split(":");if(1==b.length)return{namespace:l,path:b[0]};var c=m[b[0]];if(!c)throw"The namespace '"+b[0]+"' has not been defined (yet).";return{namespace:c.namespace,path:c.path&&b[1]?c.path+"."+b[1]:c.path||b[1]}},define:function(){return n.call(this,arguments,"define",function(a,b){a.namespace.set(a.path,b)})},extend:function(){return n.call(this,arguments,"extend",function(a,b){a.namespace.extend(a.path,b)})},condition:function(){return n.call(this,arguments,"condition",function(a,b){b&&a.namespace.set(a.path,b)})},require:function(){var a=d.matchArgs(arguments,{dependencies:"array",hiddenDependencies:"array",callback:"function",context:"object"});a.callback=a.callback||function(){};var b=a.dependencies||[],c=b.concat(a.hiddenDependencies||[]),e=c.length,f=[],g={};if(e)for(var h=function(b){this.i<f.length&&(f[this.i]=b),e--,0===e&&(f.push(g),a.callback.apply(a.context||this.ctx,f))},i=0;i<c.length;++i){var j=this.resolve(c[i]);i<b.length&&f.push(null),j.namespace.obtain(j.path,h,{ctx:this,i:i})}else f.push(g),a.callback.apply(a.context||this,f);return this},digest:function(a){var b=this.resolve(a);return b.namespace.digest(b.path),this},unresolved:function(a){var b=this.resolve(a);return b.namespace.unresolvedWatchers(b.path)}}}var c={get:function(a){return"undefined"!=typeof window?window[a]:"undefined"!=typeof global?global[a]:null},set:function(a,b){return"undefined"!=typeof window&&(window[a]=b),"undefined"!=typeof global&&(global[a]=b),b},setPath:function(a,b){var c=a.split(".");if(1==c.length)return this.set(a,b);for(var d=this.get(c[0])||this.set(c[0],{}),e=1;e<c.length-1;++e)c[e]in d||(d[c[e]]={}),d=d[c[e]];return d[c[c.length-1]]=b,b},getPath:function(a){var b=a.split(".");if(1==b.length)return this.get(a);for(var c=this.get(b[0]),d=1;d<b.length;++d){if(!c)return c;c=c[b[d]]}return c}},d={method:function(a,b){return function(){return b.apply(a,arguments)}},extend:function(a,b){a=a||{},b=b||{};for(var c in b)a[c]=b[c];return a},typeOf:function(a){return"[object Array]"===Object.prototype.toString.call(a)?"array":typeof a},isEmpty:function(a){if(null===a||"undefined"==typeof a)return!0;if("array"==this.typeOf(a))return 0===a.length;if("object"!=typeof a)return!1;for(var b in a)return!1;return!0},matchArgs:function(a,b){var c=0,d={};for(var e in b)b[e]===!0||this.typeOf(a[c])==b[e]?(d[e]=a[c],c++):"undefined"==this.typeOf(a[c])&&c++;return d},stringify:function(a){return"function"==this.typeOf(a)?""+a:JSON.stringify(a)}},e={__namespace:"Scoped",upgrade:function(a){var b=c.get(a||e.__namespace);if(b&&"object"==d.typeOf(b)&&b.guid==this.guid&&"string"==d.typeOf(b.version)){for(var f=this.version.split("."),g=b.version.split("."),h=!1,i=0;i<Math.min(f.length,g.length)&&(h=parseInt(f[i],10)>parseInt(g[i],10),f[i]==g[i]);++i);return h?this.attach(a):b}return this.attach(a)},attach:function(a){a&&(e.__namespace=a);var b=c.get(e.__namespace);return b==this?this:(e.__revert=b,c.set(e.__namespace,this),this)},detach:function(a){return a&&c.set(e.__namespace,null),"undefined"!=typeof e.__revert&&c.set(e.__namespace,e.__revert),delete e.__revert,this},exports:function(a,b,c){return a=a||("undefined"!=typeof module?module:null),"object"==typeof a&&a&&"exports"in a&&(c||a.exports==this||!a.exports||d.isEmpty(a.exports))&&(a.exports=b||this),this}},f=a({tree:!0,global:!0}),g=a({tree:!0}),h=b(null,g,g,f),i=d.extend(h,{guid:"4b6878ee-cb6a-46b3-94ac-27d91f58d666",version:"9.9436392609879",upgrade:e.upgrade,attach:e.attach,detach:e.detach,exports:e.exports});return i=i.upgrade(),i.exports(),i}.call(this);(function(){var a=this.subScope();a.binding("module","global:BetaJS.Data"),a.binding("base","global:BetaJS"),a.binding("json","global:JSON"),a.define("module:",function(){return{guid:"70ed7146-bb6d-4da4-97dc-5a8e2d23a23f",version:"55.1449878855558"}}),a.define("module:Queries.Constrained",["json:","module:Queries","base:Types","base:Objs","base:Tokens","base:Comparators"],function(a,b,c,d,e,f){return{rectify:function(a){var b="options"in a||"query"in a?a:{query:a};return d.extend({query:{},options:{}},b)},skipValidate:function(a,b){return"skip"in a&&b?b.skip:!0},limitValidate:function(a,b){return"limit"in a&&b?b.limit:!0},sortValidate:function(a,b){if("sort"in a){if(b&&!b.sort)return!1;if(b&&c.is_object(b.sort)){var e=d.all(a.sort,function(a,c){return c in b.sort});if(!e)return!1}}return!0},constraintsValidate:function(a,b){return d.all(["skip","limit","sort"],function(c){return this[c+"Validate"].call(this,a,b)},this)},validate:function(a,c){return a=this.rectify(a),this.constraintsValidate(a.options,c)&&b.validate(a.query,c.query||{})},fullConstrainedQueryCapabilities:function(a){return{query:a||b.fullQueryCapabilities(),skip:!0,limit:!0,sort:!0}},normalize:function(a){return a=this.rectify(a),{query:b.normalize(a.query),options:a.options}},serialize:function(b){return a.stringify(this.rectify(b))},unserialize:function(b){return a.parse(b)},hash:function(a){return e.simple_hash(this.serialize(a))},subsumizes:function(c,d){c=this.rectify(c),d=this.rectify(d);var e=c.options.skip||0,f=d.options.skip||0,g=c.options.limit||null,h=d.options.limit||null,i=c.options.sort,j=c.options.sort;if(e>f)return!1;if(g){if(!h)return!1;if(h+f>g+e)return!1}return(e||g)&&(i||j)&&a.stringify(i)!=a.stringify(j)?!1:b.subsumizes(c.query,d.query)},mergeable:function(c,d){if(c=this.rectify(c),d=this.rectify(d),b.serialize(c.query)!=b.serialize(d.query))return!1;var e=c.options,f=d.options;return a.stringify(e.sort||{})!=a.stringify(f.sort||{})?!1:"skip"in e?"skip"in f?e.skip<=f.skip?!e.limit||e.skip+e.limit>=f.skip:!f.limit||f.skip+f.limit>=e.skip:!f.limit||f.limit>=e.skip:!("skip"in f)||!e.limit||e.limit>=f.skip},merge:function(a,b){a=this.rectify(a),b=this.rectify(b);var c=a.options,d=b.options;return{query:a.query,options:{skip:"skip"in c&&"skip"in d?Math.min(c.skip,d.skip):null,limit:"limit"in c&&"limit"in d?Math.max(c.limit,d.limit):null,sort:a.sort}}}}}),a.define("module:Queries",["json:","base:Types","base:Sort","base:Objs","base:Class","base:Tokens","base:Iterators.ArrayIterator","base:Iterators.FilteredIterator","base:Strings","base:Comparators"],function(a,b,c,d,e,f,g,h,i,j){var k={$or:{evaluate_combine:d.exists},$and:{evaluate_combine:d.all}},l={$in:{target:"atoms",evaluate_combine:d.exists,evaluate_single:function(a,b){return a===b}},$gt:{target:"atom",evaluate_single:function(a,b){return a>b}},$lt:{target:"atom",evaluate_single:function(a,b){return b>a}},$gte:{target:"atom",evaluate_single:function(a,b){return a>=b}},$le:{target:"atom",evaluate_single:function(a,b){return b>=a}},$sw:{target:"atom",evaluate_single:function(a,c){return a===c||b.is_string(a)&&0===a.indexOf(c)}},$ct:{target:"atom",no_index_support:!0,evaluate_single:function(a,c){return a===c||b.is_string(a)&&a.indexOf(c)>=0}},$eq:{target:"atom",evaluate_single:function(a,b){return a===b}}};return d.iter(d.clone(l,1),function(a,b){var c=d.clone(a,1);c.evaluate_single=function(b,c){return a.evaluate_single(b.toLowerCase(),c.toLowerCase())},c.ignore_case=!0,l[b+"ic"]=c}),{SYNTAX_PAIR_KEYS:k,SYNTAX_CONDITION_KEYS:l,validate:function(a,b){return this.validate_query(a,b)},validate_atoms:function(a,c){return b.is_array(a)&&d.all(a,function(a){return this.validate_atom(a,c)},this)},validate_atom:function(a,b){return!b||!!b.atom},validate_queries:function(a,c){return b.is_array(a)&&d.all(a,function(a){return this.validate_query(a,c)},this)},validate_query:function(a,c){return b.is_object(a)&&d.all(a,function(a,b){return this.validate_pair(a,b,c)},this)},validate_pair:function(a,b,c){return b in this.SYNTAX_PAIR_KEYS?!c||c.bool&&b in c.bool?this.validate_queries(a,c):!1:this.validate_value(a,c)},is_query_atom:function(a){return null===a||!b.is_object(a)||d.all(a,function(a,b){return!(b in this.SYNTAX_CONDITION_KEYS)},this)},validate_value:function(a,b){return this.is_query_atom(a)?this.validate_atom(a,b):this.validate_conditions(a,b)},validate_conditions:function(a,c){return b.is_object(a)&&d.all(a,function(a,b){return this.validate_condition(a,b,c)},this)},validate_condition:function(a,b,c){if(c&&(!c.conditions||!(b in c.conditions)))return!1;var d=this.SYNTAX_CONDITION_KEYS[b];return d&&("atoms"===d.target?this.validate_atoms(a):this.validate_atom(a))},normalize:function(a){return c.deep_sort(a)},serialize:function(b){return a.stringify(b)},unserialize:function(b){return a.parse(b)},hash:function(a){return f.simple_hash(this.serialize(a))},dependencies:function(a){return d.keys(this.dependencies_query(a,{}))},dependencies_queries:function(a,b){return d.iter(a,function(a){b=this.dependencies_query(a,b)},this),b},dependencies_query:function(a,b){return d.iter(a,function(a,c){b=this.dependencies_pair(a,c,b)},this),b},dependencies_pair:function(a,b,c){return b in this.SYNTAX_PAIR_KEYS?this.dependencies_queries(a,c):this.dependencies_key(b,c)},dependencies_key:function(a,b){return b[a]=(b[a]||0)+1,b},evaluate:function(a,b){return this.evaluate_query(a,b)},evaluate_query:function(a,b){return d.all(a,function(a,c){return this.evaluate_pair(a,c,b)},this)},evaluate_pair:function(a,b,c){return b in this.SYNTAX_PAIR_KEYS?this.SYNTAX_PAIR_KEYS[b].evaluate_combine.call(d,a,function(a){return this.evaluate_query(a,c)},this):this.evaluate_value(a,c[b])},evaluate_value:function(a,b){return this.is_query_atom(a)?this.evaluate_atom(a,b):this.evaluate_conditions(a,b)},evaluate_atom:function(a,b){return a===b},evaluate_conditions:function(a,b){return d.all(a,function(a,c){return this.evaluate_condition(a,c,b)},this)},evaluate_condition:function(a,b,c){var e=this.SYNTAX_CONDITION_KEYS[b];return"atoms"===e.target?e.evaluate_combine.call(d,a,function(a){return e.evaluate_single.call(this,c,a)},this):e.evaluate_single.call(this,c,a)},subsumizes:function(a,c){if(!b.is_object(a)||!b.is_object)return a==c;for(var d in a)if(!(d in c&&this.subsumizes(a[d],c[d])))return!1;return!0},fullQueryCapabilities:function(){var a={};d.iter(this.SYNTAX_PAIR_KEYS,function(b,c){a[c]=!0});var b={};return d.iter(this.SYNTAX_CONDITION_KEYS,function(a,c){b[c]=!0}),{atom:!0,bool:a,conditions:b}},mergeConditions:function(a,c){b.is_object(a)||(a={$eq:a}),b.is_object(c)||(c={$eq:c});var e=!1,f=d.clone(a,1);return d.iter(c,function(a,b){if(e)return!1;if(b in f){var c=f[b];i.starts_with(b,"$eq")&&(e=!0),i.starts_with(b,"$in")&&(c=d.objectify(c),f[b]=[],e=!0,d.iter(a,function(a){c[a]&&(f[b].push(a),e=!1)})),i.starts_with(b,"$sw")&&(i.starts_with(c,a)?f[b]=a:i.starts_with(a,c)||(e=!0)),i.starts_with(b,"$gt")&&j.byValue(c,a)<0&&(f[b]=a),i.starts_with(b,"$lt")&&j.byValue(c,a)>0&&(f[b]=a)}else f[b]=a},this),e&&(f={$in:[]}),f},disjunctiveNormalForm:function(a,b){a=d.clone(a,1);var c=[];if(a.$or){var e=[];d.iter(a.$or,function(a){d.iter(this.disjunctiveNormalForm(a,b).$or,function(a){e.push(a)},this)},this),c.push(e),delete a.$or}a.$and&&(d.iter(a.$and,function(a){var e=[];d.iter(this.disjunctiveNormalForm(a,b).$or,function(a){e.push(a)},this),c.push(e)},this),delete a.$and);var f=[],g=function(a,e){e<c.length?d.iter(c[e],function(c){var f=d.clone(a,1);d.iter(c,function(a,c){c in f?b?f[c]=this.mergeConditions(f[c],a):(f.$and||(f.$and=[]),f.$and.push(d.objectBy(c,a))):f[c]=a},this),g(f,e+1)},this):f.push(a)};return g(a,0),{$or:f}},simplifyQuery:function(a){var c={};return d.iter(a,function(a,e){if(e in this.SYNTAX_PAIR_KEYS){var f=[],g=!1;d.iter(a,function(a){var c=this.simplifyQuery(a);b.is_empty(c)?g=!0:f.push(c)},this),("$and"===e&&f.length>0||"$or"===e&&!g)&&(c[e]=f)}else{var h=this.simplifyConditions(a);b.is_empty(h)||(c[e]=h)}},this),c},simplifyConditions:function(a){var b={};return d.iter(["","ic"],function(c){if(a["$eq"+c]||a["$in"+c]){var e=d.filter(a["$eq"+c]?[a["$eq"+c]]:a["$in"+c],function(b){return this.evaluate_conditions(a,b)},this);b[(1===e.length?"$eq":"$in")+c]=1===e.length?e[0]:e}else{var f=null,g=null,h=!1,i=!1,k=j.byValue;if(a["$gt"+c]&&(f=a["$gt"+c]),a["$lt"+c]&&(f=a["$lt"+c]),a["$gte"+c]&&(null===f||k(f,a["$gte"+c])<0)&&(i=!0,f=a["$gte"+c]),a["$lte"+c]&&(null===g||k(g,a["$lte"+c])>0)&&(h=!0,g=a["$lte"+c]),a["$sw"+c]){var l=a["$sw"+c];(null===f||k(f,l)<=0)&&(i=!0,f=l);var m=null;"number"==typeof l?m=l+1:"string"==typeof l&&l.length>0&&(m=l.substring(0,l.length-1)+String.fromCharCode(l.charCodeAt(l.length-1)+1)),null!==m&&(null===g||k(g,m)>=0)&&(h=!0,g=m)}null!==g&&(b[(h?"$lte":"$lt")+c]=g),null!==f&&(b[(i?"$gte":"$gt")+c]=f),a["$ct"+c]&&(b["$ct"+c]=a["$ct"+c])}},this),b},mapKeyValue:function(a,b,c){return this.mapKeyValueQuery(a,b,c)},mapKeyValueQuery:function(a,b,c){var e={};return d.iter(a,function(a,f){e=d.extend(e,this.mapKeyValuePair(a,f,b,c))},this),e},mapKeyValueQueries:function(a,b,c){return d.map(a,function(a){return this.mapKeyValueQuery(a,b,c)},this)},mapKeyValuePair:function(a,b,c,e){if(b in this.SYNTAX_PAIR_KEYS)return d.objectBy(b,this.mapKeyValueQueries(a,c,e));if(this.is_query_atom(a))return c.call(e,b,a);var f={};return d.iter(a,function(a,d){f[d]=this.mapKeyValueCondition(a,b,c,e)},this),Obj.objectBy(b,f)},mapKeyValueCondition:function(a,c,e,f){var g=b.is_array(a);g||(a=[a]);var h=d.map(a,function(a){return d.peek(e.call(f,c,a))},this);return g?h:h[0]}}}),a.define("module:Queries.Engine",["module:Queries","module:Queries.Constrained","base:Strings","base:Types","base:Objs","base:Promise","base:Comparators","base:Iterators.SkipIterator","base:Iterators.LimitIterator","base:Iterators.SortedIterator","base:Iterators.FilteredIterator","base:Iterators.SortedOrIterator","base:Iterators.PartiallySortedIterator","base:Iterators.ArrayIterator","base:Iterators.LazyMultiArrayIterator"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){return{indexQueryConditionsSize:function(a,b,c){var d=c?"ic":"",e=c?"_ic":"",f=b.info(),g=f.row_count,h=f.row_count/Math.max(f["key_count"+e],1);if(a["$eq"+d])g=h;else if(a["$in"+d])g=h*a["$in"+d].length;else{var i=0,j=null;(a["$gt"+d]||a["$gte"+d])&&(j=a["$gt"+d]||a["$gte"+d],a["$gt"+d]&&i--);var k=null;(a["$lt"+d]||a["$lte"+d])&&(k=a["$lt"+d]||a["$lte"+d],a["$lt"+d]&&i--),null!==j&&null!==k?i+=b["key_count_distance"+e](j,k):null!==j?i+=b["key_count_right"+e](j):null!==k&&(i+=b["key_count_left"+e](k)),g=i*h}return g},indexQuerySize:function(a,b,c){var d=0,f=c.info();return e.iter(a.$or,function(a){if(!(b in a))return d=null,!1;var e=a[b],g=f.row_count;c.options().exact&&(g=Math.min(g,this.indexQueryConditionsSize(e,c,!1))),c.options().ignoreCase&&(g=Math.min(g,this.indexQueryConditionsSize(e,c,!0))),d+=g},this),d},queryPartially:function(a,c){var d={query:a.query,options:{}};if(a.options.sort){var f=e.ithKey(a.options.sort,0);d.options.sort={},d.options.sort[f]=a.options.sort[f]}return b.validate(d,c)},compileQuery:function(c,d,e,f){c=b.rectify(c);var l=b.sortValidate(c.options,d),m=a.validate(c.query,d.query||{}),n=b.skipValidate(c.options,d),o=b.limitValidate(c.options,d),p={skip:null,limit:null,filter:null,sort:null};m&&l&&n||(p.skip=c.options.skip,delete c.options.skip,"limit"in c.options&&o&&m&&l&&(c.options.limit+=p.skip)),m&&l&&o||(p.limit=c.options.limit,delete c.options.limit),l||(p.sort=c.options.sort,delete c.options.sort),m||(p.filter=c.query,c.query={});var q=e.call(f,c);return q.mapSuccess(function(b){return b=this._queryResultRectify(b,!1),p.filter&&(b=new k(b,function(b){return a.evaluate(p.filter,b)})),p.sort&&(b=new j(b,g.byObject(p.sort))),p.skip&&(b=new h(b,p.skip)),p.limit&&(b=new i(b,p.limit)),b},this)},compileIndexQuery:function(b,c,d){var p,q=e.exists(b.query.$or,function(a){return!(c in a)}),r=b.options.sort&&e.ithKey(b.options.sort,0)===c,s=r?b.options.sort[c]:1,t=!d.options().exact;if(q){var u=[];d["itemIterate"+(t?"_ic":"")](null,s,function(a,b){u.push(b)}),p=new n(u)}else p=new l(e.map(b.query.$or,function(a){var b=a[c];!r&&d.options().ignoreCase&&d.options().exact&&this.indexQueryConditionsSize(b,d,!0)<this.indexQueryConditionsSize(b,d,!1)&&(t=!0);var e=t?"ic":"",f=t?"_ic":"";if(b["$eq"+e]){var g=[];d["itemIterate"+f](b["$eq"+e],s,function(a,c){return a!==b["$eq"+e]?!1:void g.push(c)}),p=new n(g)}else if(b["$in"+e]){var h=0;p=new o(function(){if(h>=b["$in"+e].length)return null;var a=[];return d["itemIterate"+f](b["$in"+e][h],s,function(c,d){return c!==b["in"+e][h]?!1:void a.push(d)}),h++,a})}else{var i=null,j=null;if((b["$gt"+e]||b["$gte"+e])&&(i=b["$gt"+e]||b["$gte"+e]),(b["$lt"+e]||b["$lte"+e])&&(j=b["$lt"+e]||b["$lte"+e]),0>s){var k=i;i=j,j=k}p=new o(function(){return null!==i&&null!==j&&Math.sign(d.comparator()(i,j))===Math.sign(s)?null:(d["itemIterate"+f](i,s,function(a,b){return null===i&&(i=a),a!==i?(i=a,!1):void g.push(b)}),g)})}return p},this),d.comparator());return p=new k(p,function(c){return a.evaluate(b.query,c)}),b.options.sort&&(p=r?new m(p,g.byObject(b.options.sort),function(a,b){return a[c]===b[c]}):new j(p,g.byObject(b.options.sort))),b.options.skip&&(p=new h(p,b.options.skip)),b.options.limit&&(p=new i(p,b.options.limit)),f.value(p)},compileIndexedQuery:function(c,f,g,h,i){if(c=b.rectify(c),i=i||{},this.queryPartially(c,f)||d.is_empty(i))return this.compileQuery(c,f,g,h);if(c.options.sort){var j=e.ithKey(c.options.sort,0);if(i[j])return this.compileIndexQuery({query:a.simplifyQuery(a.disjunctiveNormalForm(c.query,!0)),options:c.options},j,i[j])}var k=a.simplifyQuery(a.disjunctiveNormalForm(c.query,!0)),l=null,m=null;return e.iter(i,function(a,b){var c=this.indexQuerySize(k,b,a);null!==c&&(null===l||l>c)&&(l=c,m=b)},this),null!==m?this.compileIndexQuery({query:k,options:c.options},m,i[m]):this.compileQuery(c,f,g,h)},_queryResultRectify:function(a,b){return a=a||[],d.is_array(a)==b?a:b?a.asArray():new n(a)}}}),a.define("module:Stores.AssocStore",["module:Stores.BaseStore","base:Promise","base:Objs"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{_read_key:function(a){},_write_key:function(a,b){},_remove_key:function(a){},_iterate:function(){},constructor:function(b){b=b||{},b.create_ids=!0,a.constructor.call(this,b)},_insert:function(a){return b.tryCatch(function(){return this._write_key(a[this._id_key],a),a},this)},_remove:function(a){return b.tryCatch(function(){var b=this._read_key(a);return b&&!this._remove_key(a)?null:b},this)},_get:function(a){return b.tryCatch(function(){return this._read_key(a)},this)},_update:function(a,d){return b.tryCatch(function(){var b=this._read_key(a);return b&&(this._id_key in d&&(this._remove_key(a),a=d[this._id_key],delete d[this._id_key]),c.extend(b,d),this._write_key(a,b)),b},this)},_query:function(a,c){return b.tryCatch(function(){return this._iterate()},this)}}})}),a.define("module:Stores.MemoryStore",["module:Stores.AssocStore","base:Iterators.ObjectValuesIterator","base:Objs"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(b){a.constructor.call(this,b),this.__data={}},_read_key:function(a){return this.__data[a]},_write_key:function(a,b){this.__data[a]=b},_remove_key:function(a){delete this.__data[a]},_iterate:function(){return new b(this.__data)},_count:function(b){return b?a._count.call(this,b):c.count(this.__data)}}})}),a.define("module:Stores.BaseStore",["base:Class","base:Events.EventsMixin","module:Stores.ReadStoreMixin","module:Stores.WriteStoreMixin","base:Promise"],function(a,b,c,d,e,f){return a.extend({scoped:f},[b,c,d,function(a){return{constructor:function(b){a.constructor.call(this),this._initializeReadStore(b),this._initializeWriteStore(b)},_ensure_index:function(a){},ensure_index:function(a){return this._ensure_index(a)},clear:function(a){return this.query(null,null,a).mapSuccess(function(b){for(var c=e.and();b.hasNext();){var d=b.next();c=c.and(this.remove(d[this._id_key],a))}return c},this)}}}])}),a.define("module:Stores.ReadStoreMixin",["module:Queries.Engine","module:Stores.StoreException","base:Promise","base:Objs"],function(a,b,c,d){return{_initializeReadStore:function(a){a=a||{},this.indices={},this._watcher=a.watcher||null,this._capabilities=a.capabilities||{}},watcher:function(){return this._watcher},_get:function(a,d){return c.create(null,new b("unsupported: get"))},_query_capabilities:function(){return this._capabilities},_query:function(a,d,e){return c.create(null,new b("unsupported: query"))},get:function(a,b){return this._get(a,b)},count:function(a,b){return this._count(a,b)},_count:function(a,b){return this.query(a,{},b).mapSuccess(function(a){return a.asArray().length})},query:function(b,c,e){return b=d.clone(b||{},-1),c=d.clone(c,-1),c&&(c.limit&&(c.limit=parseInt(c.limit,10)),c.skip&&(c.skip=parseInt(c.skip,10))),a.compileIndexedQuery({query:b,options:c||{}},this._query_capabilities(),function(a){return this._query(a.query,a.options,e)},this,this.indices)}}}),a.define("module:Stores.ReadStore",["base:Class","module:Stores.ReadStoreMixin"],function(a,b,c){return a.extend({scoped:c},[b,function(a){return{constructor:function(b){a.constructor.call(this),this._initializeReadStore(b)}}}])}),a.define("module:Stores.StoreException",["base:Exceptions.Exception"],function(a,b){return a.extend({scoped:b},{})}),a.define("module:Stores.StoreHistory",["base:Class","base:Objs","base:Types","module:Stores.MemoryStore"],function(a,b,c,d,e){return a.extend({scoped:e},function(a){return{constructor:function(c,e,f){a.constructor.call(this),this._options=b.extend({combine_update_update:!1,combine_insert_update:!1,combine_insert_remove:!1,combine_update_remove:!1,source_id_key:c?c.id_key():"id",row_data:{},filter_data:{}},f),this.historyStore=e||new d,this.commitId=1,c&&(c.on("insert",this.sourceInsert,this),c.on("remove",this.sourceRemove,this),c.on("update",this.sourceUpdate,this))},sourceInsert:function(a){this.commitId++,this.historyStore.insert(b.extend({row:a,type:"insert",row_id:a[this._options.source_id_key],commit_id:this.commitId},this._options.row_data))},sourceUpdate:function(a,d){this.commitId++;var e=c.is_object(a)?a[this._options.source_id_key]:a,f="update";if(this._options.combine_insert_update||this._options.combine_update_update){var g=[];this._options.combine_insert_update&&g.push("insert"),this._options.combine_update_update&&g.push("update");for(var h={},i=[],j=this.historyStore.query(b.extend({type:{$or:g},row_id:e},this._options.filter_data),{sort:{commit_id:1}}).value();j.hasNext();){var k=j.next();"insert"===k.type&&(f="insert"),h=b.extend(h,k.row),i.push(this.historyStore.id_of(k))}d=b.extend(h,d),b.iter(i,this.historyStore.remove,this.historyStore)}this.historyStore.insert(b.extend({row:d,type:f,row_id:e,commit_id:this.commitId},this._options.row_data))},sourceRemove:function(a){if(this.commitId++,this._options.combine_insert_remove&&this.historyStore.query(b.extend({type:"insert",row_id:a},this._options.filter_data)).value().hasNext())for(var c=this.historyStore.query(b.extend({row_id:a},this._options.filter_data)).value();c.hasNext();)this.historyStore.remove(this.historyStore.id_of(c.next()));else{if(this._options.combine_update_remove)for(var d=this.historyStore.query(b.extend({type:"update",row_id:a},this._options.filter_data)).value();d.hasNext();)this.historyStore.remove(this.historyStore.id_of(d.next()));this.historyStore.insert(b.extend({type:"remove",row_id:a,commit_id:this.commitId},this._options.row_data))}}}})}),a.define("module:Stores.WriteStoreMixin",["module:Stores.StoreException","base:Promise","base:IdGenerators.TimedIdGenerator","base:Types"],function(a,b,c,d){return{_initializeWriteStore:function(a){a=a||{},this._id_key=a.id_key||"id",this._create_ids=a.create_ids||!1,this._create_ids&&(this._id_generator=a.id_generator||this._auto_destroy(new c))},id_key:function(){return this._id_key},id_of:function(a){return a[this.id_key()]},id_row:function(a){var b={};return b[this._id_key]=a,b},_inserted:function(a,b){this.trigger("insert",a,b),this.trigger("write","insert",a,b)},_removed:function(a,b){this.trigger("remove",a,b),this.trigger("write","remove",a,b)},_updated:function(a,b,c){this.trigger("update",a,b,c),this.trigger("write","update",a,b,c)},insert_all:function(a,c){for(var d=b.and(),e=0;e<a.length;++e)d=d.and(this.insert(a[e],c));return d.end()},_insert:function(c,d){return b.create(null,new a("unsupported: insert"))},_remove:function(c,d){return b.create(null,new a("unsupported: remove"))},_update:function(c,d,e){return b.create(null,new a("unsupported: update"))},insert:function(c,d){return c?(!this._create_ids||this._id_key in c&&c[this._id_key]||(c[this._id_key]=this._id_generator.generate()),this._insert(c,d).success(function(a){this._inserted(a,d)},this)):b.create(null,new a("empty insert"))},remove:function(a,b){return this._remove(a,b).success(function(){this._removed(a,b)},this)},update:function(a,b,c){return this._update(a,b,c).success(function(a){this._updated(a,b,c)},this)}}}),a.define("module:Stores.WriteStore",["base:Class","base:Events.EventsMixin","module:Stores.WriteStoreMixin"],function(a,b,c,d){return a.extend({scoped:d},[b,c,function(a){return{constructor:function(b){a.constructor.call(this),this._initializeWriteStore(b)},_ensure_index:function(a){},ensure_index:function(a){return this._ensure_index(a)}}}])}),a.define("module:Stores.ContextualizedStore",["module:Stores.BaseStore","base:Iterators.MappedIterator","base:Promise"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(b,c){this.__store=b,c=c||{},c.id_key=b.id_key(),this.__context=c.context||this,this.__decode=c.decode,this.__encode=c.encode,a.constructor.call(this,c),c.destroy_store&&this._auto_destroy(b)},_decode:function(a){return this.__decode.call(this.__context,a)},_encode:function(a,b){return this.__encode.call(this.__context,a,b)},_decodeId:function(a){var b=this._decode(this.id_row(a));return{id:this.id_of(b.data),ctx:b.ctx}},_query_capabilities:function(){return this.__store._query_capabilities()},_insert:function(a){var b=this._decode(a);return this.__store.insert(b.data,b.ctx).mapSuccess(function(a){return this._encode(a,b.ctx)},this)},_remove:function(a){var b=this._decodeId(a);return this.__store.remove(b.id,b.ctx).mapSuccess(function(){return a},this)},_get:function(a){var b=this._decodeId(a);return this.__store.get(b.id,b.ctx).mapSuccess(function(a){return this._encode(a,b.ctx)},this)},_update:function(a,b){var c=this._decodeId(a);this.__store.update(c.id,b,c.ctx).mapSuccess(function(a){return a},this)},_query:function(a,c){var d=this._decode(a);return this.__store.query(d.data,c,d.ctx).mapSuccess(function(a){return new b(a,function(a){return this._encode(a,d.ctx)},this)},this)},_ensure_index:function(a){return this.__store.ensure_index(a)},_store:function(){return this.__store}}})}),a.define("module:Stores.DecontextualizedSelectStore",["module:Stores.BaseStore","base:Iterators.MappedIterator","base:Promise","base:Objs"],function(a,b,c,d,e){return a.extend({scoped:e},function(a){return{constructor:function(b,c){this.__store=b,c=c||{},c.id_key=b.id_key(),a.constructor.call(this,c),c.destroy_store&&this._auto_destroy(b)},_decode:function(a,b){return a=d.clone(a,1),d.iter(b,function(b,c){delete a[c]}),a},_encode:function(a,b){return d.extend(d.clone(a,1),b)},_query_capabilities:function(){return this.__store._query_capabilities()},_insert:function(a,b){return this.__store.insert(this._encode(a,b)).mapSuccess(function(a){return this._decode(a,b)},this)},_query:function(a,c,d){return this.__store.query(this._encode(a,d),c).mapSuccess(function(a){return new b(a,function(a){return this._decode(a,d)},this)},this)},_ensure_index:function(a){return this.__store.ensure_index(a)},_store:function(){return this.__store},_get:function(a,b){return this.query(this.id_row(a),{limit:1},b).mapSuccess(function(a){return a.hasNext()?this._decode(a.next(),b):null},this)},_remove:function(a,b){return this.query(this.id_row(a),{limit:1},b).mapSuccess(function(a){return a.hasNext()?this.__store.remove(this.__store.id_of(this._decode(a.next(),b))):null},this)},_update:function(a,b,c){return this.query(this.id_row(a),{limit:1},c).mapSuccess(function(a){return a.hasNext()?this.__store.update(this.__store.id_of(this._decode(a.next(),c)),b):null},this)}}})}),a.define("module:Stores.MultiplexerStore",["module:Stores.BaseStore","module:Queries.Constrained","base:Promise"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(b){a.constructor.call(this,b),this.__context=b.context||this,this.__acquireStore=b.acquireStore,this.__releaseStore=b.releaseStore,this.__mapContext=b.mapContext},_acquireStore:function(a){return c.value(this.__acquireStore?this.__acquireStore.call(this.__context,a):a)},_releaseStore:function(a,b){this.__releaseStore&&this.__releaseStore.call(this.__context,a,b)},_mapContext:function(a){return this.__mapContext?this.__mapContext.call(this.__context,a):null},_query_capabilities:function(){return b.fullConstrainedQueryCapabilities()},_insert:function(a,b){return this._acquireStore(b).mapSuccess(function(c){
return c.insert(a,this._mapContext(b)).callback(function(){this._releaseStore(b,c)},this)},this)},_remove:function(a,b){return this._acquireStore(b).mapSuccess(function(c){return c.remove(a,this._mapContext(b)).callback(function(){this._releaseStore(b,c)},this)},this)},_update:function(a,b,c){return this._acquireStore(c).mapSuccess(function(d){return d.update(a,b,this._mapContext(c)).callback(function(){this._releaseStore(c,d)},this)},this)},_get:function(a,b){return this._acquireStore(b).mapSuccess(function(c){return c.get(a,this._mapContext(b)).callback(function(){this._releaseStore(b,c)},this)},this)},_query:function(a,b,c){return this._acquireStore(c).mapSuccess(function(d){return d.query(a,b,this._mapContext(c)).callback(function(){this._releaseStore(c,d)},this)},this)}}})}),a.define("module:Stores.PassthroughStore",["module:Stores.BaseStore","base:Promise"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(b,c){this.__store=b,c=c||{},c.id_key=b.id_key(),a.constructor.call(this,c),c.destroy_store&&this._auto_destroy(b)},_query_capabilities:function(){return this.__store._query_capabilities()},_insert:function(a){return this._preInsert(a).mapSuccess(function(a){return this.__store.insert(a).mapSuccess(function(a){return this._postInsert(a)},this)},this)},_remove:function(a){return this._preRemove(a).mapSuccess(function(a){return this.__store.remove(a).mapSuccess(function(){return this._postRemove(a)},this)},this)},_get:function(a){return this._preGet(a).mapSuccess(function(a){return this.__store.get(a).mapSuccess(function(a){return this._postGet(a)},this)},this)},_update:function(a,b){return this._preUpdate(a,b).mapSuccess(function(a){return this.__store.update(a.id,a.data).mapSuccess(function(a){return this._postUpdate(a)},this)},this)},_query:function(a,b){return this._preQuery(a,b).mapSuccess(function(a){return this.__store.query(a.query,a.options).mapSuccess(function(a){return this._postQuery(a)},this)},this)},_ensure_index:function(a){return this.__store.ensure_index(a)},_store:function(){return this.__store},_preInsert:function(a){return b.create(a)},_postInsert:function(a){return b.create(a)},_preRemove:function(a){return b.create(a)},_postRemove:function(a){return b.create(!0)},_preGet:function(a){return b.create(a)},_postGet:function(a){return b.create(a)},_preUpdate:function(a,c){return b.create({id:a,data:c})},_postUpdate:function(a){return b.create(a)},_preQuery:function(a,c){return b.create({query:a,options:c})},_postQuery:function(a){return b.create(a)}}})}),a.define("module:Stores.ReadyStore",["module:Stores.PassthroughStore","base:Promise","base:Objs"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{__promises:[],__ready:!1,ready:function(){this.__ready=!0,c.iter(this.__promises,function(a){a.promise.forwardCallback(a.stalling)}),this.__promises=[]},__execute:function(a){if(this.__ready)return a;var c=b.create();this.__promises.push({stalling:c,promise:a})},_preInsert:function(){return this.__execute(a._preInsert.apply(this,arguments))},_preRemove:function(){return this.__execute(a._preRemove.apply(this,arguments))},_preGet:function(){return this.__execute(a._preGet.apply(this,arguments))},_preUpdate:function(){return this.__execute(a._preUpdate.apply(this,arguments))},_preQuery:function(){return this.__execute(a._preQuery.apply(this,arguments))}}})}),a.define("module:Stores.ResilientStore",["module:Stores.BaseStore","base:Promise"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(b,c){this.__store=b,c=c||{},c.id_key=b.id_key(),a.constructor.call(this,c),this._resilience=c.resilience||10,c.destroy_store&&this._auto_destroy(b)},_query_capabilities:function(){return this.__store._query_capabilities()},_insert:function(){return b.resilientCall(this._store.insert,this._store,this._resilience,arguments)},_remove:function(){return b.resilientCall(this._store.remove,this._store,this._resilience,arguments)},_get:function(){return b.resilientCall(this._store.get,this._store,this._resilience,arguments)},_update:function(a,c){return b.resilientCall(this._store.update,this._store,this._resilience,arguments)},_query:function(a,c){return b.resilientCall(this._store.update,this._store,this._resilience,arguments)},_ensure_index:function(a){return this.__store.ensure_index(a)},_store:function(){return this.__store}}})}),a.define("module:Stores.SimulatorStore",["module:Stores.PassthroughStore","base:Promise"],function(a,b,c){return a.extend({scoped:c},function(a){return{online:!0,_preInsert:function(){return this.online?a._preInsert.apply(this,arguments):b.error("Offline")},_preRemove:function(){return this.online?a._preRemove.apply(this,arguments):b.error("Offline")},_preGet:function(){return this.online?a._preGet.apply(this,arguments):b.error("Offline")},_preUpdate:function(){return this.online?a._preUpdate.apply(this,arguments):b.error("Offline")},_preQuery:function(){return this.online?a._preQuery.apply(this,arguments):b.error("Offline")}}})}),a.define("module:Stores.TableStore",["module:Stores.BaseStore","base:Iterators.MappedIterator","module:Queries.Constrained"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(b,c){this.__table=b,c=c||{},c.id_key=b.primary_key(),a.constructor.call(this,c),this.__options={insertTags:c.insertTags||[],readTags:c.readTags||[],updateTags:c.updateTags||[]}},_query_capabilities:function(){return c.fullConstrainedQueryCapabilities()},_insert:function(a,b){var c=this.__table.newModel({},null,b);return c.setAllByTags(a,this.__options.insertTags),c.save().mapSuccess(function(){return c.asRecord(this.__options.readTags)},this)},_remove:function(a,b){return this.__table.findById(a,b).mapSuccess(function(a){return a?a.remove():a},this)},_get:function(a,b){return this.__table.findById(a,b).mapSuccess(function(a){return a?a.asRecord(this.__options.readTags):a},this)},_update:function(a,b,c){return this.__table.findById(a,c).mapSuccess(function(a){return a?(a.setByTags(b,this.__options.updateTags),a.save().mapSuccess(function(){return a.asRecord(this.__options.readTags)},this)):a},this)},_query:function(a,c,d){return this.__table.query(a,c,d).mapSuccess(function(a){return new b(a,function(a){return a.asRecord(this.__options.readTags)},this)},this)}}})}),a.define("module:Stores.TransformationStore",["module:Stores.PassthroughStore","module:Queries","base:Iterators.MappedIterator","base:Objs","base:Types","base:Promise"],function(a,b,c,d,e,f,g){return a.extend({scoped:g},function(a){return{_encodeData:function(a){return a},_decodeData:function(a){return a},_encodeId:function(a){return this.id_of(this._encodeData(d.objectBy(this.id_key(),a)))},_decodeId:function(a){return this.id_of(this._decodeData(d.objectBy(this.id_key(),a)))},_encodeQuery:function(a,c){var f=d.clone(c);return f.sort&&(f.sort=e.is_object(f.sort)?this._encodeData(f.sort):{}),{query:b.mapKeyValue(a,function(a,b){return this._encodeData(d.objectBy(a,b))},this),options:f}},_preInsert:function(a){return f.create(this._encodeData(a))},_postInsert:function(a){return f.create(this._decodeData(a))},_preRemove:function(a){return f.create(this._encodeId(a))},_postRemove:function(a){return f.create(!0)},_preGet:function(a){return f.create(this._encodeId(a))},_postGet:function(a){return f.create(this._decodeData(a))},_preUpdate:function(a,b){return f.create({id:this._encodeId(a),data:this._encodeData(b)})},_postUpdate:function(a){return f.create(this._decodeData(a))},_preQuery:function(a,b){return f.create(this._encodeQuery(a,b))},_postQuery:function(a){return f.create(new c(a,function(a){return this._decodeData(a)},this))}}})}),a.define("module:Stores.AssocDumbStore",["module:Stores.DumbStore"],function(a,b){return a.extend({scoped:b},{_read_key:function(a){},_write_key:function(a,b){},_remove_key:function(a){},__read_id:function(a){var b=this._read_key(a);return b?parseInt(b,10):null},_read_last_id:function(){return this.__read_id("last_id")},_write_last_id:function(a){this._write_key("last_id",a)},_remove_last_id:function(){this._remove_key("last_id")},_read_first_id:function(){return this.__read_id("first_id")},_write_first_id:function(a){this._write_key("first_id",a)},_remove_first_id:function(){this._remove_key("first_id")},_read_item:function(a){return this._read_key("item_"+a)},_write_item:function(a,b){this._write_key("item_"+a,b)},_remove_item:function(a){this._remove_key("item_"+a)},_read_next_id:function(a){return this.__read_id("next_"+a)},_write_next_id:function(a,b){this._write_key("next_"+a,b)},_remove_next_id:function(a){this._remove_key("next_"+a)},_read_prev_id:function(a){return this.__read_id("prev_"+a)},_write_prev_id:function(a,b){this._write_key("prev_"+a,b)},_remove_prev_id:function(a){this._remove_key("prev_"+a)}})}),a.define("module:Stores.DumbStore",["module:Stores.BaseStore","base:Promise","base:Objs","base:Iterators.Iterator"],function(a,b,c,d,e){return a.extend({scoped:e},function(a){return{_read_last_id:function(){},_write_last_id:function(a){},_remove_last_id:function(){},_read_first_id:function(){},_write_first_id:function(a){},_remove_first_id:function(){},_read_item:function(a){},_write_item:function(a,b){},_remove_item:function(a){},_read_next_id:function(a){},_write_next_id:function(a,b){},_remove_next_id:function(a){},_read_prev_id:function(a){},_write_prev_id:function(a,b){},_remove_prev_id:function(a){},constructor:function(b){b=b||{},b.create_ids=!0,a.constructor.call(this,b)},_insert:function(a){return b.tryCatch(function(){var b=this._read_last_id(),c=a[this._id_key];return null!==b?(this._write_next_id(b,c),this._write_prev_id(c,b)):this._write_first_id(c),this._write_last_id(c),this._write_item(c,a),a},this)},_remove:function(a){return b.tryCatch(function(){var b=this._read_item(a);if(b){this._remove_item(a);var c=this._read_next_id(a),d=this._read_prev_id(a);null!==c?(this._remove_next_id(a),null!==d?(this._remove_prev_id(a),this._write_next_id(d,c),this._write_prev_id(c,d)):(this._remove_prev_id(c),this._write_first_id(c))):null!==d?(this._remove_next_id(d),this._write_last_id(d)):(this._remove_first_id(),this._remove_last_id())}return b},this)},_get:function(a){return b.tryCatch(function(){return this._read_item(a)},this)},_update:function(a,d){return b.tryCatch(function(){var b=this._get(a);return b&&(delete d[this._id_key],c.extend(b,d),this._write_item(a,b)),b},this)},_query:function(a,e){return b.tryCatch(function(){var b=new d,e=this,f=this._read_first_id();return c.extend(b,{__id:null===f?1:f,__store:e,__query:a,hasNext:function(){var a=this.__store._read_last_id();if(null===a)return!1;for(;this.__id<a&&!this.__store._read_item(this.__id);)this.__id++;return this.__id<=a},next:function(){if(this.hasNext()){var a=this.__store.get(this.__id);return this.__id==this.__store._read_last_id()?this.__id++:this.__id=this.__store._read_next_id(this.__id),a}return null}}),b},this)}}})}),a.define("module:Stores.LocalStore",["module:Stores.AssocDumbStore","json:"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(b,c){a.constructor.call(this,b),this.__prefix=b.prefix,this.__localStorage=c},__key:function(a){return this.__prefix+a},_read_key:function(a){var c=this.__key(a);return c in this.__localStorage?b.parse(this.__localStorage[c]):null},_write_key:function(a,c){this.__localStorage[this.__key(a)]=b.stringify(c)},_remove_key:function(a){delete this.__localStorage[this.__key(a)]}}})}),a.define("module:Stores.Invokers.RestInvokeeAjaxInvoker",["base:Class","base:Net.Uri","base:Net.HttpHeader","module:Stores.Invokers.RestInvokee"],function(a,b,c,d,e){return a.extend({scoped:e},[d,function(a){return{constructor:function(b){a.constructor.call(this),this.__ajax=b},restInvoke:function(a,d,e,f){return this.__ajax.asyncCall({method:a,data:e,uri:b.appendUriParams(d,f)}).mapError(function(a){return{error:a.status_code(),data:a.data(),invalid:a.status_code()===c.HTTP_STATUS_PRECONDITION_FAILED}},this)}}}])}),a.define("module:Stores.Invokers.StoreInvokee",[],function(){return{storeInvoke:function(a,b,c){}}}),a.define("module:Stores.Invokers.RestInvokee",[],function(){return{restInvoke:function(a,b,c,d,e){}}}),a.define("module:Stores.Invokers.RouteredRestInvokee",[],function(){return{routeredRestInvoke:function(a,b,c,d,e){}}}),a.define("module:Stores.Invokers.InvokerStore",["module:Stores.BaseStore"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b,c){a.constructor.call(this,c),this.__storeInvokee=b},__invoke:function(a,b,c){return this.__storeInvokee.storeInvoke(a,b,c)},_insert:function(a,b){return this.__invoke("insert",a,b)},_remove:function(a,b){return this.__invoke("remove",a,b)},_get:function(a,b){return this.__invoke("get",a,b)},_update:function(a,b,c){return this.__invoke("update",{id:a,data:b},c)},_query:function(a,b,c){return this.__invoke("query",{query:a,options:b},c)}}})}),a.define("module:Stores.Invokers.StoreInvokeeInvoker",["base:Class","module:Stores.Invokers.StoreInvokee"],function(a,b,c){return a.extend({scoped:c},[b,function(a){return{constructor:function(b){a.constructor.apply(this),this.__store=b},storeInvoke:function(a,b,c){return this["__"+a](b,c)},__insert:function(a,b){return this.__store.insert(a,b)},__remove:function(a,b){return this.__store.remove(a,b)},__get:function(a,b){return this.__store.get(a,b)},__update:function(a,b){return this.__store.update(a.id,a.data,b)},__query:function(a,b){return this.__store.query(a.query,a.options,b)}}}])}),a.define("module:Stores.Invokers.StoreInvokeeRestInvoker",["base:Class","base:Objs","base:Types","json:","module:Stores.Invokers.StoreInvokee"],function(a,b,c,d,e,f){return a.extend({scoped:f},[e,function(a){return{constructor:function(e,f){a.constructor.call(this),this.__restInvokee=e,this.__options=b.tree_extend({methodMap:{insert:"POST",get:"GET",remove:"DELETE",update:"PUT",query:"GET"},toMethod:null,dataMap:{insert:function(a,b){return a},update:function(a,b){return a.data}},toData:null,getMap:{query:function(a,e){var f={};return a.query&&!c.is_empty(a.query)&&(f.query=d.stringify(a.query)),f=b.extend(f,a.options)}},toGet:null,baseURI:"/",uriMap:{get:function(a,b){return a},remove:function(a,b){return a},update:function(a,b){return a.id}},toURI:null,context:this},f)},storeInvoke:function(a,b,c){return this.__restInvokee.restInvoke(this._toMethod(a,b,c),this._toURI(a,b,c),this._toData(a,b,c),this._toGet(a,b,c))},_toMethod:function(a,b,c){var d=null;return this.__options.toMethod&&(d=this.__options.toMethod.call(this.__options.context,a,b,c)),d||this.__options.methodMap[a]},_toURI:function(a,b,d){var e=c.is_function(this.__options.baseURI)?this.__options.baseURI.call(this.__options.context,d):this.__options.baseURI;if(this.__options.toURI){var f=this.__options.toURI.call(this.__options.context,a,b,d);if(f)return e+f}return e+(a in this.__options.uriMap?c.is_function(this.__options.uriMap[a])?this.__options.uriMap[a].call(this.__options.context,b,d):this.__options.uriMap[a]:"")},_toData:function(a,b,c){var d=null;return this.__options.toData&&(d=this.__options.toData.call(this.__options.context,a,b,c)),d||(a in this.__options.dataMap?this.__options.dataMap[a].call(this.__options.context,b,c):null)},_toGet:function(a,b,c){var d=null;return this.__options.toGet&&(d=this.__options.toGet.call(this.__options.context,a,b,c)),d||(a in this.__options.getMap?this.__options.getMap[a].call(this.__options.context,b,c):null)}}}])}),a.define("module:Stores.Invokers.RouteredRestInvokeeStoreInvoker",["base:Class","base:Objs","base:Types","json:","module:Stores.Invokers.RouteredRestInvokee"],function(a,b,c,d,e,f){return a.extend({scoped:f},[e,function(a){return{constructor:function(e,f){a.constructor.call(this),this.__storeInvokee=e,this.__options=b.tree_extend({dataMap:{insert:function(a,b,c,d,e){return c},update:function(a,b,c,d,e){return{id:b.id,data:c}},get:function(a,b,c,d,e){return b.id},remove:function(a,b,c,d,e){return b.id},query:function(a,e,f,g,h){var i={};g.query&&(i.query=d.parse(g.query));var j=b.clone(g,1);return delete j.query,c.is_empty(j)||(i.options=j),i}},toData:null,contextMap:{},toContext:function(a,b,c,d,e){return e},context:this},f)},routeredRestInvoke:function(a,b,c,d,e){return this.__storeInvokee.storeInvoke(a,this._toData(a,b,c,d,e),this._toContext(a,b,c,d,e))},_toData:function(a,b,c,d,e){var f=null;return this.__options.toData&&(f=this.__options.toData.call(this.__options.context,a,b,c,d,e)),f||(a in this.__options.dataMap?this.__options.dataMap[a].call(this.__options.context,a,b,c,d,e):null)},_toContext:function(a,b,c,d,e){var f=null;return this.__options.toContext&&(f=this.__options.toContext.call(this.__options.context,a,b,c,d,e)),f||(a in this.__options.contextMap?this.__options.contextMap[a].call(this.__options.context,a,b,c,d,e):null)}}}])}),a.define("module:Stores.Invokers.RestInvokeeStoreInvoker",["module:Stores.Invokers.RouteredRestInvokeeStoreInvoker","module:Stores.Invokers.RestInvokee","base:Router.RouteParser","base:Objs","base:Types"],function(a,b,c,d,e,f){return a.extend({scoped:f},[b,function(a){return{constructor:function(b,f){a.constructor.call(this,b,d.tree_extend({baseURI:"/",methodMap:{insert:"POST",get:"GET",remove:"DELETE",update:"PUT",query:"GET"},toMethod:null,uriMap:{get:"(id:.+)",remove:"(id:.+)",update:"(id:.+)"},toURI:null},f)),this.__routes={},d.iter(this.__options.methodMap,function(a,b){var c="",d=e.is_function(this.__options.baseURI)?this.__options.baseURI.call(this.__options.context):this.__options.baseURI;if(this.__options.toURI){var f=this.__options.toURI.call(this.__options.context,b);f&&(c=d+f)}c||(c=d+(b in this.__options.uriMap?e.is_function(this.__options.uriMap[b])?this.__options.uriMap[b].call(this.__options.context):this.__options.uriMap[b]:"")),this.__routes[b]=a+" "+c},this),this.__routeParser=this.auto_destroy(new c(this.__routes))},restInvoke:function(a,b,c,d,e){var f=this.__routeParser.parse(a+" "+b);return this.routeredRestInvoke(f.name,f.args,c,d,e)}}}])}),a.define("module:Stores.CachedStore",["module:Stores.BaseStore","module:Stores.MemoryStore","module:Queries.Constrained","module:Stores.CacheStrategies.ExpiryCacheStrategy","base:Promise","base:Objs","base:Types","base:Iterators.ArrayIterator","base:Iterators.MappedIterator","base:Timers.Timer"],function(a,b,c,d,e,f,g,h,i,j,k){return a.extend({scoped:k},function(a){return{constructor:function(c,e){a.constructor.call(this),this._options=f.extend({itemMetaKey:"meta",queryMetaKey:"meta",queryKey:"query"},e),this.remoteStore=c,this._online=!0,this.itemCache=this._options.itemCache||this.auto_destroy(new b({id_key:c.id_key()})),this.queryCache=this._options.queryCache||this.auto_destroy(new b),this.cacheStrategy=this._options.cacheStrategy||this.auto_destroy(new d),this._options.auto_cleanup&&this.auto_destroy(new j({fire:this.cleanup,context:this,start:!0,delay:this._options.auto_cleanup}))},_query_capabilities:function(){return c.fullConstrainedQueryCapabilities()},_insert:function(a){return this.cacheInsert(a,{lockItem:!0,silent:!0,refreshMeta:!1,accessMeta:!0})},_update:function(a,b){return this.cacheUpdate(a,b,{ignoreLock:!1,silent:!0,lockAttrs:!0,refreshMeta:!1,accessMeta:!0})},_remove:function(a){return this.cacheRemove(a,{ignoreLock:!0,silent:!0})},_get:function(a){return this.cacheGet(a,{silentInsert:!0,silentUpdate:!0,silentRemove:!0,refreshMeta:!0,accessMeta:!0})},_query:function(a,b){return this.cacheQuery(a,b,{silent:!0,queryRefreshMeta:!0,queryAccessMeta:!0,refreshMeta:!0,accessMeta:!0})},cacheInsert:function(a,b){var c={lockedItem:b.lockItem,lockedAttrs:{},refreshMeta:b.refreshMeta?this.cacheStrategy.itemRefreshMeta():null,accessMeta:b.accessMeta?this.cacheStrategy.itemAccessMeta():null};return this.itemCache.insert(this.addItemMeta(a,c)).mapSuccess(function(c){return a=this.removeItemMeta(c),b.silent||this._inserted(a),a},this)},cacheUpdate:function(a,b,c){return this.itemCache.get(a).mapSuccess(function(d){if(!d)return null;var e=this.readItemMeta(d);return b=f.filter(b,function(a,b){return c.ignoreLock||!e.lockedItem&&!e.lockedAttrs[b]},this),g.is_empty(b)?this.removeItemMeta(d):(c.lockAttrs&&f.iter(b,function(a,b){e.lockedAttrs[b]=!0},this),c.refreshMeta&&(e.refreshMeta=this.cacheStrategy.itemRefreshMeta(e.refreshMeta)),c.accessMeta&&(e.accessMeta=this.cacheStrategy.itemAccessMeta(e.accessMeta)),this.itemCache.update(a,this.addItemMeta(b,e)).mapSuccess(function(a){return a=this.removeItemMeta(a),c.silent||this._updated(a,b),a},this))},this)},cacheInsertUpdate:function(a,b){var c=a[this.remoteStore.id_key()];return this.itemCache.get(c).mapSuccess(function(d){return d?this.cacheUpdate(c,a,b):this.cacheInsert(a,b)},this)},cacheRemove:function(a,b){return this.itemCache.get(a).mapSuccess(function(c){if(!c)return c;var d=this.readItemMeta(c);return b.ignoreLock||!d.lockedItem&&g.is_empty(d.lockedAttrs)?this.itemCache.remove(a).success(function(){b.silent||this._removed(a)},this):e.error("locked item")},this)},cacheGet:function(a,b){return this.itemCache.get(a).mapSuccess(function(c){if(!c)return this.remoteStore.get(a).success(function(a){this.online(),a&&this.cacheInsert(a,{lockItem:!1,silent:b.silentInsert,accessMeta:!0,refreshMeta:!0})},this);var d=this.readItemMeta(c);return this.cacheStrategy.validItemRefreshMeta(d.refreshMeta)||d.lockedItem?(b.accessMeta&&(d.accessMeta=this.cacheStrategy.itemAccessMeta(d.accessMeta),this.itemCache.update(a,this.addItemMeta({},d))),this.removeItemMeta(c)):this.remoteStore.get(a).success(function(c){this.online(),c?this.cacheUpdate(a,c,{ignoreLock:!1,lockAttrs:!1,silent:b.silentUpdate,accessMeta:!0,refreshMeta:!0}):this.cacheRemove(a,{ignoreLock:!1,silent:b.silentRemove})},this).mapError(function(){return this.offline(),e.value(c)},this)},this)},cacheQuery:function(a,b,d){var e=c.serialize({query:a,options:b}),g=f.objectBy(this._options.queryKey,e);return this.queryCache.query(g,{limit:1}).mapSuccess(function(c){if(c=c.hasNext()?c.next():null){var g=this.readQueryMeta(c),j=this.queryCache.id_of(c);if(this.cacheStrategy.validQueryRefreshMeta(g.refreshMeta))return d.queryAccessMeta&&(g.accessMeta=this.cacheStrategy.queryAccessMeta(g.accessMeta),this.queryCache.update(j,this.addQueryMeta({},g))),this.itemCache.query(a,d).mapSuccess(function(a){return a=a.asArray(),f.iter(a,function(a){this.cacheUpdate(this.itemCache.id_of(a),{},{lockItem:!1,lockAttrs:!1,silent:!0,accessMeta:d.accessMeta,refreshMeta:!1})},this),new i(new h(a),this.removeItemMeta,this)},this);this.queryCache.remove(j)}return this.remoteStore.query(a,b).mapSuccess(function(a){this.online(),a=a.asArray();var b={refreshMeta:d.queryRefreshMeta?this.cacheStrategy.queryRefreshMeta():null,accessMeta:d.queryAccessMeta?this.cacheStrategy.queryAccessMeta():null};return this.queryCache.insert(f.objectBy(this._options.queryKey,e,this._options.queryMetaKey,b)),f.iter(a,function(a){this.cacheInsertUpdate(a,{lockItem:!1,lockAttrs:!1,silent:d.silent,accessMeta:d.accessMeta,refreshMeta:d.refreshMeta})},this),new h(a)},this).mapError(function(){return this.offline(),this.itemCache.query(a,d).mapSuccess(function(a){return a=a.asArray(),f.iter(a,function(a){this.cacheUpdate(this.itemCache.id_of(a),{},{lockItem:!1,lockAttrs:!1,silent:!0,accessMeta:d.accessMeta,refreshMeta:!1})},this),new i(new h(a),this.removeItemMeta,this)},this)},this)},this)},online:function(){this.trigger("online"),this._online=!0},offline:function(){this.trigger("offline"),this._online=!1},addItemMeta:function(a,b){return a=f.clone(a,1),a[this._options.itemMetaKey]=b,a},addQueryMeta:function(a,b){return a=f.clone(a,1),a[this._options.queryMetaKey]=b,a},removeItemMeta:function(a){return a=f.clone(a,1),delete a[this._options.itemMetaKey],a},removeQueryMeta:function(a){return a=f.clone(a,1),delete a[this._options.queryMetaKey],a},readItemMeta:function(a){return a[this._options.itemMetaKey]},readQueryMeta:function(a){return a[this._options.queryMetaKey]},unlockItem:function(a){this.itemCache.get(a).success(function(b){if(b){var c=this.readItemMeta(b);c.lockedItem=!1,c.lockedAttrs={},this.itemCache.update(a,this.addItemMeta({},c))}},this)},cleanup:function(){this._online&&(this.queryCache.query().success(function(a){for(;a.hasNext();){var b=a.next(),c=this.readQueryMeta(b);this.cacheStrategy.validQueryRefreshMeta(c.refreshMeta)&&this.cacheStrategy.validQueryAccessMeta(c.accessMeta)||this.queryCache.remove(this.queryCache.id_of(b))}},this),this.itemCache.query().success(function(a){for(;a.hasNext();){var b=a.next(),c=this.readItemMeta(b);c.lockedItem||!g.is_empty(c.lockedAttrs)||this.cacheStrategy.validItemRefreshMeta(c.refreshMeta)&&this.cacheStrategy.validItemAccessMeta(c.accessMeta)||this.itemCache.remove(this.itemCache.id_of(b))}},this))}}})}),a.define("module:Stores.CacheStrategies.CacheStrategy",["base:Class"],function(a,b){return a.extend({scoped:b},{itemRefreshMeta:function(a){},queryRefreshMeta:function(a){},itemAccessMeta:function(a){},queryAccessMeta:function(a){},validItemRefreshMeta:function(a){},validQueryRefreshMeta:function(a){},validItemAccessMeta:function(a){},validQueryAccessMeta:function(a){}})}),a.define("module:Stores.CacheStrategies.ExpiryCacheStrategy",["module:Stores.CacheStrategies.CacheStrategy","base:Time","base:Objs"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(d){a.constructor.call(this),this._options=c.extend({itemRefreshTime:144e4,itemAccessTime:36e6,queryRefreshTime:144e4,queryAccessTime:36e6,now:function(){return b.now()}},d)},itemRefreshMeta:function(a){return a?a:this._options.now()+this._options.itemRefreshTime},queryRefreshMeta:function(a){return a?a:this._options.now()+this._options.queryRefreshTime},itemAccessMeta:function(a){return this._options.now()+this._options.itemAccessTime},queryAccessMeta:function(a){return this._options.now()+this._options.queryAccessTime},validItemRefreshMeta:function(a){return a>=this._options.now()},validQueryRefreshMeta:function(a){return a>=this._options.now()},validItemAccessMeta:function(a){return a>=this._options.now()},validQueryAccessMeta:function(a){return a>=this._options.now()}}})}),a.define("module:Stores.PartialStore",["module:Stores.BaseStore","module:Stores.CachedStore","module:Stores.PartialStoreWriteStrategies.PostWriteStrategy","base:Objs"],function(a,b,c,d,e){return a.extend({scoped:e},function(a){return{constructor:function(e,f){a.constructor.call(this,f),this._options=d.extend({},f),this.remoteStore=e,this.cachedStore=new b(e,this._options),this.writeStrategy=this._options.writeStrategy||this.auto_destroy(new c),this._watcher&&(this._watcher.on("insert",this._remoteInsert,this),this._watcher.on("update",this._remoteUpdate,this),this._watcher.on("remove",this._remoteRemove,this)),this.cachedStore.on("insert",this._inserted,this),this.cachedStore.on("remove",this._removed,this),this.cachedStore.on("update",function(a,b){this._updated(this.cachedStore.id_of(a),b)},this),this.writeStrategy.init(this)},destroy:function(){this._watcher&&this._watcher.off(null,null,this),this.cachedStore.destroy(),a.destroy.call(this)},_insert:function(a){return this.writeStrategy.insert(a)},_remove:function(a){return this.writeStrategy.remove(a)},_update:function(a,b){return this.writeStrategy.update(a,b)},_get:function(a){return this.cachedStore.get(a)},_query:function(a,b){return this.cachedStore.query(a,b)},_query_capabilities:function(){return this.cachedStore._query_capabilities()},_remoteInsert:function(a){this.cachedStore.cacheInsert(a,{lockItem:!1,silent:!1,refreshMeta:!0,accessMeta:!0})},_remoteUpdate:function(a,b){var c=this.remoteStore.id_of(a);this.cachedStore.cacheUpdate(c,b,{ignoreLock:!1,lockAttrs:!1,silent:!1,accessMeta:!0,refreshMeta:!0})},_remoteRemove:function(a){this.cachedStore.cacheRemove(a,{ignoreLock:!1,silent:!1})}}})}),a.define("module:Stores.PartialStoreWriteStrategies.WriteStrategy",["base:Class"],function(a,b){return a.extend({scoped:b},function(a){return{init:function(a){this.partialStore=a},insert:function(a){},remove:function(a){},update:function(a){}}})}),a.define("module:Stores.PartialStoreWriteStrategies.PostWriteStrategy",["module:Stores.PartialStoreWriteStrategies.WriteStrategy"],function(a,b){return a.extend({scoped:b},function(a){return{insert:function(a){return this.partialStore.remoteStore.insert(a).mapSuccess(function(a){return this.partialStore.cachedStore.cacheInsert(a,{lockItem:!1,silent:!0,refreshMeta:!0,accessMeta:!0},this)},this)},remove:function(a){return this.partialStore.remoteStore.remove(a).mapSuccess(function(){return this.partialStore.cachedStore.cacheRemove(a,{ignoreLock:!0,silent:!0},this)},this)},update:function(a,b){return this.partialStore.remoteStore.update(a,b).mapSuccess(function(){return this.partialStore.cachedStore.cacheUpdate(a,b,{ignoreLock:!1,lockAttrs:!1,silent:!0,refreshMeta:!0,accessMeta:!0},this)},this)}}})}),a.define("module:Stores.PartialStoreWriteStrategies.PreWriteStrategy",["module:Stores.PartialStoreWriteStrategies.WriteStrategy"],function(a,b){return a.extend({scoped:b},function(a){return{insert:function(a){return this.partialStore.cachedStore.cacheInsert(a,{lockItem:!0,silent:!0,refreshMeta:!0,accessMeta:!0}).success(function(a){this.partialStore.remoteStore.insert(a).success(function(){this.partialStore.cachedStore.unlockItem(this.partialStore.cachedStore.id_of(a))},this).error(function(){this.partialStore.cachedStore.cacheRemove(this.partialStore.cachedStore.id_of(a),{ignoreLock:!0,silent:!1})},this)},this)},remove:function(a){return this.partialStore.cachedStore.cacheRemove(a,{ignoreLock:!0,silent:!0}).success(function(){this.partialStore.remoteStore.remove(a)},this)},update:function(a,b){return this.partialStore.cachedStore.cacheUpdate(a,b,{lockAttrs:!0,ignoreLock:!1,silent:!0,refreshMeta:!1,accessMeta:!0}).success(function(b){this.partialStore.remoteStore.update(a,b).success(function(){this.partialStore.cachedStore.unlockItem(this.partialStore.cachedStore.id_of(b))},this)},this)}}})}),a.define("module:Stores.PartialStoreWriteStrategies.CommitStrategy",["module:Stores.PartialStoreWriteStrategies.WriteStrategy","module:Stores.StoreHistory","module:Stores.MemoryStore","base:Objs","base:Timers.Timer"],function(a,b,c,d,e,f){return a.extend({scoped:f},function(a){return{constructor:function(d,e){a.constructor.call(this),this._options=e||{},this.historyStore=this._options.historyStore||this.auto_destroy(new c),this.storeHistory=this.auto_destroy(new b(null,this.historyStore,{source_id_key:this._options.source_id_key||"id",row_data:{pushed:!1,success:!1},filter_data:{pushed:!1}}))},init:function(b){a.init.call(this,b),this._options.auto_push&&this.auto_destroy(new e({fire:function(){this.push(this.partialStore)},context:this,start:!0,delay:this._options.auto_push}))},insert:function(a){return this.partialStore.cachedStore.cacheInsert(a,{lockItem:!0,silent:!0,refreshMeta:!0,accessMeta:!0}).success(function(a){this.storeHistory.sourceInsert(a)},this)},remove:function(a){return this.partialStore.cachedStore.cacheRemove(a,{ignoreLock:!0,silent:!0}).success(function(){this.storeHistory.sourceRemove(a)},this)},update:function(a,b){return this.partialStore.cachedStore.cacheUpdate(a,b,{lockAttrs:!0,ignoreLock:!1,silent:!0,refreshMeta:!1,accessMeta:!0}).success(function(){this.storeHistory.sourceUpdate(a,b)},this)},push:function(){if(!this.pushing){var a={},b={},c=this.storeHistory.historyStore,e=c.query({success:!1},{sort:{commit_id:1}}).value(),f=function(){if(!e.hasNext())return this.pushing=!1,void d.iter(b,function(a,b){a&&this.partialStore.cachedStore.unlockItem(b)},this);var g=e.next(),h=c.id_of(g);if(h in a)c.update(h,{pushed:!0,success:!1}),f.apply(this);else{var i=null;"insert"===g.type?i=this.partialStore.remoteStore.insert(g.row):"update"===g.type?i=this.partialStore.remoteStore.update(g.row_id,g.row):"remove"===g.type&&(i=this.partialStore.remoteStore.remove(g.row_id)),i.success(function(){c.update(h,{pushed:!0,success:!0}),g.row_id in b||(b[g.row_id]=!0),f.apply(this);
},this).error(function(){c.update(h,{pushed:!0,success:!1}),a[h]=!0,b[g.row_id]=!1,f.apply(this)},this)}};f.apply(this)}}}})}),a.define("module:Stores.RemoteStore",["module:Stores.Invokers.InvokerStore","module:Stores.Invokers.StoreInvokeeRestInvoker","module:Stores.Invokers.RestInvokeeAjaxInvoker"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(d,e,f){var g=new c(d),h=new b(g,e);a.constructor.call(this,h,f),this.auto_destroy(h),this.auto_destroy(g)}}})}),a.define("module:Stores.SocketStore",["module:Stores.BaseStore","base:Objs"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(b,c,d){a.constructor.call(this,b),this.__socket=c,this.__prefix=d},__send:function(a,b){this.__socket.emit(this.__prefix+":"+a,b)},_insert:function(a){this.__send("insert",a)},_remove:function(a){this.__send("remove",a)},_update:function(a,c){this.__send("update",b.objectBy(a,c))}}})}),a.define("module:Stores.Watchers.ConsumerWatcher",["module:Stores.Watchers.StoreWatcher"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b,c,d){a.constructor.call(this,d),this._receiver=c,this._sender=b,c.on("receive",function(a,b){"insert"===a&&this._insertedWatchedInsert(b),"update"===a?this._updatedWatchedItem(b.row,b.data):"remove"===a&&this._removedWatchedItem(b)},this)},destroy:function(){this._receiver.off(null,null,this),a.destroy.apply(this)},_watchItem:function(a){this._sender.send("watch_item",a)},_unwatchItem:function(a){this._sender.send("unwatch_item",a)},_watchInsert:function(a){this._sender.send("watch_insert",a)},_unwatchInsert:function(a){this._sender.send("unwatch_insert",a)}}})}),a.define("module:Stores.Watchers.ProducerWatcher",["base:Class"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b,c,d){a.constructor.apply(this),this._watcher=d,this._receiver=c,c.on("receive",function(a,b){"watch_item"===a?d.watchItem(b,this):"unwatch_item"===a?d.unwatchItem(b,this):"watch_insert"===a?d.watchInsert(b,this):"unwatch_insert"===a&&d.unwatchInsert(b,this)},this),d.on("insert",function(a){b.send("insert",a)},this).on("update",function(a,c){b.send("update",{row:a,data:c})},this).on("remove",function(a){b.send("remove",a)},this)},destroy:function(){this._receiver.off(null,null,this),this._watcher.off(null,null,this),a.destroy.apply(this)}}})}),a.define("module:Stores.Watchers.LocalWatcher",["module:Stores.Watchers.StoreWatcher"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b,c){c=c||{},c.id_key=b.id_key(),a.constructor.call(this,c),this._store=b,this._store.on("insert",function(a){this._insertedInsert(a)},this).on("update",function(a,b){this._updatedItem(a,b)},this).on("remove",function(a){this._removedItem(a)},this)},destroy:function(){this._store.off(null,null,this),a.destroy.apply(this)}}})}),a.define("module:Stores.Watchers.PollWatcher",["module:Stores.Watchers.StoreWatcher","base:Comparators","base:Objs","base:Timers.Timer"],function(a,b,c,d,e){return a.extend({scoped:e},function(a){return{constructor:function(b,c){c=c||{},c.id_key=b.id_key(),a.constructor.call(this,c),this._store=b,c=c||{},this.__itemCache={},this.__lastKey=null,this.__lastKeyIds={},this.__insertsCount=0,this.__increasingKey=c.increasing_key||this.id_key,c.auto_poll&&this.auto_destroy(new d({fire:this.poll,context:this,start:!0,delay:c.auto_poll}))},_watchItem:function(a){this.__itemCache[a]=null},_unwatchItem:function(a){delete this.__itemCache[a]},_queryLastKey:function(){return this._store.query({},{limit:1,sort:c.objectBy(this.__increasingKey,-1)}).mapSuccess(function(a){return a.hasNext()?a.next()[this.__increasingKey]:null},this).mapError(function(){return null})},_watchInsert:function(a){0===this.__insertsCount&&this._queryLastKey().success(function(a){this.__lastKey=a,this.__lastKeyIds={}},this),this.__insertsCount++},_unwatchInsert:function(a){this.__insertsCount--,0===this.__insertsCount&&(this.__lastKey=null)},poll:function(){c.iter(this.__itemCache,function(a,d){this._store.get(d).success(function(e){e?(this.__itemCache[d]=c.clone(e,1),a&&!b.deepEqual(a,e,-1)&&this._updatedItem(e,e)):this._removedItem(d)},this)},this),this.__lastKey?this.insertsIterator().iterate(function(a){var b=c.objectBy(this.__increasingKey,{$gte:this.__lastKey});this._store.query({$and:[b,a]}).success(function(a){for(;a.hasNext();){var b=a.next(),c=this._store.id_of(b);this.__lastKeyIds[c]||this._insertedInsert(b),this.__lastKeyIds[c]=!0,c>this.__lastKey&&(this.__lastKey=c)}},this)},this):this._queryLastKey().success(function(a){a!==this.__lastKey&&(this.__lastKey=a,this.__lastKeyIds={})},this)}}})}),a.define("module:Stores.Watchers.StoreWatcherMixin",[],function(){return{watchItem:function(a,b){},unwatchItem:function(a,b){},watchInsert:function(a,b){},unwatchInsert:function(a,b){},_removedWatchedItem:function(a){this.trigger("remove",a)},_updatedWatchedItem:function(a,b){this.trigger("update",a,b)},_insertedWatchedInsert:function(a){this.trigger("insert",a)},delegateStoreEvents:function(a){this.on("insert",function(b){a.trigger("insert",b)},a).on("update",function(b,c){a.trigger("update",b,c)},a).on("remove",function(b){a.trigger("remove",b)},a)},undelegateStoreEvents:function(a){this.off(null,null,a)}}}),a.define("module:Stores.Watchers.StoreWatcher",["base:Class","base:Events.EventsMixin","base:Classes.ContextRegistry","module:Stores.Watchers.StoreWatcherMixin","module:Queries"],function(a,b,c,d,e,f){return a.extend({scoped:f},[b,d,function(a){return{constructor:function(b){a.constructor.call(this),b=b||{},b.id_key?this.id_key=b.id_key:this.id_key="id",this.__items=new c,this.__inserts=new c(e.serialize,e)},destroy:function(){this.__inserts.iterator().iterate(this.unwatchInsert,this),this.__items.iterator().iterate(this.unwatchItem,this),this.__inserts.destroy(),this.__items.destroy(),a.destroy.call(this)},insertsIterator:function(){return this.__inserts.iterator()},watchItem:function(a,b){this.__items.register(a,b)&&this._watchItem(a)},unwatchItem:function(a,b){this.__items.unregister(a,b)&&this._unwatchItem(a)},watchInsert:function(a,b){this.__inserts.register(a,b)&&this._watchInsert(a)},unwatchInsert:function(a,b){this.__inserts.unregister(a,b)&&this._unwatchInsert(a)},_removedItem:function(a){this.__items.get(a)&&this._removedWatchedItem(a)},_updatedItem:function(a,b){var c=a[this.id_key];this.__items.get(c)&&this._updatedWatchedItem(c)},_insertedInsert:function(a){for(var b=!1,c=this.__inserts.iterator();!b&&c.hasNext();)b=e.evaluate(c.next(),a);b&&this._insertedWatchedInsert(a)},unregisterItem:function(a,b){this.__items.unregister(a,b)&&this._unregisterItem(a)},_watchItem:function(a){},_unwatchItem:function(a){},_watchInsert:function(a){},_unwatchInsert:function(a){}}}])}),a.define("module:Stores.AbstractIndex",["base:Class","base:Comparators","base:Objs","base:Functions"],function(a,b,c,d,e){return a.extend({scoped:e},function(a){return{constructor:function(d,e,f,g){a.constructor.call(this),this._options=c.extend({exact:!0,ignoreCase:!1},g),this._compare=f||b.byValue,this._store=d,this.__row_count=0,this._initialize();var h=d.id_key();d.query({}).value().iterate(function(a){this.__row_count++,this._insert(a[h],a[e])},this),d.on("insert",function(a){this.__row_count++,this._insert(a[h],a[e])},this),d.on("remove",function(a){this.__row_count--,this._remove(a)},this),d.on("update",function(a,b){e in b&&this._update(a,b[e])},this)},_initialize:function(){},destroy:function(){this._store.off(null,null,this),a.destroy.call(this)},compare:function(){return this._compare.apply(arguments)},comparator:function(){return d.as_method(this,this._compare)},info:function(){return{row_count:this.__row_count,key_count:this._key_count(),key_count_ic:this._key_count_ic()}},options:function(){return this._options},iterate:function(a,b,c,d){this._iterate(a,b,c,d)},itemIterate:function(a,b,c,d){this.iterate(a,b,function(a,b){return c.call(d,a,this._store.get(b).value())},this)},iterate_ic:function(a,b,c,d){this._iterate_ic(a,b,c,d)},itemIterateIc:function(a,b,c,d){this.iterate_ic(a,b,function(a,b){return c.call(d,a,this._store.get(b).value())},this)},_iterate:function(a,b,c,d){},_iterate_ic:function(a,b,c,d){},_insert:function(a,b){},_remove:function(a){},_update:function(a,b){},_key_count:function(){},_key_count_ic:function(){},key_count_left_ic:function(a){},key_count_right_ic:function(a){},key_count_distance_ic:function(a,b){},key_count_left:function(a){},key_count_right:function(a){},key_count_distance:function(a,b){}}})}),a.define("module:Stores.MemoryIndex",["module:Stores.AbstractIndex","base:Structures.TreeMap","base:Objs"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{_initialize:function(){this._options.exact&&(this._exactMap=b.empty(this._compare)),this._options.ignoreCase&&(this._ignoreCaseMap=b.empty(this._compare)),this._idToKey={}},__insert:function(a,d,e){var f=b.find(d,e);return f?f[a]=!0:e=b.add(d,c.objectBy(a,!0),e),e},_insert:function(a,b){this._idToKey[a]=b,this._options.exact&&(this._exactMap=this.__insert(a,b,this._exactMap)),this._options.ignoreCase&&(this._ignoreCaseMap=this.__insert(a,b,this._ignoreCaseMap))},__remove:function(a,d,e){var f=b.find(a,d);return delete f[e],c.is_empty(f)&&(d=b.remove(a,d)),d},_remove:function(a){var b=this._idToKey[a];delete this._idToKey[a],this._options.exact&&(this._exactMap=this.__remove(b,this._exactMap,a)),this._options.ignoreCase&&(this._ignoreCaseMap=this.__remove(b,this._ignoreCaseMap,a))},_update:function(a,b){var c=this._idToKey[a];c!=b&&(this._remove(a),this._insert(a,b))},_iterate:function(a,c,d,e){b.iterate_from(a,this._exactMap,function(a,b){for(var c in b)if(d.call(e,a,c)===!1)return!1;return!0},this,!c)},_iterate_ic:function(a,c,d,e){b.iterate_from(a,this._ignoreCaseMap,function(a,b){for(var c in b)if(d.call(e,a,c)===!1)return!1;return!0},this,!c)},_key_count:function(){return this._options.exact?b.length(this._exactMap):0},_key_count_ic:function(){return this._options.ignoreCase?b.length(this._ignoreCaseMap):0},key_count_left_ic:function(a){return b.treeSizeLeft(a,this._ignoreCaseMap)},key_count_right_ic:function(a){return b.treeSizeRight(a,this._ignoreCaseMap)},key_count_distance_ic:function(a,c){return b.distance(a,c,this._ignoreCaseMap)},key_count_left:function(a){return b.treeSizeLeft(a,this._exactMap)},key_count_right:function(a){return b.treeSizeRight(a,this._exactMap)},key_count_distance:function(a,c){return b.distance(a,c,this._exactMap)}}})}),a.define("module:Collections.AbstractQueryCollection",["base:Collections.Collection","base:Objs","base:Types","base:Comparators","base:Promise","base:Class","module:Queries.Constrained","module:Queries"],function(a,b,c,d,e,f,g,h,i){return a.extend({scoped:i},function(a){return{constructor:function(b,c,d){a.constructor.call(this),d=d||{},this._id_key=this._id_key||d.id_key||"id",this._source=b,this._complete=!1,this._active=d.active||!1,this._incremental="incremental"in d?d.incremental:!0,this._active_bounds="active_bounds"in d?d.active_bounds:!0,this._enabled=!1,this._range=d.range||null,this._forward_steps=d.forward_steps||null,this._backward_steps=d.backward_steps||null,this._active&&(this.on("add",function(a){this._watchItem(a.get(this._id_key))},this),this.on("remove",function(a){this._unwatchItem(a.get(this._id_key))},this)),this._query={query:{},options:{skip:0,limit:null,sort:null}},c=c||{},this.update(c.query?c:{query:c,options:{skip:d.skip||0,limit:d.limit||d.range||null,sort:d.sort||null}}),d.auto&&this.enable()},destroy:function(){this.disable(),this._watcher()&&(this._watcher()._unwatchInsert(null,this),this._watcher()._unwatchItem(null,this)),a.destroy.call(this)},paginate:function(a){return this.update({options:{skip:a*this._range,limit:this._range}})},paginate_index:function(){return Math.floor(this.getSkip()/this._range)},paginate_next:function(){return this.isComplete()?e.create(!0):this.paginate(this.paginate_index()+1)},paginate_prev:function(){return this.paginate_index()>0?this.paginate(this.paginate_index()-1):e.create(!0)},increase_forwards:function(a){return a=a||this._forward_steps,this.isComplete()?e.create(!0):this.update({options:{limit:this.getLimit()+a}})},increase_backwards:function(a){return a=a||this._backward_steps,this.getSkip()?this.update({options:{skip:Math.max(this.getSkip()-a,0),limit:this.getLimit()?this.getLimit()+this.getSkip()-Math.max(this.getSkip()-a,0):null}}):e.create(!0)},get_ident:function(a){return f.is_class_instance(a)?a.get(this._id_key):a[this._id_key]},getQuery:function(){return this._query},getSkip:function(){return this._query.options.skip||0},getLimit:function(){return this._query.options.limit||null},update:function(a){a=g.rectify(a);var c=this._query.options.skip||0,d=this._query.options.limit||null;if(a.query&&(this._query.query=a.query),this._query.options=b.extend(this._query.options,a.options),!this._enabled)return e.create(!0);if(a.query||"sort"in a.options||!this._incremental)return this.refresh();var f="skip"in a.options?a.options.skip||0:c,h="limit"in a.options?a.options.limit||null:d;if(f===c&&h===d)return e.create(!0);if(h&&c>=f+h||d&&f>=c+d)return this.refresh();for(;f>c&&(null===d||d>0);)this.remove(this.getByIndex(0)),c++,d--;var i=e.create(!0);if(c>f){var j=c-f;null!==h&&(j=Math.min(j,h)),i=this._execute(b.tree_extend({options:{skip:f,limit:j}},this._query,2)),f+=j,null!==h&&(h-=j)}if(!d||h&&d>=h){if(h)for(;this.count()>h;)this.remove(this.getByIndex(this.count()-1));return i}return i.and(this._execute(b.tree_extend({options:{skip:c+d,limit:h?h-d:null}},this._query,2)))},enable:function(){this._enabled||(this._enabled=!0,this.refresh())},disable:function(){this._enabled&&(this._enabled=!1,this.clear(),this._unwatchInsert())},refresh:function(a){return a&&this.clear(),this._query.options.sort&&!c.is_empty(this._query.options.sort)?this.set_compare(d.byObject(this._query.options.sort)):this.set_compare(null),this._unwatchInsert(),this._active&&this._watchInsert(this._query.query),this._execute(this._query)},isEnabled:function(){return this._enabled},_execute:function(a){var b=a.options.limit;return this._subExecute(a.query,a.options).mapSuccess(function(a){var c=a.asArray();return this._complete=null===b||c.length<b,this.replace_objects(c),!0},this)},_subExecute:function(a,b){return this._source.query(a,b)},isComplete:function(){return this._complete},isValid:function(a){return h.evaluate(this._query.query,a)},_materialize:function(a){return a},_activeCreate:function(a){this._active&&this._enabled&&this.isValid(a)&&(this.add(this._materialize(a)),this._query.options.limit&&this.count()>this._query.options.limit&&(this._active_bounds?this._query.options.limit++:this.remove(this.getByIndex(this.count()-1))))},_activeRemove:function(a){if(this._active&&this._enabled){var b=this.getById(a);b&&(this.remove(b),null!==this._query.options.limit&&this._active_bounds&&this._query.options.limit--)}},_activeUpdate:function(a,c,d){if(this._active&&this._enabled){var e=this.getById(a),f=b.extend(d,c);e?this.isValid(f)?e.setAll(c):this._activeRemove(a):this._activeCreate(f)}},_watcher:function(){return null},_watchInsert:function(a){this._watcher()&&this._watcher().watchInsert(a,this)},_unwatchInsert:function(){this._watcher()&&this._watcher().unwatchInsert(null,this)},_watchItem:function(a){this._watcher()&&this._watcher().watchItem(a,this)},_unwatchItem:function(a){this._watcher()&&this._watcher().unwatchItem(a,this)}}})}),a.define("module:Collections.StoreQueryCollection",["module:Collections.AbstractQueryCollection","base:Objs"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(c,d,e){a.constructor.call(this,c,d,b.extend({id_key:c.id_key()},e)),this._source=c,c.on("insert",this._activeCreate,this),c.on("remove",this._activeRemove,this),c.on("update",function(a,b){this._activeUpdate(c.id_of(a),b,a)},this)},destroy:function(){this._source.off(null,null,this),a.destroy.call(this)},get_ident:function(a){return a.get(this._source.id_key())},_watcher:function(){return this._source.watcher()}}})}),a.define("module:Collections.TableQueryCollection",["module:Collections.AbstractQueryCollection","base:Objs"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(c,d,e){a.constructor.call(this,c,d,b.extend({id_key:c.primary_key()},e)),c.on("create",this._activeCreate,this),c.on("remove",this._activeRemove,this),c.on("update",this._activeUpdate,this)},destroy:function(){this._source.off(null,null,this),a.destroy.call(this)},_materialize:function(a){return this._source.materialize(a)},_watcher:function(){return this._source.store().watcher()}}})}),a.define("module:Modelling.ModelException",["base:Exceptions.Exception"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b,c){a.constructor.call(this,c),this.__model=b},model:function(){return this.__model}}})}),a.define("module:Modelling.ModelMissingIdException",["module:Modelling.ModelException"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b){a.constructor.call(this,b,"No id given.")}}})}),a.define("module:Modelling.ModelInvalidException",["module:Modelling.ModelException","base:Objs"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(c){var d=b.values(c.errors()).join("\n");a.constructor.call(this,c,d)}}})}),a.define("module:Modelling.Model",["module:Modelling.AssociatedProperties","module:Modelling.ModelInvalidException","base:Objs","base:Promise","base:Types","base:Exceptions"],function(a,b,c,d,e,f,g){return a.extend({scoped:g},function(a){return{constructor:function(b,d,e,f){this.__table=d,this.__options=c.extend({newModel:!0,removed:!1},e),this.__ctx=f,this.__silent=1,a.constructor.call(this,b),this.__silent=0,this.isNew()||(this._properties_changed={},this._registerEvents()),this.option("auto_create")&&this.isNew()&&this.save()},destroy:function(){this.__table.off(null,null,this),this.trigger("destroy"),a.destroy.call(this)},option:function(a){var b=a in this.__options?this.__options:this.table().options();return b[a]},table:function(){return this.__table},isSaved:function(){return this.isRemoved()||!this.isNew()&&!this.isChanged()},isNew:function(){return this.option("newModel")},isRemoved:function(){return this.option("removed")},_registerEvents:function(){this.__table.on("update:"+this.id(),function(a){if(!this.isRemoved()){this.__silent++;for(var b in a)this._properties_changed[b]||this.set(b,a);this.__silent--}},this),this.__table.on("remove:"+this.id(),function(){this.isRemoved()||(this.trigger("remove"),this.__options.removed=!0)},this)},update:function(a){return this.__silent++,this.setAll(a),this.__silent--,this.isNew()?d.create(!0):this.save()},_afterSet:function(b,c,d,e){a._afterSet.call(this,b,c,d,e);var f=this.cls.scheme();b in f&&!(this.__silent>0)&&this.option("auto_update")&&!this.isNew()&&this.save()},save:function(){if(this.isRemoved())return d.create({});var a=this.option("save_invalid")?d.value(!0):this.validate();return a.mapSuccess(function(a){if(!a)return d.create(null,new b(this));var g;if(this.isNew())g=this.cls.filterPersistent(this.get_all_properties()),this.__options.type_column&&(g[this.__options.type_column]=this.cls.classname);else if(g=this.cls.filterPersistent(this.properties_changed()),e.is_empty(g))return d.create(g);var h=this.isNew(),i=this.isNew()?this.__table.store().insert(g,this.__ctx):this.__table.store().update(this.id(),g,this.__ctx);return i.mapCallback(function(a,b){return a?(a.data&&c.iter(a.data,function(a,b){this.setError(b,a)},this),f.ensure(new ModalInvalidException(this))):(this.__silent++,this.setAll(b),this.__silent--,this._properties_changed={},this.trigger("save"),h&&(this.__options.newModel=!1,this._registerEvents()),b)},this)},this)},remove:function(){return this.isNew()||this.isRemoved()?d.create(!0):this.__table.store().remove(this.id(),this.__ctx).mapSuccess(function(a){return this.trigger("remove"),this.__options.removed=!0,a},this)}}})}),a.define("module:Modelling.SchemedProperties",["base:Properties.Properties","base:Types","base:Promise","base:Objs"],function(a,b,c,d,e){return a.extend({scoped:e},function(a){return{constructor:function(c){a.constructor.call(this);var d=this.cls.scheme();this._properties_changed={},this.__errors={};for(var e in d)"def"in d[e]?this.set(e,b.is_function(d[e].def)?d[e].def():d[e].def):d[e].auto_create?this.set(e,d[e].auto_create(this)):this.set(e,null);this._properties_changed={},this.__errors={};for(e in c)this.set(e,c[e])},_unsetChanged:function(a){delete this._properties_changed[a]},_beforeSet:function(a,c){var d=this.cls.scheme();if(!(a in d))return c;var e=d[a];return e.type&&(c=b.parseType(c,e.type)),e.transform&&(c=e.transform.apply(this,[c])),c},_afterSet:function(a,c){var d=this.cls.scheme();if(a in d&&(this._properties_changed[a]=c,delete this.__errors[a],d[a].after_set)){var e=b.is_string(d[a].after_set)?this[d[a].after_set]:d[a].after_set;e.apply(this,[c])}},isChanged:function(){return!b.is_empty(this._properties_changed)},properties_changed:function(){return this._properties_changed},get_all_properties:function(){var a={},b=this.cls.scheme();for(var c in b)a[c]=this.get(c);return a},validate:function(){this.trigger("validate");var a=[];for(var b in this.cls.scheme())a.push(this._validateAttr(b));return a.push(c.box(this._customValidate,this)),c.and(a).end().mapSuccess(function(a){var b=!0;return d.iter(a,function(a){b=b&&a}),b})},_customValidate:function(){return!0},_validateAttr:function(a){delete this.__errors[a];var e=this.cls.scheme(),f=e[a],g=f.validate;if(!g)return c.value(!0);b.is_array(g)||(g=[g]);var h=this.get(a),i=[];return d.iter(g,function(a){i.push(c.box(a.validate,a,[h,this]))},this),c.and(i).end().mapSuccess(function(b){var c=!0;return d.iter(b,function(b){null!==b&&(c=!1,this.__errors[a]=b)},this),this.trigger("validate:"+a,c,this.__errors[a]),c},this)},setError:function(a,b){this.__errors[a]=b,this.trigger("validate:"+a,!(a in this.__errors),this.__errors[a])},errors:function(){return this.__errors},getError:function(a){return this.__errors[a]},asRecord:function(a){var b={},c=this.cls.scheme(),e=this.get_all_properties();a=a||{};var f=function(f){var g=c[f].tags||[],h={};d.iter(g,function(a){h[a]=!0});var i=!0;d.iter(a,function(a){i=i&&a in h},this),i&&(b[f]=e[f])};for(var g in e)g in c&&f.call(this,g);return b},setByTags:function(a,b){var c=this.cls.scheme();b=b||{};var e=function(e){var f=c[e].tags||[],g={};d.iter(f,function(a){g[a]=!0});var h=!0;d.iter(b,function(a){h=h&&a in g},this),h&&this.set(e,a[e])};for(var f in a)f in c&&e.call(this,f)}}},{_initializeScheme:function(){return{}},asRecords:function(a,b){return a.map(function(a){return a.asRecord(b)})},filterPersistent:function(a){var c={},d=this.scheme();for(var e in a)b.is_defined(d[e].persistent)&&!d[e].persistent||!b.is_defined(a[e])||(c[e]=a[e]);return c}},{scheme:function(){return this.__scheme=this.__scheme||this._initializeScheme(),this.__scheme}})}),a.define("module:Modelling.AssociatedProperties",["module:Modelling.SchemedProperties"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b){a.constructor.call(this,b),this.assocs=this._initializeAssociations();for(var c in this.assocs)this.__addAssoc(c,this.assocs[c])},__addAssoc:function(a,b){this[a]=function(){return b.execute.apply(b,arguments)}},_initializeAssociations:function(){return{}},destroy:function(){for(var b in this.assocs)this.assocs[b].destroy();a.destroy.call(this)},id:function(){return this.get(this.cls.primary_key())},pid:function(){return this.id()},hasId:function(){return this.has(this.cls.primary_key())}}},{primary_key:function(){return"id"},_initializeScheme:function(){var a={};return a[this.primary_key()]={type:"id",tags:["read"],after_set:null,persistent:!0},a}})}),a.define("module:Modelling.Table",["base:Class","base:Events.EventsMixin","base:Objs","base:Types","base:Iterators.MappedIterator"],function(b,c,d,e,f,g){return b.extend({scoped:g},[c,function(b){return{constructor:function(a,c,e){b.constructor.call(this),this.__store=a,this.__model_type=c,this.__options=d.extend({type_column:null,auto_create:!1,auto_update:!0,save_invalid:!1},e||{}),this.__store.on("insert",function(a){this.trigger("create",a)},this),this.__store.on("update",function(a,b){var c=a[this.primary_key()];this.trigger("update",c,b,a),this.trigger("update:"+c,b)},this),this.__store.on("remove",function(a){this.trigger("remove",a),this.trigger("remove:"+a)},this)},modelClass:function(b){return b=b||this.__model_type,e.is_string(b)?a.getGlobal(b):b},newModel:function(a,b,c){b=this.modelClass(b);var d=new b(a,this,{},c);return this.__options.auto_create&&d.save(),d},materialize:function(a,b){if(!a)return null;var c=this.modelClass(this.__options.type_column&&a[this.__options.type_column]?this.__options.type_column:null);return new c(a,this,{newModel:!1},b)},options:function(){return this.__options},store:function(){return this.__store},findById:function(a,b){return this.__store.get(a,b).mapSuccess(function(a){return this.materialize(a,b)},this)},findBy:function(a,b,c){return this.allBy(a,d.extend({limit:1},b),c).mapSuccess(function(a){return a.next()})},allBy:function(a,b,c){return this.__store.query(a,b,c).mapSuccess(function(a){return new f(a,function(a){return this.materialize(a,c)},this)},this)},primary_key:function(){return(e.is_string(this.__model_type)?a.getGlobal(this.__model_type):this.__model_type).primary_key()},all:function(a,b){return this.allBy({},a,b)},query:function(){return this.allBy.apply(this,arguments)},scheme:function(){return this.__model_type.scheme()},ensure_indices:function(){if(!("ensure_index"in this.__store))return!1;var a=this.scheme();for(var b in a)a[b].index&&this.__store.ensure_index(b);return!0}}}])}),a.define("module:Modelling.Associations.Association",["base:Class","base:Promise","base:Iterators"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(b,c){a.constructor.call(this),this._model=b,this._options=c||{},c.delete_cascade&&b.on("remove",function(){this.__delete_cascade()},this)},__delete_cascade:function(){this.execute().success(function(a){for(a=c.ensure(a);a.hasNext();)a.next().remove({})},this)},execute:function(){if("__cache"in this)return b.create(this.__cache);var a=this._execute();return this._options.cached&&a.callback(function(a,b){this.__cache=a?null:b},this),a},invalidate:function(){delete this.__cache}}})}),a.define("module:Modelling.Associations.BelongsToAssociation",["module:Modelling.Associations.TableAssociation","base:Promise","base:Objs"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{_execute:function(){var a=this._model.get(this._foreign_key);return a?this._primary_key?this._foreign_table.findBy(c.objectBy(this._primary_key,a)):this._foreign_table.findById(a):b.value(null)}}})}),a.define("module:Modelling.Associations.ConditionalAssociation",["module:Modelling.Associations.Association","base:Objs"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(c,d){a.constructor.call(this,c,b.extend({conditional:function(){return!0}},d))},_execute:function(){var a=this.assoc();return a.execute.apply(a,arguments)},assoc:function(){return this._model.assocs[this._options.conditional(this._model)]}}})}),a.define("module:Modelling.Associations.HasManyAssociation",["module:Modelling.Associations.TableAssociation","base:Objs","base:Iterators.ArrayIterator"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{_id:function(){return this._primary_key?this._model.get(this._primary_key):this._model.id()},_execute:function(){return this.allBy()},execute:function(){return a.execute.call(this).mapSuccess(function(a){return new c(a)})},findBy:function(a){return this._foreign_table.findBy(b.objectBy(this._foreign_key,this._id()))},allBy:function(a,c){return this._foreign_table.allBy(b.extend(b.objectBy(this._foreign_key,c?c:this._id(),a)))}}})}),a.define("module:Modelling.Associations.HasManyThroughArrayAssociation",["module:Modelling.Associations.HasManyAssociation","base:Promise","base:Objs"],function(a,b,c,d){return a.extend({scoped:d},{_execute:function(){var a=b.create(),d=b.and();return c.iter(this._model.get(this._foreign_key),function(a){d=d.and(this._foreign_table.findById(a))},this),d.forwardError(a).success(function(b){a.asyncSuccess(c.filter(b,function(a){return!!a}))}),a}})}),a.define("module:Modelling.Associations.HasManyViaAssociation",["module:Modelling.Associations.HasManyAssociation","base:Objs","base:Promise"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(b,c,d,e,f,g){a.constructor.call(this,b,e,f,g),this._intermediate_table=c,this._intermediate_key=d},findBy:function(a){var d=c.create(),e=b.objectBy(this._intermediate_key,this._id());return this._intermediate_table.findBy(e).forwardError(d).success(function(c){if(c){var e=b.extend(b.clone(a,1),b.objectBy(this._foreign_table.primary_key(),c.get(this._foreign_key)));this._foreign_table.findBy(e).forwardCallback(d)}else d.asyncSuccess(null)},this),d},allBy:function(a,d){var e=c.create(),f=b.objectBy(this._intermediate_key,d?d:this._id());return this._intermediate_table.allBy(f).forwardError(e).success(function(d){for(var f=c.and();d.hasNext();){var g=d.next(),h=b.extend(b.clone(a,1),b.objectBy(this._foreign_table.primary_key(),g.get(this._foreign_key)));f=f.and(this._foreign_table.allBy(h))}f.forwardError(e).success(function(a){var c=[];b.iter(a,function(a){for(;a.hasNext();)c.push(a.next())}),e.asyncSuccess(c)},this)},this),e}}})}),a.define("module:Modelling.Associations.HasOneAssociation",["module:Modelling.Associations.TableAssociation","base:Objs"],function(a,b,c){return a.extend({scoped:c},{_execute:function(a){var c=a?a:this._primary_key?this._model.get(this._primary_key):this._model.id();return this._foreign_table.findBy(b.objectBy(this._foreign_key,c))}})}),a.define("module:Modelling.Associations.PolymorphicHasOneAssociation",["module:Modelling.Associations.Association","base:Objs"],function(b,c,d){return b.extend({scoped:d},function(b){return{constructor:function(a,c,d,e){b.constructor.call(this,a,e),this._foreign_table_key=c,this._foreign_key=d,e.primary_key&&(this._primary_key=e.primary_key)},_execute:function(b){var d=b?b:this._primary_key?this._model.get(this._primary_key):this._model.id(),e=a.getGlobal(this._model.get(this._foreign_table_key));return e.findBy(c.objectBy(this._foreign_key,d))}}})}),a.define("module:Modelling.Associations.TableAssociation",["module:Modelling.Associations.Association"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b,c,d,e){a.constructor.call(this,b,e),this._foreign_table=c,this._foreign_key=d}}})}),a.define("module:Modelling.Validators.ConditionalValidator",["module:Modelling.Validators.Validator","base:Types"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(c,d){a.constructor.call(this),this.__condition=c,this.__validator=b.is_array(d)?d:[d]},validate:function(a,b){if(!this.__condition(a,b))return null;for(var c=0;c<this.__validator.length;++c){var d=this.__validator[c].validate(a,b);if(null!==d)return d}return null}}})}),a.define("module:Modelling.Validators.EmailValidator",["module:Modelling.Validators.Validator","base:Strings"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(b){a.constructor.call(this),this.__error_string=b?b:"Not a valid email address"},validate:function(a,c){return b.is_email_address(a)?null:this.__error_string}}})}),a.define("module:Modelling.Validators.LengthValidator",["module:Modelling.Validators.Validator","base:Types","base:Objs"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(b){a.constructor.call(this),b=c.extend({min_length:null,max_length:null,error_string:null},b),this.__min_length=b.min_length,this.__max_length=b.max_length,
this.__error_string=b.error_string,this.__error_string||(null!==this.__min_length?null!==this.__max_length?this.__error_string="Between "+this.__min_length+" and "+this.__max_length+" characters":this.__error_string="At least "+this.__min_length+" characters":null!==this.__max_length&&(this.__error_string="At most "+this.__max_length+" characters"))},validate:function(a,b){return null!==this.__min_length&&(!a||a.length<this.__min_length)?this.__error_string:null!==this.__max_length&&a.length>this.__max_length?this.__error_string:null}}})}),a.define("module:Modelling.Validators.PresentValidator",["module:Modelling.Validators.Validator","base:Types"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(b){a.constructor.call(this),this.__error_string=b?b:"Field is required"},validate:function(a,c){return b.is_null(a)||""===a?this.__error_string:null}}})}),a.define("module:Modelling.Validators.UniqueValidator",["module:Modelling.Validators.Validator"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b,c){a.constructor.call(this),this.__key=b,this.__error_string=c?c:"Key already present"},validate:function(a,b){var c={};return c[this.__key]=a,b.table().findBy(c).mapSuccess(function(a){return!a||!b.isNew()&&b.id()==a.id()?null:this.__error_string},this)}}})}),a.define("module:Modelling.Validators.Validator",["base:Class"],function(a,b){return a.extend({scoped:b},{validate:function(a,b){return null}})})}).call(Scoped);